<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="pageTitle">My Class Students</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./images/icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./images/icon.png"
    />
    <link rel="manifest" href="/site.webmanifest" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <div class="container bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full">
    <header class="flex flex-col sm:flex-row justify-between items-center mb-4">
      <h1 id="page-title" class="text-3xl font-bold text-gray-800 text-center sm:text-left mb-4 sm:mb-0" data-i18n="pageTitle">My Class Students</h1>
      <div class="flex items-center space-x-2 mb-4 sm:mb-0">
        <select id="language-select" class="border border-gray-300 rounded-md p-2 text-sm">
          <option value="en">English</option>
          <option value="fr">Français</option>
          <option value="es">Español</option>
          <option value="tr">Türkçe</option>
          <option value="ar">العربية</option>
          <option value="ru">Русский</option>
        </select>
        <button id="my-class-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium shadow-md hover:bg-blue-700 transition duration-300" data-i18n="myClassBtn">My Class</button>
        <button id="other-students-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-medium shadow-md hover:bg-gray-300 transition duration-300" data-i18n="otherStudentsBtn">Other Students</button>
      </div>
    </header>

    <div class="mb-6">
      <input type="text" id="search-input" placeholder="" data-i18n-placeholder="searchStudents" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>

    <div id="content-area"></div>
  </div>

  <script src="translate.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const API_BASE_URL = "https://api.smartstudentact.com/api";

      const pageTitle = document.getElementById('page-title');
      const contentArea = document.getElementById('content-area');
      const myClassBtn = document.getElementById('my-class-btn');
      const otherStudentsBtn = document.getElementById('other-students-btn');
      const searchInput = document.getElementById('search-input');
      const langSelect = document.getElementById('language-select');

      const API_ENDPOINTS = {
        'my-class': '/teacher/students',
        'other-students': '/teacher/students/other'
      };

      let currentView = 'my-class';
      let searchTimeout;
      let currentLang = 'en';

     
      const authFetch = async (url, options = {}) => {
        return fetch(url, {
          ...options,
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            ...(options.headers || {})
          }
        });
      };

      function showLoading(viewName) {
        const title = viewName === 'my-class' ? translations.myClassBtn[currentLang] : translations.otherStudentsBtn[currentLang];
        pageTitle.textContent = `${title} ${translations.students[currentLang]}`;
        contentArea.innerHTML = `
          <div class="flex flex-col items-center justify-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-gray-200 border-t-blue-500"></div>
            <p class="ml-4 text-gray-500 mt-4">${translations.loading[currentLang]} ${title.toLowerCase()} ${translations.students[currentLang]}...</p>
          </div>
        `;
      }

      function createMyClassStudentCard(student) {
        const div = document.createElement('div');
        div.className = `p-4 rounded-lg mb-2 border-l-4 border-blue-500 bg-blue-50 shadow-sm flex items-center space-x-4`;
        const imageUrl = student.imageUrl || `https://placehold.co/100x100/A0C4FF/ffffff?text=${student.firstname.charAt(0)}${student.lastname.charAt(0)}`;
        div.innerHTML = `
          <img class="h-16 w-16 rounded-full object-cover" src="${imageUrl}" alt="${student.firstname} ${student.lastname}">
          <div class="flex-1">
            <p class="text-lg font-semibold text-gray-700">${student.firstname} ${student.lastname}</p>
            <p class="text-sm text-gray-600 mt-1">${translations.grade[currentLang]}: ${student.grade}</p>
          </div>
        `;
        return div;
      }

      function createOtherStudentCard(student) {
        const div = document.createElement('div');
        const imageUrl = student.imageUrl || `https://placehold.co/120x120/AEC6CF/ffffff?text=${student.firstname.charAt(0)}${student.lastname.charAt(0)}`;
        div.className = `flex flex-col items-center bg-blue-50 p-6 rounded-lg border-t-4 border-blue-400 shadow-sm transition-transform transform hover:scale-105`;
        div.innerHTML = `
          <img src="${imageUrl}" alt="${student.firstname} ${student.lastname}" onerror="this.onerror=null; this.src='https://placehold.co/120x120/AEC6CF/ffffff?text=OS';" class="w-24 h-24 rounded-full mb-4 object-cover border-4 border-white shadow-md">
          <div class="text-center">
            <p class="text-xl font-semibold text-gray-700">${student.firstname} ${student.lastname}</p>
            <p class="text-md text-gray-600">${translations.grade[currentLang]}: ${student.grade}</p>
          </div>
        `;
        return div;
      }

      async function fetchStudentsAndRender(view, searchTerm = '') {
        showLoading(view);
        const endpoint = API_ENDPOINTS[view] + (searchTerm ? `?search=${encodeURIComponent(searchTerm)}` : '');
        try {
          const response = await authFetch(`${API_BASE_URL}${endpoint}`);
          if (!response.ok) {
            if (response.status === 401 || response.status === 403) { window.location.href = '/login.html'; return; }
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const students = await response.json();
          if (students.length === 0) {
            const message = view === 'my-class' ? translations.noMyClassStudents[currentLang] : translations.noOtherStudents[currentLang];
            contentArea.innerHTML = `<div class="text-center text-gray-500 py-12"><p class="text-lg font-semibold">${message}</p></div>`;
            return;
          }
          const fragment = document.createDocumentFragment();
          if (view === 'other-students') {
            students.sort((a, b) => (`${a.firstname} ${a.lastname}`.toLowerCase()).localeCompare(`${b.firstname} ${b.lastname}`.toLowerCase()));
            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6';
            students.forEach(student => gridContainer.appendChild(createOtherStudentCard(student)));
            fragment.appendChild(gridContainer);
          } else {
            const listContainer = document.createElement('div');
            listContainer.className = 'space-y-4';
            students.forEach(student => listContainer.appendChild(createMyClassStudentCard(student)));
            fragment.appendChild(listContainer);
          }
          contentArea.innerHTML = '';
          contentArea.appendChild(fragment);
        } catch (error) {
          console.error('Failed to fetch students:', error);
          contentArea.innerHTML = `<div class="text-center text-red-500 py-12"><p class="font-bold">${translations.error[currentLang]}:</p><p>${error.message}</p><p>${translations.studentLoadError[currentLang]}</p></div>`;
        }
      }

      // Language change
      langSelect.addEventListener('change', (e) => {
        currentLang = e.target.value;
        translatePage('my-students', currentLang).then(() => {
          searchInput.placeholder = translations.searchStudents[currentLang] || 'Search students...';
          fetchStudentsAndRender(currentView, searchInput.value);
        });
      });

      // Buttons
      myClassBtn.addEventListener('click', () => {
        currentView = 'my-class';
        fetchStudentsAndRender(currentView, searchInput.value);
        myClassBtn.classList.replace('bg-gray-200', 'bg-blue-600');
        myClassBtn.classList.replace('text-gray-800', 'text-white');
        otherStudentsBtn.classList.replace('bg-blue-600', 'bg-gray-200');
        otherStudentsBtn.classList.replace('text-white', 'text-gray-800');
      });

      otherStudentsBtn.addEventListener('click', () => {
        currentView = 'other-students';
        fetchStudentsAndRender(currentView, searchInput.value);
        otherStudentsBtn.classList.replace('bg-gray-200', 'bg-blue-600');
        otherStudentsBtn.classList.replace('text-gray-800', 'text-white');
        myClassBtn.classList.replace('bg-blue-600', 'bg-gray-200');
        myClassBtn.classList.replace('text-white', 'text-gray-800');
      });

      // Search input listener
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          fetchStudentsAndRender(currentView, searchInput.value.trim());
        }, 300);
      });

      // Initial page load
      translatePage('my-students', currentLang).then(() => {
        searchInput.placeholder = translations.searchStudents[currentLang] || 'Search students...';
        fetchStudentsAndRender(currentView);
      });
    });
  </script>

</body>
</html>
