<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="dashboardTitle">Teacher Dashboard</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWMR745QHX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag("js", new Date());
    gtag("config", "G-EWMR745QHX");
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="./images/icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
    body { font-family: "Inter", sans-serif; }
    .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #3b82f6; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans antialiased">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-gray-200 bg-opacity-75 z-[999]">
    <div class="text-center p-6 bg-white rounded-xl shadow-lg">
      <div class="spinner mx-auto mb-4"></div>
      <p class="text-lg text-gray-700 font-medium" data-i18n="loadingMessage">Loading teacher dashboard...</p>
    </div>
  </div>

  <!-- Container -->
  <div class="container mx-auto p-4 sm:p-6 lg:p-8 space-y-6">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row justify-between items-center py-4 border-b border-gray-200">
      <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0" data-i18n="dashboardTitle">📚 Teacher Dashboard</h1>
      <div class="flex items-center space-x-6">
        <!-- Language -->
        <select id="language-select" class="rounded-full px-4 py-2 bg-white text-gray-700 border border-gray-300">
          <option value="en">EN</option><option value="fr">FR</option>
          <option value="es">ES</option><option value="tr">TR</option>
          <option value="ar">AR</option><option value="ru">RU</option>
        </select>
        <!-- Profile -->
        <div class="relative inline-block text-left">
          <button id="profile-menu-button" type="button" class="flex items-center space-x-2 rounded-full px-4 py-2 hover:bg-gray-200">
            <img id="profileAvatar" src="./images/default-avatar.png" alt="Profile Avatar" class="h-10 w-10 rounded-full object-cover border border-gray-300" />
            <span id="profilePreviewName" class="hidden sm:inline font-medium text-gray-700">Teacher</span>
            <i class="fas fa-chevron-down text-gray-400"></i>
          </button>
          <div id="profile-dropdown-menu" class="hidden absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
            <a href="/AI-Essay-Checker.html" class="block px-4 py-2 text-sm hover:bg-gray-100">🤖 AI Essay Checker</a>
            <a href="/quiz_dashboard.html" class="block px-4 py-2 text-sm hover:bg-gray-100">📝 Quiz Dashboard</a>
            <a href="/profile.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Your Profile</a>
            <a href="/settings.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Settings</a>
            <button id="logoutButton" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">🚪 Sign out</button>
          </div>
        </div>
      </div>
    </header>

    
    <nav class="flex flex-wrap sm:flex-nowrap justify-around items-center bg-white rounded-xl p-3 shadow-md">
      <a href="/my-students.html" class="flex-1 text-center py-3 m-1 bg-blue-600 text-white rounded-lg">👨‍🎓 My Class</a>
      <a href="/completed-assignment.html" class="flex-1 text-center py-3 m-1 bg-blue-600 text-white rounded-lg">✅ Completed Tasks</a>
      <a href="/quiz_dashboard.html" class="flex-1 text-center py-3 m-1 bg-purple-600 text-white rounded-lg">📝 Quiz Dashboard</a>
      <a href="/AI-Essay-Checker.html" class="flex-1 text-center py-3 m-1 bg-blue-600 text-white rounded-lg">🤖 AI Checker</a>
    </nav>

   
    <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <section id="studentsSection" class="bg-white rounded-xl p-6 shadow-lg">
        <h2 class="text-2xl font-semibold mb-4">🎓 Students in Your Class</h2>
        <div id="studentsList"></div>
      </section>
      <section id="assignedTasks" class="bg-white rounded-xl p-6 shadow-lg">
        <h2 class="text-2xl font-semibold mb-4">📝 Assigned Tasks & Feedback</h2>
        <div id="assignedTasksList"></div>
      </section>
      <section id="feedback" class="bg-white rounded-xl p-6 shadow-lg">
        <h2 class="text-2xl font-semibold mb-4">💬 Student Feedback</h2>
        <div id="feedbackList"></div>
      </section>
      <section id="overdueTasks" class="bg-white rounded-xl p-6 shadow-lg">
        <h2 class="text-2xl font-semibold mb-4">📌 Overdue Tasks</h2>
        <div id="overdueTasksList"></div>
      </section>
    </main>

    <footer class="text-center text-sm text-gray-500 py-6 mt-4">
      © <span id="currentYear"></span> SmartStudentAct 2025
    </footer>
  </div>

  <script src="translate.js"></script>
  <script>
    const API_BASE_URL = "https://api.smartstudentact.com/api";

    function hideLoadingOverlay(){ document.getElementById("loadingOverlay").style.display="none"; }

    async function fetchAPI(endpoint, options={}) {
      try {
        const res = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, credentials:"include" });
        if(res.status===401){ window.location.href="/login.html"; return null; }
        return res;
      } catch(e){ console.error(e); return null; }
    }

    async function fetchTeacherProfile(){
    const res = await fetchAPI("/teacher/profile");
    if(res && res.ok){
      const data = await res.json();
      document.getElementById("profilePreviewName").innerText = data.name || "Teacher";
      await fetchTeacherPhoto(); 
    }
  }

  async function fetchTeacherPhoto(){
    try {
      const res = await fetchAPI("/profile/upload-photo"); 
      if(res && res.ok){
        const blob = await res.blob();
        if(blob.size > 0){
          const photoUrl = URL.createObjectURL(blob);
          document.getElementById("profileAvatar").src = photoUrl;
        } else {
          document.getElementById("profileAvatar").src = "./images/default-avatar.png";
        }
      } else {
        document.getElementById("profileAvatar").src = "./images/default-avatar.png";
      }
    } catch(err){
      console.error("Error fetching profile photo:", err);
      document.getElementById("profileAvatar").src = "./images/default-avatar.png";
    }
  }

    async function fetchStudents(){
      const res = await fetchAPI("/teacher/students");
      if(res && res.ok){
        const students = await res.json();
        document.getElementById("studentsList").innerHTML = students.map(s =>
          `<div class="p-2 flex justify-between border-b">
             <span>${s.firstname} ${s.lastname}</span>
             <span class="text-green-600">Points: ${s.points||0}</span>
           </div>`).join("");
      }
    }

    async function fetchAssignedTasks(){
      const res = await fetchAPI("/teacher/assignments");
      if(res && res.ok){
        const tasks = await res.json();
        document.getElementById("assignedTasksList").innerHTML = tasks.map(t =>
          `<div class="p-2 border-b">
             <strong>${t.title}</strong><br/>
             <small>Assigned to: ${t.studentName} | Due: ${new Date(t.dueDate).toLocaleString()}</small>
           </div>`).join("");
      }
    }

    async function fetchFeedback(){
      const res = await fetchAPI("/teacher/feedback");
      if(res && res.ok){
        const feedbacks = await res.json();
        document.getElementById("feedbackList").innerHTML = feedbacks.map(f =>
          `<div class="p-2 border-b">
             <strong>${f.studentName}</strong>: ${f.comment}
           </div>`).join("");
      }
    }

    async function fetchOverdueTasks(){
      const res = await fetchAPI("/teacher/overdue-tasks");
      if(res && res.ok){
        const overdue = await res.json();
        document.getElementById("overdueTasksList").innerHTML = overdue.map(t =>
          `<div class="p-2 border-b text-red-600">
             <strong>${t.title}</strong> (Student: ${t.studentName})<br/>
             Overdue since: ${new Date(t.dueDate).toLocaleString()}
           </div>`).join("");
      }
    }

    async function init(){
      await fetchTeacherProfile();
      await fetchStudents();
      await fetchAssignedTasks();
      await fetchFeedback();
      await fetchOverdueTasks();
      hideLoadingOverlay();
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("currentYear").innerText = new Date().getFullYear();
      init();

      // Dropdown toggle
      const btn=document.getElementById("profile-menu-button");
      const menu=document.getElementById("profile-dropdown-menu");
      btn.addEventListener("click",()=>menu.classList.toggle("hidden"));
      document.addEventListener("click",(e)=>{ if(!btn.contains(e.target)&&!menu.contains(e.target)) menu.classList.add("hidden"); });

      document.getElementById("logoutButton").addEventListener("click",async()=>{
        await fetchAPI("/users/logout",{method:"POST"});
        window.location.href="/login.html";
      });
    });
  </script>
</body>
</html>

