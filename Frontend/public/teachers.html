<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="dashboardTitle">Teacher Dashboard</title>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWMR745QHX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag("js", new Date());
    gtag("config", "G-EWMR745QHX");
  </script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="./images/icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
    body { font-family: "Inter", sans-serif; }

    .spinner {
      border: 4px solid rgba(0,0,0,0.1);
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 32px; height: 32px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    .custom-file-input::-webkit-file-upload-button { visibility: hidden; }
    .custom-file-input::before {
      content: "ğŸ“ Pick Document/File";
      display: inline-block;
      background-color: #2563eb; color: #fff; font-weight: 600;
      padding: 10px 14px; border-radius: 8px; cursor: pointer;
    }
    .custom-file-input:hover::before { background-color: #1d4ed8; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen antialiased">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-gray-200 bg-opacity-75 z-[999]">
    <div class="text-center p-6 bg-white rounded-xl shadow-lg">
      <div class="spinner mx-auto mb-4"></div>
      <p class="text-lg text-gray-700 font-medium" data-i18n="loadingMessage">
        Loading teacher dashboard...
      </p>
    </div>
  </div>

  <div class="container mx-auto p-4 sm:p-6 lg:p-8 space-y-6">

    <!-- Header -->
    <header class="flex flex-col sm:flex-row justify-between items-center py-4 border-b border-gray-200">
      <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0" data-i18n="dashboardTitle">
        ğŸ“š Teacher Dashboard
      </h1>

      <div class="flex items-center space-x-6">
        <select id="language-select"
                class="rounded-full px-4 py-2 bg-white text-gray-700 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="en">EN</option>
          <option value="fr">FR</option>
          <option value="es">ES</option>
          <option value="tr">TR</option>
          <option value="ar">AR</option>
          <option value="ru">RU</option>
        </select>

        <div class="relative inline-block text-left">
          <button id="profile-menu-button" type="button"
                  class="flex items-center space-x-2 rounded-full px-4 py-2 hover:bg-gray-200 transition-all duration-300 focus:outline-none">
            <img id="profileAvatar" src="./images/default-avatar.png" alt="Profile Avatar"
                 class="h-10 w-10 rounded-full object-cover border border-gray-300" />
            <span id="profilePreviewName" class="hidden sm:inline font-medium text-gray-700">Teacher</span>
            <i class="fas fa-chevron-down text-gray-400"></i>
          </button>

          <div id="profile-dropdown-menu"
               class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 overflow-hidden transition-all duration-300 origin-top-right transform scale-95 opacity-0">
            <a href="./AI-Essay-Checker.html" class="block px-4 py-2 text-sm hover:bg-gray-100 transition" data-i18n="aiChecker">ğŸ¤– AI Essay Checker</a>
            <a href="./quiz_dashboard.html" class="block px-4 py-2 text-sm hover:bg-gray-100 transition" data-i18n="quizDashboard">ğŸ“ Quiz Dashboard</a>
            <a href="./profile.html" class="block px-4 py-2 text-sm hover:bg-gray-100 transition" data-i18n="yourProfile">ğŸ‘¤ Your Profile</a>
            <a href="./settings.html" class="block px-4 py-2 text-sm hover:bg-gray-100 transition" data-i18n="settings">âš™ï¸ Settings</a>
            <a href="./contact.html" class="block px-4 py-2 text-sm hover:bg-gray-100 transition" data-i18n="contact">ğŸ“© Contact</a>
            <button id="logoutButton" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition" data-i18n="signOut">ğŸšª Sign out</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="flex flex-wrap sm:flex-nowrap justify-around items-center bg-white rounded-xl p-3 shadow-md">
      <a href="./my-students.html" class="flex-1 text-center py-3 px-4 m-1 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-300" data-i18n="myClass">ğŸ‘¨â€ğŸ“ My Class</a>
      <a href="./completed-assignment.html" class="flex-1 text-center py-3 px-4 m-1 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-300" data-i18n="completedTasks">âœ… Completed Tasks</a>
      <a href="./quiz_dashboard.html" class="flex-1 text-center py-3 px-4 m-1 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-300" data-i18n="quizDashboard">ğŸ“ Quiz Dashboard</a>
      <a href="./AI-Essay-Checker.html" class="flex-1 text-center py-3 px-4 m-1 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-300" data-i18n="aiChecker">ğŸ¤– AI Checker</a>
    </nav>

    <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

      <!-- Students Section -->
      <section id="studentsSection" class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-i18n="studentsInClass">
          ğŸ“ Students in Your Class
        </h2>
        <div id="studentsList" class="divide-y divide-gray-200 text-gray-700"></div>
      </section>

      <!-- Assignment Section -->
      <section class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-i18n="createAssignment">
          âœï¸ Create and Send Assignment
        </h2>
        <label for="student-select" class="block text-gray-700 font-bold mb-2" data-i18n="selectStudent">Select Student:</label>
        <div class="border border-gray-300 rounded-lg overflow-hidden mb-4">
          <select id="student-select" class="w-full p-3 bg-white text-gray-800 focus:outline-none"></select>
        </div>

        <label for="assignmentTitle" class="block text-gray-700 font-bold mb-2" data-i18n="assignmentTitle">Assignment Title:</label>
        <input type="text" id="assignmentTitle" maxlength="100"
               class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="e.g., History Essay on World War II" />

        <label for="assignmentDueDate" class="block text-gray-700 font-bold mb-2" data-i18n="dueDate">Due Date:</label>
        <input type="datetime-local" id="assignmentDueDate"
               class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />

        <label for="assignmentText" class="block text-gray-700 font-bold mb-2" data-i18n="assignmentDetails">
          Assignment Details (max 1000 words or attach file):
        </label>
        <textarea id="assignmentText" maxlength="5000"
                  class="w-full min-h-[150px] p-4 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"
                  placeholder="Type your assignment here..."></textarea>
        <p id="wordCountText" class="text-sm text-gray-500 text-right mb-4">Word count: 0</p>

        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
          <label class="custom-file-input cursor-pointer text-base">
            <input type="file" id="assignmentFile" class="custom-file-input" />
          </label>
          <div id="fileStatus" class="flex items-center gap-2">
            <span id="fileName" class="text-gray-700 text-sm italic">No file selected.</span>
            <button id="clearFileButton" class="text-red-500 hover:text-red-700 hidden text-sm font-semibold">Clear</button>
          </div>
        </div>

        <button id="sendAssignmentButton"
                class="w-full py-4 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled data-i18n="sendAssignment">
          Send Assignment
        </button>
      </section>

    
      <section class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-i18n="addPointsTitle">
          â• Add Student Points
        </h2>

        <label for="points-student-select" class="block text-gray-700 font-bold mb-2" data-i18n="selectStudent">Select Student:</label>
        <div class="border border-gray-300 rounded-lg overflow-hidden mb-4">
          <select id="points-student-select" class="w-full p-3 bg-white text-gray-800 focus:outline-none"></select>
        </div>

        <label for="pointsInput" class="block text-gray-700 font-bold mb-2" data-i18n="pointsToAdd">Points to Add:</label>
        <input type="number" id="pointsInput" min="1"
               class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
               placeholder="e.g., 10" />

        <label for="reasonText" class="block text-gray-700 font-bold mb-2" data-i18n="reasonOptional">Reason (Optional):</label>
        <textarea id="reasonText"
                  class="w-full min-h-[80px] p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-y"
                  placeholder="e.g., Great participation in class discussion."></textarea>

        <button id="addPointsButton"
                class="w-full py-4 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                data-i18n="addPointsButton" disabled>
          Add Points
        </button>
      </section>

      <section class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-i18n="sendMessageTitle">
          ğŸ’Œ Send Message to Student
        </h2>

        <label for="message-student-select" class="block text-gray-700 font-bold mb-2" data-i18n="selectStudent">
          Select Student:
        </label>
        <div class="border border-gray-300 rounded-lg overflow-hidden mb-4">
          <select id="message-student-select" class="w-full p-3 bg-white text-gray-800 focus:outline-none">
            <option value="">Select Student</option>
          </select>
        </div>

        <label for="messageText" class="block text-gray-700 font-bold mb-2" data-i18n="messageText">
          Message:
        </label>
        <textarea id="messageText" rows="4"
                  class="w-full p-4 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"
                  placeholder="Type your message here..."></textarea>

        <button id="sendMessageButton"
                class="w-full py-4 bg-purple-600 text-white font-bold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled data-i18n="sendMessage">
          Send Message
        </button>
      </section>

      <section class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-i18n="overdueTasks">
          ğŸ“Œ Overdue Tasks
        </h2>
        <div id="overdueTasksList" class="divide-y divide-gray-200"></div>
      </section>

      <section class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-i18n="assignedTasks">
          ğŸ“ Assigned Tasks & Feedback
        </h2>
        <div id="assignedTasksList" class="divide-y divide-gray-200"></div>
      </section>

      <section class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-i18n="studentFeedback">
          ğŸ’¬ Student Feedback Overview
        </h2>
        <div id="feedbackList" class="divide-y divide-gray-200"></div>
      </section>

      <section class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">ğŸ“… Academic Calendar</h2>
        <input type="text" id="academicYear"
               class="w-full p-3 mb-4 border border-gray-300 rounded-lg"
               placeholder="Academic Year (e.g. 2025/2026)" />

        <div id="termsContainer" class="space-y-4"></div>

        <button id="addTermButton"
                class="w-full py-2 mb-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">
          â• Add Term
        </button>

        <button id="saveCalendarButton"
                class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-300">
          Save Calendar
        </button>

        <p id="calendarMsg" class="text-center font-semibold mt-4 text-gray-700"></p>
      </section>

    </main>

    <footer class="text-center text-sm text-gray-500 py-6 mt-4">
      Â© <span id="currentYear"></span> SmartStudentAct
    </footer>
  </div>

<script src="translate.js"></script>
<script>
const API_BASE_URL = "https://api.smartstudentact.com/api";
let studentsCache = [];
let currentLang = "en";

function showToast(message, type = "info") {
    const container = document.getElementById("toast-container") || (() => {
        const el = document.createElement("div");
        el.id = "toast-container";
        el.className = "fixed top-4 right-4 z-[1000] space-y-2";
        document.body.appendChild(el);
        return el;
    })();
    const colors = {
        success: "bg-green-600",
        error: "bg-red-600",
        info: "bg-blue-600",
        warning: "bg-yellow-500 text-gray-900"
    };
    const toast = document.createElement("div");
    toast.className = `px-4 py-2 rounded text-white shadow ${colors[type] || colors.info}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}


function hideLoadingOverlay() {
    const el = document.getElementById("loadingOverlay");
    if (el) el.style.display = "none";
}

async function fetchAPI(endpoint, options = {}) {
    try {
        const res = await fetch(`${API_BASE_URL}${endpoint}`, {
            ...options,
            credentials: "include",
            headers: { ...(options.headers || {}) }
        });
        if (res.status === 401) {
            window.location.href = "/login.html";
            return null;
        }
        return res;
    } catch (err) {
        console.error("Fetch error:", err);
        showToast("Network error, please try again.", "error");
        return null;
    }
}

async function checkAuth() {
    const res = await fetchAPI("/auth/check");
    if (!res || !res.ok) window.location.href = "/login.html";
}

async function fetchTeacherProfile() {
    const res = await fetchAPI("/teacher/profile");
    if (res && res.ok) {
        const data = await res.json();
        document.getElementById("profilePreviewName").innerText = data.name || "Teacher";
        document.getElementById("profileAvatar").src = data.profile_picture_url || "./images/default-avatar.png";
    }
}

function wireProfilePhotoUpload() {
    const avatarImg = document.getElementById("profileAvatar");
    const uploadInput = document.getElementById("profilePhotoInput");

    if (!avatarImg || !uploadInput) return;

    avatarImg.addEventListener("click", () => uploadInput.click());

    uploadInput.addEventListener("change", async () => {
        const file = uploadInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("profile_picture", file);

        try {
            const res = await fetchAPI("/profile/upload-photo", {
                method: "POST",
                body: formData
            });

            if (res && res.ok) {
                const data = await res.json();
                avatarImg.src = data.profile_picture_url;
                showToast("Profile photo updated!", "success");
            } else {
                showToast("Failed to upload profile photo", "error");
            }
        } catch (err) {
            console.error("Photo upload error:", err);
            showToast("Network error", "error");
        }
    });
}

function renderStudents(students = []) {
    const container = document.getElementById("studentsList");
    if (!container) return;
    if (!students.length) {
        container.innerHTML = `<div class="p-4 text-center text-gray-500">${translateText('no_students')}</div>`;
        return;
    }
    container.innerHTML = students.map(s => `
      <div class="p-4 flex items-center justify-between border-b last:border-b-0 hover:bg-gray-50">
        <div class="flex items-center gap-3">
          <img src="${s.imageUrl || './images/default-avatar.png'}" alt="student avatar" class="h-10 w-10 rounded-full border object-cover"/>
          <div>
            <p class="font-medium text-gray-800">${s.firstname} ${s.lastname}</p>
            <p class="text-sm text-gray-500">${translateText('grade')} ${s.grade || "-"}</p>
          </div>
        </div>
        <span class="text-xs text-gray-400">${s.email}</span>
      </div>
    `).join("");
}

async function fetchStudents() {
    let myGrade = [], otherGrade = [];
    const res = await fetchAPI("/teacher/students");
    if (res && res.ok) myGrade = (await res.json()) || [];
    const resOther = await fetchAPI("/teacher/students/other");
    if (resOther && resOther.ok) otherGrade = (await resOther.json()) || [];
    studentsCache = [...myGrade, ...otherGrade];
    renderStudents(myGrade);
    populateStudentSelects(studentsCache, myGrade, otherGrade);
    populateMessageStudentSelect(studentsCache);
}

function populateStudentSelects(allStudents, myGrade = [], otherGrade = []) {
    const studentSelect = document.getElementById("student-select");
    const toOptions = (list) => list.map(s => `<option value="${s._id || s.id}">${s.firstname} ${s.lastname} (${translateText('grade')} ${s.grade || '-'})</option>`).join("");
    if (!studentSelect) return;
    studentSelect.innerHTML = `
        <optgroup label="${translateText('myClass')}">${toOptions(myGrade)}</optgroup>
        <optgroup label="${translateText('other_students')}">${toOptions(otherGrade)}</optgroup>
    `;
}

async function fetchAssignedTasks() {
    const container = document.getElementById("assignedTasksList");
    if (!container) return;
    container.innerHTML = `<div class="p-4 text-gray-500">${translateText('loading')}...</div>`;

    const res = await fetchAPI("/teacher/assigned-tasks");
    if (res && res.ok) {
        const tasks = await res.json();
        if (!tasks.length) {
            container.innerHTML = `<div class="p-4 text-gray-500">${translateText('no_assigned_tasks')}</div>`;
            return;
        }
        container.innerHTML = tasks.map(a => `
            <div class="p-4 border-b last:border-b-0">
                <p class="font-semibold">${a.title}</p>
                <p class="text-gray-600 text-sm">${a.description || ''}</p>
                <p class="text-gray-500 text-xs">${translateText('due')}: ${a.due_date ? new Date(a.due_date).toLocaleString() : 'N/A'}</p>
            </div>
        `).join("");
    } else {
        container.innerHTML = `<div class="p-4 text-red-600">${translateText('failed_load_tasks')}</div>`;
    }
}

async function fetchFeedback() {
    const container = document.getElementById("feedbackList");
    if (!container) return;
    container.innerHTML = `<div class="p-4 text-gray-500">${translateText('loading')}...</div>`;

    const res = await fetchAPI("/teacher/feedback");
    if (res && res.ok) {
        const feedbacks = await res.json();
        if (!feedbacks.length) {
            container.innerHTML = `<div class="p-4 text-gray-500">${translateText('no_feedback')}</div>`;
            return;
        }
        container.innerHTML = feedbacks.map(f => `
            <div class="p-4 border-b last:border-b-0">
                <p class="font-medium">${f.student_email}</p>
                <p class="text-gray-600 text-sm">${f.message}</p>
                ${f.file_name ? `<p class="text-gray-500 text-xs">File: ${f.file_name}</p>` : ""}
            </div>
        `).join("");
    } else {
        container.innerHTML = `<div class="p-4 text-red-600">${translateText('failed_load_feedback')}</div>`;
    }
}

async function fetchOverdueTasks() {
    const container = document.getElementById("overdueTasksList");
    if (!container) return;
    container.innerHTML = `<div class="p-4 text-gray-500">${translateText('loading')}...</div>`;

    const res = await fetchAPI("/teacher/overdue-tasks");
    if (res && res.ok) {
        const tasks = await res.json();
        if (!tasks.length) {
            container.innerHTML = `<div class="p-4 text-gray-500">${translateText('no_overdue_tasks')}</div>`;
            return;
        }
        container.innerHTML = tasks.map(t => `
            <div class="p-4 border-b last:border-b-0">
                <p class="font-semibold">${t.title}</p>
                <p class="text-gray-500 text-xs">${translateText('due')}: ${new Date(t.due_date).toLocaleString()}</p>
            </div>
        `).join("");
    } else {
        container.innerHTML = `<div class="p-4 text-red-600">${translateText('failed_load_overdue')}</div>`;
    }
}

function wireCalendar() {
    const addTermBtn = document.getElementById("addTermButton");
    const saveCalendarBtn = document.getElementById("saveCalendarButton");
    const termsContainer = document.getElementById("termsContainer");

    addTermBtn?.addEventListener("click", () => {
        const termDiv = document.createElement("div");
        termDiv.className = "flex gap-2 mb-2";
        termDiv.innerHTML = `
            <input type="text" placeholder="Term Name" class="w-1/2 p-2 border rounded"/>
            <input type="date" class="w-1/2 p-2 border rounded"/>
            <button class="remove-term px-2 bg-red-500 text-white rounded">âŒ</button>
        `;
        termsContainer.appendChild(termDiv);
        termDiv.querySelector(".remove-term").addEventListener("click", () => termDiv.remove());
    });

    saveCalendarBtn?.addEventListener("click", async () => {
        const academicYear = document.getElementById("academicYear").value.trim();
        if (!academicYear) return showToast(translateText("enter_academic_year"), "error");

        const terms = Array.from(termsContainer.children).map(div => {
            const name = div.querySelector("input[type=text]").value.trim();
            const date = div.querySelector("input[type=date]").value;
            return { name, date };
        }).filter(t => t.name && t.date);

        try {
            const res = await fetchAPI("/teacher/calendar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ academicYear, terms })
            });
            if (res && res.ok) showToast(translateText("calendar_saved"), "success");
            else showToast(translateText("failed_save_calendar"), "error");
        } catch (err) {
            console.error("Calendar save error:", err);
            showToast(translateText("network_error"), "error");
        }
    });
}

function wireMessageForm() {
    const studentSelect = document.getElementById("message-student-select");
    const messageText = document.getElementById("messageText");
    const sendBtn = document.getElementById("sendMessageButton");

    if (!studentSelect || !messageText || !sendBtn) return;

    function validateMessageForm() {
        sendBtn.disabled = !(studentSelect.value && messageText.value.trim());
    }

    studentSelect.addEventListener("change", validateMessageForm);
    messageText.addEventListener("input", validateMessageForm);

    sendBtn.addEventListener("click", async () => {
        const toEmail = studentSelect.options[studentSelect.selectedIndex]?.dataset.email;
        const text = messageText.value.trim();

        if (!toEmail || !text) {
            showToast(translateText('fill_message_fields'), "error");
            return;
        }

        sendBtn.disabled = true;
        sendBtn.textContent = translateText('sending');

        try {
            const res = await fetchAPI("/teacher/message", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ to: toEmail, text })
            });

            if (res && res.ok) {
                showToast(translateText('message_sent'), "success");
                messageText.value = "";
                studentSelect.value = "";
                validateMessageForm();
            } else {
                const data = await res.json();
                showToast(data?.message || translateText('failed_send_message'), "error");
            }
        } catch (err) {
            console.error("Send message error:", err);
            showToast(translateText('network_error'), "error");
        } finally {
            sendBtn.disabled = false;
            sendBtn.textContent = translateText('sendMessage');
        }
    });
}

function populateMessageStudentSelect(students = []) {
    const select = document.getElementById("message-student-select");
    if (!select) return;
    select.innerHTML = `<option value="">${translateText('select_student')}</option>` +
        students.map(s => `<option value="${s._id}" data-email="${s.email}">${s.firstname} ${s.lastname} (${translateText('grade')} ${s.grade || '-'})</option>`).join("");
}


function translateText(key) {
    if (typeof translations !== "undefined" && translations[key] && translations[key][currentLang]) {
        return translations[key][currentLang];
    }
    return key;
}

function wireAssignmentForm() {
    const studentSelect = document.getElementById("student-select");
    const titleInput = document.getElementById("assignmentTitle");
    const dueDateInput = document.getElementById("assignmentDueDate");
    const textArea = document.getElementById("assignmentText");
    const fileInput = document.getElementById("assignmentFile");
    const sendBtn = document.getElementById("sendAssignmentButton");
    const wordCountText = document.getElementById("wordCountText");
    const fileNameSpan = document.getElementById("fileName");
    const clearFileBtn = document.getElementById("clearFileButton");

    if (!studentSelect || !titleInput || !dueDateInput || !textArea || !sendBtn) return;

    function updateSendBtn() {
        sendBtn.disabled = !(studentSelect.value && titleInput.value.trim() && (textArea.value.trim() || fileInput.files.length));
    }

    function updateWordCount() {
        const words = textArea.value.trim().split(/\s+/).filter(Boolean).length;
        wordCountText.textContent = `Word count: ${words}`;
        updateSendBtn();
    }

    textArea.addEventListener("input", updateWordCount);
    titleInput.addEventListener("input", updateSendBtn);
    studentSelect.addEventListener("change", updateSendBtn);

    fileInput.addEventListener("change", () => {
        if (fileInput.files.length) {
            fileNameSpan.textContent = fileInput.files[0].name;
            clearFileBtn.classList.remove("hidden");
        } else {
            fileNameSpan.textContent = "No file selected.";
            clearFileBtn.classList.add("hidden");
        }
        updateSendBtn();
    });

    clearFileBtn.addEventListener("click", () => {
        fileInput.value = "";
        fileNameSpan.textContent = "No file selected.";
        clearFileBtn.classList.add("hidden");
        updateSendBtn();
    });

    sendBtn.addEventListener("click", async () => {
        const studentId = studentSelect.value;
        const title = titleInput.value.trim();
        const dueDate = dueDateInput.value;
        const text = textArea.value.trim();
        const file = fileInput.files[0];

        if (!studentId || !title || (!text && !file)) {
            showToast("Please fill in all required fields", "error");
            return;
        }

        sendBtn.disabled = true;
        sendBtn.textContent = "Sending...";

        try {
            const formData = new FormData();
            formData.append("studentId", studentId);
            formData.append("title", title);
            formData.append("dueDate", dueDate);
            formData.append("text", text);
            if (file) formData.append("file", file);

            const res = await fetchAPI("/teacher/assignment", {
                method: "POST",
                body: formData
            });

            if (res && res.ok) {
                showToast("Assignment sent successfully", "success");
                titleInput.value = "";
                dueDateInput.value = "";
                textArea.value = "";
                fileInput.value = "";
                fileNameSpan.textContent = "No file selected.";
                clearFileBtn.classList.add("hidden");
                updateWordCount();
            } else {
                const data = await res.json();
                showToast(data?.message || "Failed to send assignment", "error");
            }
        } catch (err) {
            console.error("Assignment send error:", err);
            showToast("Network error", "error");
        } finally {
            sendBtn.disabled = false;
            sendBtn.textContent = "Send Assignment";
        }
    });

    updateWordCount();
}

function wirePointsForm() {
    const studentSelect = document.getElementById("points-student-select");
    const pointsInput = document.getElementById("pointsInput");
    const reasonText = document.getElementById("reasonText");
    const addBtn = document.getElementById("addPointsButton");

    if (!studentSelect || !pointsInput || !addBtn) return;

    function validateForm() {
        addBtn.disabled = !(studentSelect.value && parseInt(pointsInput.value) > 0);
    }

    studentSelect.addEventListener("change", validateForm);
    pointsInput.addEventListener("input", validateForm);

    addBtn.addEventListener("click", async () => {
        const studentId = studentSelect.value;
        const points = parseInt(pointsInput.value);
        const reason = reasonText.value.trim();

        if (!studentId || !points || points <= 0) {
            showToast(translateText("fill_points_fields") || "Please select a student and enter valid points.", "error");
            return;
        }

        addBtn.disabled = true;
        addBtn.textContent = translateText("adding_points") || "Adding...";

        try {
            const res = await fetchAPI("/rewards/teacher/add-points", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ studentId, points, reason })
            });

            if (res && res.ok) {
                showToast(translateText("points_added") || "Points added successfully!", "success");
                pointsInput.value = "";
                reasonText.value = "";
                studentSelect.value = "";
                validateForm();
            } else {
                const data = await res.json();
                showToast(data?.message || translateText("failed_add_points") || "Failed to add points.", "error");
            }
        } catch (err) {
            console.error("Add points error:", err);
            showToast(translateText("network_error") || "Network error, please try again.", "error");
        } finally {
            addBtn.disabled = false;
            addBtn.textContent = translateText("addPointsButton") || "Add Points";
        }
    });

    validateForm();
}


async function init() {
    try {
        await checkAuth();
        await translatePage("teachers", currentLang);

        document.getElementById("language-select").addEventListener("change", async (e) => {
            currentLang = e.target.value;
            await translatePage("teachers", currentLang);
            populateStudentSelects(studentsCache);
            populateMessageStudentSelect(studentsCache);
        });

        await Promise.all([
            fetchTeacherProfile(),
            fetchStudents(),
            fetchAssignedTasks(),
            fetchFeedback(),
            fetchOverdueTasks()
        ]);

        wireAssignmentForm();
        wirePointsForm();
        wireCalendar();
        wireMessageForm();
        wireProfilePhotoUpload();
    } catch (err) {
        console.error("Init error:", err);
        showToast(translateText('dashboard_load_error'), "error");
    } finally {
        hideLoadingOverlay();
    }
}

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("currentYear").textContent = new Date().getFullYear();

    const btn = document.getElementById("profile-menu-button");
    const menu = document.getElementById("profile-dropdown-menu");

    if (btn && menu) {
        btn.addEventListener("click", (e) => {
            e.stopPropagation();
            menu.classList.toggle("hidden");
            menu.classList.toggle("opacity-0");
            menu.classList.toggle("scale-95");
        });

        document.addEventListener("click", (e) => {
            if (!btn.contains(e.target) && !menu.contains(e.target)) {
                menu.classList.add("hidden", "opacity-0", "scale-95");
            }
        });
    }

    document.getElementById("logoutButton").addEventListener("click", async () => {
        await fetchAPI("/users/logout", { method: "POST" });
        window.location.href = "/login.html";
    });

    init();
});
</script>
</body>
</html>


