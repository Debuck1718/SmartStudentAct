<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="dashboardTitle">Teacher Dashboard</title>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-EWMR745QHX"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-EWMR745QHX");
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./images/icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./images/icon.png"
    />
    <link rel="manifest" href="/site.webmanifest" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

      body {
        font-family: "Inter", sans-serif;
      }

      #messageModal,
      #promptModal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background-color: #fefefe;
        padding: 24px;
        border-radius: 12px;
        border: 1px solid #888;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      .close-button:hover,
      .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
      .prompt-input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      .prompt-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .custom-file-input::-webkit-file-upload-button {
        visibility: hidden;
      }
      .custom-file-input::before {
        content: "üìé Pick Document/File";
        display: inline-block;
        background-color: #1abc9c;
        color: #fff;
        font-weight: bold;
        font-size: 16px;
        padding: 12px;
        border-radius: 8px;
        outline: none;
        white-space: nowrap;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .custom-file-input:hover::before {
        background-color: #16a085;
      }
      .custom-file-input:active::before {
        background-color: #1abc9c;
        box-shadow: none;
      }

      /* Custom loading spinner */
      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid #fff;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Profile Dropdown Custom Styling */
      .dropdown-menu {
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        transform: translateY(-5px);
      }

      .dropdown-menu.visible {
        opacity: 1;
        transform: translateY(0);
      }
    </style>
  </head>
  <body class="bg-slate-100 min-h-screen">
    <div
      id="loadingOverlay"
      class="fixed inset-0 flex items-center justify-center bg-gray-200 bg-opacity-75 z-[999]"
    >
      <div class="text-center p-6 bg-white rounded-xl shadow-lg">
        <div
          class="spinner mx-auto mb-4 border-blue-500 border-t-blue-500"
        ></div>
        <p class="text-lg text-gray-700 font-medium" data-i18n="loadingMessage">
          Loading teacher dashboard...
        </p>
      </div>
    </div>

    <div id="messageModal" class="flex">
      <div class="modal-content">
        <span class="close-button" onclick="closeMessageModal()">&times;</span>
        <h2 id="modalTitle" class="text-xl font-bold mb-2 text-gray-800"></h2>
        <p id="modalMessage" class="text-gray-700"></p>
        <div class="flex justify-end mt-4">
          <button
            onclick="closeMessageModal()"
            class="px-4 py-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors"
            data-i18n="ok"
          >
            OK
          </button>
        </div>
      </div>
    </div>

    <div id="promptModal" class="flex">
      <div class="modal-content">
        <h2 id="promptTitle" class="text-xl font-bold mb-2 text-gray-800"></h2>
        <p id="promptMessage" class="text-gray-700 mb-4"></p>
        <textarea
          id="promptInput"
          class="w-full h-32 p-3 mb-4 border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
          data-i18n-placeholder="promptTextPlaceholder"
          placeholder="Type your message here..."
        ></textarea>
        <div class="prompt-buttons">
          <button
            id="cancelPromptBtn"
            class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors"
            data-i18n="cancel"
          >
            Cancel
          </button>
          <button
            id="okPromptBtn"
            class="px-4 py-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors"
            data-i18n="send"
          >
            Send
          </button>
        </div>
      </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 space-y-6">
      <header
        class="flex flex-col sm:flex-row justify-between items-center py-4 border-b border-gray-200"
      >
        <h1
          class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0"
          data-i18n="dashboardTitle"
        >
          üìö Teacher Dashboard
        </h1>

        <div class="relative inline-block text-left mr-4">
          <button
            type="button"
            class="flex items-center space-x-2 rounded-full px-4 py-2 hover:bg-gray-200 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            id="language-menu-button"
          >
            <span class="font-medium text-gray-700">Language</span>
            <svg
              class="h-5 w-5 text-gray-400"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
          <div
            id="language-dropdown-menu"
            class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none dropdown-menu opacity-0"
          >
            <div class="py-1" role="none">
              <a
                href="#"
                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                data-lang="en"
                >English</a
              >
              <a
                href="#"
                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                data-lang="fr"
                >Fran√ßais</a
              >
              <a
                href="#"
                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                data-lang="es"
                >Espa√±ol</a
              >
              <a
                href="#"
                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                data-lang="tr"
                >T√ºrk√ße</a
              >
              <a
                href="#"
                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                data-lang="ar"
                >ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</a
              >
              <a
                href="#"
                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                data-lang="ru"
                >–†—É—Å—Å–∫–∏–π</a
              >
            </div>
          </div>
        </div>

        <div class="relative inline-block text-left">
          <button
            id="profile-menu-button"
            type="button"
            class="flex items-center space-x-2 rounded-full px-4 py-2 hover:bg-gray-200 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            <span
              class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-blue-500"
            >
              <span id="profileInitials" class="font-medium text-lg text-white"
                >TS</span
              >
            </span>
            <span
              id="profileName"
              class="font-medium text-gray-700 hidden sm:inline"
              >Teacher</span
            >
            <svg
              class="h-5 w-5 text-gray-400"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                clip-rule="evenodd"
              />
            </svg>
          </button>

          <div
            id="profile-dropdown-menu"
            class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none dropdown-menu opacity-0"
            role="menu"
            aria-orientation="vertical"
            aria-labelledby="profile-menu-button"
          >
            <div class="py-1" role="none">
              <a
                href="/AI-Essay-Checker.html"
                class="block py-4 text-lg text-gray-700 font-medium border-b border-gray-100 hover:bg-gray-50 transition-colors px-4"
                data-i18n="aiEssayChecker"
              >
                ü§ñ AI Essay Checker
              </a>
              <a
                href="/public/quiz_dashboard.html"
                ...
                data-i18n="quizDashboard"
              >
                üìù Quiz Dashboard
              </a>
              <a
                href="/public/profile.html"
                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                role="menuitem"
                data-i18n="yourProfile"
              >
                Your Profile
              </a>
              <a
                href="/public/settings.html"
                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                role="menuitem"
                data-i18n="settings"
              >
                Settings
              </a>
              <hr class="my-1 border-gray-100" role="none" />
              <button
                id="logoutButton"
                class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                role="menuitem"
                data-i18n="signOut"
              >
                üö™ Sign out
              </button>
            </div>
          </div>
        </div>
      </header>

      <nav
        class="flex flex-wrap sm:flex-nowrap justify-around items-center bg-gray-200 rounded-xl p-3 shadow-md"
      >
        <a
          href="/public/my-students.html"
          class="flex-1 text-center py-2 px-3 m-1 bg-blue-500 text-white font-bold rounded-lg shadow-sm hover:bg-blue-600 transition-colors"
          data-i18n="myClass"
        >
          üë®‚Äçüéì My Class
        </a>
        <a
          href="/public/completed-assignment.html"
          class="flex-1 text-center py-2 px-3 m-1 bg-blue-500 text-white font-bold rounded-lg shadow-sm hover:bg-blue-600 transition-colors"
          data-i18n="completedTasks"
        >
          ‚úÖ Completed Tasks
        </a>
        <a
          href="/public/quiz_dashboard.html"
          class="flex-1 text-center py-2 px-3 m-1 bg-purple-600 text-white font-bold rounded-lg shadow-sm hover:bg-purple-700 transition-colors"
          data-i18n="quizDashboard"
        >
          üìù Quiz Dashboard
        </a>
        <a
          href="/public/AI Essay Checker.html"
          class="flex-1 text-center py-2 px-3 m-1 bg-blue-500 text-white font-bold rounded-lg shadow-sm hover:bg-blue-600 transition-colors"
          data-i18n="aiChecker"
        >
          ü§ñ AI Checker
        </a>
      </nav>

      <section id="studentsSection" class="bg-white rounded-xl p-6 shadow-lg">
        <h2
          class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2"
          data-i18n="studentsInClass"
        >
          üéì Students in Your Class
        </h2>
        <div id="studentsList" class="divide-y divide-gray-200"></div>
      </section>

      <section class="bg-white rounded-xl p-6 shadow-lg">
        <h2
          class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2"
          data-i18n="createAssignment"
        >
          ‚úèÔ∏è Create and Send Assignment
        </h2>

        <label
          for="student-select"
          class="block text-gray-700 font-bold mb-2"
          data-i18n="selectStudent"
          >Select Student:</label
        >
        <div
          id="studentSelectContainer"
          class="border border-gray-300 rounded-lg overflow-hidden mb-4"
        >
          <select
            id="student-select"
            class="w-full p-3 bg-white text-gray-800 focus:outline-none"
          ></select>
        </div>

        <label
          for="assignmentTitle"
          class="block text-gray-700 font-bold mb-2"
          data-i18n="assignmentTitle"
          >Assignment Title:</label
        >
        <input
          type="text"
          id="assignmentTitle"
          class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
          data-i18n-placeholder="assignmentPlaceholder"
          placeholder="e.g., History Essay on World War II"
          maxlength="100"
        />

        <label
          for="assignmentDueDate"
          class="block text-gray-700 font-bold mb-2"
          data-i18n="dueDate"
          >Due Date:</label
        >
        <input
          type="datetime-local"
          id="assignmentDueDate"
          class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500"
        />

        <label
          for="assignmentText"
          class="block text-gray-700 font-bold mb-2"
          data-i18n="assignmentDetails"
          >Assignment Details (max 1000 words or attach file):</label
        >
        <textarea
          id="assignmentText"
          class="w-full min-h-[150px] p-4 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"
          data-i18n-placeholder="assignmentTextPlaceholder"
          placeholder="Type your assignment here..."
          maxlength="5000"
        ></textarea>
        <p
          id="wordCountText"
          class="text-sm text-gray-500 text-right mb-4"
          data-i18n="wordCount"
        >
          Word count: 0
        </p>

        <div
          class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4"
        >
          <label
            for="assignmentFile"
            class="custom-file-input cursor-pointer text-base"
            data-i18n="pickDocument"
          >
            <input type="file" id="assignmentFile" class="hidden" />
          </label>
          <div id="fileStatus" class="flex items-center gap-2">
            <span
              id="fileName"
              class="text-gray-700 text-sm italic"
              data-i18n="noFileSelected"
              >No file selected.</span
            >
            <button
              id="clearFileButton"
              class="text-red-500 hover:text-red-700 hidden text-sm font-semibold"
              data-i18n="clear"
            >
              Clear
            </button>
          </div>
        </div>

        <button
          id="sendAssignmentButton"
          class="w-full py-4 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-colors transform hover:scale-105"
          disabled
          data-i18n="sendAssignment"
        >
          Send Assignment
        </button>
      </section>

      <section class="bg-white rounded-xl p-6 shadow-lg">
        <h2
          class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2"
          data-i18n="addPointsTitle"
        >
          ‚ûï Add Student Points
        </h2>

        <label
          for="points-student-select"
          class="block text-gray-700 font-bold mb-2"
          data-i18n="selectStudent"
          >Select Student:</label
        >
        <div class="border border-gray-300 rounded-lg overflow-hidden mb-4">
          <select
            id="points-student-select"
            class="w-full p-3 bg-white text-gray-800 focus:outline-none"
          ></select>
        </div>

        <label
          for="pointsInput"
          class="block text-gray-700 font-bold mb-2"
          data-i18n="pointsToAdd"
          >Points to Add:</label
        >
        <input
          type="number"
          id="pointsInput"
          class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
          data-i18n-placeholder="pointsPlaceholder"
          placeholder="e.g., 10"
          min="1"
        />

        <label
          for="reasonText"
          class="block text-gray-700 font-bold mb-2"
          data-i18n="reasonOptional"
          >Reason (Optional):</label
        >
        <textarea
          id="reasonText"
          class="w-full min-h-[80px] p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-y"
          data-i18n-placeholder="reasonPlaceholder"
          placeholder="e.g., Great participation in class discussion."
        ></textarea>

        <button
          id="addPointsButton"
          class="w-full py-4 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-colors transform hover:scale-105"
          data-i18n="addPointsButton"
        >
          Add Points
        </button>
      </section>

      <section class="bg-white rounded-xl p-6 shadow-lg">
        <h2
          class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2"
          data-i18n="overdueTasks"
        >
          üìå Overdue Tasks
        </h2>
        <div id="overdueTasksList" class="divide-y divide-gray-200"></div>
      </section>

      <section class="bg-white rounded-xl p-6 shadow-lg">
        <h2
          class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2"
          data-i18n="assignedTasks"
        >
          üìù Assigned Tasks & Feedback
        </h2>
        <div id="assignedTasksList" class="divide-y divide-gray-200"></div>
      </section>

      <section class="bg-white rounded-xl p-6 shadow-lg">
        <h2
          class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2"
          data-i18n="studentFeedback"
        >
          üí¨ Student Feedback Overview
        </h2>
        <div id="feedbackList" class="divide-y divide-gray-200"></div>
      </section>

      <section class="bg-white rounded-xl p-6 shadow-lg">
        <h2
          class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2"
          data-i18n="academicCalendar"
        >
          üìÖ Academic Calendar
        </h2>
        <input
          type="date"
          id="termStart"
          class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
          data-i18n-placeholder="termStart"
          placeholder="Start of Term (YYYY-MM-DD)"
        />
        <input
          type="date"
          id="termEnd"
          class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
          data-i18n-placeholder="termEnd"
          placeholder="End of Term (YYYY-MM-DD)"
        />
        <button
          id="saveCalendarButton"
          class="w-full py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-colors transform hover:scale-105"
          data-i18n="saveCalendar"
        >
          Save Calendar
        </button>
        <p
          id="calendarMsg"
          class="text-center font-semibold mt-4 text-gray-700"
        ></p>
      </section>

      <div
        id="contactModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center"
      >
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
          <h2 class="text-xl font-bold mb-4" data-i18n="contactUs">
            üì© Contact Us
          </h2>
          <form id="contactForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium" data-i18n="yourName"
                >Your Name</label
              >
              <input
                type="text"
                id="contactName"
                required
                class="w-full border rounded p-2"
              />
            </div>
            <div>
              <label class="block text-sm font-medium" data-i18n="yourEmail"
                >Your Email</label
              >
              <input
                type="email"
                id="contactEmail"
                required
                class="w-full border rounded p-2"
              />
            </div>
            <div>
              <label class="block text-sm font-medium" data-i18n="message"
                >Message</label
              >
              <textarea
                id="contactMessage"
                rows="4"
                required
                class="w-full border rounded p-2"
              ></textarea>
            </div>
            <div class="flex justify-end gap-2">
              <button
                type="button"
                id="closeContact"
                class="bg-gray-200 px-4 py-2 rounded"
                data-i18n="cancel"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="bg-blue-600 text-white px-4 py-2 rounded"
                data-i18n="send"
              >
                Send
              </button>
            </div>
          </form>
        </div>
      </div>

      <footer class="text-center text-sm text-gray-500 py-6 mt-4">
        <p data-i18n="copyright">
          ¬© <span id="currentYear"></span> SmartStudentAct
        </p>
      </footer>
    </div>

    <script src="translate.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const defaultLang = "en";
        translatePage("teacher-dashboard", defaultLang);
        document
          .getElementById("language-menu-button")
          .addEventListener("click", () => {
            const dropdown = document.getElementById("language-dropdown-menu");
            dropdown.classList.toggle("hidden");
            setTimeout(() => dropdown.classList.toggle("opacity-0"), 10);
          });

        document
          .querySelectorAll("#language-dropdown-menu a[data-lang]")
          .forEach((link) => {
            link.addEventListener("click", (e) => {
              e.preventDefault();
              const lang = e.target.getAttribute("data-lang");
              translatePage("teacher-dashboard", lang);
              document
                .getElementById("language-dropdown-menu")
                .classList.add("hidden", "opacity-0");
            });
          });
      });
    </script>

    <script>
      let students = [];
      let overdueTasks = [];
      let assignedTasks = [];
      let feedbackList = [];
      let selectedAssignmentFile = null;
      let isDropdownVisible = false;

      const DOM = {
        loadingOverlay: document.getElementById("loadingOverlay"),
        studentsList: document.getElementById("studentsList"),
        overdueTasksList: document.getElementById("overdueTasksList"),
        assignedTasksList: document.getElementById("assignedTasksList"),
        feedbackList: document.getElementById("feedbackList"),
        studentSelect: document.getElementById("student-select"),
        assignmentTitle: document.getElementById("assignmentTitle"),
        assignmentDueDate: document.getElementById("assignmentDueDate"),
        assignmentText: document.getElementById("assignmentText"),
        wordCountText: document.getElementById("wordCountText"),
        assignmentFile: document.getElementById("assignmentFile"),
        fileName: document.getElementById("fileName"),
        clearFileButton: document.getElementById("clearFileButton"),
        sendAssignmentButton: document.getElementById("sendAssignmentButton"),
        termStart: document.getElementById("termStart"),
        termEnd: document.getElementById("termEnd"),
        saveCalendarButton: document.getElementById("saveCalendarButton"),
        calendarMsg: document.getElementById("calendarMsg"),

        profileMenuButton: document.getElementById("profile-menu-button"),
        profileDropdownMenu: document.getElementById("profile-dropdown-menu"),
        logoutButton: document.getElementById("logoutButton"),

        messageModal: document.getElementById("messageModal"),
        modalTitle: document.getElementById("modalTitle"),
        modalMessage: document.getElementById("modalMessage"),
        promptModal: document.getElementById("promptModal"),
        promptTitle: document.getElementById("promptTitle"),
        promptMessage: document.getElementById("promptMessage"),
        promptInput: document.getElementById("promptInput"),
        okPromptBtn: document.getElementById("okPromptBtn"),
        cancelPromptBtn: document.getElementById("cancelPromptBtn"),

        pointsStudentSelect: document.getElementById("points-student-select"),
        pointsInput: document.getElementById("pointsInput"),
        reasonText: document.getElementById("reasonText"),
        addPointsButton: document.getElementById("addPointsButton"),
      };

      const API_BASE = "https://smartstudentact.onrender.com/api";

      const sanitizeInput = (str) => {
        if (typeof str !== "string") return "";
        const temp = document.createElement("div");
        temp.textContent = str;
        return temp.innerHTML;
      };

      const showMessageModal = (title, message) => {
        DOM.modalTitle.textContent = title;
        DOM.modalMessage.textContent = message;
        DOM.messageModal.style.display = "flex";
      };

      const closeMessageModal = () => {
        DOM.messageModal.style.display = "none";
      };

      const toast = (msg) => showMessageModal("Notice", msg);

      const fetchAPI = async (url, options = {}) => {
        try {
          const res = await fetch(`${API_BASE}${url}`, {
            credentials: "include",
            ...options,
          });
          if (!res.ok) {
            const errData = await res
              .json()
              .catch(() => ({ message: "Unknown error" }));
            throw new Error(errData.message || `API Error: ${res.status}`);
          }
          return res;
        } catch (err) {
          console.error(`Fetch API Error for ${url}:`, err);
          showMessageModal(
            "Network Error",
            `Could not connect to server. ${err.message}`
          );
          throw err;
        }
      };

      const getWordCount = (text) =>
        text
          .trim()
          .split(/\s+/)
          .filter((w) => w.length > 0).length;

      const renderList = (container, items, renderItem, emptyMessage) => {
        container.innerHTML = "";
        if (!items.length) {
          container.innerHTML = `<p class="text-center italic text-gray-500 py-4">${emptyMessage}</p>`;
          return;
        }
        const fragment = document.createDocumentFragment();
        items.forEach((item) => {
          const wrapper = document.createElement("div");
          wrapper.innerHTML = renderItem(item);
          fragment.appendChild(wrapper);
        });
        container.appendChild(fragment);
      };

      const init = async () => {
        DOM.loadingOverlay.style.display = "flex";
        try {
          await Promise.all([
            fetchUserData(),
            fetchStudents(),
            fetchOverdueTasks(),
            fetchAssignedTasks(),
            fetchFeedback(),
          ]);
          toggleSendAssignmentButtonState();
          document.getElementById("currentYear").textContent =
            new Date().getFullYear();
        } catch (err) {
          console.error("Initialization failed:", err);
        } finally {
          DOM.loadingOverlay.style.display = "none";
        }
      };

      const fetchUserData = async () => {
        try {
          const res = await fetchAPI("/teacher/profile");
          const data = await res.json();
          const initialsEl = document.getElementById("profileInitials");
          const nameEl = document.getElementById("profileName");
          if (data.firstname && data.lastname) {
            initialsEl.textContent =
              `${data.firstname[0]}${data.lastname[0]}`.toUpperCase();
            nameEl.textContent = `${data.firstname} ${data.lastname}`;
          } else {
            initialsEl.textContent = "T";
            nameEl.textContent = "Teacher";
          }
        } catch (err) {
          console.error("Error fetching profile:", err);
        }
      };

      const toggleProfileDropdown = () => {
        isDropdownVisible = !isDropdownVisible;
        DOM.profileDropdownMenu.classList.toggle(
          "opacity-0",
          !isDropdownVisible
        );
        DOM.profileDropdownMenu.classList.toggle(
          "invisible",
          !isDropdownVisible
        );
      };

      const logout = async () => {
        try {
          await fetchAPI("/auth/logout", { method: "POST" });
          window.location.href = "/login";
        } catch (err) {
          console.error("Logout failed:", err);
        }
      };

      window.addEventListener("click", (e) => {
        if (
          !DOM.profileMenuButton.contains(e.target) &&
          !DOM.profileDropdownMenu.contains(e.target) &&
          isDropdownVisible
        ) {
          toggleProfileDropdown();
        }
      });

      const fetchStudents = async () => {
        try {
          const res = await fetchAPI("/teacher/students");
          students = await res.json();
          renderStudents();
        } catch {
          renderList(
            DOM.studentsList,
            [],
            () => "",
            "Could not load student list."
          );
        }
      };

      const renderStudents = () => {
        renderList(
          DOM.studentsList,
          students,
          (s) => `
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4">
          <span class="flex-1 text-gray-800 font-medium mb-2 sm:mb-0">
            ${sanitizeInput(s.firstname)} ${sanitizeInput(
            s.lastname
          )} (Grade ${sanitizeInput(s.grade)})
          </span>
          <button onclick="handleAssignClick('${sanitizeInput(
            s.email
          )}')" class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm font-semibold hover:bg-blue-600">
            Assign
          </button>
        </div>
      `,
          "No students found in your class."
        );
        const optionsHtml = students
          .map(
            (s) =>
              `<option value="${sanitizeInput(s.email)}">${sanitizeInput(
                s.firstname
              )} ${sanitizeInput(s.lastname)} (${sanitizeInput(
                s.email
              )})</option>`
          )
          .join("");
        DOM.studentSelect.innerHTML = optionsHtml;
        DOM.pointsStudentSelect.innerHTML = optionsHtml;
      };

      const handleAssignClick = (email) => {
        toast(`Preparing assignment for ${email}.`);
        DOM.studentSelect.value = email;
      };

      const toggleSendAssignmentButtonState = () => {
        const isFormValid =
          DOM.studentSelect.value &&
          DOM.assignmentTitle.value.trim() &&
          DOM.assignmentDueDate.value &&
          (getWordCount(DOM.assignmentText.value) > 0 ||
            selectedAssignmentFile);
        DOM.sendAssignmentButton.disabled = !isFormValid;
        DOM.sendAssignmentButton.classList.toggle("opacity-50", !isFormValid);
        DOM.sendAssignmentButton.classList.toggle(
          "cursor-not-allowed",
          !isFormValid
        );
      };

      const handleSendAssignment = async () => {
        DOM.sendAssignmentButton.disabled = true;
        try {
          const formData = new FormData();
          formData.append("studentEmail", DOM.studentSelect.value);
          formData.append("title", DOM.assignmentTitle.value.trim());
          formData.append("due_datetime", DOM.assignmentDueDate.value);
          if (DOM.assignmentText.value.trim())
            formData.append("description", DOM.assignmentText.value.trim());
          if (selectedAssignmentFile)
            formData.append("assignmentFile", selectedAssignmentFile);

          const res = await fetchAPI("/teacher/assignments", {
            method: "POST",
            body: formData,
          });
          const result = await res.json();
          toast(result.message);

          DOM.assignmentTitle.value = "";
          DOM.assignmentDueDate.value = "";
          DOM.assignmentText.value = "";
          DOM.assignmentFile.value = "";
          selectedAssignmentFile = null;
          DOM.fileName.textContent = "No file selected.";
          DOM.clearFileButton.classList.add("hidden");
          toggleSendAssignmentButtonState();
        } catch (err) {
          console.error("Send assignment failed:", err);
        } finally {
          DOM.sendAssignmentButton.disabled = false;
        }
      };

      const handleSubmitFeedback = async (e) => {
        e.preventDefault();
        const form = e.target;
        const taskId = form.taskId.value;
        const grade = form.grade.value;
        const comments = form.comments.value;
        const feedbackFile = form.feedbackFile.files[0];

        if (!grade)
          return showMessageModal(
            "Validation Error",
            "Please provide a grade."
          );

        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;

        const formData = new FormData();
        formData.append("taskId", taskId);
        formData.append("grade", grade);
        formData.append("comments", comments);
        if (feedbackFile) formData.append("feedbackFile", feedbackFile);

        try {
          const res = await fetchAPI("/teacher/feedback", {
            method: "POST",
            body: formData,
          });
          const result = await res.json();
          showMessageModal("Feedback Sent", result.message);
          await Promise.all([fetchAssignedTasks(), fetchFeedback()]);
        } catch (err) {
          console.error("Submit feedback failed:", err);
        } finally {
          submitButton.disabled = false;
        }
      };

      // =========================
      // --- Points ---
      // =========================
      const handleAddPoints = async () => {
        const studentEmail = DOM.pointsStudentSelect.value;
        const points = DOM.pointsInput.value;
        const reason = DOM.reasonText.value.trim();
        if (!studentEmail || !points || points <= 0) {
          return showMessageModal(
            "Validation Error",
            "Please select a student and enter a valid number of points."
          );
        }

        DOM.addPointsButton.disabled = true;
        try {
          const res = await fetchAPI("/teacher/points", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              studentEmail,
              points: parseInt(points, 10),
              reason,
            }),
          });
          const result = await res.json();
          showMessageModal("Success", result.message);
          DOM.pointsInput.value = "";
          DOM.reasonText.value = "";
        } catch (err) {
          console.error("Add points failed:", err);
        } finally {
          DOM.addPointsButton.disabled = false;
        }
      };

      const handleSaveCalendar = async () => {
        const termStart = DOM.termStart.value;
        const termEnd = DOM.termEnd.value;
        if (!termStart || !termEnd)
          return showMessageModal(
            "Validation Error",
            "Please select both term start and end dates."
          );

        DOM.saveCalendarButton.disabled = true;
        try {
          const res = await fetchAPI("/teacher/calendar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ termStart, termEnd }),
          });
          const result = await res.json();
          DOM.calendarMsg.textContent = result.message;
          DOM.calendarMsg.classList.add("text-green-600");
        } catch (err) {
          console.error("Save calendar failed:", err);
        } finally {
          DOM.saveCalendarButton.disabled = false;
        }
      };

      DOM.assignmentText.addEventListener("input", () => {
        DOM.wordCountText.textContent = `Word Count: ${getWordCount(
          DOM.assignmentText.value
        )}`;
        toggleSendAssignmentButtonState();
      });
      DOM.assignmentTitle.addEventListener(
        "input",
        toggleSendAssignmentButtonState
      );
      DOM.assignmentDueDate.addEventListener(
        "change",
        toggleSendAssignmentButtonState
      );

      DOM.assignmentFile.addEventListener("change", (e) => {
        selectedAssignmentFile = e.target.files[0] || null;
        DOM.fileName.textContent = selectedAssignmentFile
          ? selectedAssignmentFile.name
          : "No file selected.";
        DOM.clearFileButton.classList.toggle("hidden", !selectedAssignmentFile);
        toggleSendAssignmentButtonState();
      });

      DOM.clearFileButton.addEventListener("click", () => {
        DOM.assignmentFile.value = "";
        selectedAssignmentFile = null;
        DOM.fileName.textContent = "No file selected.";
        DOM.clearFileButton.classList.add("hidden");
        toggleSendAssignmentButtonState();
      });

      DOM.sendAssignmentButton.addEventListener("click", handleSendAssignment);
      DOM.addPointsButton.addEventListener("click", handleAddPoints);
      DOM.saveCalendarButton.addEventListener("click", handleSaveCalendar);
      DOM.profileMenuButton.addEventListener("click", toggleProfileDropdown);
      DOM.logoutButton.addEventListener("click", logout);

      document.addEventListener("submit", (e) => {
        if (e.target.classList.contains("feedback-form"))
          handleSubmitFeedback(e);
      });

      init();
    </script>
  </body>
</html>
