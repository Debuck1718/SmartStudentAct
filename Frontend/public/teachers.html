<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Import the Inter font for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom styles for the message modal */
        #messageModal, #promptModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .prompt-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        .prompt-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Custom styles for the file input button */
        .custom-file-input::-webkit-file-upload-button {
            visibility: hidden;
        }
        .custom-file-input::before {
            content: 'üìé Pick Document/File';
            display: inline-block;
            background-color: #1abc9c;
            color: #fff;
            font-weight: bold;
            font-size: 16px;
            padding: 12px;
            border-radius: 8px;
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .custom-file-input:hover::before {
            background-color: #16a085;
        }
        .custom-file-input:active::before {
            background-color: #1abc9c;
            box-shadow: none;
        }

        /* Custom loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Profile Dropdown Custom Styling */
        .dropdown-menu {
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            transform: translateY(-5px);
        }

        .dropdown-menu.visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-gray-200 bg-opacity-75 z-[999]">
        <div class="text-center p-6 bg-white rounded-xl shadow-lg">
            <div class="spinner mx-auto mb-4 border-blue-500 border-t-blue-500"></div>
            <p class="text-lg text-gray-700 font-medium">Loading teacher dashboard...</p>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="flex">
        <div class="modal-content">
            <span class="close-button" onclick="closeMessageModal()">&times;</span>
            <h2 id="modalTitle" class="text-xl font-bold mb-2 text-gray-800"></h2>
            <p id="modalMessage" class="text-gray-700"></p>
            <div class="flex justify-end mt-4">
                <button onclick="closeMessageModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Prompt Modal -->
    <div id="promptModal" class="flex">
        <div class="modal-content">
            <h2 id="promptTitle" class="text-xl font-bold mb-2 text-gray-800"></h2>
            <p id="promptMessage" class="text-gray-700 mb-4"></p>
            <textarea id="promptInput" class="w-full h-32 p-3 mb-4 border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your message here..."></textarea>
            <div class="prompt-buttons">
                <button id="cancelPromptBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors">Cancel</button>
                <button id="okPromptBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors">Send</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 space-y-6">
        
        <!-- Top Bar with Header and Profile Dropdown -->
        <header class="flex flex-col sm:flex-row justify-between items-center py-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">üìö Teacher Dashboard</h1>

            <!-- Profile Dropdown Menu with Image -->
            <div class="relative inline-block text-left">
                <!-- Dropdown toggle button -->
                <button id="profile-menu-button" type="button" class="flex items-center space-x-2 rounded-full px-4 py-2 hover:bg-gray-200 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <!-- Profile Image Placeholder -->
                    <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-blue-500">
                        <span id="profileInitials" class="font-medium text-lg text-white">TS</span>
                    </span>
                    <!-- User Name Placeholder -->
                    <span id="profileName" class="font-medium text-gray-700 hidden sm:inline">Teacher</span>
                    <!-- Dropdown Arrow Icon -->
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>

                <!-- Dropdown menu, initially hidden -->
                <div id="profile-dropdown-menu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none dropdown-menu opacity-0" role="menu" aria-orientation="vertical" aria-labelledby="profile-menu-button">
                    <div class="py-1" role="none">
                        <!-- New AI Essay Checker Link -->
                        <a href="/AI-Essay-Checker.html" class="block py-4 text-lg text-gray-700 font-medium border-b border-gray-100 hover:bg-gray-50 transition-colors px-4">
                            ü§ñ AI Essay Checker
                        </a>
                        <!-- Profile link -->
                        <a href="/public/profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                            Your Profile
                        </a>
                        <!-- Settings link -->
                        <a href="/public/settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                            Settings
                        </a>
                        <hr class="my-1 border-gray-100" role="none">
                        <!-- Logout button -->
                        <button id="logoutButton" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                            üö™ Sign out
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Sections -->
        
        <!-- Tab Navigation -->
        <nav class="flex flex-wrap sm:flex-nowrap justify-around items-center bg-gray-200 rounded-xl p-3 shadow-md">
            <a href="/public/my-students.html" class="flex-1 text-center py-2 px-3 m-1 bg-blue-500 text-white font-bold rounded-lg shadow-sm hover:bg-blue-600 transition-colors">
                üë®‚Äçüéì My Class
            </a>
            <a href="/public/completed-assignment.html" class="flex-1 text-center py-2 px-3 m-1 bg-blue-500 text-white font-bold rounded-lg shadow-sm hover:bg-blue-600 transition-colors">
                ‚úÖ Completed Tasks
            </a>
            <a href="/public/AI Essay Checker.html" class="flex-1 text-center py-2 px-3 m-1 bg-blue-500 text-white font-bold rounded-lg shadow-sm hover:bg-blue-600 transition-colors">
                ü§ñ AI Checker
            </a>
        </nav>

        <!-- Students in Your Class Section -->
        <section id="studentsSection" class="bg-white rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">üéì Students in Your Class</h2>
            <div id="studentsList" class="divide-y divide-gray-200">
                <!-- Students will be rendered here by JS -->
            </div>
        </section>

<!-- Create and Send Assignment Section -->
<section class="bg-white rounded-xl p-6 shadow-lg">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">‚úèÔ∏è Create and Send Assignment</h2>
    
    <label for="student-select" class="block text-gray-700 font-bold mb-2">Select Student:</label>
    <div id="studentSelectContainer" class="border border-gray-300 rounded-lg overflow-hidden mb-4">
        <select id="student-select" class="w-full p-3 bg-white text-gray-800 focus:outline-none">
            <!-- Options will be populated by JS -->
        </select>
    </div>

    <label for="assignmentTitle" class="block text-gray-700 font-bold mb-2">Assignment Title:</label>
    <input type="text" id="assignmentTitle" class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., History Essay on World War II" maxlength="100">

    <label for="assignmentDueDate" class="block text-gray-700 font-bold mb-2">Due Date:</label>
    <input type="datetime-local" id="assignmentDueDate" class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">

    <label for="assignmentText" class="block text-gray-700 font-bold mb-2">Assignment Details (max 1000 words or attach file):</label>
    <textarea id="assignmentText" class="w-full min-h-[150px] p-4 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y" placeholder="Type your assignment here..." maxlength="5000"></textarea>
    <p id="wordCountText" class="text-sm text-gray-500 text-right mb-4">Word count: 0</p>
    
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
        <label for="assignmentFile" class="custom-file-input cursor-pointer text-base">
            <input type="file" id="assignmentFile" class="hidden">
        </label>
        <div id="fileStatus" class="flex items-center gap-2">
            <span id="fileName" class="text-gray-700 text-sm italic">No file selected.</span>
            <button id="clearFileButton" class="text-red-500 hover:text-red-700 hidden text-sm font-semibold">Clear</button>
        </div>
    </div>
    
    <button id="sendAssignmentButton" class="w-full py-4 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-colors transform hover:scale-105" disabled>
        Send Assignment
    </button>
</section>

<!-- Add Student Points Section -->
<section class="bg-white rounded-xl p-6 shadow-lg">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">‚ûï Add Student Points</h2>

    <label for="points-student-select" class="block text-gray-700 font-bold mb-2">Select Student:</label>
    <div class="border border-gray-300 rounded-lg overflow-hidden mb-4">
        <select id="points-student-select" class="w-full p-3 bg-white text-gray-800 focus:outline-none">
            <!-- Options will be populated dynamically -->
        </select>
    </div>

    <label for="pointsInput" class="block text-gray-700 font-bold mb-2">Points to Add:</label>
    <input type="number" id="pointsInput" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., 10" min="1">
    
    <label for="reasonText" class="block text-gray-700 font-bold mb-2">Reason (Optional):</label>
    <textarea id="reasonText" class="w-full min-h-[80px] p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-y" placeholder="e.g., Great participation in class discussion."></textarea>
    
    <button id="addPointsButton" class="w-full py-4 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-colors transform hover:scale-105">
        Add Points
    </button>
</section>

<!-- Overdue Tasks Section -->
<section class="bg-white rounded-xl p-6 shadow-lg">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">üìå Overdue Tasks</h2>
    <div id="overdueTasksList" class="divide-y divide-gray-200">
        <!-- Overdue tasks will be rendered here by JS -->
    </div>
</section>

<!-- Assigned Tasks Section -->
<section class="bg-white rounded-xl p-6 shadow-lg">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">üìù Assigned Tasks & Feedback</h2>
    <div id="assignedTasksList" class="divide-y divide-gray-200">
        <!-- Each assigned task will be rendered here by JS -->
    </div>
</section>

<!-- Student Feedback Section -->
<section class="bg-white rounded-xl p-6 shadow-lg">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">üí¨ Student Feedback Overview</h2>
    <div id="feedbackList" class="divide-y divide-gray-200">
        <!-- Student feedback will be rendered here by JS -->
    </div>
</section>

<!-- Academic Calendar Section -->
<section class="bg-white rounded-xl p-6 shadow-lg">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">üìÖ Academic Calendar</h2>
    <input type="date" id="termStart" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Start of Term (YYYY-MM-DD)">
    <input type="date" id="termEnd" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="End of Term (YYYY-MM-DD)">
    <button id="saveCalendarButton" class="w-full py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-colors transform hover:scale-105">
        Save Calendar
    </button>
    <p id="calendarMsg" class="text-center font-semibold mt-4 text-gray-700"></p>
</section>
        
        <!-- Footer -->
        <footer class="text-center text-sm text-gray-500 py-6 mt-4">
            ¬© <span id="currentYear"></span> SmartStudentAct
        </footer>
    </div>

    <script>
        // --- State Variables ---
        let students = [];
        let overdueTasks = [];
        let assignedTasks = [];
        let feedbackList = [];
        let selectedAssignmentFile = null;
        let isDropdownVisible = false;

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const studentsListEl = document.getElementById('studentsList');
        const overdueTasksListEl = document.getElementById('overdueTasksList');
        const assignedTasksListEl = document.getElementById('assignedTasksList');
        const feedbackListEl = document.getElementById('feedbackList');
        const studentSelectEl = document.getElementById('student-select');
        const assignmentTitleEl = document.getElementById('assignmentTitle');
        const assignmentDueDateEl = document.getElementById('assignmentDueDate');
        const assignmentTextEl = document.getElementById('assignmentText');
        const wordCountTextEl = document.getElementById('wordCountText');
        const assignmentFileEl = document.getElementById('assignmentFile');
        const fileNameEl = document.getElementById('fileName');
        const clearFileButtonEl = document.getElementById('clearFileButton');
        const sendAssignmentButtonEl = document.getElementById('sendAssignmentButton');
        const termStartEl = document.getElementById('termStart');
        const termEndEl = document.getElementById('termEnd');
        const saveCalendarButtonEl = document.getElementById('saveCalendarButton');
        const calendarMsgEl = document.getElementById('calendarMsg');
        
        // Profile dropdown DOM elements
        const profileMenuButton = document.getElementById('profile-menu-button');
        const profileDropdownMenu = document.getElementById('profile-dropdown-menu');
        const logoutButtonEl = document.getElementById('logoutButton');

        // Modal DOM elements
        const messageModal = document.getElementById('messageModal');
        const modalTitleEl = document.getElementById('modalTitle');
        const modalMessageEl = document.getElementById('modalMessage');
        const promptModal = document.getElementById('promptModal');
        const promptTitleEl = document.getElementById('promptTitle');
        const promptMessageEl = document.getElementById('promptMessage');
        const promptInputEl = document.getElementById('promptInput');
        const okPromptBtn = document.getElementById('okPromptBtn');
        const cancelPromptBtn = document.getElementById('cancelPromptBtn');

        // Points section DOM elements
        const pointsStudentSelectEl = document.getElementById('points-student-select');
        const pointsInputEl = document.getElementById('pointsInput');
        const reasonTextEl = document.getElementById('reasonText');
        const addPointsButtonEl = document.getElementById('addPointsButton');

        // --- API Base URL ---
        // Changed hardcoded URL to a relative path for better deployment flexibility.
        const API_BASE = '/api';

        // --- Helper Functions ---
        /**
         * Simple function to sanitize string inputs to prevent XSS attacks.
         * This is a client-side safeguard and NOT a substitute for robust
         * server-side validation, which is mandatory for real security.
         * @param {string} str The string to sanitize.
         * @returns {string} The sanitized string.
         */
        function sanitizeInput(str) {
            if (typeof str !== 'string') return '';
            const tempDiv = document.createElement('div');
            tempDiv.textContent = str;
            return tempDiv.innerHTML;
        }

        /**
         * Displays a custom message modal.
         * @param {string} title The title of the modal.
         * @param {string} message The message to display.
         */
        function showMessageModal(title, message) {
            modalTitleEl.textContent = title;
            modalMessageEl.textContent = message;
            messageModal.style.display = 'flex';
        }

        /**
         * Closes the message modal.
         */
        function closeMessageModal() {
            messageModal.style.display = 'none';
        }

        /**
         * Displays a custom prompt modal for user input.
         * Replaces the browser's native `prompt()` for better styling and control.
         * @param {string} title The title of the prompt.
         * @param {string} message The message to display.
         * @returns {Promise<string|null>} A promise that resolves with the user's input or null if canceled.
         */
        function showPromptModal(title, message) {
            return new Promise((resolve) => {
                promptTitleEl.textContent = title;
                promptMessageEl.textContent = message;
                promptInputEl.value = ''; // Clear previous input
                promptModal.style.display = 'flex';

                const onOk = () => {
                    resolve(promptInputEl.value);
                    promptModal.style.display = 'none';
                    okPromptBtn.removeEventListener('click', onOk);
                    cancelPromptBtn.removeEventListener('click', onCancel);
                };

                const onCancel = () => {
                    resolve(null);
                    promptModal.style.display = 'none';
                    okPromptBtn.removeEventListener('click', onOk);
                    cancelPromptBtn.removeEventListener('click', onCancel);
                };

                okPromptBtn.addEventListener('click', onOk);
                cancelPromptBtn.addEventListener('click', onCancel);
            });
        }

        /**
         * Simple toast/alert function.
         * Replaced `alert()` with the custom modal for better UI.
         * @param {string} msg The message to display.
         */
        function toast(msg) {
            showMessageModal('Notice', msg);
        }

        /**
         * Helper for API calls with error handling.
         * This function centralizes fetch logic to handle network and API errors.
         * @param {string} url The API endpoint URL.
         * @param {Object} options The fetch options.
         * @returns {Promise<Response>} The response object.
         */
        async function fetchAPI(url, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${url}`, {
                    credentials: 'include',
                    ...options
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                    throw new Error(`API Error: ${response.status} - ${errorData.message || response.statusText}`);
                }
                return response;
            } catch (error) {
                console.error(`Fetch API Error for ${url}:`, error);
                showMessageModal('Network Error', `Could not connect to the server or fetch data. Please check your network connection. Details: ${error.message}`);
                throw error;
            }
        }

        /**
         * Counts words in a given text.
         * @param {string} text The text to count.
         * @returns {number} The word count.
         */
        function getWordCount(text) {
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        /**
         * Renders a list of items to a container element.
         * @param {HTMLElement} container The DOM element to render into.
         * @param {Array} items The data array.
         * @param {Function} renderItem A function that returns HTML for each item.
         * @param {string} emptyMessage The message to show if the list is empty.
         */
        function renderList(container, items, renderItem, emptyMessage) {
            container.innerHTML = ''; // Clear previous content
            if (items.length === 0) {
                container.innerHTML = `<p class="text-center italic text-gray-500 py-4">${emptyMessage}</p>`;
                return;
            }
            items.forEach(item => {
                container.innerHTML += renderItem(item);
            });
        }

        // --- Core Application Logic ---

        /**
         * Fetches all data from the API and renders the dashboard.
         */
        async function init() {
            loadingOverlay.style.display = 'flex';
            try {
                // Fetch and render all data sections
                await Promise.all([
                    fetchUserData(),
                    fetchStudents(),
                    fetchOverdueTasks(),
                    fetchAssignedTasks(),
                    fetchFeedback()
                ]);

                // Initial state update for the assignment button
                toggleSendAssignmentButtonState();

                // Set current year in the footer
                document.getElementById('currentYear').textContent = new Date().getFullYear();

            } catch (error) {
                console.error('Initialization failed:', error);
                // The showMessageModal in fetchAPI already handles this.
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        /**
         * Fetches and displays teacher and student data.
         * @returns {Promise<void>}
         */
        async function fetchUserData() {
            try {
                const teacherResponse = await fetchAPI('/teacher/profile');
                const teacherData = await teacherResponse.json();
                
                // Update profile initials and name
                const profileInitialsEl = document.getElementById('profileInitials');
                const profileNameEl = document.getElementById('profileName');
                if (teacherData.firstname && teacherData.lastname) {
                    profileInitialsEl.textContent = `${teacherData.firstname.charAt(0)}${teacherData.lastname.charAt(0)}`.toUpperCase();
                    profileNameEl.textContent = `${teacherData.firstname} ${teacherData.lastname}`;
                } else {
                    profileInitialsEl.textContent = 'T';
                    profileNameEl.textContent = 'Teacher';
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
                // Error handled by fetchAPI
            }
        }
        
        /**
         * Fetches and renders the list of students in the class.
         */
        async function fetchStudents() {
            try {
                const response = await fetchAPI('/teacher/students');
                students = await response.json();
                renderStudents();
            } catch (error) {
                console.error('Error fetching students:', error);
                renderList(studentsListEl, [], () => '', 'Could not load student list.');
            }
        }

        /**
         * Renders the list of students to the UI.
         */
        function renderStudents() {
            renderList(studentsListEl, students, (s) => `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4">
                    <span class="flex-1 text-gray-800 text-base font-medium mb-2 sm:mb-0">${sanitizeInput(s.firstname)} ${sanitizeInput(s.lastname)} (Grade ${sanitizeInput(s.grade)})</span>
                    <button onclick="handleAssignClick('${sanitizeInput(s.email)}')" class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm font-semibold shadow-sm hover:bg-blue-600 transition-colors">Assign</button>
                </div>
            `, 'No students found in your class.');

            // Populate student select for assignments and points
            const optionsHtml = students.map(s => `<option value="${sanitizeInput(s.email)}">${sanitizeInput(s.firstname)} ${sanitizeInput(s.lastname)} (${sanitizeInput(s.email)})</option>`).join('');
            studentSelectEl.innerHTML = optionsHtml;
            pointsStudentSelectEl.innerHTML = optionsHtml;
        }

        /**
         * Placeholder for handling the 'Assign' button click.
         * @param {string} studentEmail The email of the student to assign to.
         */
        function handleAssignClick(studentEmail) {
            toast(`Preparing to create an assignment for ${studentEmail}.`);
            // Here you would likely scroll to the assignment section or pre-fill the student selector.
            studentSelectEl.value = studentEmail;
        }

        /**
         * Fetches and renders the list of overdue tasks.
         */
        async function fetchOverdueTasks() {
            try {
                const response = await fetchAPI('/teacher/overdue-tasks');
                overdueTasks = await response.json();
                renderOverdueTasks();
            } catch (error) {
                console.error('Error fetching overdue tasks:', error);
                renderList(overdueTasksListEl, [], () => '', 'Could not load overdue tasks.');
            }
        }
        
        /**
         * Renders overdue tasks list.
         */
        function renderOverdueTasks() {
            renderList(overdueTasksListEl, overdueTasks, (o) => `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4">
                    <span class="flex-1 text-gray-800 text-base font-medium mb-2 sm:mb-0">
                        <span class="font-bold">${sanitizeInput(o.student_email)}</span>: "${sanitizeInput(o.title)}" was due ${new Date(o.due_datetime).toLocaleString()}
                    </span>
                    <button onclick="sendMessage('${sanitizeInput(o.student_email)}')" class="px-3 py-1 bg-orange-500 text-white rounded-md text-sm font-semibold shadow-sm hover:bg-orange-600 transition-colors">Remind</button>
                </div>
            `, 'No overdue tasks!');
        }

        /**
         * Fetches and renders the list of assigned tasks that need feedback.
         * These are the tasks that students have submitted.
         */
        async function fetchAssignedTasks() {
            try {
                const response = await fetchAPI('/teacher/assigned-tasks');
                assignedTasks = await response.json();
                renderAssignedTasks();
            } catch (error) {
                console.error('Error fetching assigned tasks:', error);
                renderList(assignedTasksListEl, [], () => '', 'Could not load assigned tasks.');
            }
        }

        /**
         * Renders assigned tasks list with feedback forms.
         */
        function renderAssignedTasks() {
            renderList(assignedTasksListEl, assignedTasks, (task) => `
                <div class="task-card p-4 bg-gray-50 rounded-lg my-4 shadow-sm">
                    <p class="mb-1 text-gray-700"><strong>Assignment:</strong> ${sanitizeInput(task.title)}</p>
                    <p class="mb-1 text-gray-700"><strong>Student:</strong> ${sanitizeInput(task.student_email)}</p>
                    <p class="mb-2 text-gray-500 text-sm">Submitted on: ${new Date(task.submitted_at).toLocaleString()}</p>
                    ${task.submission_url ? `<a href="${sanitizeInput(task.submission_url)}" target="_blank" class="text-blue-500 hover:underline text-sm font-semibold mb-2 block">View Submission File</a>` : `<p class="text-gray-500 text-sm mb-2">No file attached.</p>`}
                    
                    <form id="feedback-form-${sanitizeInput(task._id)}" class="feedback-form mt-2 border-t pt-4">
                        <input type="hidden" name="taskId" value="${sanitizeInput(task._id)}">
                        <label class="block font-semibold mb-1 text-gray-700">Feedback Grade:</label>
                        <input type="number" name="grade" class="w-full p-2 border border-gray-300 rounded mb-2 text-gray-800" placeholder="e.g., 95" min="0" max="100" required>
                        
                        <label class="block font-semibold mb-1 text-gray-700">Comments:</label>
                        <textarea name="comments" class="w-full p-2 border border-gray-300 rounded mb-2 text-gray-800" placeholder="Write feedback here..."></textarea>
                        
                        <label class="block font-semibold mb-1 text-gray-700">Upload Feedback File (Optional):</label>
                        <input type="file" name="feedbackFile" class="mb-2">
                        
                        <button type="submit" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors font-semibold">Send Feedback</button>
                    </form>
                </div>
            `, 'No assigned tasks that require feedback.');
        }

        /**
         * Fetches and renders student feedback history.
         */
        async function fetchFeedback() {
            try {
                const response = await fetchAPI('/teacher/feedback');
                feedbackList = await response.json();
                renderFeedback();
            } catch (error) {
                console.error('Error fetching feedback:', error);
                renderList(feedbackListEl, [], () => '', 'Could not load feedback history.');
            }
        }
        
        /**
         * Renders feedback history list.
         */
        function renderFeedback() {
            renderList(feedbackListEl, feedbackList, (f) => `
                <div class="p-4 my-2 bg-gray-50 rounded-lg shadow-sm">
                    <p class="mb-1 text-gray-700"><strong>Student:</strong> ${sanitizeInput(f.student_email)}</p>
                    <p class="mb-1 text-gray-700"><strong>Assignment:</strong> ${sanitizeInput(f.assignment_title)}</p>
                    <p class="mb-1 text-gray-700"><strong>Grade:</strong> <span class="font-bold text-green-600">${sanitizeInput(f.grade)}%</span></p>
                    <p class="mb-1 text-gray-700"><strong>Comments:</strong> ${sanitizeInput(f.comments)}</p>
                    ${f.feedback_url ? `<a href="${sanitizeInput(f.feedback_url)}" target="_blank" class="text-blue-500 hover:underline text-sm font-semibold mt-2 block">View Feedback File</a>` : ''}
                </div>
            `, 'No feedback has been sent yet.');
        }

        // --- Event Handlers ---

        /**
         * Toggles the state of the send assignment button based on form validity.
         */
        function toggleSendAssignmentButtonState() {
            const isStudentSelected = studentSelectEl.value !== '';
            const isTitleEntered = assignmentTitleEl.value.trim() !== '';
            const isDueDateSelected = assignmentDueDateEl.value !== '';
            const isTextEntered = getWordCount(assignmentTextEl.value) > 0;
            const isFileSelected = selectedAssignmentFile !== null;

            const isFormValid = isStudentSelected && isTitleEntered && isDueDateSelected && (isTextEntered || isFileSelected);
            sendAssignmentButtonEl.disabled = !isFormValid;
            sendAssignmentButtonEl.classList.toggle('opacity-50', !isFormValid);
            sendAssignmentButtonEl.classList.toggle('cursor-not-allowed', !isFormValid);
        }

        /**
         * Handles the submission of a new assignment.
         */
        async function handleSendAssignment() {
            sendAssignmentButtonEl.disabled = true;
            try {
                const formData = new FormData();
                formData.append('studentEmail', studentSelectEl.value);
                formData.append('title', assignmentTitleEl.value.trim());
                formData.append('due_datetime', assignmentDueDateEl.value);
                
                if (assignmentTextEl.value.trim()) {
                    formData.append('description', assignmentTextEl.value.trim());
                }
                
                if (selectedAssignmentFile) {
                    formData.append('assignmentFile', selectedAssignmentFile);
                }

                const response = await fetchAPI('/teacher/assignments', {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();
                showMessageModal('Success', result.message);

                // Clear the form after successful submission
                assignmentTitleEl.value = '';
                assignmentDueDateEl.value = '';
                assignmentTextEl.value = '';
                assignmentFileEl.value = '';
                selectedAssignmentFile = null;
                fileNameEl.textContent = 'No file selected.';
                clearFileButtonEl.classList.add('hidden');
                toggleSendAssignmentButtonState();
                
            } catch (error) {
                console.error('Error sending assignment:', error);
                // The fetchAPI function already displays a modal.
            } finally {
                sendAssignmentButtonEl.disabled = false;
            }
        }
        
        /**
         * Handles the submission of feedback for a completed task.
         * @param {Event} e The form submission event.
         */
        async function handleSubmitFeedback(e) {
            e.preventDefault();
            const form = e.target;
            const taskId = form.querySelector('[name="taskId"]').value;
            const grade = form.querySelector('[name="grade"]').value;
            const comments = form.querySelector('[name="comments"]').value;
            const feedbackFile = form.querySelector('[name="feedbackFile"]').files[0];

            if (!grade) {
                showMessageModal('Validation Error', 'Please provide a grade.');
                return;
            }
            
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            const formData = new FormData();
            formData.append('taskId', taskId);
            formData.append('grade', grade);
            formData.append('comments', comments);
            if (feedbackFile) {
                formData.append('feedbackFile', feedbackFile);
            }

            try {
                const response = await fetchAPI('/teacher/feedback', {
                    method: 'POST',
                    body: formData,
                });
                
                const result = await response.json();
                showMessageModal('Feedback Sent', result.message);

                // Refresh the lists to show updated state
                await Promise.all([fetchAssignedTasks(), fetchFeedback()]);

            } catch (error) {
                console.error('Error submitting feedback:', error);
                // Error handled by fetchAPI
            } finally {
                submitButton.disabled = false;
            }
        }

        /**
         * Handles the click event for the add points button.
         */
        async function handleAddPoints() {
            const studentEmail = pointsStudentSelectEl.value;
            const points = pointsInputEl.value;
            const reason = reasonTextEl.value.trim();

            if (!studentEmail || !points || points <= 0) {
                showMessageModal('Validation Error', 'Please select a student and enter a valid number of points.');
                return;
            }
            
            addPointsButtonEl.disabled = true;

            try {
                const response = await fetchAPI('/teacher/points', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentEmail, points: parseInt(points, 10), reason }),
                });

                const result = await response.json();
                showMessageModal('Success', result.message);

                // Clear the form
                pointsInputEl.value = '';
                reasonTextEl.value = '';

            } catch (error) {
                console.error('Error adding points:', error);
                // Error handled by fetchAPI
            } finally {
                addPointsButtonEl.disabled = false;
            }
        }
        
        /**
         * Handles the academic calendar submission.
         */
        async function handleSaveCalendar() {
            const termStart = termStartEl.value;
            const termEnd = termEndEl.value;

            if (!termStart || !termEnd) {
                showMessageModal('Validation Error', 'Please select both start and end dates.');
                return;
            }
            saveCalendarButtonEl.disabled = true;

            try {
                const response = await fetchAPI('/teacher/calendar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ termStart, termEnd }),
                });
                const result = await response.json();
                showMessageModal('Success', result.message);
                calendarMsgEl.textContent = `Calendar saved successfully! Term from ${new Date(termStart).toLocaleDateString()} to ${new Date(termEnd).toLocaleDateString()}.`;
            } catch (error) {
                console.error('Error saving calendar:', error);
                calendarMsgEl.textContent = 'Failed to save calendar.';
            } finally {
                saveCalendarButtonEl.disabled = false;
            }
        }
        
        /**
         * Toggles the profile dropdown menu visibility.
         */
        function toggleProfileDropdown() {
            isDropdownVisible = !isDropdownVisible;
            if (isDropdownVisible) {
                profileDropdownMenu.classList.remove('hidden', 'opacity-0');
                profileDropdownMenu.classList.add('visible');
            } else {
                profileDropdownMenu.classList.add('opacity-0');
                profileDropdownMenu.classList.remove('visible');
                // Use a slight delay to allow the fade-out animation to complete
                setTimeout(() => profileDropdownMenu.classList.add('hidden'), 200);
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                const response = await fetchAPI('/teacher/logout', { method: 'POST' });
                if (response.ok) {
                    showMessageModal('Signed Out', 'You have been successfully signed out. Redirecting to the login page...');
                    // Redirect to login page after a short delay
                    setTimeout(() => {
                        window.location.href = '/public/login.html';
                    }, 2000);
                }
            } catch (error) {
                console.error('Logout failed:', error);
                showMessageModal('Logout Error', 'Failed to sign out. Please try again.');
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', init);

        // Assignment form listeners
        assignmentTextEl.addEventListener('input', () => {
            wordCountTextEl.textContent = `Word count: ${getWordCount(assignmentTextEl.value)}`;
            toggleSendAssignmentButtonState();
        });
        assignmentFileEl.addEventListener('change', (e) => {
            selectedAssignmentFile = e.target.files[0];
            if (selectedAssignmentFile) {
                fileNameEl.textContent = selectedAssignmentFile.name;
                clearFileButtonEl.classList.remove('hidden');
            } else {
                fileNameEl.textContent = 'No file selected.';
                clearFileButtonEl.classList.add('hidden');
            }
            toggleSendAssignmentButtonState();
        });
        clearFileButtonEl.addEventListener('click', () => {
            assignmentFileEl.value = null;
            selectedAssignmentFile = null;
            fileNameEl.textContent = 'No file selected.';
            clearFileButtonEl.classList.add('hidden');
            toggleSendAssignmentButtonState();
        });
        studentSelectEl.addEventListener('change', toggleSendAssignmentButtonState);
        assignmentTitleEl.addEventListener('input', toggleSendAssignmentButtonState);
        assignmentDueDateEl.addEventListener('change', toggleSendAssignmentButtonState);
        sendAssignmentButtonEl.addEventListener('click', handleSendAssignment);

        // Delegated event listener for feedback forms
        document.getElementById('assignedTasksList').addEventListener('submit', handleSubmitFeedback);

        // Add points button listener
        addPointsButtonEl.addEventListener('click', handleAddPoints);

        // Calendar button listener
        saveCalendarButtonEl.addEventListener('click', handleSaveCalendar);

        // Profile dropdown listeners
        profileMenuButton.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent the body listener from immediately closing it
            toggleProfileDropdown();
        });
        document.addEventListener('click', (e) => {
            if (isDropdownVisible && !profileDropdownMenu.contains(e.target) && !profileMenuButton.contains(e.target)) {
                toggleProfileDropdown();
            }
        });
        
        // Logout button listener
        logoutButtonEl.addEventListener('click', handleLogout);
    </script>
</body>
</html>
