<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="dashboardTitle">Teacher Dashboard</title>

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-EWMR745QHX"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-EWMR745QHX");
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: "class" };
      if (
        localStorage.getItem("theme") === "dark" ||
        (!("theme" in localStorage) && window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    </script>

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="./images/icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="/vendor/cropperjs/cropper.min.css" />
    <script src="/vendor/cropperjs/cropper.min.js" defer></script>

    <script src="/vendor/fullcalendar/index.global.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

      body {
        font-family: "Inter", sans-serif;
      }

      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .custom-file-input::-webkit-file-upload-button {
        visibility: hidden;
      }

      .custom-file-input::before {
        content: "üìé Pick Document/File";
        display: inline-block;
        background-color: #2563eb;
        color: #fff;
        font-weight: 600;
        padding: 10px 14px;
        border-radius: 8px;
        cursor: pointer;
      }

      .custom-file-input:hover::before {
        background-color: #1d4ed8;
      }
      .cropper-container {
        max-height: 60vh;
      }
      .cropper-view-box,
      .cropper-face {
        border-radius: 50%;
      }
    </style>
  </head>

  <body class="bg-slate-100 dark:bg-gray-900 dark:text-white min-h-screen antialiased flex flex-col transition-colors duration-200">
    <div
      id="loadingOverlay"
      class="fixed inset-0 flex items-center justify-center bg-slate-200 bg-opacity-75 z-[999] hidden"
    >
      <div class="text-center p-6 bg-white rounded-xl shadow-lg">
        <div class="spinner mx-auto mb-4"></div>
        <p class="text-lg text-slate-700 font-medium" data-i18n="loadingMessage">
          Loading teacher dashboard...
        </p>
      </div>
    </div>
    
    <header class="bg-white text-gray-800 p-4 flex justify-between items-center shadow-lg rounded-b-3xl z-50 relative">
      <button id="menu-btn" class="p-2 text-2xl text-blue-600 focus:outline-none lg:hidden" aria-label="Open navigation menu"><i class="fas fa-bars"></i></button>
      
      <div class="flex items-center gap-4">
        <h1
          class="text-xl sm:text-2xl font-bold text-slate-800"
          data-i18n="dashboardTitle"
        >
          üìö Teacher Dashboard
        </h1>

        <div class="flex items-center space-x-6">
          <select
            id="language-switcher"
            class="px-3 py-2 bg-white border border-gray-300 rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none pr-8 cursor-pointer text-sm hidden sm:block"
          >
            <option value="en">EN - English</option>
            <option value="fr">FR</option>
            <option value="es">ES</option>
            <option value="tr">TR</option>
            <option value="ar">AR</option>
            <option value="ru">RU</option>
          </select>

          <div class="relative inline-block text-left">
            <button
              id="profile-menu-button"
              type="button" class="flex items-center space-x-2 rounded-full p-1 hover:bg-slate-200/70 transition-all duration-300 focus:outline-none"
              >
              <img
                id="profileAvatar"
                src="./images/default-avatar.png"
                alt="Profile Avatar"
                referrerpolicy="no-referrer"
                class="h-10 w-10 rounded-full object-cover border border-slate-300"
                onerror="this.onerror=null; this.src='./images/default-avatar.png';"
              />
              <span
                id="profilePreviewName"
                class="hidden sm:inline font-medium text-slate-700"
                >Teacher</span
              >
              <i class="fas fa-chevron-down text-slate-400"></i>
            </button>
            <input
              type="file"
              id="profilePhotoInput"
              accept="image/*"
              class="hidden"
            />

            <div
              id="profile-dropdown-menu"
              class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-slate-900/5 overflow-hidden transition-all duration-300 origin-top-right transform scale-95 opacity-0"
            >
              <a
                href="./special-link.html"
                class="text-blue-600 font-semibold hover:underline"
                >Special Links</a
              >
              <a
                href="./quiz_dashboard.html"
                class="block px-4 py-2 text-sm hover:bg-gray-100 transition"
                data-i18n="quizDashboard"
                >üìù Quiz Dashboard</a
              >
              <a
                href="./profile.html"
                class="block px-4 py-2 text-sm hover:bg-gray-100 transition"
                data-i18n="yourProfile"
                >üë§ Your Profile</a
              >
              <a
                href="./settings.html"
                class="block px-4 py-2 text-sm hover:bg-gray-100 transition"
                data-i18n="settings"
                >‚öôÔ∏è Settings</a
              >
              <a
                href="./contact.html"
                class="block px-4 py-2 text-sm hover:bg-gray-100 transition"
                data-i18n="contact"
                >üì© Contact</a
              >
              <button
                id="removeProfilePhotoBtn"
                class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 transition"
              >
                üóëÔ∏è Remove Photo
              </button>
              <button
                id="logoutButton"
                class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition"
                data-i18n="signOut"
              >
                üö™ Sign out
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar (Desktop) -->
      <aside class="hidden lg:flex flex-col w-64 bg-white shadow-xl z-40 overflow-y-auto">
        <nav class="flex-1 p-4 space-y-2">
          <a href="./my-students.html" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition-colors font-medium">
            <i class="fas fa-user-graduate w-6"></i> <span data-i18n="myClass">My Class</span>
          </a>
          <a href="./completed-assignment.html" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition-colors font-medium">
            <i class="fas fa-check-circle w-6"></i> <span data-i18n="completedTasks">Completed Tasks</span>
          </a>
          <a href="./quiz_dashboard.html" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition-colors font-medium">
            <i class="fas fa-clipboard-list w-6"></i> <span data-i18n="quizDashboard">Quiz Dashboard</span>
          </a>
          <a href="./AI Checker.html" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition-colors font-medium">
            <i class="fas fa-robot w-6"></i> <span data-i18n="aiChecker">AI Checker</span>
          </a>
          <a href="./special-link.html" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition-colors font-medium">
            <i class="fas fa-link w-6"></i> <span>Special Links</span>
          </a>
          <a href="./settings.html" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition-colors font-medium">
            <i class="fas fa-cog w-6"></i> <span data-i18n="settings">Settings</span>
          </a>
        </nav>
        <div class="p-4 border-t border-gray-100">
           <button id="notification-btn" class="w-full flex items-center justify-center gap-2 py-2 px-4 text-sm font-semibold text-white bg-blue-500 rounded-full hover:bg-blue-600 transition-colors shadow-md mb-3">
            <span id="notification-btn-icon">üîî</span> <span id="notification-btn-text">Subscribe</span>
          </button>
          <p class="text-xs text-center text-gray-400">¬© 2025 SmartStudentAct</p>
        </div>
      </aside>

      <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 bg-slate-100">
        <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Welcome Section -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-3xl p-8 text-white shadow-lg mb-8">
          <h2 class="text-3xl font-bold mb-2">Welcome back, Teacher! üëã</h2>
          <p class="text-blue-100">Manage your classroom, assignments, and student progress all in one place.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <section
          id="studentsSection"
          class="bg-white rounded-3xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-slate-100"
        >
          <h2
            class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2"
            data-i18n="studentsInClass"
          >
            üéì Students in Your Class
          </h2>
          <div
            id="studentsList"
            class="divide-y divide-gray-200 text-gray-700"
          ></div>
        </section>
        <section
          class="bg-white rounded-3xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-slate-100 md:col-span-2 lg:col-span-2"
        >
          <h2
            class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2"
            data-i18n="createAssignment"
          >
            ‚úèÔ∏è Create and Send Assignment
          </h2>
          <form id="assignmentForm">
            <div class="mb-4">
              <label
                class="block text-gray-700 font-bold mb-2"
                data-i18n="selectRecipient"
                >Select Recipient:</label
              >
              <div class="flex flex-col sm:flex-row gap-2">
                <label class="inline-flex items-center">
                  <input
                    type="checkbox"
                    name="assignmentRecipient"
                    value="student"
                    class="form-checkbox text-blue-600"
                  />
                  <span class="ml-2 text-gray-700" data-i18n="selectStudents"
                    >Specific Students</span
                  >
                </label>
                <label class="inline-flex items-center">
                  <input
                    type="checkbox"
                    name="assignmentRecipient"
                    value="myClass"
                    class="form-checkbox text-blue-600"
                  />
                  <span class="ml-2 text-gray-700" data-i18n="entireClass"
                    >Entire Class</span
                  >
                </label>
                <label class="inline-flex items-center">
                  <input
                    type="checkbox"
                    name="assignmentRecipient"
                    value="otherGrade"
                    class="form-checkbox text-blue-600"
                  />
                  <span class="ml-2 text-gray-700" data-i18n="otherGrade"
                    >Another Grade</span
                  >
                </label>
                <label class="inline-flex items-center">
                  <input
                    type="checkbox"
                    name="assignmentRecipient"
                    value="special_student"
                    class="form-checkbox text-blue-600"
                  />
                  <span class="ml-2 text-gray-700" data-i18n="otherGrade"
                    >special_student</span
                  >
                </label>
                <label class="inline-flex items-center">
                  <input
                    type="checkbox"
                    name="assignmentRecipient"
                    value="program"
                    class="form-checkbox text-blue-600"
                  />
                  <span class="ml-2 text-gray-700" data-i18n="program"
                    >Program</span
                  >
                </label>
              </div>
            </div>

            <div id="assignment-student-select-group" class="hidden">
              <label
                for="assignment-student-select"
                class="block text-gray-700 font-bold mb-2"
                data-i18n="selectStudentsLabel"
                >Select Student(s):</label
              >
              <div
                class="border border-gray-300 rounded-lg overflow-hidden mb-4"
              >
                <select
                  id="assignment-student-select"
                  class="w-full p-3 bg-white text-gray-800 focus:outline-none max-h-48 overflow-auto"
                  multiple
                ></select>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div id="assignment-grade-select-group" class="hidden">
              <label
                for="assignment-grade-select"
                class="block text-gray-700 font-bold mb-2"
                data-i18n="selectGrade"
                >Select Grade:</label
              >
              <div
                class="border border-gray-300 rounded-lg overflow-hidden mb-4"
              >
                <select
                  id="assignment-grade-select"
                  class="w-full p-3 bg-white text-gray-800 focus:outline-none max-h-48 overflow-auto"
                ></select>
              </div>
            </div>

            <div id="assignment-program-select-group" class="hidden">
              <label
                for="assignment-program-select"
                class="block text-gray-700 font-bold mb-2"
                data-i18n="selectProgram"
                >Select Program:</label
              >
              <div
                class="border border-gray-300 rounded-lg overflow-hidden mb-4"
              >
                <select
                  id="assignment-program-select"
                  class="w-full p-3 bg-white text-gray-800 focus:outline-none"
                ></select>
              </div>
            </div>
            <div>
              <label
                for="assignmentTitle"
                class="block text-gray-700 font-bold mb-2"
                data-i18n="assignmentTitle"
                >Assignment Title:</label
              >
              <input
                type="text"
                id="assignmentTitle"
                name="assignmentTitle"
                maxlength="100"
                class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="e.g., History Essay on World War II"
              />
            </div>

            <div>
              <label
                for="assignmentDueDate"
                class="block text-gray-700 font-bold mb-2"
                data-i18n="dueDate"
                >Due Date:</label
              >
              <input
                type="datetime-local"
                id="assignmentDueDate"
                name="assignmentDueDate"
                class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div class="md:col-span-2">
              <label
                for="assignmentText"
                class="block text-gray-700 font-bold mb-2"
                data-i18n="assignmentDetails"
              >
                Assignment Details (max 1000 words or attach file):
              </label>
              <textarea
                id="assignmentText"
                name="assignmentText"
                maxlength="5000"
                class="w-full min-h-[150px] p-4 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"
                placeholder="Type your assignment here..."
              ></textarea>
              <p id="wordCountText" class="text-sm text-gray-500 text-right mb-4">
                Word count: 0
              </p>
            </div>

            <div
              class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4 md:col-span-2"
            >
              <label class="custom-file-input cursor-pointer text-base">
                <input
                  type="file"
                  id="assignmentFile"
                  name="assignmentFile"
                  class="custom-file-input"
                />
              </label>
              <div id="fileStatus" class="flex items-center gap-2">
                <span id="fileName" class="text-slate-700 text-sm italic"
                  >No file selected.</span
                >
                <button
                  id="clearFileButton"
                  class="text-red-500 hover:text-red-700 hidden text-sm font-semibold"
                >
                  Clear
                </button>
              </div>
            </div>

            <button
              id="sendAssignmentButton"
              class="w-full py-4 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
              data-i18n="sendAssignment"
            >
              Send Assignment
            </button>
            </div>
          </form>
        </section>
        <section class="bg-white rounded-3xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-slate-100">
          <h2 class="text-2xl font-semibold text-slate-800 mb-4 border-b border-slate-200 pb-2">Recent Quiz Results</h2>
          <div id="quizSummaries" class="grid gap-4"></div>
        </section>
        <section
          class="bg-white rounded-3xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-slate-100"
        >
          <h2
            class="text-2xl font-semibold text-slate-800 mb-4 border-b border-slate-200 pb-2"
            data-i18n="addPointsTitle"
          >
            ‚ûï Add Student Points
          </h2>
          <div class="mb-4">
            <label
              class="block text-slate-700 font-bold mb-2"
              data-i18n="selectRecipient"
              >Select Recipient:</label
            >
            <div class="flex flex-col sm:flex-row gap-2">
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="pointsRecipient"
                  value="single"
                  class="form-radio text-green-600"
                  checked
                />
                <span class="ml-2 text-slate-700" data-i18n="singleStudent"
                  >Single Student</span
                >
              </label>
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="pointsRecipient"
                  value="multiple"
                  class="form-radio text-green-600"
                />
                <span class="ml-2 text-slate-700" data-i18n="multipleStudents"
                  >Multiple Students</span
                >
              </label>
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="pointsRecipient"
                  value="class"
                  class="form-radio text-green-600"
                />
                <span class="ml-2 text-slate-700" data-i18n="entireClass"
                  >Entire Class</span
                >
              </label>
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="pointsRecipient"
                  value="otherGrade"
                  class="form-radio text-green-600"
                />
                <span class="ml-2 text-slate-700" data-i18n="otherGrade"
                  >Another Grade</span
                >
              </label>
            </div>
          </div>

          <div id="points-select-group">
            <label
              for="points-student-select"
              class="block text-slate-700 font-bold mb-2"
              data-i18n="selectStudent"
              >Select Student(s):</label
            >
            <div class="border border-slate-300 rounded-lg overflow-hidden mb-4">
              <select
                id="points-student-select"
                class="w-full p-3 bg-white text-slate-800 focus:outline-none"
              ></select>
            </div>
          </div>

          <div id="points-grade-select-group" class="hidden">
            <label
              for="points-grade-select"
              class="block text-slate-700 font-bold mb-2"
              data-i18n="selectGrade"
              >Select Grade:</label
            >
            <div class="border border-slate-300 rounded-lg overflow-hidden mb-4">
              <select
                id="points-grade-select"
                class="w-full p-3 bg-white text-slate-800 focus:outline-none"
              ></select>
            </div>
          </div>

          <label
            for="pointsInput"
            class="block text-slate-700 font-bold mb-2"
            data-i18n="pointsToAdd"
            >Points to Add:</label
          >
          <input
            type="number"
            id="pointsInput"
            min="1"
            class="w-full p-3 mb-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
            placeholder="e.g., 10"
          />

          <label
            for="reasonText"
            class="block text-slate-700 font-bold mb-2"
            data-i18n="reasonOptional"
            >Reason (Optional):</label
          >
          <textarea
            id="reasonText"
            class="w-full min-h-[80px] p-3 mb-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-y"
            placeholder="e.g., Great participation in class discussion."
          ></textarea>

          <button
            id="addPointsButton"
            class="w-full py-4 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
            data-i18n="addPointsButton"
            disabled
          >
            Add Points
          </button>
        </section>
        <section class="bg-white rounded-3xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-slate-100">
          <h2 class="text-2xl font-semibold text-slate-800 mb-4 border-b border-slate-200 pb-2">
            üì¢ Messages & Announcements
          </h2>
          <div id="messagesList" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
        </section>

        <section class="bg-white rounded-3xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-slate-100">
          <h2 class="text-2xl font-semibold text-slate-800 mb-4 border-b border-slate-200 pb-2" data-i18n="grantRewardsTitle">üéñÔ∏è Grant Rewards</h2>
          <div class="mb-4">
            <label class="block text-slate-700 font-bold mb-2" data-i18n="selectRecipient">Select Recipient:</label>
            <div class="flex flex-col sm:flex-row gap-2">
              <label class="inline-flex items-center">
                <input type="radio" name="grantRecipient" value="single" class="form-radio text-indigo-600" checked />
                <span class="ml-2 text-slate-700" data-i18n="singleStudent">Single Student</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="grantRecipient" value="multiple" class="form-radio text-indigo-600" />
                <span class="ml-2 text-slate-700" data-i18n="multipleStudents">Multiple Students</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="grantRecipient" value="class" class="form-radio text-indigo-600" />
                <span class="ml-2 text-slate-700" data-i18n="entireClass">Entire Class</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="grantRecipient" value="otherGrade" class="form-radio text-indigo-600" />
                <span class="ml-2 text-slate-700" data-i18n="otherGrade">Another Grade</span>
              </label>
            </div>
          </div>

          <div id="grant-select-group">
            <label for="grant-student-select" class="block text-slate-700 font-bold mb-2" data-i18n="selectStudent">Select Student(s):</label>
            <div class="border border-slate-300 rounded-lg overflow-hidden mb-4">
              <select id="grant-student-select" class="w-full p-3 bg-white text-slate-800 focus:outline-none" multiple></select>
            </div>
          </div>

          <div id="grant-grade-select-group" class="hidden">
            <label for="grant-grade-select" class="block text-slate-700 font-bold mb-2" data-i18n="selectGrade">Select Grade:</label>
            <div class="border border-slate-300 rounded-lg overflow-hidden mb-4">
              <select id="grant-grade-select" class="w-full p-3 bg-white text-slate-800 focus:outline-none"></select>
            </div>
          </div>

          <label for="grantType" class="block text-slate-700 font-bold mb-2" data-i18n="grantTypeLabel">Reward Type:</label>
          <select id="grantType" class="w-full p-3 mb-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="badge">Badge</option>
            <option value="bonus">Bonus</option>
            <option value="custom">Custom</option>
          </select>

          <label for="grantPoints" class="block text-slate-700 font-bold mb-2" data-i18n="grantPointsLabel">Points (optional):</label>
          <input type="number" id="grantPoints" min="0" class="w-full p-3 mb-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 10" />

          <label for="grantDescription" class="block text-slate-700 font-bold mb-2" data-i18n="grantDescriptionLabel">Description (optional):</label>
          <textarea id="grantDescription" class="w-full min-h-[80px] p-3 mb-4 border border-slate-300 rounded-lg focus:outline-none resize-y focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Excellent participation"></textarea>

          <button id="grantRewardsButton" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" data-i18n="grantRewardsButton" disabled>
            Grant Rewards
          </button>
        </section>
        <section
          class="bg-white rounded-3xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-slate-100"
        >
          <h2
            class="text-2xl font-semibold text-slate-800 mb-4 border-b border-slate-200 pb-2"
            data-i18n="sendMessageTitle"
          >
            üíå Send Message to Student
          </h2>
          <div class="mb-4">
            <label
              class="block text-slate-700 font-bold mb-2"
              data-i18n="selectRecipient"
              >Select Recipient:</label
            >
            <div class="flex flex-col sm:flex-row gap-2">
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="messageRecipient"
                  value="single"
                  class="form-radio text-purple-600"
                  checked
                />
                <span class="ml-2 text-slate-700" data-i18n="singleStudent"
                  >Single Student</span
                >
              </label>
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="messageRecipient"
                  value="multiple"
                  class="form-radio text-purple-600"
                />
                <span class="ml-2 text-slate-700" data-i18n="multipleStudents"
                  >Multiple Students</span
                >
              </label>
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="messageRecipient"
                  value="class"
                  class="form-radio text-purple-600"
                />
                <span class="ml-2 text-slate-700" data-i18n="entireClass"
                  >Entire Class</span
                >
              </label>
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="messageRecipient"
                  value="otherGrade"
                  class="form-radio text-purple-600"
                />
                <span class="ml-2 text-slate-700" data-i18n="otherGrade"
                  >Another Grade</span
                >
              </label>
            </div>
          </div>
          <div id="message-select-group">
            <label
              for="message-student-select"
              class="block text-slate-700 font-bold mb-2"
              data-i18n="selectStudent"
              >Select Student(s):</label
            >
            <div class="border border-slate-300 rounded-lg overflow-hidden mb-4">
              <select
                id="message-student-select"
                class="w-full p-3 bg-white text-slate-800 focus:outline-none"
              ></select>
            </div>
          </div>
          <div id="message-grade-select-group" class="hidden">
            <label
              for="message-grade-select"
              class="block text-slate-700 font-bold mb-2"
              data-i18n="selectGrade"
              >Select Grade:</label
            >
            <div class="border border-slate-300 rounded-lg overflow-hidden mb-4">
              <select
                id="message-grade-select"
                class="w-full p-3 bg-white text-slate-800 focus:outline-none"
              ></select>
            </div>
          </div>
          <label
            for="messageText"
            class="block text-slate-700 font-bold mb-2"
            data-i18n="messageText"
          >
            Message:
          </label>
          <textarea
            id="messageText"
            rows="4"
            class="w-full p-4 mb-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-y"
            placeholder="Type your message here..."
          ></textarea>

          <button
            id="sendMessageButton"
            class="w-full py-4 bg-purple-600 text-white font-bold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
            data-i18n="sendMessage"
          >
            Send Message
          </button>
        </section>
        <section
          class="bg-white rounded-3xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-slate-100"
        >
          <h2
            class="text-2xl font-semibold text-slate-800 mb-4 border-b border-slate-200 pb-2"
            data-i18n="overdueTasks"
          >
            üìå Overdue Tasks
          </h2>
          <div id="overdueTasksList" class="divide-y divide-slate-200"></div>
        </section>
        <section
          class="bg-white rounded-3xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-slate-100"
        >
          <h2
            class="text-2xl font-semibold text-slate-800 mb-4 border-b border-slate-200 pb-2"
            data-i18n="assignedTasks"
          >
            üìù Assigned Tasks & Feedback
          </h2>
          <div id="assignedTasksList" class="divide-y divide-slate-200"></div>
        </section>
        <section
          class="bg-white rounded-3xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-slate-100"
        >
          <h2
            class="text-2xl font-semibold text-slate-800 mb-4 border-b border-slate-200 pb-2"
            data-i18n="studentFeedback"
          >
            üí¨ Student Feedback Overview
          </h2>
          <div id="feedbackList" class="divide-y divide-slate-200"></div>
        </section>
        <section
          class="bg-white rounded-3xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-slate-100 md:col-span-2 lg:col-span-3"
        >
          <h2 class="text-2xl font-semibold text-slate-800 mb-4 border-b border-slate-200 pb-2">
            üìÖ Assignment Calendar
          </h2>
          <div id='calendar'></div>
        </section>
        <section
          class="bg-white rounded-3xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 border border-slate-100 md:col-span-2 lg:col-span-3"
        >
          <h2 class="text-2xl font-semibold text-slate-800 mb-4 border-b border-slate-200 pb-2">
            üìÖ Academic Calendar
          </h2>
          <input
            type="text"
            id="academicYear"
            class="w-full p-3 mb-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
            placeholder="Academic Year (e.g. 2025/2026)"
          />

          <div id="termsContainer" class="space-y-4"></div>
          <button
            id="addTermButton"
            class="w-full py-2 mb-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300"
          >
            ‚ûï Add Term
          </button>

          <button
            id="saveCalendarButton"
            class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-300"
          >
            Save Calendar
          </button>

          <div class="mt-4 p-4 border border-slate-200 rounded-lg">
            <h3 class="font-semibold mb-2" data-i18n="resultsTitle">Term Results</h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
              <input type="text" id="resultsAcademicYear" class="p-2 border border-slate-300 rounded" placeholder="Academic Year (e.g. 2025/2026)" />
              <select id="termSelect" class="p-2 border border-slate-300 rounded">
                <option value="">Select Term</option>
              </select>
              <button id="loadResultsButton" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Load Results</button>
            </div>
            <div id="termResultsContainer" class="overflow-auto"></div>
          </div>

          <p
            id="calendarMsg"
            class="text-center font-semibold mt-4 text-slate-700"
          ></p>
        </section>
        </div>
        </div>
      </main>
    </div>

    <!-- Mobile Menu Overlay -->
    <div id="menu-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden lg:hidden">
      <div id="menu-content" class="bg-white h-full w-64 p-6 shadow-2xl transition-transform duration-300 ease-in-out transform -translate-x-full">
        <button id="close-menu-btn" class="text-gray-500 text-2xl absolute top-4 right-4">&times;</button>
        <h2 class="text-xl font-bold mb-6 text-blue-600">Menu</h2>
        <nav class="space-y-4">
          <a href="./my-students.html" class="block text-gray-700 font-semibold hover:text-blue-600">My Class</a>
          <a href="./completed-assignment.html" class="block text-gray-700 font-semibold hover:text-blue-600">Completed Tasks</a>
          <a href="./quiz_dashboard.html" class="block text-gray-700 font-semibold hover:text-blue-600">Quiz Dashboard</a>
          <a href="./AI Checker.html" class="block text-gray-700 font-semibold hover:text-blue-600">AI Checker</a>
          <a href="./special-link.html" class="block text-gray-700 font-semibold hover:text-blue-600">Special Links</a>
          <a href="./settings.html" class="block text-gray-700 font-semibold hover:text-blue-600">Settings</a>
          <a href="./contact.html" class="block text-gray-700 font-semibold hover:text-blue-600">Contact</a>
          <button id="mobile-logout-btn" class="text-red-500 font-semibold hover:underline w-full text-left">Logout</button>
        </nav>
        <div class="mt-8 pt-4 border-t border-gray-200">
           <select
            id="mobile-language-select"
            class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
          >
            <option value="en">EN - English</option>
            <option value="fr">FR - Fran√ßais</option>
            <option value="es">ES - Espa√±ol</option>
            <option value="tr">TR - T√ºrk√ße</option>
            <option value="ar">AR - ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            <option value="ru">RU - –†—É—Å—Å–∫–∏–π</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Cropper Modal -->
    <div id="cropper-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000] hidden">
      <div class="bg-white p-4 rounded-lg shadow-xl max-w-md w-full">
        <h2 class="text-xl font-bold mb-4">Crop Your Photo</h2>
        <div class="img-container">
          <img id="cropper-image" src="" class="max-w-full">
        </div>
        <div class="flex justify-end gap-2 mt-4">
          <button id="cancel-crop-btn" type="button" class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
          <button id="crop-and-save-btn" type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Crop & Save</button>
        </div>
      </div>
    </div>

    <script src="api-config.js"></script>
    <script src="translate.js"></script>
    <script>
      const API_BASE_URL = window.API_BASE_URL;
      let translations = {};
      let currentLang = localStorage.getItem("lang") || "en";
      let studentsCache = [];
      let currentUser = {};

      const defaultTranslations = {
        myClass: { en: "My Class", fr: "Ma Classe" },
        other_students: { en: "Other Students", fr: "Autres √âtudiants" },
        grade: { en: "Grade", fr: "Niveau" },
        select_grade: { en: "Select Grade", fr: "S√©lectionner le niveau" },
        select_program: { en: "Select Program", fr: "S√©lectionner le programme" },
        loading: { en: "Loading", fr: "Chargement" },
        no_assigned_tasks: { en: "No assigned tasks.", fr: "Aucune t√¢che assign√©e." },
        failed_load_tasks: { en: "Failed to load tasks.", fr: "√âchec du chargement des t√¢ches." },
        no_students: { en: "No students found.", fr: "Aucun √©tudiant trouv√©." },
        due: { en: "Due", fr: "Pour le" }
      };

      async function loadTranslations(lang = "en") {
        try {
          const res = await fetch(`/locales/teachers.json`);
          if (!res.ok) throw new Error("Failed to load translations");
          const allTranslations = await res.json();
          translations = allTranslations[lang] || {};
        } catch (err) {
          console.error("Translation load error:", err);
          translations = {};
        }
      }

      function translateText(key) {
        return translations[key] || (defaultTranslations[key] ? defaultTranslations[key][currentLang] : key);
      }

      function applyTranslations() {
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const key = el.getAttribute("data-i18n");
          if (translations[key]) {
            const translatedText = translations[key][currentLang];
            if (translatedText) {
              if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
                el.placeholder = translatedText;
              } else {
                el.innerHTML = translatedText;
              }
            }
          }
        });
      }

      function showToast(message, type = "info") {
        const container =
          document.getElementById("toast-container") ||
          (() => {
            const el = document.createElement("div");
            el.id = "toast-container";
            el.className = "fixed top-4 right-4 z-[1000] space-y-2";
            document.body.appendChild(el);
            return el;
          })();
        const colors = {
          success: "bg-green-600",
          error: "bg-red-600",
          info: "bg-blue-600",
          warning: "bg-yellow-500 text-gray-900",
        };
        const toast = document.createElement("div");
        toast.className = `px-4 py-2 rounded text-white shadow ${
          colors[type] || colors.info
        }`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
      }

      function hideLoadingOverlay() {
        const el = document.getElementById("loadingOverlay");
        if (el) el.style.display = "none";
      }

      async function fetchAPI(endpoint, options = {}) {
        try {
          const res = await fetch(`${API_BASE_URL}${endpoint}`, {
            ...options,
            credentials: "include",
            headers: { ...(options.headers || {}) },
          });
          if (res.status === 401) {
            window.location.href = "/login.html";
            return null;
          }
          return res;
        } catch (err) {
          console.error("Fetch error:", err);
          showToast("Network error, please try again.", "error");
          return null;
        }
      }

      async function checkAuth() {
        const res = await fetchAPI("/auth/check");
        if (!res || !res.ok) {
          window.location.href = "/login.html";
          return;
        }
        const data = await res.json().catch(()=>null);
        if (data && data.user && data.user.id) {
          // store authenticated id for reliable comparisons later
          currentUser._id = data.user.id;
        }
      }

      async function fetchTeacherProfile() {
        const res = await fetchAPI("/teacher/profile");
        if (res && res.ok) {
          const data = await res.json();
          currentUser = data;
          document.getElementById("profilePreviewName").innerText =
            data.name || "Teacher";
          document.getElementById("profileAvatar").src =
            data.profile_picture_url || "./images/default-avatar.png";
          // School name and country display removed from this page
        }
      }

      function wireProfilePhotoUpload() {
        const avatarImg = document.getElementById("profileAvatar");
        const uploadInput = document.getElementById("profilePhotoInput");
        if (!avatarImg || !uploadInput) return;
        
        let cropper;
        const cropperModal = document.getElementById("cropper-modal");
        const cropperImage = document.getElementById("cropper-image");
        const cropAndSaveBtn = document.getElementById("crop-and-save-btn");
        const cancelCropBtn = document.getElementById("cancel-crop-btn");
        
        avatarImg.addEventListener("click", () => uploadInput.click());

        uploadInput.addEventListener("change", (e) => {
          const file = uploadInput.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            cropperImage.src = event.target.result;
            cropperModal.classList.remove("hidden");
            if(cropper) cropper.destroy();
            cropper = new Cropper(cropperImage, {
              aspectRatio: 1, viewMode: 1, dragMode: 'move', autoCropArea: 0.8,
              restore: false, guides: false, center: false, highlight: false,
              cropBoxMovable: false, cropBoxResizable: false, toggleDragModeOnDblclick: false,
            });
          };
          reader.readAsDataURL(file);
        });

        function closeCropperModal() {
          cropperModal.classList.add("hidden");
          if (cropper) cropper.destroy();
          uploadInput.value = "";
        }

        cancelCropBtn.addEventListener("click", closeCropperModal);

        cropAndSaveBtn.addEventListener("click", () => {
          if (!cropper) return;
          cropAndSaveBtn.disabled = true;
          cropAndSaveBtn.textContent = "Saving...";

          cropper.getCroppedCanvas({ width: 512, height: 512, imageSmoothingQuality: 'high' })
            .toBlob(async (blob) => {
              const formData = new FormData();
              formData.append("profilePhoto", blob, "profile.jpg");

              try {
                const res = await fetchAPI("/profile/upload-photo", { method: "POST", body: formData });
                if (!res || !res.ok) throw new Error("Upload failed");
                const data = await res.json();
                avatarImg.src = data.photoUrl || data.imageUrl;
                showToast("Profile photo updated!", "success");
              } catch (err) {
                showToast(err.message || "Error uploading picture", "error");
              } finally {
                closeCropperModal();
                cropAndSaveBtn.disabled = false;
                cropAndSaveBtn.textContent = "Crop & Save";
              }
            }, 'image/jpeg');
        });
      }

      function renderStudents(students = []) {
        const container = document.getElementById("studentsList");
        if (!container) return;
        if (!students.length) {
          container.innerHTML = `<div class="p-4 text-center text-gray-500">${translateText(
            "no_students"
          )}</div>`;
          return;
        }
        container.innerHTML = students
          .map(
            (s) => `
              <div class="p-4 flex items-center justify-between border-b last:border-b-0 hover:bg-gray-50">
                  <div class="flex items-center gap-3">
                      <img src="${
                        s.imageUrl || "./images/default-avatar.png"
                      }" alt="student avatar" class="h-10 w-10 rounded-full border object-cover"/>
                      <div>
                          <p class="font-medium text-gray-800">${s.firstname} ${
              s.lastname
            }</p>
                          <p class="text-sm text-gray-500">${translateText(
                            "grade"
                          )} ${s.grade || "-"}</p>
                      </div>
                  </div>
                  <span class="text-xs text-gray-400">${s.email}</span>
              </div>
          `
          )
          .join("");
      }

      async function fetchStudents() {
        try {
          const res = await fetchAPI("/teacher/assignable-students");
          if (!res || !res.ok) throw new Error("Failed to fetch assignable students");
          const data = await res.json();
          const myGrade = data.myGradeStudents || [];
          const otherGrade = data.otherStudents || [];
          const specialConnections = data.specialConnections || [];
          const availableGrades = data.availableGrades || [];
          studentsCache = [...myGrade, ...otherGrade, ...specialConnections];
          renderStudents(myGrade);
          populateSelects(studentsCache, myGrade, otherGrade, specialConnections, availableGrades);
        } catch (err) {
          console.error("Failed to fetch students:", err);
        }
      }

      function populateSelects(allStudents, myGrade = [], otherGrade = [], specialConnections = [], availableGrades = []) {
        const studentSelects = [
          document.getElementById("assignment-student-select"),
          document.getElementById("points-student-select"),
          document.getElementById("message-student-select"),
          document.getElementById("grant-student-select"),
        ];

        const toProgramOptions = () =>
          [...new Set(allStudents.map((s) => s.program))]
            .filter(Boolean)
            .map((p) => `<option value="${p}">${p}</option>`)
            .join("");

        const toOptions = (list) =>
          list
            .map(
              (s) =>
                `<option value="${s._id || s.id}">${s.firstname} ${
                  s.lastname
                } (${translateText("grade")} ${s.grade || "-"})</option>`
            )
            .join("");
        const toGradeOptions = () =>
          (availableGrades.length > 0 ? availableGrades : [...new Set(allStudents.map((s) => s.grade))].filter(Boolean))
            .map(
              (grade) =>
                `<option value="${grade}">${translateText(
                  "grade"
                )} ${grade}</option>`
            )
            .join("");

        studentSelects.forEach((select) => {
          if (!select) return;
          select.innerHTML = `
                  <optgroup label="${translateText("myClass")}">${toOptions(
            myGrade
          )}</optgroup>
                  <optgroup label="${translateText(
                    "other_students"
                  )}">${toOptions(otherGrade)}</optgroup>
              `;
        });

        // special connections select
        const specialSelect = document.getElementById("assignment-special-student-select");
        if (specialSelect) {
          specialSelect.innerHTML = specialConnections
            .map((s) => `<option value="${s._id}">${s.firstname} ${s.lastname} (${s.email || ''}) ‚Äî ${s.school ? (s.school.schoolName || s.school.name || s.school) : ''}</option>`)
            .join("");
        }

        const gradeSelects = [
          document.getElementById("assignment-grade-select"),
          document.getElementById("points-grade-select"),
          document.getElementById("message-grade-select"),
          document.getElementById("grant-grade-select"),
        ];
        gradeSelects.forEach((select) => {
          if (!select) return;
          select.innerHTML =
            `<option value="">${translateText("select_grade")}</option>` +
            toGradeOptions();
        });

        const programSelect = document.getElementById("assignment-program-select");
        if (programSelect) programSelect.innerHTML = `<option value="">${translateText("select_program")}</option>` + toProgramOptions();
      }

      async function fetchAssignedTasks() {
        const container = document.getElementById("assignedTasksList");
        if (!container) return;
        container.innerHTML = `<div class="p-4 text-gray-500">${translateText(
          "loading"
        )}...</div>`;

        const res = await fetchAPI("/teacher/assigned-tasks");
        if (res && res.ok) {
          const tasks = await res.json();
          if (!tasks.length) {
            container.innerHTML = `<div class="p-4 text-gray-500">${translateText(
              "no_assigned_tasks"
            )}</div>`;
            return;
          }
          container.innerHTML = tasks
            .map(
              (a) => `
                  <div class="p-4 border-b last:border-b-0">
                      <div class="flex justify-between items-start">
                          <div>
                              <p class="font-semibold">${a.title}</p>
                              <p class="text-gray-600 text-sm">${
                                a.description || ""
                              }</p>
                              <p class="text-gray-500 text-xs">${translateText(
                                "due"
                              )}: ${
                        a.due_date ? new Date(a.due_date).toLocaleString() : "N/A"
                      }</p>
                          </div>
                          <button class="edit-assignment-btn text-sm text-blue-600 hover:underline" data-assignment-id="${a._id}">Edit</button>
                      </div>
                  </div>
              `
            )
            .join("");

          container.querySelectorAll('.edit-assignment-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const assignment = tasks.find(t => t._id === btn.dataset.assignmentId);
              if (assignment) populateAssignmentFormForEdit(assignment);
            });
          });
        } else {
          container.innerHTML = `<div class="p-4 text-red-600">${translateText(
            "failed_load_tasks"
          )}</div>`;
        }
      }

      function populateAssignmentFormForEdit(assignment) {
        const form = document.getElementById('assignmentForm');
        if (!form) return;

        // Add a hidden input to store the assignment ID
        let idInput = form.querySelector('input[name="assignmentId"]');
        if (!idInput) {
          idInput = document.createElement('input');
          idInput.type = 'hidden';
          idInput.name = 'assignmentId';
          form.appendChild(idInput);
        }
        idInput.value = assignment._id;

        document.getElementById('assignmentTitle').value = assignment.title || '';
        const assignmentTextArea = document.getElementById('assignmentText');
        assignmentTextArea.value = assignment.description || '';
        // Manually trigger input event to update word count, etc.
        assignmentTextArea.dispatchEvent(new Event('input', { bubbles: true }));

        if (assignment.due_date) {
          document.getElementById('assignmentDueDate').value = new Date(assignment.due_date).toISOString().slice(0, 16);
        }

        // Reset recipient checkboxes
        document.querySelectorAll('input[name="assignmentRecipient"]').forEach(chk => chk.checked = false);

        // Select assigned students using backend/model field assigned_to_users
        if (Array.isArray(assignment.assigned_to_users) && assignment.assigned_to_users.length > 0) {
          document.querySelector('input[name="assignmentRecipient"][value="student"]').checked = true;
          const studentSelect = document.getElementById('assignment-student-select');
          Array.from(studentSelect.options).forEach(opt => {
            opt.selected = assignment.assigned_to_users.some(id => String(id) === String(opt.value));
          });
          document.getElementById('assignment-student-select-group').classList.remove('hidden');
        }

        document.getElementById('sendAssignmentButton').textContent = 'Update Assignment';
        document.getElementById('sendAssignmentButton').disabled = false;

        // Scroll to the form
        form.scrollIntoView({ behavior: 'smooth' });
      }

      async function fetchQuizSummaries() {
        const container = document.getElementById('quizSummaries');
        if (!container) return;
        container.innerHTML = '<div class="p-4 text-gray-500">Loading...</div>';
        try {
          const res = await fetchAPI("/teacher/quiz-summaries");
          if (!res || !res.ok) {
            let msg = 'Failed to fetch quiz summaries.';
            try {
              const errData = await res.json();
              msg = errData.message || msg;
            } catch {}
            throw new Error(msg);
          }
          const data = await res.json();
          if (!Array.isArray(data) || !data.length) {
            container.innerHTML = '<div class="p-4 text-gray-500">No quiz summaries.</div>';
            return;
          }
          container.innerHTML = data.map(q => `
            <div class="p-4 border rounded flex justify-between items-center">
              <div>
                <div class="font-semibold">${q.title}</div>
                <div class="text-gray-600 text-sm">Questions: ${q.questionsCount}</div>
              </div>
              <div class="text-right">
                <div class="text-sm text-gray-500">Submissions: ${q.submissionsCount}</div>
                <div class="text-lg font-bold text-blue-600">Avg: ${q.averageScore !== null ? (q.averageScore).toFixed(2) : 'N/A'}</div>
              </div>
            </div>
          `).join('');
        } catch (err) {
          container.innerHTML = `<div class="p-4 text-red-600">Error: ${err.message}</div>`;
        }
      }

      async function fetchMessages() {
        const container = document.getElementById("messagesList");
        if (!container) return;
        container.innerHTML = `<div class="p-4 text-gray-500">${translateText("loading")}...</div>`;

        const res = await fetchAPI("/messages");
        if (res && res.ok) {
          const messages = await res.json();
          if (!messages.length) {
            container.innerHTML = `<div class="p-4 text-gray-500">No messages found.</div>`;
            return;
          }
          container.innerHTML = messages.map(msg => {
            const isMe = msg.sender._id === currentUser._id;
            const other = isMe ? msg.recipient : msg.sender;
            const roleBadge = other.role === 'admin' ? '<span class="bg-red-100 text-red-800 text-xs px-2 py-0.5 rounded-full ml-2">Admin</span>' : '';
            
            return `
              <div class="p-3 rounded-lg border ${isMe ? 'bg-blue-50 border-blue-100 ml-8' : 'bg-white border-gray-200 mr-8'}">
                <div class="flex justify-between items-center mb-1">
                  <span class="font-bold text-sm text-gray-700 flex items-center">
                    ${isMe ? 'You' : (other.firstname + ' ' + other.lastname)} ${!isMe ? roleBadge : ''}
                  </span>
                  <span class="text-xs text-gray-400">${new Date(msg.createdAt).toLocaleString()}</span>
                </div>
                <p class="text-gray-800 text-sm">${msg.content}</p>
                ${!isMe ? `<button onclick="handleReply('${other._id}', '${other.firstname}')" class="text-xs text-blue-600 hover:underline mt-2">Reply</button>` : ''}
              </div>
            `;
          }).join("");
        } else {
          container.innerHTML = `<div class="p-4 text-red-600">Failed to load messages.</div>`;
        }
      }

      async function fetchFeedback() {
        const container = document.getElementById("feedbackList");
        if (!container) return;
        container.innerHTML = `<div class="p-4 text-gray-500">${translateText(
          "loading"
        )}...</div>`;

        const res = await fetchAPI("/teacher/feedback");
        if (res && res.ok) {
          const feedbacks = await res.json();
          if (!feedbacks.length) {
            container.innerHTML = `<div class="p-4 text-gray-500">${translateText(
              "no_feedback"
            )}</div>`;
            return;
          }
          container.innerHTML = feedbacks
            .map(
              (f) => `
                  <div class="p-4 border-b last:border-b-0">
                      <p class="font-medium">${f.student_email}</p>
                      <p class="text-gray-600 text-sm">${f.message}</p>
                      ${
                        f.file_name
                          ? `<p class="text-gray-500 text-xs">File: ${f.file_name}</p>`
                          : ""
                      }
                  </div>
              `
            )
            .join("");
        } else {
          container.innerHTML = `<div class="p-4 text-red-600">${translateText(
            "failed_load_feedback"
          )}</div>`;
        }
      }

      async function initCalendar() {
        const calendarEl = document.getElementById('calendar');
        if (!calendarEl) return;

        if (typeof FullCalendar === 'undefined' || !FullCalendar.Calendar) {
          console.warn('FullCalendar not available. Calendar will be disabled.');
          calendarEl.innerHTML = '<div class="p-4 text-sm text-gray-500">Calendar unavailable.</div>';
          return;
        }

        const res = await fetchAPI("/teacher/assigned-tasks");
        let events = [];
        if (res && res.ok) {
          const tasks = await res.json();
          events = tasks.map(t => ({
            title: t.title,
            start: t.due_date,
            url: '#'
          }));
        }

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          events: events
        });
        calendar.render();
      }

      async function fetchOverdueTasks() {
        const container = document.getElementById("overdueTasksList");
        if (!container) return;
        container.innerHTML = `<div class="p-4 text-gray-500">${translateText(
          "loading"
        )}...</div>`;

        const res = await fetchAPI("/teacher/overdue-tasks");
        if (res && res.ok) {
          const tasks = await res.json();
          if (!tasks.length) {
            container.innerHTML = `<div class="p-4 text-gray-500">${translateText(
              "no_overdue_tasks"
            )}</div>`;
            return;
          }
          
          // Refresh calendar events if calendar is initialized
          initCalendar();

          container.innerHTML = tasks
            .map(
              (t) => `
                  <div class="p-4 border-b last:border-b-0">
                      <p class="font-semibold">${t.title}</p>
                      <p class="text-gray-500 text-xs">${new Date(
                        t.due_date
                      ).toLocaleString()}</p>
                  </div>
              `
            )
            .join("");
        } else {
          container.innerHTML = `<div class="p-4 text-red-600">${translateText(
            "failed_load_overdue"
          )}</div>`;
        }
      }

      function wireCalendar() {
        const addTermBtn = document.getElementById("addTermButton");
        const saveCalendarBtn = document.getElementById("saveCalendarButton");
        const termsContainer = document.getElementById("termsContainer");
        const academicYearInput = document.getElementById("academicYear");
        const calendarMsg = document.getElementById("calendarMsg");

        const renderTerms = (terms) => {
          termsContainer.innerHTML = "";
          terms.forEach((term, index) => {
            const termDiv = document.createElement("div");
            termDiv.className =
              "p-4 border border-gray-300 rounded-lg shadow-sm";
            termDiv.innerHTML = `
                      <h3 class="font-semibold text-gray-700 mb-2">Term ${
                        index + 1
                      }</h3>
                      <input type="text" class="w-full p-2 mb-2 border border-gray-300 rounded-md term-name" placeholder="Term Name (e.g. Fall Term)" value="${
                        term.name || ""
                      }" />
                      <label class="block text-gray-600 text-sm mb-1">Start Date:</label>
                      <input type="date" class="w-full p-2 mb-2 border border-gray-300 rounded-md term-start-date" value="${
                        term.startDate || ""
                      }" />
                      <label class="block text-gray-600 text-sm mb-1">End Date:</label>
                      <input type="date" class="w-full p-2 mb-2 border border-gray-300 rounded-md term-end-date" value="${
                        term.endDate || ""
                      }" />
                      <button class="remove-term-button text-red-500 hover:text-red-700 text-sm mt-2">Remove</button>
                  `;
            termsContainer.appendChild(termDiv);
          });
          // also populate the term select for results
          const termSelect = document.getElementById("termSelect");
          if (termSelect) {
            termSelect.innerHTML = `<option value="">${translateText('selectTerm') || 'Select Term'}</option>` +
              terms
                .map(t => `<option value="${t.name || t.termName || ''}">${t.name || t.termName || ''}</option>`)
                .join('');
          }
        };

        const saveCalendar = async () => {
          const academicYear = academicYearInput.value;
          const terms = [];
          document
            .querySelectorAll("#termsContainer > div")
            .forEach((termDiv) => {
              const name = termDiv.querySelector(".term-name").value;
              const startDate = termDiv.querySelector(".term-start-date").value;
              const endDate = termDiv.querySelector(".term-end-date").value;
              if (name && startDate && endDate) {
                terms.push({ name, startDate, endDate });
              }
            });

          if (!academicYear || terms.length === 0) {
            calendarMsg.textContent = "Please fill in all fields.";
            calendarMsg.className =
              "text-center font-semibold mt-4 text-red-600";
            return;
          }

          const res = await fetchAPI("/teacher/calendar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ academicYear, terms }),
          });

          if (res && res.ok) {
            calendarMsg.textContent = "Calendar saved successfully!";
            calendarMsg.className =
              "text-center font-semibold mt-4 text-green-600";
            // refresh term select and optionally results
            const calendarRes = await res.json().catch(()=>null);
            // attempt to reload calendar from server to get canonical names
            await loadCalendar();
            if (typeof fetchCalendarResults === "function") fetchCalendarResults();
          } else {
            calendarMsg.textContent = "Failed to save calendar.";
            calendarMsg.className =
              "text-center font-semibold mt-4 text-red-600";
          }
        };

        async function loadCalendar() {
          const res = await fetchAPI(`/teacher/calendar`);
          if (res && res.ok) {
            const data = await res.json();
            if (data.academicYear) document.getElementById("academicYear").value = data.academicYear;
            if (document.getElementById("resultsAcademicYear")) document.getElementById("resultsAcademicYear").value = data.academicYear || '';
            if (data.terms && data.terms.length) renderTerms(data.terms);
          }
        }

        document.getElementById("loadResultsButton")?.addEventListener("click", async () => {
          await fetchCalendarResults();
        });

        // expose fetchCalendarResults globally so other pieces can call it
        window.fetchCalendarResults = async function fetchCalendarResults() {
          const academicYear = document.getElementById("resultsAcademicYear").value || document.getElementById("academicYear").value;
          const termName = document.getElementById("termSelect").value;
          const resultsContainer = document.getElementById("termResultsContainer");
          if (!academicYear || !termName) {
            resultsContainer.innerHTML = `<div class="p-4 text-gray-500">${translateText('selectTerm') || 'Please select an academic year and term.'}</div>`;
            return;
          }
          resultsContainer.innerHTML = `<div class="p-4 text-gray-500">${translateText('fetchingResults') || 'Loading results...'}</div>`;

          try {
            const res = await fetchAPI(`/teacher/calendar/results?academicYear=${encodeURIComponent(academicYear)}&termName=${encodeURIComponent(termName)}`);
            if (!res || !res.ok) {
              const err = res ? await res.json().catch(()=>({message:'Failed to fetch results'})) : { message: 'Network error' };
              resultsContainer.innerHTML = `<div class="p-4 text-red-600">${err.message || translateText('noResults') || 'No results available.'}</div>`;
              return;
            }
            const data = await res.json();
            if (!data.results || !data.results.length) {
              resultsContainer.innerHTML = `<div class="p-4 text-gray-500">${translateText('noResults') || 'No results for selected term.'}</div>`;
              return;
            }

            resultsContainer.innerHTML = `
              <div class="overflow-auto">
                <table class="min-w-full text-sm">
                  <thead class="bg-gray-100 text-left">
                    <tr>
                      <th class="p-2">${translateText('position') || 'Pos'}</th>
                      <th class="p-2">${translateText('student') || 'Student'}</th>
                      <th class="p-2">${translateText('assignmentAvg') || 'Assignment Avg'}</th>
                      <th class="p-2">${translateText('quizAvg') || 'Quiz Avg'}</th>
                      <th class="p-2">${translateText('rewardPoints') || 'Reward Points'}</th>
                      <th class="p-2">${translateText('activity') || 'Activity'}</th>
                      <th class="p-2">${translateText('score') || 'Score'}</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${data.results.map(r => `
                      <tr class="border-b">
                        <td class="p-2">${r.position}</td>
                        <td class="p-2">${r.student.firstname} ${r.student.lastname}</td>
                        <td class="p-2">${r.assignmentAvg}</td>
                        <td class="p-2">${r.quizAvg}</td>
                        <td class="p-2">${r.rewardPoints}</td>
                        <td class="p-2">${r.activityCount}</td>
                        <td class="p-2 font-semibold">${r.score}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `;
          } catch (err) {
            console.error('Results fetch error', err);
            resultsContainer.innerHTML = `<div class="p-4 text-red-600">${translateText('noResults') || 'No results available.'}</div>`;
          }
        };

        // initial load
        loadCalendar();

        const fetchCalendar = async () => {
          const res = await fetchAPI("/teacher/calendar");
          if (res && res.ok) {
            const { academicYear, terms } = await res.json();
            academicYearInput.value = academicYear || "";
            renderTerms(terms || []);
          }
        };

        addTermBtn?.addEventListener("click", () => {
          renderTerms([
            ...Array.from(termsContainer.children).map((termDiv) => ({
              name: termDiv.querySelector(".term-name").value,
              startDate: termDiv.querySelector(".term-start-date").value,
              endDate: termDiv.querySelector(".term-end-date").value,
            })),
            {},
          ]);
        });

        saveCalendarBtn?.addEventListener("click", saveCalendar);

        termsContainer?.addEventListener("click", (e) => {
          if (e.target.classList.contains("remove-term-button")) {
            e.target.closest("div").remove();
          }
        });

        fetchCalendar();
      }

      const specialStudentSelectGroup = document.createElement("div");
      specialStudentSelectGroup.id = "assignment-special-student-select-group";
      specialStudentSelectGroup.className = "hidden";
      specialStudentSelectGroup.innerHTML = `
  <label for="assignment-special-student-select" class="block text-gray-700 font-bold mb-2">
    Select Special Student(s):
  </label>
  <div class="border border-gray-300 rounded-lg overflow-hidden mb-4">
      <select id="assignment-special-student-select" class="w-full p-3 bg-white text-gray-800 focus:outline-none max-h-48 overflow-auto" multiple></select>
  </div>
`;

      const assignmentForm = document.getElementById("assignmentForm");
      const recipientBlock = assignmentForm?.querySelector('label[data-i18n="selectRecipient"]')?.parentElement;
      if (assignmentForm && recipientBlock && recipientBlock.parentElement === assignmentForm) {
        // Insert after the recipient selection block for consistent layout
        assignmentForm.insertBefore(specialStudentSelectGroup, recipientBlock.nextElementSibling);
      } else if (assignmentForm) {
        // Fallback: append near the top of the form
        assignmentForm.insertBefore(specialStudentSelectGroup, assignmentForm.firstChild);
      } else {
        console.warn("Assignment form not found; skipping special student select group insertion.");
      }

      async function loadSpecialStudents() {
        try {
          const res = await fetchAPI("/special-links/list");
          if (!res || !res.ok) throw new Error("Failed to load special students");
          const data = await res.json();
          const select = document.getElementById(
            "assignment-special-student-select"
          );
          select.innerHTML = "";

          if (!data.links || data.links.length === 0) {
            select.innerHTML = `<option disabled>No special students available</option>`;
            return;
          }

          data.links
            .filter((l) => l.partnerRole === "student")
            .forEach((student) => {
              const opt = document.createElement("option");
              opt.value = student.partnerId;
              opt.textContent = `${student.partnerName} (${student.partnerEmail})`;
              select.appendChild(opt);
            });
        } catch (err) {
          console.error("Failed to load special students:", err);
        }
      }

      function wireDashboardForms() {
        const sendAssignmentButton = document.getElementById(
          "sendAssignmentButton"
        );
        const addPointsButton = document.getElementById("addPointsButton");
        const sendMessageButton = document.getElementById("sendMessageButton");
        const assignmentForm = document.getElementById("assignmentForm");
        const pointsForm = document.getElementById("pointsForm");
        const messageForm = document.getElementById("messageForm");
        const assignmentRecipients = document.querySelectorAll(
          'input[name="assignmentRecipient"]'
        );
        const pointsRecipients = document.querySelectorAll(
          'input[name="pointsRecipient"]'
        );
        const messageRecipients = document.querySelectorAll(
          'input[name="messageRecipient"]'
        );
        const assignmentStudentSelectGroup = document.getElementById(
          "assignment-student-select-group"
        );
        const assignmentGradeSelectGroup = document.getElementById(
          "assignment-grade-select-group"
        );
        const assignmentProgramSelectGroup = document.getElementById(
          "assignment-program-select-group"
        );
        const pointsStudentSelectGroup = document.getElementById(
          "points-select-group"
        );
        const pointsGradeSelectGroup = document.getElementById(
          "points-grade-select-group"
        );
        const messageStudentSelectGroup = document.getElementById(
          "message-select-group"
        );
        const messageGradeSelectGroup = document.getElementById(
          "message-grade-select-group"
        );

        const updateFormVisibility = (
          recipientType,
          studentGroup,
          gradeGroup,
          programGroup,
          specialGroup
        ) => {
          const hide = (el) => el && el.classList && el.classList.add("hidden");
          const show = (el) => el && el.classList && el.classList.remove("hidden");

          if (recipientType === "student" || recipientType === "single" || recipientType === "multiple") {
            show(studentGroup);
            hide(gradeGroup);
            hide(programGroup);
            hide(specialGroup);
          } else if (recipientType === "special_student") {
            show(specialGroup);
            hide(studentGroup);
            hide(gradeGroup);
            hide(programGroup);
            loadSpecialStudents(); // load on demand
          } else if (recipientType === "otherGrade") {
            show(gradeGroup);
            hide(studentGroup);
            hide(programGroup);
            hide(specialGroup);
          } else if (recipientType === "program") {
            show(programGroup);
            hide(studentGroup);
            hide(gradeGroup);
            hide(specialGroup);
          } else {
            hide(studentGroup);
            hide(gradeGroup);
            hide(programGroup);
            hide(specialGroup);
          }
        };

        assignmentRecipients.forEach((input) => {
          input.addEventListener("change", (e) => {
            updateFormVisibility(
              e.target.value,
              assignmentStudentSelectGroup,
              assignmentGradeSelectGroup,
              assignmentProgramSelectGroup,
              specialStudentSelectGroup
            );
            sendAssignmentButton.disabled = !Array.from(
              assignmentRecipients
            ).some((r) => r.checked);
          });
        });

        pointsRecipients.forEach((input) => {
          input.addEventListener("change", (e) => {
            updateFormVisibility(
              e.target.value,
              pointsStudentSelectGroup,
              pointsGradeSelectGroup
            );
          });
        });

        messageRecipients.forEach((input) => {
          input.addEventListener("change", (e) => {
            updateFormVisibility(
              e.target.value,
              messageStudentSelectGroup,
              messageGradeSelectGroup
            );
          });
        });

        const validateAssignmentForm = () => {
          const hasRecipient = Array.from(assignmentRecipients).some(
            (r) => r.checked
          );
          const hasTitle =
            document.getElementById("assignmentTitle").value.trim() !== "";
          const hasContent =
            document.getElementById("assignmentText").value.trim() !== "" ||
            document.getElementById("assignmentFile").files.length > 0;
          sendAssignmentButton.disabled = !(
            hasRecipient &&
            hasTitle &&
            hasContent
          );
        };

        document
          .getElementById("assignmentTitle")
          ?.addEventListener("input", validateAssignmentForm);
        document
          .getElementById("assignmentText")
          ?.addEventListener("input", validateAssignmentForm);
        document
          .getElementById("assignmentFile")
          ?.addEventListener("change", validateAssignmentForm);

        assignmentRecipients.forEach((input) =>
          input.addEventListener("change", validateAssignmentForm)
        );

        const validatePointsForm = () => {
          const selectedStudent =
            document.getElementById("points-student-select").value !== "";
          const pointsInput =
            document.getElementById("pointsInput").value.trim() !== "";
          addPointsButton.disabled = !(selectedStudent && pointsInput);
        };
        document
          .getElementById("points-student-select")
          ?.addEventListener("change", validatePointsForm);
        document
          .getElementById("pointsInput")
          ?.addEventListener("input", validatePointsForm);

        const validateMessageForm = () => {
          const selectedStudent =
            document.getElementById("message-student-select").value !== "";
          const messageText =
            document.getElementById("messageText").value.trim() !== "";
          sendMessageButton.disabled = !(selectedStudent && messageText);
        };
        document
          .getElementById("message-student-select")
          ?.addEventListener("change", validateMessageForm);
        document
          .getElementById("messageText")
          ?.addEventListener("input", validateMessageForm);

        document
          .getElementById("assignmentFile")
          ?.addEventListener("change", (e) => {
            const fileName = e.target.files[0]?.name || "No file selected.";
            document.getElementById("fileName").textContent = fileName;
            document
              .getElementById("clearFileButton")
              .classList.toggle("hidden", e.target.files.length === 0);
          });

        document
          .getElementById("clearFileButton")
          ?.addEventListener("click", () => {
            const fileInput = document.getElementById("assignmentFile");
            fileInput.value = "";
            document.getElementById("fileName").textContent =
              "No file selected.";
            document.getElementById("clearFileButton").classList.add("hidden");
            validateAssignmentForm();
          });

        document
          .getElementById("assignmentText")
          ?.addEventListener("input", (e) => {
            const wordCount = e.target.value
              .split(/\s+/)
              .filter(Boolean).length;
            document.getElementById(
              "wordCountText"
            ).textContent = `Word count: ${wordCount}`;
          });

        assignmentForm?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const assignmentId = assignmentForm.querySelector('input[name="assignmentId"]')?.value;
          const isEditing = !!assignmentId;
          const recipients = Array.from(assignmentRecipients)
            .filter((r) => r.checked)
            .map((r) => r.value);
          if (recipients.length === 0)
            return showToast("Please select a recipient.", "warning");

          const originalFormData = new FormData(assignmentForm);
          const fileInput = document.getElementById("assignmentFile");
          const file = fileInput.files[0];

          // Normalize recipients: transform "myClass" to backend-supported "class"
          const normalizedRecipients = recipients.map(r => r === "myClass" ? "class" : r);

          const rawDue = originalFormData.get("assignmentDueDate");
          const dueISO = rawDue ? new Date(rawDue).toISOString() : "";

          const assignmentData = {
            title: (originalFormData.get("assignmentTitle") || "").toString().trim(),
            description: (originalFormData.get("assignmentText") || "").toString().trim(),
            due_date: dueISO,
            assigned_to_users: normalizedRecipients.includes("student")
              ? Array.from(
                  document.getElementById("assignment-student-select")
                    .selectedOptions
                ).map((opt) => opt.value)
              : [],
            assigned_to_other_grades: normalizedRecipients.includes("otherGrade")
              ? [Number(document.getElementById("assignment-grade-select").value)]
              : [],
            assigned_to_programs: normalizedRecipients.includes("program")
              ? [document.getElementById("assignment-program-select").value].filter(Boolean)
              : [],
            recipientType: normalizedRecipients.find(r => ["class","otherGrade","program","special_student","student"].includes(r)) || null,
            grade: normalizedRecipients.includes("otherGrade") ? Number(document.getElementById("assignment-grade-select").value) : null,
            specialStudentIds: normalizedRecipients.includes("special_student")
              ? Array.from(
                  document.getElementById("assignment-special-student-select")
                    .selectedOptions
                ).map((opt) => opt.value)
              : [],
          };

          // Merge special students into assigned_to_users
          if (assignmentData.specialStudentIds?.length) {
            assignmentData.assigned_to_users = [
              ...(assignmentData.assigned_to_users || []),
              ...assignmentData.specialStudentIds,
            ];
          }
          delete assignmentData.specialStudentIds;

          // De-duplicate recipients to avoid duplicates in backend
          if (assignmentData.assigned_to_users?.length) {
            assignmentData.assigned_to_users = Array.from(new Set(assignmentData.assigned_to_users.map(String)));
          }

          // Normalize unsupported or missing recipientType to "student"
          if (!assignmentData.recipientType && (assignmentData.assigned_to_users?.length || 0) > 0) {
            assignmentData.recipientType = "student";
          }
          if (assignmentData.recipientType === "special_student") {
            assignmentData.recipientType = "student";
          }

          // Build a clean FormData matching backend expectations
          const formData = new FormData();
          if (assignmentData.title) formData.set("title", assignmentData.title);
          if (assignmentData.description) formData.set("description", assignmentData.description);
          if (assignmentData.due_date) formData.set("due_date", assignmentData.due_date);
          if (assignmentData.recipientType) formData.set("recipientType", assignmentData.recipientType);
          if (assignmentData.recipientType === "otherGrade" && typeof assignmentData.grade === "number" && !Number.isNaN(assignmentData.grade)) {
            formData.set("grade", String(assignmentData.grade));
          }
          // Include both assigned_to_users and alias assigned_to for backend compatibility
          (assignmentData.assigned_to_users || []).forEach(v => {
            formData.append("assigned_to_users", v);
            formData.append("assigned_to", v);
          });
          // Do not append empty assigned_to_grades; backend defaults this safely
          (assignmentData.assigned_to_other_grades || []).forEach(v => formData.append("assigned_to_other_grades", String(v)));
          (assignmentData.assigned_to_programs || []).forEach(v => formData.append("assigned_to_programs", v));

          // Only include a new file if chosen
          if (file) {
            formData.append("file", file);
          }

          const endpoint = isEditing ? `/teacher/assignments/${assignmentId}` : "/teacher/assignments";
          const method = isEditing ? "PATCH" : "POST";

          // Final client-side validation to avoid backend 500 for missing fields
          if (!assignmentData.title) {
            showToast("Please enter an assignment title.", "warning");
            return;
          }
          if (!assignmentData.due_date) {
            showToast("Please select a valid due date.", "warning");
            return;
          }
          if (!file && !assignmentData.description) {
            showToast("Please add details or attach a file.", "warning");
            return;
          }

          try {
            const res = await fetchAPI(endpoint, {
              method: method,
              body: formData,
            });

            if (res && res.ok) {
              showToast(isEditing ? "Assignment updated successfully!" : "Assignment sent successfully!", "success");
              assignmentForm.reset();
              sendAssignmentButton.disabled = true;
              document.getElementById("fileName").textContent =
                "No file selected.";
              document
                .getElementById("clearFileButton")
                .classList.add("hidden");
              if (isEditing) {
                assignmentForm.querySelector('input[name="assignmentId"]')?.remove();
                document.getElementById('sendAssignmentButton').textContent = 'Send Assignment';
              }
              fetchAssignedTasks();
            } else {
              let result = { message: "Network error" };
              try { result = res ? await res.json() : result; } catch {
                // fallback to text if JSON parsing fails
                try {
                  const txt = await res.text();
                  result = { message: txt || result.message };
                } catch {}
              }
              console.error("Assignment submit error:", result, 
                "\nPayload preview:", {
                  title: assignmentData.title,
                  description: assignmentData.description?.slice(0, 120),
                  due_date: assignmentData.due_date,
                  recipientType: assignmentData.recipientType,
                  assigned_to_users: assignmentData.assigned_to_users
                });
              showToast(result.message || "Failed to send assignment.", "error");
            }
          } catch (error) {
            console.error("Assignment submit unexpected error:", error);
            showToast("Unexpected error occurred.", "error");
          }
        });

        addPointsButton?.addEventListener("click", async () => {
          const points = document.getElementById("pointsInput").value;
          const reason = document.getElementById("reasonText").value;
          const recipientType = document.querySelector(
            'input[name="pointsRecipient"]:checked'
          ).value;

          let studentIds = [];
          let grade = null;
          let message = null;

          if (recipientType === "single") {
            studentIds.push(
              document.getElementById("points-student-select").value
            );
          } else if (recipientType === "multiple") {
            studentIds = Array.from(
              document.getElementById("points-student-select").selectedOptions
            ).map((opt) => opt.value);
          } else if (recipientType === "class") {
            studentIds = studentsCache
              .filter((s) => (currentUser.teacherGrade || []).includes(String(s.grade)))
              .map((s) => s._id || s.id);
            message = `You've been awarded ${points} points for ${
              reason || "general good performance"
            }.`;
          } else if (recipientType === "otherGrade") {
            grade = document.getElementById("points-grade-select").value;
            message = `You've been awarded ${points} points for ${
              reason || "general good performance"
            }.`;
          }

          if (
            !points ||
            (recipientType !== "class" &&
              recipientType !== "otherGrade" &&
              studentIds.length === 0)
          ) {
            return showToast(
              "Please select a student and enter points.",
              "warning"
            );
          }

          try {
            const res = await fetchAPI("/advanced-goals/teacher/add-points", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                assigned_to_users: studentIds,
                assigned_to_grades: grade ? [Number(grade)] : [],
                points: Number(points),
                reason,
                message,
                recipientType,
              }),
            });
            if (res && res.ok) {
              showToast("Points added successfully!", "success");
              document.getElementById("pointsInput").value = "";
              document.getElementById("reasonText").value = "";
              addPointsButton.disabled = true;
            } else {
              const error = await res.json();
              showToast(error.message || "Failed to add points.", "error");
            }
          } catch (error) {
            showToast("An unexpected error occurred.", "error");
            console.error(error);
          }
        });

        // Grant Rewards functionality
        const grantRecipients = document.querySelectorAll('input[name="grantRecipient"]');
        const grantStudentSelectGroup = document.getElementById("grant-select-group");
        const grantGradeSelectGroup = document.getElementById("grant-grade-select-group");
        const grantRewardsButton = document.getElementById("grantRewardsButton");

        const validateGrantForm = () => {
          const recipientType = document.querySelector('input[name="grantRecipient"]:checked')?.value;
          const selectedStudents = Array.from(document.getElementById("grant-student-select").selectedOptions).map(o => o.value);
          const grantType = document.getElementById("grantType").value;
          const points = document.getElementById("grantPoints").value;

          if ((recipientType === "single" || recipientType === "multiple") && selectedStudents.length === 0) {
            grantRewardsButton.disabled = true;
            return;
          }

          if (!grantType) {
            grantRewardsButton.disabled = true;
            return;
          }

          grantRewardsButton.disabled = false;
        };

        grantRecipients.forEach((input) => {
          input.addEventListener("change", (e) => {
            updateFormVisibility(
              e.target.value,
              grantStudentSelectGroup,
              grantGradeSelectGroup
            );
            validateGrantForm();
          });
        });

        document.getElementById("grant-student-select")?.addEventListener("change", validateGrantForm);
        document.getElementById("grantType")?.addEventListener("change", validateGrantForm);
        document.getElementById("grantPoints")?.addEventListener("input", validateGrantForm);
        document.getElementById("grantDescription")?.addEventListener("input", validateGrantForm);

        grantRewardsButton?.addEventListener("click", async () => {
          const recipientType = document.querySelector('input[name="grantRecipient"]:checked')?.value;
          let studentIds = [];
          if (recipientType === "single" || recipientType === "multiple") {
            studentIds = Array.from(document.getElementById("grant-student-select").selectedOptions).map(o => o.value);
          } else if (recipientType === "class") {
            studentIds = studentsCache.filter(s => (currentUser.teacherGrade || []).includes(String(s.grade))).map(s => s._id || s.id);
          } else if (recipientType === "otherGrade") {
            const grade = document.getElementById("grant-grade-select").value;
            studentIds = studentsCache.filter(s => String(s.grade) === String(grade)).map(s => s._id || s.id);
          }

          if (!studentIds.length) return showToast("Please select at least one student.", "warning");

          const type = document.getElementById("grantType").value;
          const points = Number(document.getElementById("grantPoints").value) || 0;
          const description = document.getElementById("grantDescription").value || "";

          const grants = studentIds.map(id => ({ userId: id, type, points, description }));

          try {
            const res = await fetchAPI("/teacher/calendar/grant", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ grants }),
            });
            if (res && res.ok) {
              showToast(translateText('rewardGrantedSuccess') || "Rewards granted successfully!", "success");
              // reset form
              document.getElementById("grantDescription").value = "";
              document.getElementById("grantPoints").value = "";
              document.getElementById("grant-student-select").selectedIndex = -1;
              grantRewardsButton.disabled = true;
              // optionally refresh calendar results if UI present
              if (typeof fetchCalendarResults === "function") fetchCalendarResults();
            } else {
              const err = await res.json();
              showToast(err.message || translateText('rewardGrantedError') || "Failed to grant rewards.", "error");
            }
          } catch (error) {
            console.error("Grant error:", error);
            showToast("An unexpected error occurred.", "error");
          }
        });

        sendMessageButton?.addEventListener("click", async () => {
          const message = document.getElementById("messageText").value;
          const recipientType = document.querySelector(
            'input[name="messageRecipient"]:checked'
          ).value;

          let studentIds = [];
          let grade = null;

          if (recipientType === "single") {
            studentIds.push(
              document.getElementById("message-student-select").value
            );
          } else if (recipientType === "multiple") {
            studentIds = Array.from(
              document.getElementById("message-student-select").selectedOptions
            ).map((opt) => opt.value);
          } else if (recipientType === "class") {
            studentIds = studentsCache
              .filter((s) => (currentUser.teacherGrade || []).includes(String(s.grade)))
              .map((s) => s._id || s.id);
          } else if (recipientType === "otherGrade") {
            grade = document.getElementById("message-grade-select").value;
          }

          if (
            !message ||
            (recipientType !== "class" &&
              recipientType !== "otherGrade" &&
              studentIds.length === 0)
          ) {
            return showToast(
              "Please select a recipient and enter a message.",
              "warning"
            );
          }

          try {
            const res = await fetchAPI("/teacher/message", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                assigned_to_users: studentIds,
                assigned_to_grades: grade ? [Number(grade)] : [],
                message,
                recipientType,
              }),
            });
            if (res && res.ok) {
              showToast("Message sent successfully!", "success");
              document.getElementById("messageText").value = "";
              sendMessageButton.disabled = true;
            } else {
              const error = await res.json();
              showToast(error.message || "Failed to send message.", "error");
            }
          } catch (error) {
            showToast("An unexpected error occurred.", "error");
            console.error(error);
          }
        });
      }

      document
        .getElementById("logoutButton")
        ?.addEventListener("click", async () => {
          const res = await fetchAPI("/auth/logout", { method: "POST" });
          if (res && res.ok) {
            window.location.href = "/login.html";
          } else {
            showToast("Logout failed. Please try again.", "error");
          }
        });

      document
        .getElementById("profile-menu-button")
        ?.addEventListener("click", () => {
          const menu = document.getElementById("profile-dropdown-menu");
          const isExpanded = menu.classList.contains("scale-100");
          if (isExpanded) {
            menu.classList.remove("scale-100", "opacity-100");
            menu.classList.add("scale-95", "opacity-0");
            setTimeout(() => menu.classList.add("hidden"), 300);
          } else {
            menu.classList.remove("hidden");
            setTimeout(() => {
              menu.classList.remove("scale-95", "opacity-0");
              menu.classList.add("scale-100", "opacity-100");
            }, 10);
          }
        });

      document.addEventListener("click", (e) => {
        const menu = document.getElementById("profile-dropdown-menu");
        const button = document.getElementById("profile-menu-button");
        if (
          menu &&
          button &&
          !menu.contains(e.target) &&
          !button.contains(e.target)
        ) {
          menu.classList.remove("scale-100", "opacity-100");
          menu.classList.add("scale-95", "opacity-0");
          setTimeout(() => menu.classList.add("hidden"), 300);
        }
      });
      
      // Mobile Menu Logic
      const menuBtn = document.getElementById('menu-btn');
      const menuModal = document.getElementById('menu-modal');
      const menuContent = document.getElementById('menu-content');
      const closeMenuBtn = document.getElementById('close-menu-btn');
      const mobileLogoutBtn = document.getElementById('mobile-logout-btn');

      menuBtn?.addEventListener('click', () => {
        menuModal.classList.remove('hidden');
        setTimeout(() => menuContent.classList.remove('-translate-x-full'), 10);
      });

      const closeMenu = () => {
        menuContent.classList.add('-translate-x-full');
        setTimeout(() => menuModal.classList.add('hidden'), 300);
      };

      closeMenuBtn?.addEventListener('click', closeMenu);
      menuModal?.addEventListener('click', (e) => {
        if(e.target === menuModal) closeMenu();
      });

      mobileLogoutBtn?.addEventListener('click', () => document.getElementById('logoutButton').click());

      document.getElementById("removeProfilePhotoBtn")?.addEventListener("click", async () => {
        // Backend does not implement DELETE /profile/photo; avoid 404s
        showToast("Removing profile photo is not available yet.", "info");
      });

      const langSelect = document.getElementById("language-switcher");
      const mobileLangSelect = document.getElementById("mobile-language-select");
      
      // Set initial values
      if (langSelect) langSelect.value = currentLang;
      if (mobileLangSelect) mobileLangSelect.value = currentLang;

      if(mobileLangSelect) {
          mobileLangSelect.addEventListener("change", (e) => {
              langSelect.value = e.target.value;
              langSelect.dispatchEvent(new Event('change'));
          });
      }
      
      langSelect
        .addEventListener("change", async (e) => {
          currentLang = e.target.value;
          localStorage.setItem("lang", currentLang);
          await loadTranslations(currentLang);
          applyTranslations();
          fetchStudents();
          fetchAssignedTasks();
          fetchFeedback();
          fetchOverdueTasks();
        });

      // --- Push Notification Logic ---
      function urlBase64ToUint8Array(base64String) {
          const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
          const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
          const rawData = window.atob(base64);
          const outputArray = new Uint8Array(rawData.length);
          for (let i = 0; i < rawData.length; ++i) {
              outputArray[i] = rawData.charCodeAt(i);
          }
          return outputArray;
      }

      async function isUserSubscribedToPush() {
          if (!('serviceWorker' in navigator)) return false;
          const reg = await navigator.serviceWorker.ready;
          const subscription = await reg.pushManager.getSubscription();
          return !!subscription;
      }

      function updateNotificationBtn(isSubscribed) {
          const btn = document.getElementById('notification-btn');
          const icon = document.getElementById('notification-btn-icon');
          const text = document.getElementById('notification-btn-text');
          if (!btn || !icon || !text) return;
          if (isSubscribed) {
              btn.classList.add('bg-green-200/70');
              icon.textContent = 'üîî';
              text.textContent = 'Subscribed';
          } else {
              btn.classList.remove('bg-green-200/70');
              icon.textContent = 'üîï';
              text.textContent = 'Subscribe';
          }
      }

      async function subscribeUserToPush() {
          if (!('serviceWorker' in navigator)) return;
          try {
              await navigator.serviceWorker.register('/sw.js');
              const reg = await navigator.serviceWorker.ready;
              if (Notification.permission === 'default') {
                  await Notification.requestPermission();
              }
              if (Notification.permission !== 'granted') {
                  showToast('Push notification permission denied.', 'warning');
                  return;
              }
              const subscription = await reg.pushManager.subscribe({
                  userVisibleOnly: true,
                  applicationServerKey: urlBase64ToUint8Array('BIiReZmmNOxbUaqVrIob40QBGzO_CN5FcDvUlyx8_13PRxIC0Ru46KDW3VYRjJUQquvud5FSvIhWgvtgbjuP0fA'),
              });
              await fetchAPI('/push/subscribe', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(subscription) });
              showToast('Subscribed to notifications!', 'success');
              updateNotificationBtn(true);
          } catch (err) {
              showToast('Failed to subscribe to notifications.', 'error');
              console.error('Push subscription failed:', err);
              updateNotificationBtn(false);
          }
      }

      async function unsubscribeUserFromPush() {
          if (!('serviceWorker'in navigator)) return;
          const reg = await navigator.serviceWorker.ready;
          const subscription = await reg.pushManager.getSubscription();
          if (subscription) {
              await subscription.unsubscribe();
              // Also notify backend if you have an endpoint for it
              // await fetchAPI('/push/unsubscribe', { method: 'POST', body: JSON.stringify({ endpoint: subscription.endpoint }) });
              showToast('Unsubscribed from notifications.', 'info');
              updateNotificationBtn(false);
          }
      }

      // --- Init ---
      window.addEventListener("load", async () => {
          await checkAuth();
          await fetchTeacherProfile();
          await fetchStudents();
          await fetchAssignedTasks();
          await fetchQuizSummaries();
          await fetchFeedback();
          await fetchOverdueTasks();
          await fetchMessages();
          initCalendar();
          wireDashboardForms();
          wireCalendar();
          hideLoadingOverlay();
          wireProfilePhotoUpload();
          await applyTranslations(currentLang);

          const notificationBtn = document.getElementById('notification-btn');
          if (notificationBtn) {
              isUserSubscribedToPush().then(updateNotificationBtn);
              notificationBtn.addEventListener('click', async () => {
                  const isSubscribed = await isUserSubscribedToPush();
                  if (isSubscribed) {
                      await unsubscribeUserFromPush();
                  } else {
                      await subscribeUserToPush();
                  }
              });
          }
      });
    </script>
  </body>
</html>
