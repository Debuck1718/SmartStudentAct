<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="dashboardTitle">Teacher Dashboard</title>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWMR745QHX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag("js", new Date());
    gtag("config", "G-EWMR745QHX");
  </script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="./images/icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
    body { font-family: "Inter", sans-serif; }

    .spinner {
      border: 4px solid rgba(0,0,0,0.1);
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 32px; height: 32px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    .custom-file-input::-webkit-file-upload-button { visibility: hidden; }
    .custom-file-input::before {
      content: "ğŸ“ Pick Document/File";
      display: inline-block;
      background-color: #2563eb; color: #fff; font-weight: 600;
      padding: 10px 14px; border-radius: 8px; cursor: pointer;
    }
    .custom-file-input:hover::before { background-color: #1d4ed8; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen antialiased">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-gray-200 bg-opacity-75 z-[999]">
    <div class="text-center p-6 bg-white rounded-xl shadow-lg">
      <div class="spinner mx-auto mb-4"></div>
      <p class="text-lg text-gray-700 font-medium" data-i18n="loadingMessage">
        Loading teacher dashboard...
      </p>
    </div>
  </div>

  <div class="container mx-auto p-4 sm:p-6 lg:p-8 space-y-6">

    <!-- Header -->
    <header class="flex flex-col sm:flex-row justify-between items-center py-4 border-b border-gray-200">
      <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0" data-i18n="dashboardTitle">
        ğŸ“š Teacher Dashboard
      </h1>

      <div class="flex items-center space-x-6">
        <select id="language-select"
                class="rounded-full px-4 py-2 bg-white text-gray-700 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option value="en">EN</option>
          <option value="fr">FR</option>
          <option value="es">ES</option>
          <option value="tr">TR</option>
          <option value="ar">AR</option>
          <option value="ru">RU</option>
        </select>

        <div class="relative inline-block text-left">
          <button id="profile-menu-button" type="button"
                  class="flex items-center space-x-2 rounded-full px-4 py-2 hover:bg-gray-200 transition-all duration-300 focus:outline-none">
            <img id="profileAvatar" src="./images/default-avatar.png" alt="Profile Avatar"
                 class="h-10 w-10 rounded-full object-cover border border-gray-300" />
            <span id="profilePreviewName" class="hidden sm:inline font-medium text-gray-700">Teacher</span>
            <i class="fas fa-chevron-down text-gray-400"></i>
          </button>

          <div id="profile-dropdown-menu"
               class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 overflow-hidden transition-all duration-300 origin-top-right transform scale-95 opacity-0">
            <a href="./AI-Essay-Checker.html" class="block px-4 py-2 text-sm hover:bg-gray-100 transition" data-i18n="aiChecker">ğŸ¤– AI Essay Checker</a>
            <a href="./quiz_dashboard.html" class="block px-4 py-2 text-sm hover:bg-gray-100 transition" data-i18n="quizDashboard">ğŸ“ Quiz Dashboard</a>
            <a href="./profile.html" class="block px-4 py-2 text-sm hover:bg-gray-100 transition" data-i18n="yourProfile">ğŸ‘¤ Your Profile</a>
            <a href="./settings.html" class="block px-4 py-2 text-sm hover:bg-gray-100 transition" data-i18n="settings">âš™ï¸ Settings</a>
            <a href="./contact.html" class="block px-4 py-2 text-sm hover:bg-gray-100 transition" data-i18n="contact">ğŸ“© Contact</a>
            <button id="logoutButton" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition" data-i18n="signOut">ğŸšª Sign out</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="flex flex-wrap sm:flex-nowrap justify-around items-center bg-white rounded-xl p-3 shadow-md">
      <a href="./my-students.html" class="flex-1 text-center py-3 px-4 m-1 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-300" data-i18n="myClass">ğŸ‘¨â€ğŸ“ My Class</a>
      <a href="./completed-assignment.html" class="flex-1 text-center py-3 px-4 m-1 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-300" data-i18n="completedTasks">âœ… Completed Tasks</a>
      <a href="./quiz_dashboard.html" class="flex-1 text-center py-3 px-4 m-1 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-300" data-i18n="quizDashboard">ğŸ“ Quiz Dashboard</a>
      <a href="./AI-Essay-Checker.html" class="flex-1 text-center py-3 px-4 m-1 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-300" data-i18n="aiChecker">ğŸ¤– AI Checker</a>
    </nav>

    <!-- Main Sections -->
    <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

      <!-- Students Section -->
      <section id="studentsSection" class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-i18n="studentsInClass">
          ğŸ“ Students in Your Class
        </h2>
        <div id="studentsList" class="divide-y divide-gray-200 text-gray-700"></div>
      </section>

      <!-- Assignment Section -->
      <section class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-i18n="createAssignment">
          âœï¸ Create and Send Assignment
        </h2>
        <label for="student-select" class="block text-gray-700 font-bold mb-2" data-i18n="selectStudent">Select Student:</label>
        <div class="border border-gray-300 rounded-lg overflow-hidden mb-4">
          <select id="student-select" class="w-full p-3 bg-white text-gray-800 focus:outline-none"></select>
        </div>

        <label for="assignmentTitle" class="block text-gray-700 font-bold mb-2" data-i18n="assignmentTitle">Assignment Title:</label>
        <input type="text" id="assignmentTitle" maxlength="100"
               class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
               placeholder="e.g., History Essay on World War II" />

        <label for="assignmentDueDate" class="block text-gray-700 font-bold mb-2" data-i18n="dueDate">Due Date:</label>
        <input type="datetime-local" id="assignmentDueDate"
               class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />

        <label for="assignmentText" class="block text-gray-700 font-bold mb-2" data-i18n="assignmentDetails">
          Assignment Details (max 1000 words or attach file):
        </label>
        <textarea id="assignmentText" maxlength="5000"
                  class="w-full min-h-[150px] p-4 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"
                  placeholder="Type your assignment here..."></textarea>
        <p id="wordCountText" class="text-sm text-gray-500 text-right mb-4">Word count: 0</p>

        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
          <label class="custom-file-input cursor-pointer text-base">
            <input type="file" id="assignmentFile" class="custom-file-input" />
          </label>
          <div id="fileStatus" class="flex items-center gap-2">
            <span id="fileName" class="text-gray-700 text-sm italic">No file selected.</span>
            <button id="clearFileButton" class="text-red-500 hover:text-red-700 hidden text-sm font-semibold">Clear</button>
          </div>
        </div>

        <button id="sendAssignmentButton"
                class="w-full py-4 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled data-i18n="sendAssignment">
          Send Assignment
        </button>
      </section>

      <!-- Points Section -->
      <section class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-i18n="addPointsTitle">
          â• Add Student Points
        </h2>

        <label for="points-student-select" class="block text-gray-700 font-bold mb-2" data-i18n="selectStudent">Select Student:</label>
        <div class="border border-gray-300 rounded-lg overflow-hidden mb-4">
          <select id="points-student-select" class="w-full p-3 bg-white text-gray-800 focus:outline-none"></select>
        </div>

        <label for="pointsInput" class="block text-gray-700 font-bold mb-2" data-i18n="pointsToAdd">Points to Add:</label>
        <input type="number" id="pointsInput" min="1"
               class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
               placeholder="e.g., 10" />

        <label for="reasonText" class="block text-gray-700 font-bold mb-2" data-i18n="reasonOptional">Reason (Optional):</label>
        <textarea id="reasonText"
                  class="w-full min-h-[80px] p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-y"
                  placeholder="e.g., Great participation in class discussion."></textarea>

        <button id="addPointsButton"
                class="w-full py-4 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                data-i18n="addPointsButton" disabled>
          Add Points
        </button>
      </section>

      <!-- Overdue Tasks -->
      <section class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-i18n="overdueTasks">
          ğŸ“Œ Overdue Tasks
        </h2>
        <div id="overdueTasksList" class="divide-y divide-gray-200"></div>
      </section>

      <!-- Assigned Tasks & Feedback -->
      <section class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-i18n="assignedTasks">
          ğŸ“ Assigned Tasks & Feedback
        </h2>
        <div id="assignedTasksList" class="divide-y divide-gray-200"></div>
      </section>

      <!-- Feedback -->
      <section class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2" data-i18n="studentFeedback">
          ğŸ’¬ Student Feedback Overview
        </h2>
        <div id="feedbackList" class="divide-y divide-gray-200"></div>
      </section>

      <!-- Academic Calendar -->
      <section class="bg-white rounded-xl p-6 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-105">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">ğŸ“… Academic Calendar</h2>
        <input type="text" id="academicYear"
               class="w-full p-3 mb-4 border border-gray-300 rounded-lg"
               placeholder="Academic Year (e.g. 2025/2026)" />

        <div id="termsContainer" class="space-y-4"></div>

        <button id="addTermButton"
                class="w-full py-2 mb-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">
          â• Add Term
        </button>

        <button id="saveCalendarButton"
                class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-300">
          Save Calendar
        </button>

        <p id="calendarMsg" class="text-center font-semibold mt-4 text-gray-700"></p>
      </section>

    </main>

    <footer class="text-center text-sm text-gray-500 py-6 mt-4">
      Â© <span id="currentYear"></span> SmartStudentAct
    </footer>
  </div>

<script src="translate.js"></script>
<script>
const API_BASE_URL = "https://api.smartstudentact.com/api";
let studentsCache = [];
let currentLang = "en";

// ---------------- Toast ----------------
function showToast(message, type = "info") {
    const container = document.getElementById("toast-container") || (() => {
        const el = document.createElement("div");
        el.id = "toast-container";
        el.className = "fixed top-4 right-4 z-[1000] space-y-2";
        document.body.appendChild(el);
        return el;
    })();
    const colors = {
        success: "bg-green-600",
        error: "bg-red-600",
        info: "bg-blue-600",
        warning: "bg-yellow-500 text-gray-900"
    };
    const toast = document.createElement("div");
    toast.className = `px-4 py-2 rounded text-white shadow ${colors[type] || colors.info}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// ---------------- Loading ----------------
function hideLoadingOverlay() {
    const el = document.getElementById("loadingOverlay");
    if (el) el.style.display = "none";
}

// ---------------- API Helper ----------------
async function fetchAPI(endpoint, options = {}) {
    try {
        const res = await fetch(`${API_BASE_URL}${endpoint}`, {
            ...options,
            credentials: "include",
            headers: { ...(options.headers || {}) }
        });
        if (res.status === 401) {
            window.location.href = "/login.html";
            return null;
        }
        return res;
    } catch (err) {
        console.error("Fetch error:", err);
        showToast("Network error, please try again.", "error");
        return null;
    }
}

// ---------------- Auth / Profile ----------------
async function checkAuth() {
    const res = await fetchAPI("/auth/check");
    if (!res || !res.ok) window.location.href = "/login.html";
}

async function fetchTeacherProfile() {
    const res = await fetchAPI("/teacher/profile");
    if (res && res.ok) {
        const data = await res.json();
        document.getElementById("profilePreviewName").innerText = data.name || "Teacher";
        document.getElementById("profileAvatar").src = data.profile_picture_url || "./images/default-avatar.png";
    }
}

// ---------------- Students ----------------
function renderStudents(students = []) {
    const container = document.getElementById("studentsList");
    if (!container) return;
    if (!students.length) {
        container.innerHTML = `<div class="p-4 text-center text-gray-500">${translateText('no_students')}</div>`;
        return;
    }
    container.innerHTML = students.map(s => `
      <div class="p-4 flex items-center justify-between border-b last:border-b-0 hover:bg-gray-50">
        <div class="flex items-center gap-3">
          <img src="${s.imageUrl || './images/default-avatar.png'}" alt="student avatar" class="h-10 w-10 rounded-full border object-cover"/>
          <div>
            <p class="font-medium text-gray-800">${s.firstname} ${s.lastname}</p>
            <p class="text-sm text-gray-500">${translateText('grade')} ${s.grade || "-"}</p>
          </div>
        </div>
        <span class="text-xs text-gray-400">${s.email}</span>
      </div>
    `).join("");
}

async function fetchStudents() {
    let myGrade = [], otherGrade = [];
    const res = await fetchAPI("/teacher/students");
    if (res && res.ok) myGrade = (await res.json()) || [];
    const resOther = await fetchAPI("/teacher/students/other");
    if (resOther && resOther.ok) otherGrade = (await resOther.json()) || [];
    studentsCache = [...myGrade, ...otherGrade];
    renderStudents(myGrade);
    populateStudentSelects(studentsCache, myGrade, otherGrade);
}

function populateStudentSelects(allStudents, myGrade = [], otherGrade = []) {
    const studentSelect = document.getElementById("student-select");
    const toOptions = (list) => list.map(s => `<option value="${s._id || s.id}">${s.firstname} ${s.lastname} (${translateText('grade')} ${s.grade || '-'})</option>`).join("");
    if (!studentSelect) return;
    studentSelect.innerHTML = `
        <optgroup label="${translateText('myClass')}">${toOptions(myGrade)}</optgroup>
        <optgroup label="${translateText('other_students')}">${toOptions(otherGrade)}</optgroup>
    `;
}

// ---------------- Assignment Form ----------------
function validateAssignmentForm() {
    const title = document.getElementById('assignmentTitle').value.trim();
    const text = document.getElementById('assignmentText').value.trim();
    const file = document.getElementById('assignmentFile').files.length > 0;
    const targets = Array.from(document.querySelectorAll('.target-checkbox:checked')).map(c => c.value);
    const sendButton = document.getElementById('sendAssignmentButton');
    sendButton.disabled = !(title && (text || file) && targets.length);
}

function wireAssignmentForm() {
    const assignTitle = document.getElementById('assignmentTitle');
    const assignText = document.getElementById('assignmentText');
    const assignFile = document.getElementById('assignmentFile');
    const clearFileBtn = document.getElementById('clearFileButton');
    const fileNameSpan = document.getElementById('fileName');
    const sendBtn = document.getElementById('sendAssignmentButton');

    assignTitle.addEventListener('input', validateAssignmentForm);
    assignText.addEventListener('input', validateAssignmentForm);
    assignFile.addEventListener('change', () => {
        if (assignFile.files.length > 0) {
            fileNameSpan.textContent = assignFile.files[0].name;
            clearFileBtn.classList.remove('hidden');
        } else {
            fileNameSpan.textContent = translateText('noFileSelected');
            clearFileBtn.classList.add('hidden');
        }
        validateAssignmentForm();
    });

    clearFileBtn.addEventListener('click', () => {
        assignFile.value = '';
        fileNameSpan.textContent = translateText('noFileSelected');
        clearFileBtn.classList.add('hidden');
        validateAssignmentForm();
    });

    document.querySelectorAll('.target-checkbox').forEach(cb => {
        cb.addEventListener('change', validateAssignmentForm);
    });

    sendBtn.addEventListener('click', async () => {
        const title = assignTitle.value.trim();
        const text = assignText.value.trim();
        const file = assignFile.files[0];
        const targets = Array.from(document.querySelectorAll('.target-checkbox:checked')).map(c => c.value);

        if (!title || (!text && !file) || !targets.length) {
            showToast(translateText('fill_required_fields'), 'error');
            return;
        }

        const formData = new FormData();
        formData.append('title', title);
        formData.append('description', text);
        formData.append('assigned_to', JSON.stringify(targets));
        if (file) formData.append('file', file);

        sendBtn.disabled = true;
        sendBtn.textContent = translateText('sending');

        try {
            const res = await fetchAPI('/teacher/assignments', {
                method: 'POST',
                body: formData
            });
            if (res && res.ok) {
                const data = await res.json();
                showToast(data.message || translateText('assignment_sent'), 'success');
                assignTitle.value = '';
                assignText.value = '';
                assignFile.value = '';
                fileNameSpan.textContent = translateText('noFileSelected');
                document.querySelectorAll('.target-checkbox').forEach(cb => cb.checked = false);
                validateAssignmentForm();
                fetchAssignedTasks();
            } else {
                showToast(translateText('failed_send_assignment'), 'error');
            }
        } catch (err) {
            console.error('Assignment submission error:', err);
            showToast(translateText('network_error'), 'error');
        } finally {
            sendBtn.disabled = false;
            sendBtn.textContent = translateText('sendAssignment');
        }
    });
}

// ---------------- Points Form ----------------
function validatePointsForm() {
    const pointsInput = document.getElementById('pointsInput').value.trim();
    const studentSelect = document.getElementById('points-student-select').value;
    const reason = document.getElementById('reasonText').value.trim();
    const addButton = document.getElementById('addPointsButton');
    addButton.disabled = !(pointsInput && studentSelect && reason);
}

function wirePointsForm() {
    const pointsInput = document.getElementById('pointsInput');
    const pointsSelect = document.getElementById('points-student-select');
    const addBtn = document.getElementById('addPointsButton');
    const reasonText = document.getElementById('reasonText');

    pointsInput.addEventListener('input', validatePointsForm);
    pointsSelect.addEventListener('change', validatePointsForm);
    reasonText.addEventListener('input', validatePointsForm);

    addBtn.addEventListener('click', async () => {
        const studentId = pointsSelect.value;
        const points = pointsInput.value;
        const reason = reasonText.value;

        if (!studentId || !points || !reason) {
            showToast(translateText('fill_points_fields'), 'error');
            return;
        }

        addBtn.disabled = true;
        addBtn.textContent = translateText('adding');

        try {
            const res = await fetchAPI('/teacher/add-points', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ studentId, points, reason })
            });
            if (res && res.ok) {
                showToast(translateText('points_added'), 'success');
                pointsInput.value = '';
                reasonText.value = '';
                pointsSelect.value = '';
                validatePointsForm();
            } else {
                showToast(translateText('failed_add_points'), 'error');
            }
        } catch (err) {
            console.error('Add points error:', err);
            showToast(translateText('network_error'), 'error');
        } finally {
            addBtn.disabled = false;
            addBtn.textContent = translateText('addPoints');
        }
    });
}

// ---------------- Translation ----------------
function translateText(key) {
    if (typeof translations !== "undefined" && translations[key] && translations[key][currentLang]) {
        return translations[key][currentLang];
    }
    return key;
}

// ---------------- Init ----------------
async function init() {
    try {
        await checkAuth();
        await translatePage("teachers", currentLang);

        document.getElementById("language-select").addEventListener("change", async (e) => {
            currentLang = e.target.value;
            await translatePage("teachers", currentLang);
            populateStudentSelects(studentsCache);
        });

        await Promise.all([
            fetchTeacherProfile(),
            fetchStudents(),
            fetchAssignedTasks(),
            fetchFeedback(),
            fetchOverdueTasks()
        ]);

        wireAssignmentForm();
        wirePointsForm();
        wireCalendar();
    } catch (err) {
        console.error("Init error:", err);
        showToast(translateText('dashboard_load_error'), "error");
    } finally {
        hideLoadingOverlay();
    }
}

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("currentYear").textContent = new Date().getFullYear();

    const btn = document.getElementById("profile-menu-button");
    const menu = document.getElementById("profile-dropdown-menu");
    btn.addEventListener("click", (e) => { e.stopPropagation(); menu.classList.toggle("hidden"); });
    document.addEventListener("click", (e) => { if (!btn.contains(e.target) && !menu.contains(e.target)) menu.classList.add("hidden"); });

    document.getElementById("logoutButton").addEventListener("click", async () => {
        await fetchAPI("/users/logout", { method: "POST" });
        window.location.href = "/login.html";
    });

    init();
});
</script>
</body>
</html>


