<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="pageTitle">Reset Password</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="./images/icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
  <script src="https://kit.fontawesome.com/your-kit-code.js" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="absolute top-4 right-4 z-20">
    <select id="language-selector" class="bg-white border border-gray-300 rounded-lg p-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
      <option value="en">English</option>
      <option value="fr">Français</option>
      <option value="es">Español</option>
      <option value="tr">Türkçe</option>
      <option value="ar">العربية</option>
      <option value="ru">Русский</option>
    </select>
  </div>

  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-8" id="form-container">
    <h2 id="form-title" class="text-2xl font-bold text-center text-gray-800 mb-6">Reset Your Password</h2>
    
    <form id="resetPasswordForm" class="space-y-4">
      <div>
        <label for="password" id="label-password" class="block text-gray-700 font-medium">New Password</label>
        <div class="relative">
          <input type="password" id="password" name="password" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring focus:ring-blue-300 pr-10">
          <button type="button" onclick="togglePassword('password','togglePasswordIcon')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">
            <i id="togglePasswordIcon" class="fas fa-eye"></i>
          </button>
        </div>
        <div id="passwordStrength" class="mt-2 text-sm font-medium"></div>
      </div>
      
      <div>
        <label for="confirmPassword" id="label-confirmPassword" class="block text-gray-700 font-medium">Confirm New Password</label>
        <div class="relative">
          <input type="password" id="confirmPassword" name="confirmPassword" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring focus:ring-blue-300 pr-10">
          <button type="button" onclick="togglePassword('confirmPassword','toggleConfirmPasswordIcon')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500">
            <i id="toggleConfirmPasswordIcon" class="fas fa-eye"></i>
          </button>
        </div>
      </div>
      
      <button type="submit" id="submit-button" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Update Password</button>
    </form>

    <div id="message" class="mt-4 text-center text-sm"></div>
  </div>

  <script>
    const translations = {
      en: {
        pageTitle: "Reset Password",
        formTitle: "Reset Your Password",
        labelPassword: "New Password",
        labelConfirmPassword: "Confirm New Password",
        submitButton: "Update Password",
        strength: {
          weak: "Weak ❌ (Add uppercase, special char, min 8 chars)",
          fair: "Fair ⚠️ (Add more variety for strength)",
          good: "Good ✅ (Secure enough)",
          strong: "Strong 🔒 (Excellent!)"
        },
        errors: {
          invalidPassword: "❌ Password must be at least 8 characters, include uppercase & special char.",
          mismatch: "❌ Passwords do not match.",
          resetFail: "❌ Failed to reset password. Try again.",
          serverError: "❌ Something went wrong."
        },
        success: "✅ Password updated successfully. You can now log in."
      },
      fr: {
        pageTitle: "Réinitialiser le mot de passe",
        formTitle: "Réinitialisez votre mot de passe",
        labelPassword: "Nouveau mot de passe",
        labelConfirmPassword: "Confirmer le nouveau mot de passe",
        submitButton: "Mettre à jour le mot de passe",
        strength: {
          weak: "Faible ❌ (Ajouter majuscule, caractère spécial, min 8 caractères)",
          fair: "Moyen ⚠️ (Ajoutez plus de variété)",
          good: "Bon ✅ (Assez sécurisé)",
          strong: "Fort 🔒 (Excellent!)"
        },
        errors: {
          invalidPassword: "❌ Le mot de passe doit contenir au moins 8 caractères, majuscule et caractère spécial.",
          mismatch: "❌ Les mots de passe ne correspondent pas.",
          resetFail: "❌ Échec de la réinitialisation. Réessayez.",
          serverError: "❌ Une erreur est survenue."
        },
        success: "✅ Mot de passe mis à jour avec succès. Vous pouvez maintenant vous connecter."
      },
      es: {
        pageTitle: "Restablecer contraseña",
        formTitle: "Restablece tu contraseña",
        labelPassword: "Nueva contraseña",
        labelConfirmPassword: "Confirmar nueva contraseña",
        submitButton: "Actualizar contraseña",
        strength: {
          weak: "Débil ❌ (Añade mayúscula, caracter especial, min 8 caracteres)",
          fair: "Regular ⚠️ (Añade más variedad)",
          good: "Bueno ✅ (Suficientemente seguro)",
          strong: "Fuerte 🔒 (Excelente!)"
        },
        errors: {
          invalidPassword: "❌ La contraseña debe tener al menos 8 caracteres, incluir mayúscula y caracter especial.",
          mismatch: "❌ Las contraseñas no coinciden.",
          resetFail: "❌ Fallo al restablecer. Intenta de nuevo.",
          serverError: "❌ Algo salió mal."
        },
        success: "✅ Contraseña actualizada. Ya puedes iniciar sesión."
      },
      tr: {
        pageTitle: "Şifreyi Sıfırla",
        formTitle: "Şifrenizi Sıfırlayın",
        labelPassword: "Yeni Şifre",
        labelConfirmPassword: "Yeni Şifreyi Onayla",
        submitButton: "Şifreyi Güncelle",
        strength: {
          weak: "Zayıf ❌ (Büyük harf, özel karakter, min 8 karakter ekleyin)",
          fair: "Orta ⚠️ (Daha fazla çeşitlilik ekleyin)",
          good: "İyi ✅ (Yeterince güvenli)",
          strong: "Güçlü 🔒 (Mükemmel!)"
        },
        errors: {
          invalidPassword: "❌ Şifre en az 8 karakter, büyük harf ve özel karakter içermelidir.",
          mismatch: "❌ Şifreler eşleşmiyor.",
          resetFail: "❌ Sıfırlama başarısız. Tekrar deneyin.",
          serverError: "❌ Bir hata oluştu."
        },
        success: "✅ Şifre başarıyla güncellendi. Artık giriş yapabilirsiniz."
      },
      ar: {
        pageTitle: "إعادة تعيين كلمة المرور",
        formTitle: "إعادة تعيين كلمة المرور الخاصة بك",
        labelPassword: "كلمة المرور الجديدة",
        labelConfirmPassword: "تأكيد كلمة المرور الجديدة",
        submitButton: "تحديث كلمة المرور",
        strength: {
          weak: "ضعيفة ❌ (أضف حرف كبير، رمز خاص، 8 أحرف على الأقل)",
          fair: "متوسطة ⚠️ (أضف المزيد من التنوع)",
          good: "جيدة ✅ (آمنة بما فيه الكفاية)",
          strong: "قوية 🔒 (ممتاز!)"
        },
        errors: {
          invalidPassword: "❌ يجب أن تكون كلمة المرور 8 أحرف على الأقل، تحتوي على حرف كبير ورمز خاص.",
          mismatch: "❌ كلمات المرور غير متطابقة.",
          resetFail: "❌ فشل إعادة تعيين كلمة المرور. حاول مرة أخرى.",
          serverError: "❌ حدث خطأ ما."
        },
        success: "✅ تم تحديث كلمة المرور بنجاح. يمكنك الآن تسجيل الدخول."
      },
      ru: {
        pageTitle: "Сброс пароля",
        formTitle: "Сбросьте свой пароль",
        labelPassword: "Новый пароль",
        labelConfirmPassword: "Подтвердите новый пароль",
        submitButton: "Обновить пароль",
        strength: {
          weak: "Слабый ❌ (Добавьте заглавную, спецсимвол, мин 8 символов)",
          fair: "Средний ⚠️ (Добавьте разнообразия)",
          good: "Хороший ✅ (Достаточно безопасно)",
          strong: "Сильный 🔒 (Отлично!)"
        },
        errors: {
          invalidPassword: "❌ Пароль должен быть не менее 8 символов, включать заглавную и спецсимвол.",
          mismatch: "❌ Пароли не совпадают.",
          resetFail: "❌ Не удалось сбросить пароль. Попробуйте снова.",
          serverError: "❌ Что-то пошло не так."
        },
        success: "✅ Пароль успешно обновлён. Теперь вы можете войти."
      }
    };

    const form = document.getElementById("resetPasswordForm");
    const passwordInput = document.getElementById("password");
    const passwordStrength = document.getElementById("passwordStrength");
    const messageDiv = document.getElementById("message");
    const languageSelector = document.getElementById("language-selector");

    let currentLang = "en";

    function translatePage(lang){
      currentLang = lang;
      const t = translations[lang];
      document.title = t.pageTitle;
      document.getElementById("form-title").textContent = t.formTitle;
      document.getElementById("label-password").textContent = t.labelPassword;
      document.getElementById("label-confirmPassword").textContent = t.labelConfirmPassword;
      document.getElementById("submit-button").textContent = t.submitButton;
      passwordStrength.textContent = "";
      messageDiv.textContent = "";
    }

    languageSelector.addEventListener("change", e => translatePage(e.target.value));
    translatePage(currentLang);

    function validatePassword(password){
      return /^(?=.*[A-Z])(?=.*[!@#$%^&*(),.?":{}|<>]).{8,}$/.test(password);
    }
    
    function checkStrength(password) {
      let score = 0;
      if (password.length >= 8) score++;
      if (/[A-Z]/.test(password)) score++;
      if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) score++;
      if (/[0-9]/.test(password)) score++;

      switch (score) {
        case 0:
        case 1:
          passwordStrength.textContent = "Weak ❌ (Add uppercase, special char, min 8 chars)";
          passwordStrength.className = "mt-2 text-red-600 text-sm font-medium";
          break;
        case 2:
          passwordStrength.textContent = "Fair ⚠️ (Add more variety for strength)";
          passwordStrength.className = "mt-2 text-yellow-600 text-sm font-medium";
          break;
        case 3:
          passwordStrength.textContent = "Good ✅ (Secure enough)";
          passwordStrength.className = "mt-2 text-green-600 text-sm font-medium";
          break;
        case 4:
          passwordStrength.textContent = "Strong 🔒 (Excellent!)";
          passwordStrength.className = "mt-2 text-green-700 text-sm font-bold";
          break;
      }
    }

    passwordInput.addEventListener("input", () => {
      checkStrength(passwordInput.value);
    });

    function togglePassword(inputId, iconId) {
      const input = document.getElementById(inputId);
      const icon = document.getElementById(iconId);
      if (input.type === "password") {
        input.type = "text";
        icon.classList.remove("fa-eye");
        icon.classList.add("fa-eye-slash");
      } else {
        input.type = "password";
        icon.classList.remove("fa-eye-slash");
        icon.classList.add("fa-eye");
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token"); // token from reset email link

      const password = document.getElementById("password").value.trim();
      const confirmPassword = document.getElementById("confirmPassword").value.trim();

      if (!validatePassword(password)) {
        messageDiv.textContent = "❌ Password must be at least 8 characters long, include an uppercase letter and a special character.";
        messageDiv.className = "mt-4 text-center text-red-600";
        return;
      }

      if (password !== confirmPassword) {
        messageDiv.textContent = "❌ Passwords do not match.";
        messageDiv.className = "mt-4 text-center text-red-600";
        return;
      }

      try {
        const response = await fetch("https://smartstudentact.onrender.com/api/reset-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, password })
        });

        const data = await response.json();
        if (response.ok) {
          messageDiv.textContent = "✅ Password updated successfully. You can now log in.";
          messageDiv.className = "mt-4 text-center text-green-600";
          form.reset();
          passwordStrength.textContent = "";
        } else {
          messageDiv.textContent = "❌ " + (data.error || "Something went wrong.");
          messageDiv.className = "mt-4 text-center text-red-600";
        }
      } catch (err) {
        console.error(err);
        messageDiv.textContent = "❌ Failed to reset password. Try again.";
        messageDiv.className = "mt-4 text-center text-red-600";
      }
    });
  </script>
</body>
</html>

