<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="completedTasksTitle">Completed Tasks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./images/icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./images/icon.png"
    />
    <link rel="manifest" href="/site.webmanifest" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">

    <!-- Language Selector -->
    <nav class="w-full max-w-2xl p-4 flex justify-end">
        <select id="language-select" class="border border-gray-300 rounded-md p-2 text-sm">
            <option value="en">English</option>
            <option value="fr">Français</option>
            <option value="es">Español</option>
            <option value="tr">Türkçe</option>
            <option value="ar">العربية</option>
            <option value="ru">Русский</option>
        </select>
      </div>
    </header>

    <main class="w-full max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <h1 id="page-title" class="text-3xl sm:text-4xl font-bold text-center text-gray-800 my-8" data-i18n="completedTasksTitle">Your Completed Tasks</h1>
        <div id="completed-tasks-list" class="space-y-4"></div>
    </main>

    <script src="api-config.js"></script>
    <script>
        const translations = {
            "en": {
                "completedTasksTitle": "Your Completed Tasks",
                "completedLabel": "Completed",
                "gradedLabel": "Graded",
                "personalTaskLabel": "Personal Task",
                "teacherAssignedLabel": "Teacher Assigned",
                "loading": "Loading completed tasks...",
                "noTasks": "You haven't completed any tasks yet."
            },
            "fr": {
                "completedTasksTitle": "Vos tâches terminées",
                "completedLabel": "Terminé",
                "gradedLabel": "Noté",
                "personalTaskLabel": "Tâche personnelle",
                "teacherAssignedLabel": "Assigné par l'enseignant",
                "loading": "Chargement des tâches terminées...",
                "noTasks": "Vous n'avez encore terminé aucune tâche."
            },
            // ... other languages
        };

        const pageTitle = document.getElementById('page-title');
        const taskListContainer = document.getElementById('completed-tasks-list');
        const langSelect = document.getElementById('language-select');
        let currentLang = 'en';

        async function authFetch(endpoint, options = {}) {
            const res = await fetch(`${window.API_BASE_URL}${endpoint}`, {
                ...options,
                credentials: 'include',
                headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
            });
            if (res.status === 401) window.location.href = '/login.html';
            return res;
        }

        function renderTasks(tasks, lang) {
            taskListContainer.innerHTML = '';
            if (tasks.length === 0) {
                taskListContainer.innerHTML = `<p class="text-center text-gray-500 italic">${translations[lang].noTasks}</p>`;
                return;
            }

            tasks.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));

            tasks.forEach(task => {
                const taskItemEl = document.createElement('div');
                const isGraded = task.grade !== undefined && task.grade !== null;
                const cardColor = isGraded ? 'bg-green-50 border-green-600' : 'bg-blue-50 border-blue-600';
                taskItemEl.className = `p-4 rounded-lg mb-3 border-l-4 shadow-sm ${cardColor}`;

                const titleEl = document.createElement('p');
                titleEl.className = 'text-lg font-semibold text-gray-700';
                titleEl.textContent = task.title;

                const dateEl = document.createElement('p');
                dateEl.className = 'text-sm text-gray-500 mt-1';
                dateEl.textContent = `${translations[lang]['completedLabel']}: ${new Date(task.completedAt).toLocaleString()}`;

                taskItemEl.appendChild(titleEl);
                if (task.description) {
                    const descEl = document.createElement('p');
                    descEl.className = 'text-sm text-gray-600';
                    descEl.textContent = task.description;
                    taskItemEl.appendChild(descEl);
                }
                taskItemEl.appendChild(dateEl);

                if (isGraded) {
                    const gradeEl = document.createElement('p');
                    gradeEl.className = 'text-md font-bold text-green-700 mt-2';
                    gradeEl.textContent = `Grade: ${task.grade}`;
                    taskItemEl.appendChild(gradeEl);
                }

                taskListContainer.appendChild(taskItemEl);
            });
        }

        async function fetchAndRenderTasks(lang) {
            taskListContainer.innerHTML = `<p class="text-center text-gray-500">${translations[lang].loading}</p>`;
            try {
                // Fetch teacher-assigned submissions
                const res = await authFetch('/student/submissions');
                if (!res.ok) throw new Error('Failed to fetch submissions.');
                const submissions = await res.json();
                const teacherTasks = submissions.map(s => ({
                    title: s.assignment.title,
                    completedAt: s.submitted_at,
                    grade: s.grade,
                    type: 'teacher'
                }));

                // Get personal tasks from localStorage
                const personalTasks = JSON.parse(localStorage.getItem('completedTasks') || '[]').map(t => ({
                    ...t,
                    type: 'personal'
                }));

                renderTasks([...teacherTasks, ...personalTasks], lang);
            } catch (error) {
                taskListContainer.innerHTML = `<p class="text-center text-red-500">${error.message}</p>`;
            }
        }

        langSelect.addEventListener('change', e => {
            currentLang = e.target.value;
            pageTitle.textContent = translations[currentLang]['completedTasksTitle'];
            fetchAndRenderTasks(currentLang);
        });

        document.addEventListener('DOMContentLoaded', () => {
            pageTitle.textContent = translations[currentLang]['completedTasksTitle'];
            fetchAndRenderTasks(currentLang);
        });
    </script>

</body>
</html>
