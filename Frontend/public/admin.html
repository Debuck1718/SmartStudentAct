<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <script src="api-config.js"></script>
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./images/icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./images/icon.png"
    />
    <link rel="manifest" href="/site.webmanifest" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6;
      }

      .container {
        padding: 20px;
        background-color: #f5f7fa;
        min-height: 100vh;
      }

      .loading-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #f5f7fa;
      }

      .action-button:active,
      .logout-button:active,
      .header-icon:active,
      .lang-button:active {
        transform: scale(0.98);
      }

      .picker-container {
        border-width: 1px;
        border-color: #ccc;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 10px;
        background-color: #fff;
        position: relative;
      }

      .picker-container::after {
        content: "\f078";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        color: #4b5563;
      }

      .picker {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        height: 50px;
        width: 100%;
        background-color: transparent;
        padding: 0 15px;
        font-size: 16px;
        color: #4b5563;
      }

      .tab-button {
        padding: 10px 15px;
        font-weight: 600;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: border-color 0.3s;
      }

      .tab-button.active {
        border-bottom-color: #3b82f6; 
      }
      
      /* Sidebar transition */
      .sidebar {
        transition: transform 0.3s ease-in-out;
      }
      
      .sidebar-open {
        transform: translateX(0);
      }
      
      .sidebar-closed {
        transform: translateX(-100%);
      }

      @media (min-width: 1024px) {
        .sidebar-closed {
            transform: translateX(0);
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 antialiased flex h-screen overflow-hidden">
    
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar sidebar-closed fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg lg:static lg:translate-x-0 flex flex-col">
        <div class="flex items-center justify-center h-16 border-b border-gray-200">
            <span class="text-xl font-bold text-blue-600">Admin Panel</span>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
            <button onclick="changeTab('dashboard')" id="nav-dashboard" class="flex items-center w-full px-4 py-2 text-gray-600 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i class="fas fa-chart-pie mr-3"></i> Dashboard
            </button>
            <button onclick="changeTab('users')" id="nav-users" class="flex items-center w-full px-4 py-2 text-gray-600 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i class="fas fa-users mr-3"></i> Manage Users
            </button>
            <button onclick="changeTab('files')" id="nav-files" class="flex items-center w-full px-4 py-2 text-gray-600 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i class="fas fa-folder-open mr-3"></i> Manage Files
            </button>
            <button onclick="changeTab('announcements')" id="nav-announcements" class="flex items-center w-full px-4 py-2 text-gray-600 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <i class="fas fa-bullhorn mr-3"></i> Announcements
            </button>
        </nav>
        <div class="p-4 border-t border-gray-200">
            <button id="logout-button" class="flex items-center w-full px-4 py-2 text-red-600 rounded-lg hover:bg-red-50 transition-colors">
                <i class="fas fa-sign-out-alt mr-3"></i> Logout
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="flex items-center justify-between px-6 py-4 bg-white shadow-sm">
            <button id="menu-toggle" class="text-gray-500 focus:outline-none lg:hidden">
                <i class="fas fa-bars text-2xl"></i>
            </button>
            <h1 id="header-title" class="text-xl font-semibold text-gray-800">Dashboard</h1>
            <div class="flex items-center space-x-4">
                 <select id="lang-select" class="border border-gray-300 rounded-md p-1 text-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="en">EN</option>
                    <option value="fr">FR</option>
                    <option value="es">ES</option>
                    <option value="tr">TR</option>
                    <option value="ar">AR</option>
                    <option value="ru">RU</option>
                </select>
                <div class="relative">
                    <img id="admin-avatar" src="https://placehold.co/40x40" alt="Admin" class="w-10 h-10 rounded-full object-cover border border-gray-200">
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6" id="main-content">
            <!-- Content injected here -->
        </main>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>

    <div
      id="alert-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center p-4"
    >
      <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
        <h3 id="alert-title" class="font-bold text-lg mb-2"></h3>
        <p id="alert-message" class="text-sm text-gray-700 mb-4"></p>
        <div class="flex justify-end space-x-2">
          <button
            id="alert-cancel"
            class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300"
          >
            Cancel
          </button>
          <button
            id="alert-confirm"
            class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300"
          >
            OK
          </button>
        </div>
      </div>
    </div>

    <div
      id="contactModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center"
    >
      <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
        <h2 class="text-xl font-bold mb-4">ðŸ“© <span id="contact-title">Contact Us</span></h2>
        <form id="contactForm" class="space-y-4">
          <div>
            <label id="contact-name-label" class="block text-sm font-medium">Your Name</label>
            <input
              type="text"
              id="contactName"
              required
              class="w-full border rounded p-2"
            />
          </div>
          <div>
            <label id="contact-email-label" class="block text-sm font-medium">Your Email</label>
            <input
              type="email"
              id="contactEmail"
              required
              class="w-full border rounded p-2"
            />
          </div>
          <div>
            <label id="contact-message-label" class="block text-sm font-medium">Message</label>
            <textarea
              id="contactMessage"
              rows="4"
              required
              class="w-full border rounded p-2"
            ></textarea>
          </div>
          <div class="flex justify-end gap-2">
            <button
              type="button"
              id="closeContact"
              class="bg-gray-200 px-4 py-2 rounded"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="bg-blue-600 text-white px-4 py-2 rounded"
            >
              Send
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const API_BASE_URL = window.API_BASE_URL || (window.location.hostname.includes('localhost') ? '/api' : 'https://api.smartstudentact.com');

      const router = {
        replace: (path) => (window.location.href = path),
        push: (path) => (window.location.href = path),
      };

      
      const translations = {
        en: {
          title: "Admin Dashboard",
          loading: "Loading dashboard...",
          logout: "Logout",
          manageUsers: "Manage Users",
          dashboard: "Dashboard",
          manageFiles: "Manage Files",
          filters: "Filters",
          searchLabel: "Search by Name/Email:",
          searchPlaceholder: "Search...",
          gradeFilterLabel: "Filter by Grade:",
          allGrades: "All Grades",
          upperGrade: "Upper Grade (Class 5-6)",
          grade: "Grade",
          juniorHigh: "Junior High (Form 1-3)",
          seniorHigh: "Senior High (SHS 1-3)",
          university: "University",
          level: "Level",
          firstYear: "(First Year)",
          secondYear: "(Second Year)",
          thirdYear: "(Third Year)",
          finalYear: "(Final Year)",
          usersHeading: (count) => `Users (${count})`,
          noUsers: "No users found matching filters.",
          role: "Role",
          school: "School",
          gradeText: "Grade",
          promote: "Promote",
          demote: "Demote",
          suspend: "Suspend",
          delete: "Delete",
          note: "Note:",
          noteText: "You can only manage users from your school.",
          filesHeading: "Files from Your School",
          noFiles: "No files found for your school.",
          type: "Type",
          submittedBy: "Submitted By",
          viewFile: "View File",
          alert: {
            title: "",
            message: "",
            cancel: "Cancel",
            ok: "OK",
            logoutConfirmTitle: "Logout",
            logoutConfirmMessage: "Are you sure you want to log out?",
            logoutErrorTitle: "Logout Error",
            logoutErrorMessage: "Failed to log out. Please try again.",
            sessionExpiredTitle: "Session Expired",
            sessionExpiredMessage: "Your session has expired. Please log in again.",
            loadUsersError: "Failed to load user data.",
            loadFilesError: "Failed to load files from your school.",
            promoteUserTitle: "Promote User",
            promoteUserMessage: "Are you sure you want to promote this user?",
            demoteUserTitle: "Demote User",
            demoteUserMessage: "Are you sure you want to demote this user?",
            suspendUserTitle: "Suspend User",
            suspendUserMessage: "Are you sure you want to suspend this user?",
            deleteUserTitle: "Delete User",
            deleteUserMessage: "Are you sure you want to delete this user?",
            accessDeniedTitle: "Access Denied",
            accessDeniedMessage: "You do not have permission to view this page.",
            authFailedTitle: "Authentication Failed",
            authFailedMessage: "Please log in to continue.",
            sessionErrorTitle: "Session Error",
            sessionErrorMessage: "Could not verify session. Please log in again.",
            confirmDeleteTitle: "Confirm Delete",
            confirmDeleteMessage: (userName) => `Are you sure you want to delete ${userName}? This action cannot be undone.`,
            generalError: (action) => `Something went wrong while trying to ${action} the user.`,
            apiFailed: (message) => message || "API request failed.",
            successTitle: "Success",
            sendSuccess: "âœ… Message sent successfully!",
            sendError: "âŒ Could not send message. Try again later."
          },
          contactForm: {
            title: "Contact Us",
            nameLabel: "Your Name",
            emailLabel: "Your Email",
            messageLabel: "Message",
            cancel: "Cancel",
            send: "Send"
          }
        },
        fr: {
          title: "Tableau de bord de l'administrateur",
          loading: "Chargement du tableau de bord...",
          logout: "DÃ©connexion",
          manageUsers: "GÃ©rer les utilisateurs",
          dashboard: "Tableau de bord",
          manageFiles: "GÃ©rer les fichiers",
          filters: "Filtres",
          searchLabel: "Rechercher par nom/e-mail :",
          searchPlaceholder: "Rechercher...",
          gradeFilterLabel: "Filtrer par niveau :",
          allGrades: "Tous les niveaux",
          upperGrade: "Niveau supÃ©rieur (Classe 5-6)",
          grade: "Niveau",
          juniorHigh: "CollÃ¨ge (Form 1-3)",
          seniorHigh: "LycÃ©e (SHS 1-3)",
          university: "UniversitÃ©",
          level: "Niveau",
          firstYear: "(PremiÃ¨re annÃ©e)",
          secondYear: "(DeuxiÃ¨me annÃ©e)",
          thirdYear: "(TroisiÃ¨me annÃ©e)",
          finalYear: "(DerniÃ¨re annÃ©e)",
          usersHeading: (count) => `Utilisateurs (${count})`,
          noUsers: "Aucun utilisateur trouvÃ© correspondant aux filtres.",
          role: "RÃ´le",
          school: "Ã‰cole",
          gradeText: "Niveau",
          promote: "Promouvoir",
          demote: "RÃ©trograder",
          suspend: "Suspendre",
          delete: "Supprimer",
          note: "Note :",
          noteText: "Vous ne pouvez gÃ©rer que les utilisateurs de votre Ã©cole.",
          filesHeading: "Fichiers de votre Ã©cole",
          noFiles: "Aucun fichier trouvÃ© pour votre Ã©cole.",
          type: "Type",
          submittedBy: "Soumis par",
          viewFile: "Voir le fichier",
          alert: {
            title: "",
            message: "",
            cancel: "Annuler",
            ok: "OK",
            logoutConfirmTitle: "DÃ©connexion",
            logoutConfirmMessage: "ÃŠtes-vous sÃ»r de vouloir vous dÃ©connecter ?",
            logoutErrorTitle: "Erreur de dÃ©connexion",
            logoutErrorMessage: "Ã‰chec de la dÃ©connexion. Veuillez rÃ©essayer.",
            sessionExpiredTitle: "Session expirÃ©e",
            sessionExpiredMessage: "Votre session a expirÃ©. Veuillez vous reconnecter.",
            loadUsersError: "Ã‰chec du chargement des donnÃ©es utilisateur.",
            loadFilesError: "Ã‰chec du chargement des fichiers de votre Ã©cole.",
            promoteUserTitle: "Promouvoir l'utilisateur",
            promoteUserMessage: "ÃŠtes-vous sÃ»r de vouloir promouvoir cet utilisateur ?",
            demoteUserTitle: "RÃ©trograder l'utilisateur",
            demoteUserMessage: "ÃŠtes-vous sÃ»r de vouloir rÃ©trograder cet utilisateur ?",
            suspendUserTitle: "Suspendre l'utilisateur",
            suspendUserMessage: "ÃŠtes-vous sÃ»r de vouloir suspendre cet utilisateur ?",
            deleteUserTitle: "Supprimer l'utilisateur",
            deleteUserMessage: "ÃŠtes-vous sÃ»r de vouloir supprimer cet utilisateur ?",
            accessDeniedTitle: "AccÃ¨s refusÃ©",
            accessDeniedMessage: "Vous n'avez pas l'autorisation de voir cette page.",
            authFailedTitle: "Ã‰chec de l'authentification",
            authFailedMessage: "Veuillez vous connecter pour continuer.",
            sessionErrorTitle: "Erreur de session",
            sessionErrorMessage: "Impossible de vÃ©rifier la session. Veuillez vous reconnecter.",
            confirmDeleteTitle: "Confirmer la suppression",
            confirmDeleteMessage: (userName) => `ÃŠtes-vous sÃ»r de vouloir supprimer ${userName} ? Cette action est irrÃ©versible.`,
            generalError: (action) => `Une erreur s'est produite lors de la tentative de ${action} de l'utilisateur.`,
            apiFailed: (message) => message || "La requÃªte API a Ã©chouÃ©.",
            successTitle: "SuccÃ¨s",
            sendSuccess: "âœ… Message envoyÃ© avec succÃ¨s !",
            sendError: "âŒ Le message n'a pas pu Ãªtre envoyÃ©. RÃ©essayez plus tard."
          },
          contactForm: {
            title: "Nous contacter",
            nameLabel: "Votre nom",
            emailLabel: "Votre e-mail",
            messageLabel: "Message",
            cancel: "Annuler",
            send: "Envoyer"
          }
        },
          es: { 
      title: "Panel de Administrador",
      loading: "Cargando panel...",
      logout: "Cerrar sesiÃ³n",
      manageUsers: "Administrar Usuarios",
      dashboard: "Tablero",
      manageFiles: "Administrar Archivos",
      filters: "Filtros",
      searchLabel: "Buscar por Nombre/Correo:",
      searchPlaceholder: "Buscar...",
      gradeFilterLabel: "Filtrar por Nivel:",
      allGrades: "Todos los Niveles",
      upperGrade: "Nivel Superior (Clase 5-6)",
      grade: "Nivel",
      juniorHigh: "Secundaria (Form 1-3)",
      seniorHigh: "Preparatoria (SHS 1-3)",
      university: "Universidad",
      level: "Nivel",
      firstYear: "(Primer AÃ±o)",
      secondYear: "(Segundo AÃ±o)",
      thirdYear: "(Tercer AÃ±o)",
      finalYear: "(Ãšltimo AÃ±o)",
      usersHeading: (count) => `Usuarios (${count})`,
      noUsers: "No se encontraron usuarios.",
      role: "Rol",
      school: "Escuela",
      gradeText: "Nivel",
      promote: "Promover",
      demote: "Degradar",
      suspend: "Suspender",
      delete: "Eliminar",
      note: "Nota:",
      noteText: "Solo puedes administrar usuarios de tu escuela.",
      filesHeading: "Archivos de tu escuela",
      noFiles: "No se encontraron archivos para tu escuela.",
      type: "Tipo",
      submittedBy: "Enviado por",
      viewFile: "Ver Archivo",
      alert: { /* similar structure as before */ },
      contactForm: { /* similar structure as before */ }
    },
    tr: {
      title: "YÃ¶netici Paneli",
      loading: "Panel yÃ¼kleniyor...",
      logout: "Ã‡Ä±kÄ±ÅŸ Yap",
      manageUsers: "KullanÄ±cÄ±larÄ± YÃ¶net",
      dashboard: "GÃ¶sterge Paneli",
      manageFiles: "DosyalarÄ± YÃ¶net",
      filters: "Filtreler",
      searchLabel: "Ä°sim/E-posta ile Ara:",
      searchPlaceholder: "Ara...",
      gradeFilterLabel: "SÄ±nÄ±fa GÃ¶re Filtrele:",
      allGrades: "TÃ¼m SÄ±nÄ±flar",
      upperGrade: "Ãœst SÄ±nÄ±f (5-6. SÄ±nÄ±f)",
      grade: "SÄ±nÄ±f",
      juniorHigh: "Ortaokul (1-3. SÄ±nÄ±f)",
      seniorHigh: "Lise (SHS 1-3)",
      university: "Ãœniversite",
      level: "Seviye",
      firstYear: "(1. YÄ±l)",
      secondYear: "(2. YÄ±l)",
      thirdYear: "(3. YÄ±l)",
      finalYear: "(Son YÄ±l)",
      usersHeading: (count) => `KullanÄ±cÄ±lar (${count})`,
      noUsers: "Filtrelere uyan kullanÄ±cÄ± bulunamadÄ±.",
      role: "Rol",
      school: "Okul",
      gradeText: "SÄ±nÄ±f",
      promote: "Terfi Etir",
      demote: "RÃ¼tbe DÃ¼ÅŸÃ¼r",
      suspend: "AskÄ±ya Al",
      delete: "Sil",
      note: "Not:",
      noteText: "Sadece kendi okulunuzdaki kullanÄ±cÄ±larÄ± yÃ¶netebilirsiniz.",
      filesHeading: "Okulunuzun DosyalarÄ±",
      noFiles: "Okulunuz iÃ§in dosya bulunamadÄ±.",
      type: "TÃ¼r",
      submittedBy: "GÃ¶nderen",
      viewFile: "DosyayÄ± GÃ¶rÃ¼ntÃ¼le",
      alert: { /* same structure */ },
      contactForm: { /* same structure */ }
    },
    ar: {
      title: "Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„",
      loading: "Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…...",
      logout: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
      manageUsers: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
      dashboard: "Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©",
      manageFiles: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª",
      filters: "Ø§Ù„ÙÙ„Ø§ØªØ±",
      searchLabel: "Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:",
      searchPlaceholder: "Ø§Ø¨Ø­Ø«...",
      gradeFilterLabel: "Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØµÙ:",
      allGrades: "Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ",
      upperGrade: "Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¹Ù„ÙŠØ§ (5-6)",
      grade: "Ø§Ù„ØµÙ",
      juniorHigh: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ© (1-3)",
      seniorHigh: "Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© (SHS 1-3)",
      university: "Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©",
      level: "Ø§Ù„Ù…Ø³ØªÙˆÙ‰",
      firstYear: "(Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰)",
      secondYear: "(Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©)",
      thirdYear: "(Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©)",
      finalYear: "(Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©)",
      usersHeading: (count) => `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† (${count})`,
      noUsers: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†.",
      role: "Ø§Ù„Ø¯ÙˆØ±",
      school: "Ø§Ù„Ù…Ø¯Ø±Ø³Ø©",
      gradeText: "Ø§Ù„ØµÙ",
      promote: "ØªØ±Ù‚ÙŠØ©",
      demote: "Ø®ÙØ¶",
      suspend: "ØªØ¹Ù„ÙŠÙ‚",
      delete: "Ø­Ø°Ù",
      note: "Ù…Ù„Ø§Ø­Ø¸Ø©:",
      noteText: "ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ù…Ø¯Ø±Ø³ØªÙƒ ÙÙ‚Ø·.",
      filesHeading: "Ù…Ù„ÙØ§Øª Ù…Ø¯Ø±Ø³ØªÙƒ",
      noFiles: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù„Ù…Ø¯Ø±Ø³ØªÙƒ.",
      type: "Ø§Ù„Ù†ÙˆØ¹",
      submittedBy: "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙˆØ§Ø³Ø·Ø©",
      viewFile: "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù",
      alert: { /* same structure */ },
      contactForm: { /* same structure */ }
    },
    ru: {
      title: "ÐŸÐ°Ð½ÐµÐ»ÑŒ ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°",
      loading: "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ð°Ð½ÐµÐ»Ð¸...",
      logout: "Ð’Ñ‹Ð¹Ñ‚Ð¸",
      manageUsers: "Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸",
      dashboard: "ÐŸÐ°Ð½ÐµÐ»ÑŒ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ",
      manageFiles: "Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¤Ð°Ð¹Ð»Ð°Ð¼Ð¸",
      filters: "Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹",
      searchLabel: "ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ Ð˜Ð¼ÐµÐ½Ð¸/Ð­Ð».Ð¿Ð¾Ñ‡Ñ‚Ðµ:",
      searchPlaceholder: "ÐŸÐ¾Ð¸ÑÐº...",
      gradeFilterLabel: "Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾ ÐšÐ»Ð°ÑÑÑƒ:",
      allGrades: "Ð’ÑÐµ ÐšÐ»Ð°ÑÑÑ‹",
      upperGrade: "Ð¡Ñ‚Ð°Ñ€ÑˆÐ¸Ð¹ ÐšÐ»Ð°ÑÑ (5-6)",
      grade: "ÐšÐ»Ð°ÑÑ",
      juniorHigh: "Ð¡Ñ€ÐµÐ´Ð½ÑÑ ÑˆÐºÐ¾Ð»Ð° (1-3 ÐºÐ»Ð°ÑÑ)",
      seniorHigh: "Ð¡Ñ‚Ð°Ñ€ÑˆÐ°Ñ ÑˆÐºÐ¾Ð»Ð° (SHS 1-3)",
      university: "Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ¸Ñ‚ÐµÑ‚",
      level: "Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ",
      firstYear: "(ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ð³Ð¾Ð´)",
      secondYear: "(Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð³Ð¾Ð´)",
      thirdYear: "(Ð¢Ñ€ÐµÑ‚Ð¸Ð¹ Ð³Ð¾Ð´)",
      finalYear: "(ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð³Ð¾Ð´)",
      usersHeading: (count) => `ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ (${count})`,
      noUsers: "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹.",
      role: "Ð Ð¾Ð»ÑŒ",
      school: "Ð¨ÐºÐ¾Ð»Ð°",
      gradeText: "ÐšÐ»Ð°ÑÑ",
      promote: "ÐŸÐ¾Ð²Ñ‹ÑÐ¸Ñ‚ÑŒ",
      demote: "ÐŸÐ¾Ð½Ð¸Ð·Ð¸Ñ‚ÑŒ",
      suspend: "ÐŸÑ€Ð¸Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ",
      delete: "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ",
      note: "ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ðµ:",
      noteText: "Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸ ÑÐ²Ð¾ÐµÐ¹ ÑˆÐºÐ¾Ð»Ñ‹.",
      filesHeading: "Ð¤Ð°Ð¹Ð»Ñ‹ Ð²Ð°ÑˆÐµÐ¹ ÑˆÐºÐ¾Ð»Ñ‹",
      noFiles: "Ð¤Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ¹ ÑˆÐºÐ¾Ð»Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹.",
      type: "Ð¢Ð¸Ð¿",
      submittedBy: "ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾",
      viewFile: "ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ñ„Ð°Ð¹Ð»",
      alert: { /* same structure */ },
      contactForm: { /* same structure */ }
    }
      };

      let currentLang = localStorage.getItem("lang") || "en";
      const t = (key, ...args) => {
        const value = translations[currentLang][key];
        return typeof value === 'function' ? value(...args) : value;
      };
      
      const updateLang = (lang) => {
        currentLang = lang;
        localStorage.setItem("lang", lang);
        document.documentElement.lang = lang;
        render(); 
        
        document.getElementById('nav-dashboard').innerHTML = `<i class="fas fa-chart-pie mr-3"></i> ${translations[currentLang].dashboard}`;
        document.getElementById('nav-users').innerHTML = `<i class="fas fa-users mr-3"></i> ${translations[currentLang].manageUsers}`;
        document.getElementById('nav-files').innerHTML = `<i class="fas fa-folder-open mr-3"></i> ${translations[currentLang].manageFiles}`;
        document.getElementById('logout-button').innerHTML = `<i class="fas fa-sign-out-alt mr-3"></i> ${translations[currentLang].logout}`;

        document.getElementById('alert-cancel').textContent = translations[currentLang].alert.cancel;
        document.getElementById('alert-confirm').textContent = translations[currentLang].alert.ok;
        document.getElementById('contact-title').textContent = translations[currentLang].contactForm.title;
        document.getElementById('contact-name-label').textContent = translations[currentLang].contactForm.nameLabel;
        document.getElementById('contact-email-label').textContent = translations[currentLang].contactForm.emailLabel;
        document.getElementById('contact-message-label').textContent = translations[currentLang].contactForm.messageLabel;
        document.getElementById('closeContact').textContent = translations[currentLang].contactForm.cancel;
        document.querySelector('#contactForm button[type="submit"]').textContent = translations[currentLang].contactForm.send;

        const searchInput = document.getElementById('search-term');
        if(searchInput) searchInput.placeholder = translations[currentLang].searchPlaceholder;
      };


      const fetchAPI = async (url, options = {}) => {
  try {
    const response = await fetch(`${API_BASE_URL}${url}`, {
      ...options,
      credentials: 'include', 
      headers: {
        "Content-Type": "application/json",
      },
    });

    if (response.status === 401) {
      showCustomAlert(
        translations[currentLang].alert.sessionExpiredTitle,
        translations[currentLang].alert.sessionExpiredMessage
      );
      router.replace("/login.html");
      return { ok: false, status: 401 };
    }

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || translations[currentLang].alert.apiFailed(""));
    }

    return response;
  } catch (error) {
    console.error("Fetch error:", error);
    throw error;
  }
};


      const showCustomAlert = (title, message, options) => {
        const modal = document.getElementById("alert-modal");
        const titleEl = document.getElementById("alert-title");
        const messageEl = document.getElementById("alert-message");
        const confirmBtn = document.getElementById("alert-confirm");
        const cancelBtn = document.getElementById("alert-cancel");

        titleEl.textContent = title;
        messageEl.textContent = message;

        confirmBtn.onclick = () => {
          if (options && options.length > 1 && options[1].onPress) {
            options[1].onPress();
          }
          modal.classList.add("hidden");
        };

        if (options && options.length > 0 && (options[0].text === "Cancel" || options[0].text === "Annuler")) {
          cancelBtn.textContent = options[0].text;
          cancelBtn.onclick = () => modal.classList.add("hidden");
          cancelBtn.classList.remove("hidden");
        } else {
          cancelBtn.classList.add("hidden");
        }

        modal.classList.remove("hidden");
      };

      const state = {
        user: null,
        users: [],
        files: [],
        filteredUsers: [],
        roleFilter: "all",
        gradeFilter: "all",
        searchTerm: "",
        activeTab: "users",
        isLoading: false,
      };

   
const renderHeader = () => {
  // Header logic moved to static HTML structure
  const adminAvatar = document.getElementById('admin-avatar');
  if(adminAvatar && state.user) {
      adminAvatar.src = state.user.profile_picture_url || 'https://placehold.co/40x40/94a3b8/ffffff?text=A';
  }
  
  const langSelect = document.getElementById('lang-select');
  if(langSelect) {
      langSelect.value = currentLang;
      langSelect.onchange = (e) => updateLang(e.target.value);
  }
};

      const render = () => {
        renderHeader();
        if (state.activeTab === 'users') {
          renderUserManagement();
        } else if (state.activeTab === 'files') {
          renderFileManagement();
        } else if (state.activeTab === 'announcements') {
           // announcements handles its own rendering via changeTab
        } else {
          renderDashboard();
        }
      };

      const renderDashboard = () => {
          const container = document.getElementById("main-content");
          container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                            <i class="fas fa-users text-2xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Total Users</p>
                            <p class="text-2xl font-bold text-gray-800">${state.users.length}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                            <i class="fas fa-chalkboard-teacher text-2xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Teachers</p>
                            <p class="text-2xl font-bold text-gray-800">${state.users.filter(u => u.role === 'teacher').length}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                            <i class="fas fa-user-graduate text-2xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Students</p>
                            <p class="text-2xl font-bold text-gray-800">${state.users.filter(u => u.role === 'student').length}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Quick Actions</h3>
                <div class="flex gap-4">
                    <button onclick="changeTab('users')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Manage Users</button>
                    <button onclick="changeTab('files')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">Manage Files</button>
                </div>
            </div>
          `;
      }

      const renderUserManagement = () => {
        const container = document.getElementById("main-content");
        container.innerHTML = ''; // Clear content
        const usersSection = document.createElement("div");

        const filtersHtml = `
          <div class="bg-white rounded-xl shadow-md p-4 mb-5">
            <h2 class="text-base sm:text-lg font-semibold text-gray-800">${translations[currentLang].filters}</h2>
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label for="search-term" class="block text-gray-700 font-bold mb-2">${translations[currentLang].searchLabel}</label>
                <input type="text" id="search-term" value="${state.searchTerm}" placeholder="${translations[currentLang].searchPlaceholder}" class="w-full p-2 border rounded-lg">
              </div>
              <div>
                <label for="grade-filter" class="block text-gray-700 font-bold mb-2">${translations[currentLang].gradeFilterLabel}</label>
                <div class="picker-container">
                  <select id="grade-filter" class="picker">
                    <option value="all">${translations[currentLang].allGrades}</option>
                    <optgroup label="${translations[currentLang].upperGrade}">
                      <option value="5">${translations[currentLang].grade} 5 (Class 5)</option>
                      <option value="6">${translations[currentLang].grade} 6 (Class 6)</option>
                    </optgroup>
                    <optgroup label="${translations[currentLang].juniorHigh}">
                      <option value="7">${translations[currentLang].grade} 7 (Form 1)</option>
                      <option value="8">${translations[currentLang].grade} 8 (Form 2)</option>
                      <option value="9">${translations[currentLang].grade} 9 (Form 3)</option>
                    </optgroup>
                    <optgroup label="${translations[currentLang].seniorHigh}">
                      <option value="10">${translations[currentLang].grade} 10 (SHS 1)</option>
                      <option value="11">${translations[currentLang].grade} 11 (SHS 2)</option>
                      <option value="12">${translations[currentLang].grade} 12 (SHS 3)</option>
                    </optgroup>
                    <optgroup label="${translations[currentLang].university}">
                      <option value="100">${translations[currentLang].level} 100 ${translations[currentLang].firstYear}</option>
                      <option value="200">${translations[currentLang].level} 200 ${translations[currentLang].secondYear}</option>
                      <option value="300">${translations[currentLang].level} 300 ${translations[currentLang].thirdYear}</option>
                      <option value="400">${translations[currentLang].level} 400 ${translations[currentLang].finalYear}</option>
                    </optgroup>
                  </select>
                </div>
              </div>
            </div>
          </div>
        `;
        usersSection.innerHTML = filtersHtml;

        const usersListHeading = document.createElement("h2");
        usersListHeading.className = "text-lg sm:text-xl font-semibold text-gray-800 mb-4";
        usersListHeading.textContent = translations[currentLang].usersHeading(state.filteredUsers.length);
        usersSection.appendChild(usersListHeading);

        const usersList = document.createElement("div");
        usersList.id = "users-list";

        if (state.filteredUsers.length === 0) {
          const noUsers = document.createElement("p");
          noUsers.className = "text-center italic text-gray-500 py-5";
          noUsers.textContent = translations[currentLang].noUsers;
          usersList.appendChild(noUsers);
        } else {
          state.filteredUsers.forEach(u => {
            const userCard = document.createElement("div");
            userCard.className = "bg-white rounded-xl shadow-md p-4 mb-3 relative";
            userCard.innerHTML = `
              <h3 class="font-bold text-base sm:text-lg mb-1 text-gray-800">
                ${u.firstname} ${u.lastname} (<span class="text-gray-600 font-normal">${u.email}</span>)
              </h3>
              <p class="text-sm text-gray-600 mb-3">
                ${translations[currentLang].role}: ${u.occupation} | ${translations[currentLang].school}: ${u.schoolName || u.teacherSchool || "N/A"}
                ${u.occupation === "student" ? `| ${translations[currentLang].gradeText}: ${u.grade || "N/A"}` : ""}
              </p>
              <div class="flex flex-wrap gap-2">
                <button onclick="manageUser('${u.email}', 'promote')" class="action-button flex-1 bg-green-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-green-600 transition duration-300">${translations[currentLang].promote}</button>
                <button onclick="manageUser('${u.email}', 'demote')" class="action-button flex-1 bg-yellow-500 text-gray-900 font-bold py-2 px-3 rounded-lg hover:bg-yellow-600 transition duration-300">${translations[currentLang].demote}</button>
                <button onclick="manageUser('${u.email}', 'suspend')" class="action-button flex-1 bg-cyan-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-cyan-600 transition duration-300">${translations[currentLang].suspend}</button>
                <button onclick="confirmRemove('${u.email}', '${u.firstname} ${u.lastname}')" class="action-button flex-1 bg-red-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-red-600 transition duration-300">${translations[currentLang].delete}</button>
              </div>
            `;
            usersList.appendChild(userCard);
          });
        }
        usersSection.appendChild(usersList);

        const note = document.createElement("div");
        note.className = "mt-6 p-4 bg-gray-200 rounded-lg border-l-4 border-gray-500";
        note.innerHTML = `<h4 class="font-bold text-base text-gray-900 mb-1">${translations[currentLang].note}</h4><p class="text-sm text-gray-700">${translations[currentLang].noteText}</p>`;
        usersSection.appendChild(note);

        container.appendChild(usersSection);
        
        document.getElementById("search-term").addEventListener("input", (e) => {
          state.searchTerm = e.target.value;
          filterUsers();
        });
        document.getElementById("grade-filter").addEventListener("change", (e) => {
          state.gradeFilter = e.target.value;
          filterUsers();
        });
        document.getElementById("grade-filter").value = state.gradeFilter;
      };

      const renderFileManagement = () => {
        const container = document.getElementById("main-content");
        container.innerHTML = '';
        const filesSection = document.createElement("div");
        const filesListHeading = document.createElement("h2");
        filesListHeading.className = "text-lg sm:text-xl font-semibold text-gray-800 mb-4";
        filesListHeading.textContent = translations[currentLang].filesHeading;
        filesSection.appendChild(filesListHeading);
        
        const filesList = document.createElement("div");
        filesList.id = "files-list";

        if (state.files.length === 0) {
          const noFiles = document.createElement("p");
          noFiles.className = "text-center italic text-gray-500 py-5";
          noFiles.textContent = translations[currentLang].noFiles;
          filesList.appendChild(noFiles);
        } else {
          state.files.forEach(file => {
            const fileCard = document.createElement("div");
            fileCard.className = "bg-white rounded-xl shadow-md p-4 mb-3";
            fileCard.innerHTML = `
              <h3 class="font-bold text-base sm:text-lg mb-1 text-gray-800">${file.filename}</h3>
              <p class="text-sm text-gray-600">
                ${translations[currentLang].type}: ${file.type} | ${translations[currentLang].submittedBy}: ${file.submittedBy || "N/A"}
              </p>
              <a href="${file.url}" target="_blank" class="mt-2 inline-block text-blue-600 hover:underline">
                <i class="fas fa-eye mr-1"></i>${translations[currentLang].viewFile}
              </a>
            `;
            filesList.appendChild(fileCard);
          });
        }
        filesSection.appendChild(filesList);
        container.appendChild(filesSection);
      };

      const renderAnnouncements = () => {
        const container = document.getElementById("main-content");
        container.innerHTML = `
            <div class="bg-white rounded-xl shadow-md p-6 max-w-2xl mx-auto mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ðŸ“¢ Send Announcement</h2>
                <p class="text-gray-600 mb-6">Send a message to all teachers and students in your school.</p>
                <form id="announcement-form" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">Subject</label>
                        <input type="text" id="announcement-subject" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Announcement Subject">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">Message</label>
                        <textarea id="announcement-message" rows="5" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Type your message here..." required></textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300">
                        Send Announcement
                    </button>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 max-w-4xl mx-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ðŸ“œ Announcement History</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Date</th>
                                <th class="py-3 px-6 text-left">Message</th>
                                <th class="py-3 px-6 text-center">Recipients</th>
                            </tr>
                        </thead>
                        <tbody id="announcement-history-body" class="text-gray-600 text-sm font-light">
                            <tr><td colspan="3" class="text-center py-4">Loading history...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        const loadAnnouncementHistory = async () => {
            const tbody = document.getElementById('announcement-history-body');
            try {
                const res = await fetchAPI('/admin/announcements');
                const data = await res.json();
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4">No announcements sent yet.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(item => `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="py-3 px-6 text-left whitespace-nowrap">${new Date(item.sentAt).toLocaleString()}</td>
                        <td class="py-3 px-6 text-left">${item.content}</td>
                        <td class="py-3 px-6 text-center">${item.recipientCount}</td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500">Failed to load history.</td></tr>';
            }
        };

        document.getElementById("announcement-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const subject = document.getElementById("announcement-subject").value;
            const message = document.getElementById("announcement-message").value;
            const btn = e.target.querySelector("button");
            
            if(!message.trim()) return showCustomAlert("Error", "Message content is required.");

            btn.disabled = true;
            btn.textContent = "Sending...";

            try {
                const res = await fetchAPI("/admin/announcement", {
                    method: "POST",
                    body: JSON.stringify({ subject, message })
                });
                const data = await res.json();
                showCustomAlert("Success", data.message || "Announcement sent successfully!");
                document.getElementById("announcement-form").reset();
                loadAnnouncementHistory(); // Refresh history
            } catch (err) {
                console.error(err);
                showCustomAlert("Error", err.message || "Failed to send announcement.");
            } finally {
                btn.disabled = false;
                btn.textContent = "Send Announcement";
            }
        });

        loadAnnouncementHistory();
      };

      const changeTab = (tab) => {
        // Update active state in sidebar
        document.querySelectorAll('aside nav button').forEach(btn => {
            btn.classList.remove('bg-blue-50', 'text-blue-600');
            btn.classList.add('text-gray-600');
        });
        const activeBtn = document.getElementById(`nav-${tab}`);
        if(activeBtn) {
            activeBtn.classList.add('bg-blue-50', 'text-blue-600');
            activeBtn.classList.remove('text-gray-600');
        }

        // Close mobile sidebar if open
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        if (!sidebar.classList.contains('sidebar-closed') && window.innerWidth < 1024) {
             sidebar.classList.add('sidebar-closed');
             sidebar.classList.remove('sidebar-open');
             overlay.classList.add('hidden');
        }

        state.activeTab = tab;
        document.getElementById('header-title').textContent = translations[currentLang][tab] || 'Dashboard';

        if (tab === "users") {
          loadUsers();
        } else if (tab === "files") {
          loadFiles();
        } else if (tab === "announcements") {
          renderAnnouncements();
        } else {
            // Dashboard
            renderDashboard();
        }
      };

      const filterUsers = () => {
        let result = state.users;

        if (state.searchTerm) {
          const term = state.searchTerm.toLowerCase();
          result = result.filter(
            (u) =>
              (u.firstname && u.firstname.toLowerCase().includes(term)) ||
              (u.lastname && u.lastname.toLowerCase().includes(term)) ||
              (u.email && u.email.toLowerCase().includes(term))
          );
        }

        if (state.gradeFilter !== "all") {
          result = result.filter((u) => String(u.grade) === state.gradeFilter);
        }

        state.filteredUsers = result;
        render();
      };

      const loadUsers = async () => {
        state.isLoading = true;
        render();
        try {
          const res = await fetchAPI("/global-overseer/users"); // This endpoint handles admin role filtering on backend
          state.users = await res.json();
          filterUsers();
        } catch (err) {
          console.error("Failed to load users", err);
          showCustomAlert(translations[currentLang].alert.title, translations[currentLang].alert.loadUsersError);
        } finally {
          state.isLoading = false;
          render();
        }
      };

      const loadFiles = async () => {
        state.isLoading = true;
        render();
        try {
          const res = await fetchAPI("/admin/my-school-files");
          state.files = await res.json();
        } catch (err) {
          console.error("Failed to load files", err);
          showCustomAlert(translations[currentLang].alert.title, translations[currentLang].alert.loadFilesError);
        } finally {
          state.isLoading = false;
          render();
        }
      };

      const handleLogout = () => {
        showCustomAlert(
          translations[currentLang].alert.logoutConfirmTitle, 
          translations[currentLang].alert.logoutConfirmMessage,
          [
            { text: translations[currentLang].alert.cancel, style: "cancel" },
            {
              text: translations[currentLang].alert.logout,
              onPress: async () => {
                try {
                  await fetchAPI("/users/logout", { method: "POST" });
                  router.replace("/login.html");
                } catch (error) {
                  console.error("Logout failed:", error);
                  showCustomAlert(
                    translations[currentLang].alert.logoutErrorTitle,
                    translations[currentLang].alert.logoutErrorMessage,
                  );
                }
              },
            },
          ]
        );
      };

      const manageUser = async (email, action) => {
        try {
            const endpoint = `/global-overseer/users/${email}/${action}`;
            const res = await fetchAPI(endpoint, { method: "PUT" });
            const data = await res.json();
            if (data.status === 'success') {
                showCustomAlert(translations[currentLang].alert.successTitle, data.message);
                loadUsers();
            } else {
                showCustomAlert(translations[currentLang].alert.title, data.message || translations[currentLang].alert.generalError(translations[currentLang][action]));
            }
        } catch (error) {
            console.error(`Error managing user:`, error);
            showCustomAlert(translations[currentLang].alert.title, translations[currentLang].alert.generalError(translations[currentLang][action]));
        }
      };
      
      const confirmRemove = (email, userName) => {
        showCustomAlert(
            translations[currentLang].alert.confirmDeleteTitle,
            translations[currentLang].alert.confirmDeleteMessage(userName),
            [
                { text: translations[currentLang].alert.cancel, style: "cancel" },
                { 
                    text: translations[currentLang].alert.delete,
                    onPress: async () => {
                        try {
                            const res = await fetchAPI(`/global-overseer/users${email}/delete`, { method: "DELETE" });
                            const data = await res.json();
                            if (data.status === 'success') {
                                showCustomAlert(translations[currentLang].alert.successTitle, data.message);
                                loadUsers();
                            } else {
                                showCustomAlert(translations[currentLang].alert.title, data.message || translations[currentLang].alert.generalError("delete"));
                            }
                        } catch (error) {
                            console.error(`Error deleting user:`, error);
                            showCustomAlert(translations[currentLang].alert.title, translations[currentLang].alert.generalError("delete"));
                        }
                    }
                }
            ]
        );
      };

      window.onload = () => {
        updateLang(currentLang);
        loadUsers();
      };
    </script>
  </body>
</html>