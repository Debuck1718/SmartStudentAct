<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f5f5f5;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen px-4">

    <div class="w-full max-w-md bg-white shadow-md rounded-2xl p-8">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">SmartStudentAct Login</h1>

        <div id="banner" class="hidden text-center mb-4 p-3 rounded-lg text-sm transition-all duration-300"></div>

        <!-- Email -->
        <div class="mb-4">
            <input id="emailInput" type="email" 
                   class="w-full h-12 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                   placeholder="Email" autocomplete="email" />
            <p id="emailError" class="text-red-500 text-sm mt-1"></p>
        </div>

        <!-- Password -->
        <div class="mb-4">
            <div class="flex items-center border border-gray-300 rounded-lg bg-white">
                <input id="passwordInput" type="password" 
                       class="w-full h-12 px-4 rounded-l-lg focus:outline-none"
                       placeholder="Password" autocomplete="current-password" />
                <button id="passwordToggle" type="button" class="px-4 text-blue-600 font-bold">Show</button>
            </div>
            <p id="passwordError" class="text-red-500 text-sm mt-1"></p>
        </div>

        <!-- Login Button -->
        <button id="loginButton" 
                class="w-full h-12 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition">
            Login
        </button>

        <!-- Links -->
        <div class="mt-6 text-center space-y-2">
            <a href="/signup.html" class="text-blue-600 hover:underline">Don’t have an account? Sign up</a><br />
            <a href="/forgot-password.html" class="text-blue-600 hover:underline">Forgot Password?</a>
        </div>
    </div>

<script>
    // A helper function to show a banner message
    function showBanner(message, type = 'error') {
        const bannerEl = document.getElementById("banner");
        bannerEl.textContent = message;
        bannerEl.classList.remove("hidden");
        if (type === 'error') {
            bannerEl.classList.add("bg-red-100", "text-red-700");
            bannerEl.classList.remove("bg-green-100", "text-green-700", "bg-gray-100", "text-gray-700");
        } else if (type === 'success') {
            bannerEl.classList.add("bg-green-100", "text-green-700");
            bannerEl.classList.remove("bg-red-100", "text-red-700", "bg-gray-100", "text-gray-700");
        } else { // info
            bannerEl.classList.add("bg-gray-100", "text-gray-700");
            bannerEl.classList.remove("bg-red-100", "text-red-700", "bg-green-100", "text-green-700");
        }
    }

    // A helper function to hide the banner
    function hideBanner() {
        const bannerEl = document.getElementById("banner");
        bannerEl.classList.add("hidden");
    }

    // --- UI and State Management ---
    const API_BASE_URL = "https://smartstudentact.onrender.com";
    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const loginButton = document.getElementById("loginButton");
    const passwordToggle = document.getElementById("passwordToggle");
    const emailErrorEl = document.getElementById("emailError");
    const passwordErrorEl = document.getElementById("passwordError");

    let showPassword = false;

    function setLoading(isLoading) {
        loginButton.disabled = isLoading;
        loginButton.innerHTML = isLoading ? '<div class="spinner mx-auto"></div>' : 'Login';
    }

    function setError(element, message, inputElement) {
        if (message) {
            element.textContent = message;
            inputElement.classList.add("border-red-500");
        } else {
            element.textContent = "";
            inputElement.classList.remove("border-red-500");
        }
    }

    // --- Validation Logic ---
    function validateEmail(text) {
        if (!text.trim()) return "Email cannot be empty.";
        if (!/\S+@\S+\.\S+/.test(text)) return "Please enter a valid email address.";
        return null;
    }

    function validatePassword(text) {
        if (!text.trim()) return "Password cannot be empty.";
        if (text.length < 6) return "Password must be at least 6 characters long.";
        return null;
    }

    // --- Event Listeners ---
    emailInput.addEventListener("input", () => {
        setError(emailErrorEl, null, emailInput);
        hideBanner();
    });

    passwordInput.addEventListener("input", () => {
        setError(passwordErrorEl, null, passwordInput);
        hideBanner();
    });

    passwordToggle.addEventListener("click", () => {
        showPassword = !showPassword;
        passwordInput.type = showPassword ? "text" : "password";
        passwordToggle.textContent = showPassword ? "Hide" : "Show";
    });

    loginButton.addEventListener("click", handleLogin);

    // --- Main Login Function ---
    async function handleLogin() {
        setError(emailErrorEl, null, emailInput);
        setError(passwordErrorEl, null, passwordInput);
        hideBanner();

        const emailValidationResult = validateEmail(emailInput.value);
        const passwordValidationResult = validatePassword(passwordInput.value);

        setError(emailErrorEl, emailValidationResult, emailInput);
        setError(passwordErrorEl, passwordValidationResult, passwordInput);
        if (emailValidationResult || passwordValidationResult) return;

        setLoading(true);

        try {
            const response = await fetch(`${API_BASE_URL}/users/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include", // ✅ Ensures the browser sends the session cookie automatically
                body: JSON.stringify({
                    email: emailInput.value.trim().toLowerCase(),
                    password: passwordInput.value
                })
            });

            if (!response.ok) {
                if (response.status === 429) {
                    showBanner("Too many login attempts. Your account is temporarily locked.", 'error');
                } else {
                    const data = await response.json().catch(() => {});
                    showBanner(data?.error || "Login failed. Invalid email or password.", 'error');
                }
                return;
            }
            
            const data = await response.json().catch(() => {
                throw new Error("Server did not return JSON");
            });

            // ✅ Store CSRF token. The session cookie is handled by the browser.
            if (data.csrfToken) {
                localStorage.setItem("csrfToken", data.csrfToken);
            }

            // ✅ Redirect based on role
            switch (data.user?.role) {
                case "global_overseer":
                    window.location.href = "/global_overseer.html";
                    break;
                case "overseer":
                    window.location.href = "/overseer.html";
                    break;
                case "student":
                    window.location.href = "/students.html";
                    break;
                case "teacher":
                    window.location.href = "/teachers.html";
                    break;
                case "admin":
                    window.location.href = "/admin.html";
                    break;
                default:
                    showBanner("Invalid user role.", 'error');
            }
        } catch (error) {
            showBanner("An unexpected error occurred. Please try again later.", 'error');
            console.error("Login error:", error);
        } finally {
            setLoading(false);
        }
    }
</script>
</body>
</html>
