<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartStudentAct Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">
  <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-md">
    <!-- Banner -->
    <div id="banner" class="hidden p-3 rounded-md mb-4 text-sm font-medium"></div>

    <h2 class="text-2xl font-bold text-center mb-6">Login</h2>

    <!-- ✅ Form -->
    <form id="loginForm" class="space-y-4">
      <!-- Email -->
      <div>
        <label for="email" class="block text-sm font-medium">Email</label>
        <input id="email" type="email" required
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"/>
        <p id="emailError" class="text-sm text-red-500"></p>
      </div>

      <!-- Password -->
      <div>
        <label for="password" class="block text-sm font-medium">Password</label>
        <div class="relative">
          <input id="password" type="password" required
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 pr-12"/>
          <button type="button" id="passwordToggle"
            class="absolute inset-y-0 right-0 px-3 text-sm text-gray-500">Show</button>
        </div>
        <p id="passwordError" class="text-sm text-red-500"></p>
      </div>

      <!-- Button -->
      <button id="loginButton" type="submit"
        class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700">Login</button>
    </form>

    <!-- Links -->
    <div class="mt-6 text-center space-y-2">
      <a href="/signup.html" class="text-blue-600 hover:underline">Don’t have an account? Sign up</a><br />
      <a href="/forgot-password.html" class="text-blue-600 hover:underline">Forgot Password?</a>
    </div>
  </div>

  <!-- ✅ Script at END so elements exist -->
  <script>
  // --- Banner helpers ---
  function showBanner(message, type = "error") {
    const bannerEl = document.getElementById("banner");
    bannerEl.textContent = message;
    bannerEl.classList.remove("hidden");
    if (type === "error") {
      bannerEl.className = "p-3 rounded-md mb-4 text-sm font-medium bg-red-100 text-red-700";
    } else if (type === "success") {
      bannerEl.className = "p-3 rounded-md mb-4 text-sm font-medium bg-green-100 text-green-700";
    } else {
      bannerEl.className = "p-3 rounded-md mb-4 text-sm font-medium bg-gray-100 text-gray-700";
    }
  }
  function hideBanner() {
    document.getElementById("banner").classList.add("hidden");
  }

  // --- UI refs ---
  const API_BASE_URL = "https://smartstudentact.onrender.com/api";
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const loginButton = document.getElementById("loginButton");
  const passwordToggle = document.getElementById("passwordToggle");
  const emailErrorEl = document.getElementById("emailError");
  const passwordErrorEl = document.getElementById("passwordError");
  let showPassword = false;

  function setError(element, message, inputElement) {
    if (message) {
      element.textContent = message;
      inputElement.classList.add("border-red-500");
    } else {
      element.textContent = "";
      inputElement.classList.remove("border-red-500");
    }
  }

  // Validation
  function validateEmail(text) {
    if (!text.trim()) return "Email cannot be empty.";
    if (!/\S+@\S+\.\S+/.test(text)) return "Please enter a valid email address.";
    return null;
  }
  function validatePassword(text) {
    if (!text.trim()) return "Password cannot be empty.";
    if (text.length < 6) return "Password must be at least 6 characters long.";
    return null;
  }

  // Password toggle
  if (passwordToggle) {
    passwordToggle.addEventListener("click", () => {
      showPassword = !showPassword;
      passwordInput.type = showPassword ? "text" : "password";
      passwordToggle.textContent = showPassword ? "Hide" : "Show";
    });
  }

  // --- API Fetch wrapper ---
  async function apiFetch(endpoint, options = {}) {
    const authToken = localStorage.getItem("authToken");
    const csrfToken = localStorage.getItem("csrfToken");

    // Routes that skip CSRF
    const CSRF_EXEMPT = [
      "/users/login",
      "/users/signup",
      "/users/verify-otp",
      "/auth/forgot-password",
      "/auth/reset-password"
    ];

    const headers = {
      "Content-Type": "application/json",
      ...(authToken && { Authorization: `Bearer ${authToken}` }),
      ...options.headers
    };

    // Only attach CSRF token if not exempt
    if (csrfToken && !CSRF_EXEMPT.includes(endpoint)) {
      headers["X-CSRF-Token"] = csrfToken;
    }

    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
      ...options,
      headers,
      credentials: "include"
    });

    const data = await response.json();
    if (data.csrfToken) {
      localStorage.setItem("csrfToken", data.csrfToken);
    }
    return data;
  }

  // --- Main Login ---
  async function handleLogin(e) {
    e.preventDefault();
    hideBanner();

    // Validate
    const emailErr = validateEmail(emailInput.value);
    const passErr = validatePassword(passwordInput.value);
    setError(emailErrorEl, emailErr, emailInput);
    setError(passwordErrorEl, passErr, passwordInput);
    if (emailErr || passErr) return;

    try {
      const data = await apiFetch("/users/login", {
        method: "POST",
        body: JSON.stringify({
          email: emailInput.value.trim().toLowerCase(),
          password: passwordInput.value
        })
      });

      if (data.token) {
        localStorage.setItem("authToken", data.token);
        if (data.csrfToken) {
          localStorage.setItem("csrfToken", data.csrfToken);
        }
        showBanner("✅ Login successful!", "success");
        window.location.href = "/dashboard.html";
      } else {
        showBanner("❌ " + (data.message || "Login failed"), "error");
      }
    } catch (err) {
      console.error("Login error:", err);
      showBanner("❌ Login request failed", "error");
    }
  }

  // Attach listener safely
  const loginForm = document.getElementById("loginForm");
  if (loginForm) {
    loginForm.addEventListener("submit", handleLogin);
  }
</script>

</body>
</html>

