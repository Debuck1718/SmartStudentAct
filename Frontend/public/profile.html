<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n="pageTitle">My Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Make sure translate.js is reachable and defines translatePage / translateElements -->
  <script src="translate.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    .message-box {
      position: fixed; bottom: 1rem; right: 1rem; z-index: 50;
      padding: .75rem 1rem; border-radius: .5rem; color: #fff; font-weight: 600;
      transform: translateX(120%); transition: transform .25s ease-in-out, opacity .25s;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      opacity: 0;
    }
    .message-box.show { transform: translateX(0); opacity: 1; }
    .message-box.success { background:#16a34a; }
    .message-box.error { background:#ef4444; }
    .input:disabled { background:#f3f4f6; color:#6b7280; cursor:not-allowed; }
    .input-error { border-color:#ef4444 !important; }
    /* Simple RTL helper */
    [dir="rtl"] .rtl-flip { direction: rtl; text-align: right; }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">

  <!-- Top bar -->
  <header class="bg-white shadow">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <button type="button" id="back-btn"
        class="text-gray-600 hover:text-gray-800"
        onclick="history.back()"
        data-i18n="backButton">‚Üê Back</button>

      <!-- Language dropdown -->
      <div class="flex items-center gap-2">
        <label for="lang" class="text-sm text-gray-600">üåê</label>
        <select id="lang" class="border rounded-lg px-2 py-1 text-sm">
          <option value="en">English</option>
          <option value="fr">Fran√ßais</option>
          <option value="es">Espa√±ol</option>
          <option value="tr">T√ºrk√ße</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        </select>
      </div>
    </div>
  </header>

  <!-- Loading overlay -->
  <div id="loading" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-40">
    <div class="flex flex-col items-center">
      <svg class="animate-spin h-10 w-10 text-blue-600" viewBox="0 0 24 24" fill="none">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.38 0 0 5.38 0 12h4z"></path>
      </svg>
      <p class="mt-2 text-gray-600 font-semibold" data-i18n="loadingText">Loading profile...</p>
    </div>
  </div>

  <main class="max-w-5xl mx-auto p-4 md:p-6">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-6 rtl-flip" data-i18n="mainTitle">üë§ My Profile</h1>

    <form id="profile-form" class="bg-white rounded-2xl shadow p-6 md:p-8 space-y-8">

      <!-- Avatar -->
      <section class="flex flex-col items-center gap-3">
        <img id="avatar" src="https://placehold.co/128x128/e5e7eb/111?text=üë§"
             alt="Profile Picture" class="w-28 h-28 rounded-full border-4 border-white shadow object-cover"/>
        <div class="flex flex-col items-center gap-2">
          <input id="avatar-input" type="file" accept="image/*" class="hidden"/>
          <button type="button" id="change-pic"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            data-i18n="changePicture">Change Picture</button>
        </div>
      </section>

      <!-- Personal info -->
      <section class="space-y-4">
        <h2 class="text-xl font-semibold text-blue-800 border-b pb-2" data-i18n="personalInfoSection">Personal Information</h2>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="firstNameLabel">First Name:</label>
            <input id="firstName" name="firstName" type="text"
                   class="input w-full border rounded-lg px-3 py-2"/>
            <p id="firstName-error" class="hidden text-sm text-red-600 mt-1"></p>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="lastNameLabel">Last Name:</label>
            <input id="lastName" name="lastName" type="text"
                   class="input w-full border rounded-lg px-3 py-2"/>
            <p id="lastName-error" class="hidden text-sm text-red-600 mt-1"></p>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="emailLabel">Email:</label>
            <input id="email" name="email" type="email"
                   class="input w-full border rounded-lg px-3 py-2 bg-gray-50" readonly disabled/>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="phoneLabel">Phone:</label>
            <input id="phone" name="phone" type="tel"
                   class="input w-full border rounded-lg px-3 py-2"/>
            <p id="phone-error" class="hidden text-sm text-red-600 mt-1"></p>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="occupationLabel">Occupation:</label>
            <input id="occupation" name="occupation" type="text"
                   class="input w-full border rounded-lg px-3 py-2 bg-gray-50" readonly disabled/>
          </div>
        </div>
      </section>

      <!-- Student section -->
      <section id="student-section" class="space-y-4 hidden">
        <h3 class="text-lg font-semibold text-gray-800" data-i18n="academicDetailsSection">Academic Details</h3>

        <div>
          <label class="block text-sm font-medium mb-1" data-i18n="educationLevelLabel">Education Level:</label>
          <select id="educationLevel" name="educationLevel" class="input w-full border rounded-lg px-3 py-2">
            <option value="" data-i18n="selectEducationLevel">Select Education Level</option>
            <option value="junior" data-i18n="juniorHigh">Junior High</option>
            <option value="high" data-i18n="seniorHigh">Senior High</option>
            <option value="university" data-i18n="university">University</option>
          </select>
          <p id="educationLevel-error" class="hidden text-sm text-red-600 mt-1"></p>
        </div>

        <div id="school-fields" class="grid md:grid-cols-2 gap-4 hidden">
          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="gradeLabel">Grade:</label>
            <input id="grade" name="grade" type="text" class="input w-full border rounded-lg px-3 py-2"/>
            <p id="grade-error" class="hidden text-sm text-red-600 mt-1"></p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="schoolNameLabel">School Name:</label>
            <input id="schoolName" name="schoolName" type="text" class="input w-full border rounded-lg px-3 py-2"/>
            <p id="schoolName-error" class="hidden text-sm text-red-600 mt-1"></p>
          </div>
        </div>

        <div id="university-fields" class="grid md:grid-cols-3 gap-4 hidden">
          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="universityLabel">University:</label>
            <input id="university" name="university" type="text" class="input w-full border rounded-lg px-3 py-2"/>
            <p id="university-error" class="hidden text-sm text-red-600 mt-1"></p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="levelLabel">Level:</label>
            <input id="uniLevel" name="uniLevel" type="text" class="input w-full border rounded-lg px-3 py-2"/>
            <p id="uniLevel-error" class="hidden text-sm text-red-600 mt-1"></p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="programLabel">Program:</label>
            <input id="program" name="program" type="text" class="input w-full border rounded-lg px-3 py-2"/>
            <p id="program-error" class="hidden text-sm text-red-600 mt-1"></p>
          </div>
        </div>
      </section>

      <!-- Teacher section -->
      <section id="teacher-section" class="space-y-4 hidden">
        <h3 class="text-lg font-semibold text-gray-800" data-i18n="professionalDetailsSection">Professional Details</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="teacherSchoolLabel">School:</label>
            <input id="teacherSchool" name="teacherSchool" type="text" class="input w-full border rounded-lg px-3 py-2"/>
            <p id="teacherSchool-error" class="hidden text-sm text-red-600 mt-1"></p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" data-i18n="gradeTaughtLabel">Grade Taught:</label>
            <input id="teacherGrade" name="teacherGrade" type="text" class="input w-full border rounded-lg px-3 py-2"/>
            <p id="teacherGrade-error" class="hidden text-sm text-red-600 mt-1"></p>
          </div>
        </div>
      </section>

      <!-- Admin section -->
      <section id="admin-section" class="space-y-4 hidden">
        <h3 class="text-lg font-semibold text-gray-800" data-i18n="adminSchoolDetailsSection">Admin School Details</h3>
        <div>
          <label class="block text-sm font-medium mb-1" data-i18n="assignedSchoolLabel">Assigned School:</label>
          <input id="adminSchool" name="adminSchool" type="text" class="input w-full border rounded-lg px-3 py-2"/>
          <p id="adminSchool-error" class="hidden text-sm text-red-600 mt-1"></p>
        </div>
      </section>

      <!-- Save -->
      <div class="pt-2">
        <button id="save" type="submit"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg flex items-center justify-center gap-2">
          <span data-i18n="saveChangesButton">Save Profile Changes</span>
          <svg id="spinner" class="hidden animate-spin h-5 w-5 text-white" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.38 0 0 5.38 0 12h4z"></path>
          </svg>
        </button>
        <p class="text-center text-gray-400 text-sm mt-6" data-i18n="copyright">¬© 2025 SmartStudentAct</p>
      </div>
    </form>
  </main>

  <div id="toast" class="message-box"></div>

  <script>
    const API_BASE_URL = "https://smartstudentact.onrender.com/api";

    // Global-ish state
    let currentLang = localStorage.getItem("lang") || "en";
    let userData = {};
    let saving = false;
    let uploading = false;

    // --- Helpers ---
    const $ = (id) => document.getElementById(id);
    const stripColon = (s) => (typeof s === "string" ? s.replace(/[:Ôºö]\s*$/, "") : String(s));
    const getT = (key) => {
      try {
        if (typeof translations !== "undefined" && translations[key]) {
          const val = translations[key][currentLang] || translations[key]["en"];
          if (typeof val === "string") return val;
        }
      } catch {}
      return key; // safe fallback
    };
    const toast = (msg, type = "success") => {
      const box = $("toast");
      box.textContent = msg;
      box.className = `message-box ${type} show`;
      setTimeout(() => box.classList.remove("show"), 2600);
    };
    const setDir = () => {
      document.documentElement.lang = currentLang;
      document.documentElement.dir = currentLang === "ar" ? "rtl" : "ltr";
    };
    const toggleSpinner = (on) => {
      saving = !!on;
      $("spinner").classList.toggle("hidden", !saving);
      $("save").classList.toggle("opacity-70", saving);
      $("save").classList.toggle("cursor-not-allowed", saving);
      $("save").disabled = saving;
      $("save").querySelector("span").textContent = on ? getT("saving") : getT("saveChangesButton");
      // disable inputs while saving/uploading
      document.querySelectorAll(".input, #change-pic, #lang").forEach(el => el.disabled = saving || uploading);
    };

    // --- Render visibility by occupation / edu level ---
    const renderSections = () => {
      const occ = userData.occupation || "";
      const edu = userData.educationLevel || "";

      $("student-section").classList.toggle("hidden", occ !== "student");
      $("teacher-section").classList.toggle("hidden", occ !== "teacher");
      $("admin-section").classList.toggle("hidden", occ !== "admin");

      $("school-fields").classList.toggle("hidden", !(occ === "student" && (edu === "junior" || edu === "high")));
      $("university-fields").classList.toggle("hidden", !(occ === "student" && edu === "university"));
    };

    // --- Validation ---
    function showFieldError(id, msg) {
      const el = $(id);
      const err = $(`${id}-error`);
      if (!err) return true;
      if (msg) {
        err.textContent = msg;
        err.classList.remove("hidden");
        el && el.classList.add("input-error");
        return false;
      } else {
        err.classList.add("hidden");
        el && el.classList.remove("input-error");
        return true;
      }
    }

    function validateAll() {
      let ok = true;

      // first/last name
      if (!($("firstName").value || "").trim()) {
        ok = showFieldError("firstName", stripColon(getT("firstNameLabel")) + getT("required")) && ok;
      } else showFieldError("firstName", "");

      if (!($("lastName").value || "").trim()) {
        ok = showFieldError("lastName", stripColon(getT("lastNameLabel")) + getT("required")) && ok;
      } else showFieldError("lastName", "");

      // phone
      const phoneVal = ($("phone").value || "").trim();
      if (!phoneVal) {
        ok = showFieldError("phone", getT("phoneRequired")) && ok;
      } else if (!/^\+?[0-9]{7,15}$/.test(phoneVal)) {
        ok = showFieldError("phone", getT("invalidPhone")) && ok;
      } else showFieldError("phone", "");

      // occupation-specific
      const occ = userData.occupation;
      const edu = $("educationLevel").value;

      if (occ === "student") {
        if (!edu) {
          ok = showFieldError("educationLevel", getT("educationLevelRequired")) && ok;
        } else showFieldError("educationLevel", "");

        if (edu === "junior" || edu === "high") {
          if (!($("grade").value || "").trim()) {
            ok = showFieldError("grade", stripColon(getT("gradeLabel")) + getT("required")) && ok;
          } else showFieldError("grade", "");
          if (!($("schoolName").value || "").trim()) {
            ok = showFieldError("schoolName", getT("schoolNameRequired")) && ok;
          } else showFieldError("schoolName", "");
        } else if (edu === "university") {
          ["university","uniLevel","program"].forEach(fid=>{
            if (!($(fid).value || "").trim()) {
              ok = showFieldError(fid, stripColon(getT(fid + "Label")) + getT("required")) && ok;
            } else showFieldError(fid, "");
          });
        }
      } else if (occ === "teacher") {
        ["teacherSchool","teacherGrade"].forEach(fid=>{
          if (!($(fid).value || "").trim()) {
            ok = showFieldError(fid, stripColon(getT(fid + "Label")) + getT("required")) && ok;
          } else showFieldError(fid, "");
        });
      } else if (occ === "admin") {
        if (!($("adminSchool").value || "").trim()) {
          ok = showFieldError("adminSchool", getT("schoolNameRequired")) && ok;
        } else showFieldError("adminSchool", "");
      }

      return ok;
    }

    // --- Data I/O ---
    async function loadProfile() {
      try {
        const res = await fetch(`${API_BASE_URL}/profile`, { credentials: "include" });
        if (!res.ok) throw new Error(getT("loadFailed"));
        const data = await res.json();
        userData = data || {};

        // Fill fields (guard against undefined)
        $("avatar").src = userData.profile_picture_url || "https://placehold.co/128x128/e5e7eb/111?text=üë§";
        ["firstName","lastName","email","phone","occupation","educationLevel","grade","schoolName",
         "university","uniLevel","program","teacherSchool","teacherGrade","adminSchool"].forEach(k=>{
          if ($(k) && typeof userData[k] !== "undefined") $(k).value = userData[k] ?? "";
        });

        renderSections();
      } catch (e) {
        console.error(e);
        toast(getT("couldNotFetch"), "error");
      } finally {
        $("loading").classList.add("hidden");
      }
    }

    async function saveProfile(e) {
      e.preventDefault();
      if (!validateAll()) {
        toast(getT("fixErrors"), "error");
        return;
      }

      const payload = {
        firstName: $("firstName").value.trim(),
        lastName: $("lastName").value.trim(),
        phone: $("phone").value.trim(),
        // email & occupation are readonly
        educationLevel: $("educationLevel").value || null,
        grade: $("grade")?.value?.trim() || null,
        schoolName: $("schoolName")?.value?.trim() || null,
        university: $("university")?.value?.trim() || null,
        uniLevel: $("uniLevel")?.value?.trim() || null,
        program: $("program")?.value?.trim() || null,
        teacherSchool: $("teacherSchool")?.value?.trim() || null,
        teacherGrade: $("teacherGrade")?.value?.trim() || null,
        adminSchool: $("adminSchool")?.value?.trim() || null,
      };

      toggleSpinner(true);
      try {
        const res = await fetch(`${API_BASE_URL}/profile`, {
          method: "PATCH",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok) throw new Error(data?.message || getT("updateFailed"));

        userData = { ...userData, ...payload };
        toast(getT("profileUpdatedSuccess"), "success");
      } catch (err) {
        console.error(err);
        toast(getT("couldNotSave"), "error");
      } finally {
        toggleSpinner(false);
      }
    }

    async function uploadAvatar(file) {
      if (!file) { toast(getT("noFileSelected"), "error"); return; }
      uploading = true; toggleSpinner(false);
      toast(getT("uploadingPhoto"), "success");

      try {
        const form = new FormData();
        form.append("profilePhoto", file);

        const res = await fetch(`${API_BASE_URL}/profile/upload-photo`, {
          method: "POST",
          credentials: "include",
          body: form
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data?.message || getT("uploadFailed"));

        $("avatar").src = data.photoUrl || $("avatar").src;
        userData.profile_picture_url = data.photoUrl || userData.profile_picture_url;
        toast(getT("photoUploadedSuccess"), "success");
      } catch (e) {
        console.error(e);
        toast(getT("uploadFailed"), "error");
      } finally {
        uploading = false; toggleSpinner(false);
      }
    }

    // --- Events / Init ---
    document.addEventListener("DOMContentLoaded", () => {
      // Language init
      $("lang").value = currentLang;
      setDir();
      if (typeof translatePage === "function") {
        translatePage("profile", currentLang);
      }

      $("lang").addEventListener("change", (e) => {
        currentLang = e.target.value;
        localStorage.setItem("lang", currentLang);
        setDir();
        if (typeof translatePage === "function") translatePage("profile", currentLang);
        // Also re-run translations for any dynamically created content if needed:
        if (typeof translateElements === "function") translateElements(document.body);
      });

      // Form listeners
      $("profile-form").addEventListener("submit", saveProfile);
      document.body.addEventListener("input", (e) => {
        const id = e.target?.id;
        if (!id) return;
        // keep local state in sync for section toggles
        userData[id] = e.target.value;
        if (id === "educationLevel") renderSections();
      });

      // Avatar
      $("change-pic").addEventListener("click", () => $("avatar-input").click());
      $("avatar-input").addEventListener("change", (e) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => { $("avatar").src = ev.target.result; };
          reader.readAsDataURL(file);
          uploadAvatar(file); // async upload
        }
      });

      loadProfile();
    });
  </script>
</body>
</html>
