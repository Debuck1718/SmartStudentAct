<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n="pageTitle">My Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="./images/icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
  <script src="translate.js"></script>
  <style>
    body { font-family: "Inter", system-ui, sans-serif; }
    .message-box { position: fixed; bottom: 1rem; right: 1rem; z-index: 50; padding: .75rem 1rem; border-radius: .75rem; color: #fff; font-weight: 500; transform: translateX(120%); transition: transform .25s ease, opacity .25s; box-shadow: 0 8px 20px rgba(0,0,0,.15); opacity: 0; }
    .message-box.show { transform: translateX(0); opacity: 1; }
    .message-box.success { background:#16a34a; }
    .message-box.error { background:#dc2626; }
    .input:disabled { background:#f9fafb; color:#6b7280; cursor:not-allowed; }
    .input-error { border-color:#dc2626 !important; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <button type="button" onclick="history.back()" data-i18n="backButton"
        class="text-gray-600 hover:text-gray-900 font-medium flex items-center gap-1">‚Üê Back</button>

      <div class="flex items-center gap-2">
        <label for="lang" class="text-sm text-gray-600">üåê</label>
        <select id="lang" class="border rounded-lg px-2 py-1 text-sm focus:ring focus:ring-blue-300">
          <option value="en">English</option>
          <option value="fr">Fran√ßais</option>
          <option value="es">Espa√±ol</option>
          <option value="tr">T√ºrk√ße</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        </select>
      </div>
    </div>
  </header>


  <div id="loading" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-40">
    <div class="flex flex-col items-center">
      <svg class="animate-spin h-10 w-10 text-blue-600" viewBox="0 0 24 24" fill="none">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.38 0 0 5.38 0 12h4z"></path>
      </svg>
      <p class="mt-3 text-gray-600 font-medium" data-i18n="loadingText">Loading profile...</p>
    </div>
  </div>


  <main class="max-w-6xl mx-auto p-4 md:p-8">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-6" data-i18n="mainTitle">üë§ My Profile</h1>

    <form id="profile-form" class="bg-white rounded-2xl shadow-lg p-6 md:p-10 space-y-10">

      <section class="flex flex-col md:flex-row items-center md:items-start gap-6 md:gap-10">
        <div class="relative">
          <img id="avatar" src="https://placehold.co/128x128/e5e7eb/111?text=üë§" alt="Profile Picture"
            class="w-32 h-32 md:w-36 md:h-36 rounded-full border-4 border-white shadow-md object-cover"/>
          <input id="avatar-input" type="file" accept="image/*" class="hidden"/>
          <button type="button" id="change-pic"
            class="absolute -bottom-2 left-1/2 -translate-x-1/2 px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 shadow"
            data-i18n="changePicture">Change</button>
        </div>

        <div class="text-center md:text-left">
          <h2 id="profile-name" class="text-2xl font-semibold text-gray-900">First Last</h2>
          <p id="profile-role" class="text-gray-500 capitalize">role</p>
        </div>
      </section>

      <section class="space-y-4">
        <h2 class="text-xl font-semibold text-blue-700 border-b pb-2" data-i18n="personalInfoSection">Personal Information</h2>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label data-i18n="firstNameLabel" class="block text-sm font-medium mb-1">First Name</label>
            <input id="firstname" name="firstname" type="text" class="input w-full border rounded-lg px-3 py-2"/>
          </div>
          <div>
            <label data-i18n="lastNameLabel" class="block text-sm font-medium mb-1">Last Name</label>
            <input id="lastname" name="lastname" type="text" class="input w-full border rounded-lg px-3 py-2"/>
          </div>
          <div>
            <label data-i18n="emailLabel" class="block text-sm font-medium mb-1">Email</label>
            <input id="email" name="email" type="email" class="input w-full border rounded-lg px-3 py-2 bg-gray-50" readonly disabled/>
          </div>
          <div>
            <label data-i18n="phoneLabel" class="block text-sm font-medium mb-1">Phone</label>
            <input id="phone" name="phone" type="tel" class="input w-full border rounded-lg px-3 py-2"/>
          </div>
          <div>
            <label data-i18n="occupationLabel" class="block text-sm font-medium mb-1">Occupation</label>
            <input id="occupation" name="occupation" type="text" class="input w-full border rounded-lg px-3 py-2 bg-gray-50" readonly disabled/>
          </div>
        </div>
      </section>

      <section id="student-section" class="space-y-4 hidden">
        <h3 data-i18n="academicDetailsSection" class="text-lg font-semibold text-gray-800 border-b pb-2">Academic Details</h3>
      </section>

      <section id="teacher-section" class="space-y-4 hidden">
        <h3 data-i18n="professionalDetailsSection" class="text-lg font-semibold text-gray-800 border-b pb-2">Professional Details</h3>
      </section>

      <section id="admin-section" class="space-y-4 hidden">
        <h3 data-i18n="adminSchoolDetailsSection" class="text-lg font-semibold text-gray-800 border-b pb-2">Admin School Details</h3>
      </section>

      <div class="pt-2">
        <button id="save" type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg flex items-center justify-center gap-2">
          <span data-i18n="saveChangesButton">Save Profile Changes</span>
          <svg id="spinner" class="hidden animate-spin h-5 w-5 text-white" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.38 0 0 5.38 0 12h4z"></path>
          </svg>
        </button>
        <p class="text-center text-gray-400 text-sm mt-6" data-i18n="copyright">¬© 2025 SmartStudentAct</p>
      </div>
    </form>
  </main>


  <div id="toast" class="message-box"></div>

<script>
  const API_BASE_URL = "https://api.smartstudentact.com/api";
  let currentLang = localStorage.getItem("lang") || "en";
  let userData = {};

  const $ = (id) => document.getElementById(id);
  const toast = (msg, type = "success") => {
    const box = $("toast");
    box.textContent = msg;
    box.className = `message-box ${type} show`;
    setTimeout(() => box.classList.remove("show"), 2600);
  };

  async function loadProfile() {
    try {
      const res = await fetch(`${API_BASE_URL}/profile`, { credentials: "include" });
      if (!res.ok) throw new Error("Failed to fetch profile");
      const data = await res.json();
      userData = data.user || {};

      // Avatar & Basic Info
      $("avatar").src =
        userData.profile_picture_url ||
        "https://placehold.co/128x128/e5e7eb/111?text=üë§";
      $("profile-name").textContent = `${userData.firstname || ""} ${userData.lastname || ""}`;
      $("profile-role").textContent = userData.occupation || "";

      // Basic fields
      ["firstname", "lastname", "email", "phone", "occupation"].forEach((k) => {
        if ($(k)) $(k).value = userData[k] ?? "";
      });

      // School
      if (userData.school) {
        $("schoolName").value = userData.school.schoolName || "";
        $("schoolCountry").value = userData.school.schoolCountry || "";
      }

      // Student fields
      if (userData.occupation === "student") {
        $("educationLevel").value = userData.educationLevel || "";
        $("grade").value = userData.grade || "";

        if (userData.educationLevel === "university") {
          $("university").value = userData.university || "";
          $("uniLevel").value = userData.uniLevel || "";
          $("program").value = userData.program || "";
        }
      }

      // Teacher fields
      if (userData.occupation === "teacher") {
        $("teacherGrade").value = (userData.teacherGrade || []).join(", ");
        $("teacherSubject").value = userData.teacherSubject || "";
      }

      toggleSections(userData.occupation);
    } catch (err) {
      console.error(err);
      toast("Could not fetch profile", "error");
    } finally {
      $("loading").classList.add("hidden");
    }
  }

  $("profile-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    $("spinner").classList.remove("hidden");

    const occupation = $("occupation").value;

    const payload = {
      firstname: $("firstname").value.trim(),
      lastname: $("lastname").value.trim(),
      email: $("email").value.trim(),
      phone: $("phone").value.trim(),
      occupation: occupation,
      school: {
        schoolName: $("schoolName").value.trim(),
        schoolCountry: $("schoolCountry").value.trim(),
      },
    };

    if (occupation === "student") {
      payload.educationLevel = $("educationLevel").value;
      if (payload.educationLevel === "junior" || payload.educationLevel === "high") {
        payload.grade = $("grade").value;
      } else if (payload.educationLevel === "university") {
        payload.university = $("university").value;
        payload.uniLevel = $("uniLevel").value;
        payload.program = $("program").value;
      }
    } else if (occupation === "teacher") {
      payload.teacherGrade = $("teacherGrade")
        .value.split(",")
        .map((g) => g.trim())
        .filter((g) => g);
      payload.teacherSubject = $("teacherSubject").value;
    }

    try {
      const res = await fetch(`${API_BASE_URL}/profile`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload),
      });

      if (!res.ok) throw new Error("Failed to update profile");
      toast("Profile updated successfully!", "success");
      loadProfile();
    } catch (err) {
      console.error(err);
      toast("Error saving profile", "error");
    } finally {
      $("spinner").classList.add("hidden");
    }
  });

  $("change-pic").addEventListener("click", () => $("avatar-input").click());

$("avatar-input").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("profilePhoto", file); 

  try {
    const res = await fetch(`${API_BASE_URL}/profile/upload-photo`, {
      method: "POST",
      credentials: "include",
      body: formData,
    });

    if (!res.ok) throw new Error("Upload failed");

    const data = await res.json();
    toast("Profile picture updated!", "success");

    const avatarImg = $("profileAvatar");
    if (avatarImg) avatarImg.src = data.photoUrl;

    loadProfile(); 
  } catch (err) {
    console.error(err);
    toast("Error uploading picture", "error");
  }
});


  function toggleSections(role) {
    $("student-section").classList.toggle("hidden", role !== "student");
    $("teacher-section").classList.toggle("hidden", role !== "teacher");
    $("admin-section").classList.toggle("hidden", role !== "admin");
  }

  // Init
  document.addEventListener("DOMContentLoaded", () => {
    $("lang").value = currentLang;
    if (typeof translatePage === "function") translatePage("profile", currentLang);
    $("lang").addEventListener("change", (e) => {
      currentLang = e.target.value;
      localStorage.setItem("lang", currentLang);
      if (typeof translatePage === "function") translatePage("profile", currentLang);
    });
    loadProfile();
  });
</script>
</body>
</html>


