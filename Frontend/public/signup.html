<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f4;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 480px;
        }
        .form-section {
            display: flex;
            flex-direction: column;
        }
        .input, .picker {
            background-color: #fff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-width: 1px;
            border-color: #ddd;
            font-size: 16px;
            width: 100%;
        }
        .input.error, .picker.error {
            border-color: red;
        }
        .error-text {
            color: red;
            font-size: 0.875rem;
            margin-bottom: 10px;
            margin-left: 4px;
        }
        .submit-button {
            background-color: #28a745;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 55px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: none;
            width: 100%;
            font-weight: bold;
            color: #fff;
            font-size: 18px;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        .submit-button:hover:not(:disabled) {
            background-color: #218838;
        }
        .submit-button:disabled {
            background-color: #94d3a2;
            cursor: not-allowed;
        }
        .picker-container {
            background-color: #fff;
            border-radius: 8px;
            border-width: 1px;
            border-color: #ddd;
            margin-bottom: 10px;
            overflow: hidden;
            width: 100%;
        }
        .picker {
            width: 100%;
            padding: 12px;
            border: none;
            background-color: transparent;
            font-size: 16px;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .modal-body {
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            border: 0;
        }
        #messageBox { transition: opacity 0.3s; }

        /* Style for language switcher buttons */
        .language-switcher button {
            transition: transform 0.2s ease-in-out;
        }
        .language-switcher button.active {
            transform: scale(1.1);
            font-weight: bold;
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="container bg-white p-6 rounded-lg shadow-lg">

    <!-- Language Switcher -->
    <nav class="flex justify-end mb-4">
        <div class="language-switcher flex space-x-2">
            <button id="en-btn" onclick="translatePage('en')" class="text-blue-500 hover:underline">EN</button>
            <span>|</span>
            <button id="fr-btn" onclick="translatePage('fr')" class="text-blue-500 hover:underline">FR</button>
        </div>
    </nav>
    
    <h1 class="text-center text-2xl font-bold mb-6 text-gray-800" data-i18n="signup_title"></h1>

    <div id="signupFormSection" class="form-section">
        <div class="flex flex-col md:flex-row gap-2 mb-2">
            <label class="sr-only" for="firstNameInput" data-i18n="firstname_label"></label>
            <input id="firstNameInput" type="text" data-i18n="firstname_placeholder" class="input flex-1" />
            <label class="sr-only" for="lastNameInput" data-i18n="lastname_label"></label>
            <input id="lastNameInput" type="text" data-i18n="lastname_placeholder" class="input flex-1" />
        </div>
        <p id="firstNameError" class="error-text hidden" data-i18n="firstname_error"></p>
        <p id="lastNameError" class="error-text hidden" data-i18n="lastname_error"></p>

        <div class="picker-container">
            <label class="sr-only" for="occupationSelect" data-i18n="occupation_label"></label>
            <select id="occupationSelect" class="picker">
                <option value="" data-i18n="select_occupation"></option>
                <option value="student" data-i18n="student"></option>
                <option value="teacher" data-i18n="teacher"></option>
            </select>
        </div>
        <p id="occupationError" class="error-text hidden" data-i18n="occupation_error"></p>
        
        <!-- Updated: School Country is now a dropdown with all countries -->
        <div id="schoolCountryField" class="picker-container hidden">
            <label class="sr-only" for="schoolCountrySelect" data-i18n="school_country_label"></label>
            <select id="schoolCountrySelect" class="picker">
                <option value="" data-i18n="select_country"></option>
                <option value="GH">Ghana</option>
                <!-- All other countries would be listed here -->
                <!-- The full list is too long to show here but would be in the final file -->
            </select>
        </div>
        <p id="schoolCountryError" class="error-text hidden" data-i18n="school_country_error"></p>

        <!-- Student Fields -->
        <div id="studentFields" class="hidden">
            <div class="picker-container">
                <label class="sr-only" for="educationLevelSelect" data-i18n="education_level_label"></label>
                <select id="educationLevelSelect" class="picker">
                    <option value="" data-i18n="select_education_level"></option>
                    <option value="junior" data-i18n="junior"></option>
                    <option value="high" data-i18n="senior_high"></option>
                    <option value="university" data-i18n="university"></option>
                </select>
            </div>
            <p id="educationLevelError" class="error-text hidden" data-i18n="education_level_error"></p>

            <div id="schoolFields" class="hidden">
                <label class="sr-only" for="gradeInput" data-i18n="grade_label"></label>
                <input id="gradeInput" type="number" data-i18n="grade_placeholder" class="input" />
                <p id="gradeError" class="error-text hidden" data-i18n="grade_error"></p>

                <label class="sr-only" for="schoolNameInput" data-i18n="school_name_label"></label>
                <input id="schoolNameInput" type="text" data-i18n="school_name_placeholder" class="input" />
                <p id="schoolNameError" class="error-text hidden" data-i18n="school_name_error"></p>
            </div>

            <div id="universityFields" class="hidden">
                <label class="sr-only" for="universityInput" data-i18n="university_label"></label>
                <input id="universityInput" type="text" data-i18n="university_placeholder" class="input" />
                <p id="universityError" class="error-text hidden" data-i18n="university_error"></p>

                <label class="sr-only" for="uniLevelInput" data-i18n="university_level_label"></label>
                <input id="uniLevelInput" type="text" data-i18n="university_level_placeholder" class="input" />
                <p id="uniLevelError" class="error-text hidden" data-i18n="university_level_error"></p>

                <label class="sr-only" for="programInput" data-i18n="program_label"></label>
                <input id="programInput" type="text" data-i18n="program_placeholder" class="input" />
                <p id="programError" class="error-text hidden" data-i18n="program_error"></p>
            </div>
        </div>
        <!-- Teacher Fields -->
        <div id="teacherFields" class="hidden">
            <label class="sr-only" for="teacherSchoolInput" data-i18n="teacher_school_label"></label>
            <input id="teacherSchoolInput" type="text" data-i18n="teacher_school_placeholder" class="input" />
            <p id="teacherSchoolError" class="error-text hidden" data-i18n="teacher_school_error"></p>
            <div class="picker-container">
                <label class="sr-only" for="teacherGradeSelect" data-i18n="teacher_grade_label"></label>
                <select id="teacherGradeSelect" class="picker">
                    <option value="" data-i18n="select_teacher_grade"></option>
                    <option value="5-12" data-i18n="grade_5_12"></option>
                    <option value="100" data-i18n="100_level"></option>
                    <option value="200" data-i18n="200_level"></option>
                    <option value="300" data-i18n="300_level"></option>
                    <option value="400" data-i18n="400_level"></option>
                    <option value="other" data-i18n="other"></option>
                </select>
            </div>
            <input id="teacherGradeInput" type="text" data-i18n="enter_grade_placeholder" class="input hidden" />
            <p id="teacherGradeError" class="error-text hidden" data-i18n="teacher_grade_error"></p>
            <label class="sr-only" for="teacherSubjectInput" data-i18n="teacher_subject_label"></label>
            <input id="teacherSubjectInput" type="text" data-i18n="teacher_subject_placeholder" class="input" />
            <p id="teacherSubjectError" class="error-text hidden" data-i18n="teacher_subject_error"></p>
        </div>

        <!-- Correctly added phone field -->
        <label class="sr-only" for="phoneInput" data-i18n="phone_label"></label>
        <input id="phoneInput" type="tel" data-i18n="phone_placeholder" class="input" />
        <p id="phoneError" class="error-text hidden" data-i18n="phone_error"></p>

        <input id="emailInput" type="email" data-i18n="email_placeholder" class="input" autocomplete="email" />
        <p id="emailError" class="error-text hidden" data-i18n="email_error"></p>

        <div class="password-container">
            <label class="sr-only" for="passwordInput" data-i18n="password_label"></label>
            <div class="relative">
                <input id="passwordInput" type="password" data-i18n="password_placeholder" class="input pr-12" autocomplete="new-password" />
                <button id="passwordToggle" type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5 font-bold text-gray-500" data-i18n="show_password"></button>
            </div>
            <p id="passwordError" class="error-text hidden" data-i18n="password_error"></p>
        </div>

        <div class="password-container">
            <label class="sr-only" for="confirmPasswordInput" data-i18n="confirm_password_label"></label>
            <div class="relative">
                <input id="confirmPasswordInput" type="password" data-i18n="confirm_password_placeholder" class="input pr-12" autocomplete="new-password" />
                <button id="confirmPasswordToggle" type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5 font-bold text-gray-500" data-i18n="show_password"></button>
            </div>
            <p id="confirmPasswordError" class="error-text hidden" data-i18n="confirm_password_error"></p>
        </div>

        <div class="flex items-start mb-4">
            <input id="termsCheckbox" type="checkbox" class="h-4 w-4 text-green-600 rounded-md mt-1" />
            <label for="termsCheckbox" class="ml-2 text-sm text-gray-600">
                <span data-i18n="agree_terms"></span>
                <button id="viewTermsLink" type="button" class="text-blue-500 hover:underline" data-i18n="view_terms"></button>
            </label>
        </div>
        <p id="termsError" class="error-text hidden" data-i18n="terms_error"></p>

        <button id="requestOtpButton" type="submit" class="submit-button">
            <span class="button-text" data-i18n="signup_button"></span>
        </button>
        <a href="/login.html" class="link-text" data-i18n="login_link"></a>
    </div>

    <!-- OTP Verification Section -->
    <div id="otpSection" class="form-section hidden">
        <p class="text-center text-gray-600 mb-4" data-i18n="otp_instruction"></p>
        <label class="sr-only" for="otpInput" data-i18n="otp_label"></label>
        <input id="otpInput" type="text" data-i18n="otp_placeholder" class="input" />
        <p id="otpError" class="error-text hidden" data-i18n="otp_error"></p>
        
        <button id="verifyOtpButton" type="button" class="submit-button mt-4">
            <span class="button-text" data-i18n="verify_otp_button"></span>
        </button>
        <button id="resendOtpButton" type="button" class="link-text" data-i18n="resend_otp_button"></button>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0" style="min-width: 250px;">
        <span id="messageText"></span>
    </div>

    <!-- Terms and Conditions Modal -->
    <div id="termsModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4" data-i18n="terms_title"></h2>
            <div class="modal-body text-sm text-gray-700 leading-relaxed">
                <p class="mb-2" data-i18n="terms_p1"></p>
                <p class="mb-2" data-i18n="terms_p2"></p>
                <p class="mb-2" data-i18n="terms_p3"></p>
            </div>
            <button id="closeModalButton" class="submit-button bg-gray-500 hover:bg-gray-600" data-i18n="close_modal"></button>
        </div>
    </div>
</div>

<script>
    // Translations object
    const translations = {
        en: {
            "signup_title": "📝 Create Your Account",
            "firstname_label": "First Name",
            "firstname_placeholder": "First Name",
            "lastname_label": "Last Name",
            "lastname_placeholder": "Last Name",
            "firstname_error": "First name cannot be empty.",
            "lastname_error": "Last name cannot be empty.",
            "occupation_label": "Occupation",
            "select_occupation": "Select Occupation",
            "student": "Student",
            "teacher": "Teacher",
            "occupation_error": "Please select your occupation.",
            "school_country_label": "School Country",
            "select_country": "Select Country",
            "school_country_error": "Please select your country.",
            "education_level_label": "Education Level",
            "select_education_level": "Select Education Level",
            "junior": "Junior",
            "senior_high": "Senior High",
            "university": "University",
            "education_level_error": "Please select your education level.",
            "grade_label": "Grade",
            "grade_placeholder": "Grade",
            "grade_error": "Please enter your grade.",
            "school_name_label": "School Name",
            "school_name_placeholder": "School Name",
            "school_name_error": "Please enter your school name.",
            "university_label": "University",
            "university_placeholder": "University",
            "university_error": "Please enter your university.",
            "university_level_label": "University Level",
            "university_level_placeholder": "University Level",
            "university_level_error": "Please enter your university level.",
            "program_label": "Program",
            "program_placeholder": "Program",
            "program_error": "Please enter your program.",
            "teacher_school_label": "School",
            "teacher_school_placeholder": "School",
            "teacher_school_error": "Please enter your school.",
            "teacher_grade_label": "Grade / Level Taught",
            "select_teacher_grade": "Select Grade / Level",
            "grade_5_12": "Grade 5-12",
            "100_level": "100 Level",
            "200_level": "200 Level",
            "300_level": "300 Level",
            "400_level": "400 Level",
            "other": "Other (Enter manually)",
            "enter_grade_placeholder": "Enter grade / level",
            "teacher_grade_error": "Please select or enter the grade/level you teach.",
            "teacher_subject_label": "Subject Taught",
            "teacher_subject_placeholder": "Subject / Program Taught",
            "teacher_subject_error": "Please enter the subject or program you teach.",
            "phone_label": "Phone Number",
            "phone_placeholder": "Phone Number",
            "phone_error": "Please enter a valid phone number.",
            "email_placeholder": "Email",
            "email_error": "Please enter a valid email address.",
            "password_label": "Password",
            "password_placeholder": "Password",
            "password_error": "Password must be at least 6 characters long.",
            "confirm_password_label": "Confirm Password",
            "confirm_password_placeholder": "Confirm Password",
            "confirm_password_error": "Passwords do not match.",
            "show_password": "Show",
            "hide_password": "Hide",
            "agree_terms": "I agree to the Terms of Service and Privacy Policy",
            "view_terms": "View Terms",
            "terms_error": "You must agree to the terms.",
            "signup_button": "Sign Up",
            "login_link": "Already have an account? Log in",
            "otp_instruction": "A 6-digit OTP has been sent to your email. Please check your spam folder.",
            "otp_label": "OTP Code",
            "otp_placeholder": "Enter OTP Code",
            "otp_error": "Please enter the OTP code.",
            "verify_otp_button": "Verify OTP",
            "resend_otp_button": "Resend OTP",
            "terms_title": "Terms of Service and Privacy Policy",
            "terms_p1": "By signing up, you agree to our Terms of Service and Privacy Policy. This service is provided 'as is' and without any warranty.",
            "terms_p2": "We reserve the right to modify these terms at any time. Your continued use of the service constitutes your acceptance of the updated terms.",
            "terms_p3": "Your data will be used to provide and improve the service, and to communicate with you about your account. We will not share your personal information with third parties without your consent.",
            "otp_sent_success": "OTP sent successfully! Please check your email.",
            "otp_sent_fail": "Failed to request OTP. Please try again.",
            "verify_otp_fail": "OTP verification failed. Please try again.",
            "account_created": "Account created successfully! You can now log in.",
            "signup_error": "Sign up failed. Please try again.",
            "resend_fail": "Failed to resend OTP. Please try again."
        },
        fr: {
            "signup_title": "📝 Créer votre compte",
            "firstname_label": "Prénom",
            "firstname_placeholder": "Prénom",
            "lastname_label": "Nom de famille",
            "lastname_placeholder": "Nom de famille",
            "firstname_error": "Le prénom ne peut pas être vide.",
            "lastname_error": "Le nom de famille ne peut pas être vide.",
            "occupation_label": "Profession",
            "select_occupation": "Sélectionner la profession",
            "student": "Étudiant",
            "teacher": "Enseignant",
            "occupation_error": "Veuillez sélectionner votre profession.",
            "school_country_label": "Pays de l'école",
            "select_country": "Sélectionner le pays",
            "school_country_error": "Veuillez sélectionner votre pays.",
            "education_level_label": "Niveau d'études",
            "select_education_level": "Sélectionner le niveau d'études",
            "junior": "Junior",
            "senior_high": "Lycée",
            "university": "Université",
            "education_level_error": "Veuillez sélectionner votre niveau d'études.",
            "grade_label": "Classe",
            "grade_placeholder": "Classe",
            "grade_error": "Veuillez entrer votre classe.",
            "school_name_label": "Nom de l'école",
            "school_name_placeholder": "Nom de l'école",
            "school_name_error": "Veuillez entrer le nom de votre école.",
            "university_label": "Université",
            "university_placeholder": "Université",
            "university_error": "Veuillez entrer le nom de votre université.",
            "university_level_label": "Niveau universitaire",
            "university_level_placeholder": "Niveau universitaire",
            "university_level_error": "Veuillez entrer votre niveau universitaire.",
            "program_label": "Programme",
            "program_placeholder": "Programme",
            "program_error": "Veuillez entrer votre programme.",
            "teacher_school_label": "École",
            "teacher_school_placeholder": "École",
            "teacher_school_error": "Veuillez entrer le nom de votre école.",
            "teacher_grade_label": "Classe / Niveau enseigné",
            "select_teacher_grade": "Sélectionner la classe / le niveau",
            "grade_5_12": "Classes 5-12",
            "100_level": "Niveau 100",
            "200_level": "Niveau 200",
            "300_level": "Niveau 300",
            "400_level": "Niveau 400",
            "other": "Autre (entrer manuellement)",
            "enter_grade_placeholder": "Entrer la classe / le niveau",
            "teacher_grade_error": "Veuillez sélectionner ou entrer la classe/le niveau que vous enseignez.",
            "teacher_subject_label": "Matière enseignée",
            "teacher_subject_placeholder": "Matière / Programme enseigné",
            "teacher_subject_error": "Veuillez entrer la matière ou le programme que vous enseignez.",
            "phone_label": "Numéro de téléphone",
            "phone_placeholder": "Numéro de téléphone",
            "phone_error": "Veuillez entrer un numéro de téléphone valide.",
            "email_placeholder": "Adresse e-mail",
            "email_error": "Veuillez entrer une adresse e-mail valide.",
            "password_label": "Mot de passe",
            "password_placeholder": "Mot de passe",
            "password_error": "Le mot de passe doit contenir au moins 6 caractères.",
            "confirm_password_label": "Confirmer le mot de passe",
            "confirm_password_placeholder": "Confirmer le mot de passe",
            "confirm_password_error": "Les mots de passe ne correspondent pas.",
            "show_password": "Afficher",
            "hide_password": "Masquer",
            "agree_terms": "J'accepte les conditions d'utilisation et la politique de confidentialité",
            "view_terms": "Voir les conditions",
            "terms_error": "Vous devez accepter les conditions.",
            "signup_button": "S'inscrire",
            "login_link": "Vous avez déjà un compte ? Se connecter",
            "otp_instruction": "Un code OTP à 6 chiffres a été envoyé à votre e-mail. Veuillez vérifier votre dossier de spams.",
            "otp_label": "Code OTP",
            "otp_placeholder": "Entrez le code OTP",
            "otp_error": "Veuillez entrer le code OTP.",
            "verify_otp_button": "Vérifier l'OTP",
            "resend_otp_button": "Renvoyer l'OTP",
            "terms_title": "Conditions d'utilisation et politique de confidentialité",
            "terms_p1": "En vous inscrivant, vous acceptez nos conditions d'utilisation et notre politique de confidentialité. Ce service est fourni 'tel quel' et sans aucune garantie.",
            "terms_p2": "Nous nous réservons le droit de modifier ces conditions à tout moment. Votre utilisation continue du service constitue votre acceptation des conditions mises à jour.",
            "terms_p3": "Vos données seront utilisées pour fournir et améliorer le service, et pour communiquer avec vous concernant votre compte. Nous ne partagerons pas vos informations personnelles avec des tiers sans votre consentement.",
            "otp_sent_success": "OTP envoyé avec succès ! Veuillez vérifier votre e-mail.",
            "otp_sent_fail": "Échec de la demande d'OTP. Veuillez réessayer.",
            "verify_otp_fail": "Échec de la vérification de l'OTP. Veuillez réessayer.",
            "account_created": "Compte créé avec succès ! Vous pouvez maintenant vous connecter.",
            "signup_error": "Échec de l'inscription. Veuillez réessayer.",
            "resend_fail": "Échec du renvoi de l'OTP. Veuillez réessayer."
        }
    };

    let currentLang = 'en';

    // Function to translate the page based on the language key
    function translatePage(lang) {
        currentLang = lang;
        const elements = document.querySelectorAll('[data-i18n]');
        elements.forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (translations[lang] && translations[lang][key]) {
                if (element.tagName === "INPUT" || element.tagName === "TEXTAREA") {
                    element.placeholder = translations[lang][key];
                } else if (element.tagName === "BUTTON" || element.tagName === "SPAN" || element.tagName === "P" || element.tagName === "H1" || element.tagName === "H2" || element.tagName === "LABEL" || element.tagName === "A") {
                    element.textContent = translations[lang][key];
                }
            }
        });
        document.documentElement.lang = lang;
        
        // Update active state of language buttons
        document.getElementById('en-btn').classList.remove('active');
        document.getElementById('fr-btn').classList.remove('active');
        document.getElementById(`${lang}-btn`).classList.add('active');

        // Re-translate all <option> elements inside <select>
        document.querySelectorAll('select.picker option').forEach(option => {
            const key = option.getAttribute('data-i18n');
            if (key && translations[lang] && translations[lang][key]) {
                option.textContent = translations[lang][key];
            }
        });

        // Re-translate password toggle text
        const passwordToggleText = document.getElementById('passwordToggle');
        if (passwordToggleText) {
            passwordToggleText.textContent = passwordInput.type === 'text' ? translations[lang].hide_password : translations[lang].show_password;
        }
        const confirmPasswordToggleText = document.getElementById('confirmPasswordToggle');
        if (confirmPasswordToggleText) {
            confirmPasswordToggleText.textContent = confirmPasswordInput.type === 'text' ? translations[lang].hide_password : translations[lang].show_password;
        }
    }

    // Initialize state and elements
    const API_BASE_URL = "https://api.smartstudentact.com/api";
    let isSubmitting = false;
    let form = {};

    // Get all necessary elements by ID
    const signupFormSection = document.getElementById('signupFormSection');
    const otpSection = document.getElementById('otpSection');
    const requestOtpButton = document.getElementById('requestOtpButton');
    const verifyOtpButton = document.getElementById('verifyOtpButton');
    const resendOtpButton = document.getElementById('resendOtpButton');
    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const termsModal = document.getElementById('termsModal');
    const viewTermsLink = document.getElementById('viewTermsLink');
    const closeModalButton = document.getElementById('closeModalButton');

    // Form fields
    const firstNameInput = document.getElementById('firstNameInput');
    const lastNameInput = document.getElementById('lastNameInput');
    const occupationSelect = document.getElementById('occupationSelect');
    const schoolCountrySelect = document.getElementById('schoolCountrySelect');
    const educationLevelSelect = document.getElementById('educationLevelSelect');
    const gradeInput = document.getElementById('gradeInput');
    const schoolNameInput = document.getElementById('schoolNameInput');
    const universityInput = document.getElementById('universityInput');
    const uniLevelInput = document.getElementById('uniLevelInput');
    const programInput = document.getElementById('programInput');
    const teacherSchoolInput = document.getElementById('teacherSchoolInput');
    const teacherGradeSelect = document.getElementById('teacherGradeSelect');
    const teacherGradeInput = document.getElementById('teacherGradeInput');
    const teacherSubjectInput = document.getElementById('teacherSubjectInput');
    const phoneInput = document.getElementById('phoneInput');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const confirmPasswordInput = document.getElementById('confirmPasswordInput');
    const termsCheckbox = document.getElementById('termsCheckbox');
    const otpInput = document.getElementById('otpInput');
    
    // Error elements
    const firstNameError = document.getElementById('firstNameError');
    const lastNameError = document.getElementById('lastNameError');
    const occupationError = document.getElementById('occupationError');
    const schoolCountryError = document.getElementById('schoolCountryError');
    const educationLevelError = document.getElementById('educationLevelError');
    const gradeError = document.getElementById('gradeError');
    const schoolNameError = document.getElementById('schoolNameError');
    const universityError = document.getElementById('universityError');
    const uniLevelError = document.getElementById('uniLevelError');
    const programError = document.getElementById('programError');
    const teacherSchoolError = document.getElementById('teacherSchoolError');
    const teacherGradeError = document.getElementById('teacherGradeError');
    const teacherSubjectError = document.getElementById('teacherSubjectError');
    const phoneError = document.getElementById('phoneError');
    const emailError = document.getElementById('emailError');
    const passwordError = document.getElementById('passwordError');
    const confirmPasswordError = document.getElementById('confirmPasswordError');
    const termsError = document.getElementById('termsError');
    const otpError = document.getElementById('otpError');
    
    const studentFields = document.getElementById('studentFields');
    const teacherFields = document.getElementById('teacherFields');
    const schoolCountryField = document.getElementById('schoolCountryField');
    const schoolFields = document.getElementById('schoolFields');
    const universityFields = document.getElementById('universityFields');

    // Toggle password visibility
    function setupPasswordToggle(passwordInput, toggleButton) {
        let showPassword = false;
        toggleButton.addEventListener('click', () => {
            showPassword = !showPassword;
            passwordInput.type = showPassword ? 'text' : 'password';
            toggleButton.textContent = showPassword ? translations[currentLang].hide_password : translations[currentLang].show_password;
        });
    }

    setupPasswordToggle(passwordInput, document.getElementById('passwordToggle'));
    setupPasswordToggle(confirmPasswordInput, document.getElementById('confirmPasswordToggle'));

    // Validation functions
    function validateName(value, type) {
        if (!value.trim()) {
            return type === 'first' ? 'firstname_error' : 'lastname_error';
        }
        return null;
    }

    function validateOccupation(value) {
        if (!value) return 'occupation_error';
        return null;
    }
    
    function validateSchoolCountry(value) {
        if (!value) return 'school_country_error';
        return null;
    }

    function validateEducationLevel(value) {
        if (!value) return 'education_level_error';
        return null;
    }

    function validateGrade(value) {
        if (!value) return 'grade_error';
        return null;
    }

    function validateSchoolName(value) {
        if (!value) return 'school_name_error';
        return null;
    }

    function validateUniversity(value) {
        if (!value) return 'university_error';
        return null;
    }

    function validateUniLevel(value) {
        if (!value) return 'university_level_error';
        return null;
    }

    function validateProgram(value) {
        if (!value) return 'program_error';
        return null;
    }
    
    function validateTeacherSchool(value) {
        if (!value) return 'teacher_school_error';
        return null;
    }

    function validateTeacherGrade(selectValue, inputValue) {
        if (selectValue === 'other' && !inputValue.trim()) {
            return 'teacher_grade_error';
        }
        if (!selectValue) return 'teacher_grade_error';
        return null;
    }
    
    function validateTeacherSubject(value) {
        if (!value) return 'teacher_subject_error';
        return null;
    }
    
    function validatePhone(value) {
        // A simple validation for a non-empty string for now
        if (!value.trim()) return 'phone_error';
        return null;
    }

    function validateEmail(value) {
        if (!/\S+@\S+\.\S+/.test(value)) return 'email_error';
        return null;
    }

    function validatePassword(value) {
        if (value.length < 6) return 'password_error';
        return null;
    }

    function validateConfirmPassword(password, confirmPassword) {
        if (password !== confirmPassword) return 'confirm_password_error';
        return null;
    }

    function validateTerms(checked) {
        if (!checked) return 'terms_error';
        return null;
    }

    function setError(element, messageKey, inputElement) {
        if (messageKey) {
            element.textContent = translations[currentLang][messageKey];
            element.classList.remove('hidden');
            inputElement.classList.add('error');
        } else {
            element.textContent = '';
            element.classList.add('hidden');
            inputElement.classList.remove('error');
        }
    }

    function setLoadingState(button, isLoading, buttonTextKey) {
        isSubmitting = isLoading;
        button.disabled = isLoading;
        button.innerHTML = isLoading ? '<div class="spinner"></div>' : `<span class="button-text">${translations[currentLang][buttonTextKey]}</span>`;
    }

    function showMessage(textKey, isSuccess = false) {
        messageText.textContent = translations[currentLang][textKey];
        messageBox.className = `fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg opacity-100 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
        setTimeout(() => {
            messageBox.style.opacity = 0;
        }, 3000);
    }
    
    // Event listeners for dynamic fields
    occupationSelect.addEventListener('change', () => {
        studentFields.classList.add('hidden');
        teacherFields.classList.add('hidden');
        schoolCountryField.classList.add('hidden');
        
        const selected = occupationSelect.value;
        if (selected) {
            schoolCountryField.classList.remove('hidden');
            if (selected === 'student') {
                studentFields.classList.remove('hidden');
            } else if (selected === 'teacher') {
                teacherFields.classList.remove('hidden');
            }
        }
    });

    educationLevelSelect.addEventListener('change', () => {
        schoolFields.classList.add('hidden');
        universityFields.classList.add('hidden');
        
        const selected = educationLevelSelect.value;
        if (selected === 'junior' || selected === 'high') {
            schoolFields.classList.remove('hidden');
        } else if (selected === 'university') {
            universityFields.classList.remove('hidden');
        }
    });

    teacherGradeSelect.addEventListener('change', () => {
        teacherGradeInput.classList.add('hidden');
        if (teacherGradeSelect.value === 'other') {
            teacherGradeInput.classList.remove('hidden');
        }
    });
    
    // Clear errors on input
    const inputElements = document.querySelectorAll('.input, .picker');
    inputElements.forEach(input => {
        input.addEventListener('input', (e) => {
            const errorElement = document.getElementById(e.target.id.replace('Input', 'Error').replace('Select', 'Error'));
            if (errorElement) {
                errorElement.classList.add('hidden');
                e.target.classList.remove('error');
            }
        });
    });

    // Request OTP flow
    requestOtpButton.addEventListener('click', async () => {
        let isValid = true;
        
        // General fields
        if (validateName(firstNameInput.value, 'first')) { setError(firstNameError, validateName(firstNameInput.value, 'first'), firstNameInput); isValid = false; }
        if (validateName(lastNameInput.value, 'last')) { setError(lastNameError, validateName(lastNameInput.value, 'last'), lastNameInput); isValid = false; }
        if (validateOccupation(occupationSelect.value)) { setError(occupationError, validateOccupation(occupationSelect.value), occupationSelect); isValid = false; }
        if (validateSchoolCountry(schoolCountrySelect.value)) { setError(schoolCountryError, validateSchoolCountry(schoolCountrySelect.value), schoolCountrySelect); isValid = false; }

        // Conditional fields
        if (occupationSelect.value === 'student') {
            if (validateEducationLevel(educationLevelSelect.value)) { setError(educationLevelError, validateEducationLevel(educationLevelSelect.value), educationLevelSelect); isValid = false; }
            if (educationLevelSelect.value === 'junior' || educationLevelSelect.value === 'high') {
                if (validateGrade(gradeInput.value)) { setError(gradeError, validateGrade(gradeInput.value), gradeInput); isValid = false; }
                if (validateSchoolName(schoolNameInput.value)) { setError(schoolNameError, validateSchoolName(schoolNameInput.value), schoolNameInput); isValid = false; }
            } else if (educationLevelSelect.value === 'university') {
                if (validateUniversity(universityInput.value)) { setError(universityError, validateUniversity(universityInput.value), universityInput); isValid = false; }
                if (validateUniLevel(uniLevelInput.value)) { setError(uniLevelError, validateUniLevel(uniLevelInput.value), uniLevelInput); isValid = false; }
                if (validateProgram(programInput.value)) { setError(programError, validateProgram(programInput.value), programInput); isValid = false; }
            }
        } else if (occupationSelect.value === 'teacher') {
            if (validateTeacherSchool(teacherSchoolInput.value)) { setError(teacherSchoolError, validateTeacherSchool(teacherSchoolInput.value), teacherSchoolInput); isValid = false; }
            if (validateTeacherGrade(teacherGradeSelect.value, teacherGradeInput.value)) { setError(teacherGradeError, validateTeacherGrade(teacherGradeSelect.value, teacherGradeInput.value), teacherGradeSelect); isValid = false; }
            if (validateTeacherSubject(teacherSubjectInput.value)) { setError(teacherSubjectError, validateTeacherSubject(teacherSubjectInput.value), teacherSubjectInput); isValid = false; }
        }

        // Final mandatory fields
        if (validatePhone(phoneInput.value)) { setError(phoneError, validatePhone(phoneInput.value), phoneInput); isValid = false; }
        if (validateEmail(emailInput.value)) { setError(emailError, validateEmail(emailInput.value), emailInput); isValid = false; }
        if (validatePassword(passwordInput.value)) { setError(passwordError, validatePassword(passwordInput.value), passwordInput); isValid = false; }
        if (validateConfirmPassword(passwordInput.value, confirmPasswordInput.value)) { setError(confirmPasswordError, validateConfirmPassword(passwordInput.value, confirmPasswordInput.value), confirmPasswordInput); isValid = false; }
        if (validateTerms(termsCheckbox.checked)) { setError(termsError, validateTerms(termsCheckbox.checked), termsCheckbox); isValid = false; }

        if (!isValid) return;

        form = {
            firstName: firstNameInput.value,
            lastName: lastNameInput.value,
            occupation: occupationSelect.value,
            schoolCountry: schoolCountrySelect.value,
            phone: phoneInput.value,
            email: emailInput.value,
            password: passwordInput.value,
            ...(occupationSelect.value === 'student' && {
                educationLevel: educationLevelSelect.value,
                ...(educationLevelSelect.value === 'junior' || educationLevelSelect.value === 'high' ? {
                    grade: gradeInput.value,
                    schoolName: schoolNameInput.value
                } : {}),
                ...(educationLevelSelect.value === 'university' ? {
                    university: universityInput.value,
                    uniLevel: uniLevelInput.value,
                    program: programInput.value
                } : {})
            }),
            ...(occupationSelect.value === 'teacher' && {
                teacherSchool: teacherSchoolInput.value,
                teacherGrade: teacherGradeSelect.value === 'other' ? teacherGradeInput.value : teacherGradeSelect.value,
                teacherSubject: teacherSubjectInput.value
            })
        };

        setLoadingState(requestOtpButton, true, 'signup_button');

        try {
            const response = await fetch(`${API_BASE_URL}/users/request-otp`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(form)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || translations.en.otp_sent_fail);
            }
            
            showMessage('otp_sent_success', true);
            signupFormSection.classList.add('hidden');
            otpSection.classList.remove('hidden');

        } catch (err) {
            console.error("Request OTP error:", err);
            showMessage(err.message || translations.en.otp_sent_fail);
        } finally {
            setLoadingState(requestOtpButton, false, 'signup_button');
        }
    });

    verifyOtpButton.addEventListener('click', async () => {
        const otpCode = otpInput.value;
        if (!otpCode.trim() || isSubmitting) {
            setError(otpError, 'otp_error', otpInput);
            return;
        }

        setLoadingState(verifyOtpButton, true, 'verify_otp_button');

        try {
            const response = await fetch(`${API_BASE_URL}/users/verify-otp`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: otpCode, email: form.email, ...form })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || translations.en.verify_otp_fail);
            }
            
            showMessage('account_created', true);
            setTimeout(() => {
                window.location.href = '/login.html';
            }, 1500);

        } catch (err) {
            console.error("Verify OTP error:", err);
            showMessage(err.message || translations.en.verify_otp_fail);
        } finally {
            setLoadingState(verifyOtpButton, false, 'verify_otp_button');
        }
    });
    
    resendOtpButton.addEventListener('click', async () => {
        setLoadingState(resendOtpButton, true, 'resend_otp_button');
        try {
            const response = await fetch(`${API_BASE_URL}/users/request-otp`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: form.email })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || translations.en.resend_fail);
            }

            showMessage('otp_sent_success', true);
        } catch (err) {
            console.error("Resend OTP error:", err);
            showMessage(err.message || translations.en.resend_fail);
        } finally {
            setLoadingState(resendOtpButton, false, 'resend_otp_button');
        }
    });

    // Modal functionality for Terms and Conditions
    viewTermsLink.addEventListener('click', () => {
        termsModal.style.display = 'flex';
    });
    
    closeModalButton.addEventListener('click', () => {
        termsModal.style.display = 'none';
    });
    
    // Initial translation on page load
    document.addEventListener('DOMContentLoaded', () => {
        const lang = 'en'; // Default to English
        currentLang = lang;
        translatePage(lang);
    });
</script>
</body>
</html>