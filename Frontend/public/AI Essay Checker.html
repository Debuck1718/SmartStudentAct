<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Essay Checker</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 p-8 flex justify-center items-center min-h-screen">

    <div class="w-full max-w-4xl bg-white p-6 md:p-10 rounded-xl shadow-2xl transition-all duration-300">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6 md:mb-8">AI Essay Checker ✍️</h1>

        <!-- Trial Status Section -->
        <div id="trial-status-message" class="bg-yellow-100 text-yellow-800 p-4 rounded-lg mb-6 text-center shadow-md border border-yellow-200">
            You are on a **30-day free trial**. You have <span id="uses-left" class="font-bold text-lg">5</span> AI checks remaining.
        </div>

        <!-- Essay Submission Form -->
        <form id="essay-form" class="flex flex-col gap-4">
            <textarea
                id="essay-text"
                class="w-full h-64 p-4 md:p-6 border border-gray-300 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                placeholder="Paste your essay here..."
                required
            ></textarea>
            <button
                type="submit"
                id="submit-button"
                class="w-full px-6 py-3 text-lg font-semibold rounded-lg shadow-lg transition-all duration-300
                       bg-blue-600 hover:bg-blue-700 text-white transform hover:-translate-y-1"
            >
                Get Feedback
            </button>
        </form>

        <!-- Loading and Error Messages -->
        <div id="status-message" class="mt-4 text-center hidden"></div>

        <!-- Feedback Display Section -->
        <div id="feedback-container" class="mt-8 space-y-6 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Feedback</h2>
            <!-- Feedback content will be dynamically inserted here -->
        </div>

    </div>

    <script>
        // DOM element references
        const essayForm = document.getElementById('essay-form');
        const essayTextarea = document.getElementById('essay-text');
        const submitButton = document.getElementById('submit-button');
        const statusMessageDiv = document.getElementById('status-message');
        const feedbackContainer = document.getElementById('feedback-container');
        const trialStatusMessage = document.getElementById('trial-status-message');
        const usesLeftSpan = document.getElementById('uses-left');

        // Initial state
        let isTrialUser = true; // Simulates user state from backend. Set to 'false' for paid users.
        let usesLeft = 5; // Simulates the number of trial uses remaining from backend.

        // Initial UI setup based on user state
        if (!isTrialUser) {
            trialStatusMessage.classList.add('hidden'); // Hide the trial message for paying users
        }

        // Function to update the trial uses counter in the UI
        function updateUsesLeft() {
            if (isTrialUser) {
                usesLeftSpan.textContent = usesLeft;
                if (usesLeft <= 0) {
                    submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'transform', 'hover:-translate-y-1');
                    submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                    submitButton.disabled = true;
                    statusMessageDiv.textContent = 'You have used all your free trial checks. Please subscribe to continue.';
                    statusMessageDiv.classList.remove('hidden');
                    statusMessageDiv.classList.add('bg-red-100', 'text-red-800', 'p-4', 'rounded-lg', 'mt-4');
                }
            }
        }

        // Initial call to set up the uses counter
        updateUsesLeft();

        // Function to display messages (loading, error)
        function showStatus(message, type) {
            statusMessageDiv.textContent = message;
            statusMessageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'p-4', 'rounded-lg', 'mt-4');
            if (type === 'loading') {
                statusMessageDiv.classList.add('text-blue-600', 'animate-pulse');
            } else if (type === 'error') {
                statusMessageDiv.classList.add('bg-red-100', 'text-red-800', 'p-4', 'rounded-lg', 'mt-4');
            }
            statusMessageDiv.classList.remove('hidden');
        }

        // Function to render the feedback sections dynamically
        function renderFeedback(feedback) {
            feedbackContainer.innerHTML = '<h2 class="text-2xl font-bold text-gray-800 mb-4">Feedback</h2>'; // Clear previous feedback
            feedbackContainer.classList.remove('hidden');

            for (const category in feedback) {
                const title = category.charAt(0).toUpperCase() + category.slice(1);
                const feedbackItems = feedback[category];

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-sm';
                categoryDiv.innerHTML = `<h3 class="text-xl font-semibold text-gray-700 mb-2">${title.replace(/([A-Z])/g, ' $1')}</h3>`;

                if (feedbackItems.length > 0) {
                    const ul = document.createElement('ul');
                    ul.className = 'list-disc list-inside space-y-2';
                    feedbackItems.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'text-gray-600';
                        li.textContent = item;
                        ul.appendChild(li);
                    });
                    categoryDiv.appendChild(ul);
                } else {
                    const p = document.createElement('p');
                    p.className = 'text-gray-500 italic';
                    p.textContent = 'No feedback for this category. Great job!';
                    categoryDiv.appendChild(p);
                }
                feedbackContainer.appendChild(categoryDiv);
            }
        }

        // Event listener for the form submission
        essayForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // --- Core Trial Logic ---
            if (isTrialUser && usesLeft <= 0) {
                showStatus('You have used all your free trial checks. Please subscribe to continue.', 'error');
                return;
            }

            // Reset UI states
            showStatus('Analyzing...', 'loading');
            feedbackContainer.classList.add('hidden');
            
            const essayText = essayTextarea.value;

            try {
                const response = await fetch('/api/essay/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Assuming you have a way to get the JWT token.
                        // For a real app, this would be retrieved from a cookie or local storage.
                        'Authorization': `Bearer your_jwt_token_here`
                    },
                    body: JSON.stringify({ essayText })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to get essay feedback.');
                }

                if (isTrialUser) {
                    usesLeft--; // Decrement the trial counter
                    updateUsesLeft(); // Update the UI
                }

                renderFeedback(result.feedback);

            } catch (error) {
                console.error('API Error:', error);
                showStatus(error.message, 'error');
            } finally {
                // Hide the loading message
                if (statusMessageDiv.textContent === 'Analyzing...') {
                    statusMessageDiv.classList.add('hidden');
                }
            }
        });
    </script>

</body>
</html>