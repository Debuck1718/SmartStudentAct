<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartStudentAct - Dashboard</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWMR745QHX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-EWMR745QHX');
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png"/>
  <link rel="icon" type="image/png" sizes="16x16" href="./images/icon.png"/>
  <link rel="manifest" href="/site.webmanifest"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap");
    body { font-family: "Inter", sans-serif; background: #f0f2f5; padding-bottom: 70px; }
    .modal-overlay { background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 50; }
    .modal-overlay.active { display: flex; }
    .tab-active { color: #3b82f6; border-bottom: 2px solid #3b82f6; }
    .loading-spinner { display: none; }
    .modal-content { max-height: 90vh; overflow-y: auto; }
    #toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 8px; z-index: 60; }
    .toast { animation: fadeinout 4s forwards; opacity: 0; }
    @keyframes fadeinout {
      0% { opacity: 0; transform: translateY(20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }
  </style>
</head>
<body class="min-h-screen">

  <header class="bg-white text-gray-800 p-4 flex justify-between items-center shadow-lg rounded-b-3xl">
    <button id="menu-btn" class="p-2 text-2xl text-blue-600 focus:outline-none" aria-label="Open navigation menu"><i class="fas fa-bars"></i></button>
    <span data-i18n="nav_title" class="text-xl font-bold flex-1 text-center">üìò SmartStudentAct</span>
    <button id="logout-btn" class="bg-red-500 py-2 px-4 rounded-full font-bold shadow-md text-white hover:bg-red-600 transition-colors"><span data-i18n="logout">Logout</span></button>
  </header>

  <main class="p-4 sm:p-6 lg:p-8">
    <div class="max-w-4xl mx-auto">
      
      
      <div class="flex flex-col sm:flex-row items-center justify-between mb-8">
        <div class="flex flex-col items-center sm:items-start mb-4 sm:mb-0">
          <img id="profile-preview" src="./images/default-avatar.png" class="w-24 h-24 rounded-full shadow-lg mb-2 transform transition-transform duration-300 hover:scale-110" />
          <form id="profile-form" class="flex items-center space-x-2">
            <label for="profile-photo" class="bg-blue-500 text-white text-sm py-1 px-3 rounded-full cursor-pointer hover:bg-blue-600 transition-colors">
              <i class="fas fa-camera"></i> <span data-i18n="change_photo">Change Photo</span>
            </label>
            <input type="file" id="profile-photo" name="profilePhoto" accept="image/*" class="hidden" />
          </form>
        </div>
        
        <div id="language-switcher" class="relative mt-4 sm:mt-0">
          <select id="lang-select" class="px-3 py-2 bg-white border border-gray-300 rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none pr-8 cursor-pointer text-sm">
            <option value="en">EN - English</option>
            <option value="fr">FR - Fran√ßais</option>
            <option value="es">ES - Espa√±ol</option>
            <option value="tr">TR - T√ºrk√ße</option>
            <option value="ar">AR - ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            <option value="ru">RU - –†—É—Å—Å–∫–∏–π</option>
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
          </div>
        </div>
      </div>

      <h1 data-i18n="welcome_heading" class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mt-8 mb-4">Welcome to SmartStudentAct</h1>
      <p data-i18n="welcome_text" class="text-lg text-center text-gray-600 mb-8">Your learning & financial companion</p>
      
      <section class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <h2 data-i18n="assignments_title" class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">üìö Assignments</h2>
        <button id="add-assignment-btn" data-i18n="add_assignment_btn" class="bg-green-500 text-white py-3 px-6 rounded-full font-bold w-full mb-4 shadow-lg hover:bg-green-600 transition-colors">+ Add Assignment</button>
        <div id="assignments-list" class="space-y-4">
          <p data-i18n="no_assignments" class="italic text-gray-500 text-center">No assignments added yet.</p>
        </div>
        <div id="assignments-loading" class="text-center mt-4 loading-spinner"><i class="fas fa-spinner fa-spin text-3xl text-gray-500"></i></div>
      </section>

      <section class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <h2 data-i18n="quizzes_title" class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">üìù Quizzes</h2>
        <div id="quizzes-list" class="space-y-4">
          <p data-i18n="no_quizzes" class="italic text-gray-500 text-center">No quizzes assigned yet.</p>
        </div>
        <div id="quizzes-loading" class="text-center mt-4 loading-spinner"><i class="fas fa-spinner fa-spin text-3xl text-gray-500"></i></div>
      </section>

      <section class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <h2 data-i18n="budget_title" class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">üí∞ Budget</h2>
        <button id="add-budget-btn" data-i18n="add_expense_btn" class="bg-green-500 text-white py-3 px-6 rounded-full font-bold w-full mb-4 shadow-lg hover:bg-green-600 transition-colors">+ Add Expense</button>
        <div id="budget-list" class="space-y-4">
          <p data-i18n="no_budget" class="italic text-gray-500 text-center">No budget entries yet.</p>
        </div>
        <div id="budget-loading" class="text-center mt-4 loading-spinner"><i class="fas fa-spinner fa-spin text-3xl text-gray-500"></i></div>
      </section>

      <section class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <h2 data-i18n="weekly_goal_title" class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">üéØ Weekly Goal</h2>
        <div class="space-y-4">
          <input id="goal-input" type="text" data-i18n-placeholder="goal_placeholder" placeholder="Your weekly goal" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500 text-base"/>
          <input id="goal-target-date" type="date" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500 text-base"/>
          <select id="goal-type" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500 text-base">
            <option value="academic">Academic</option>
            <option value="personal">Personal</option>
            <option value="extracurricular">Extracurricular</option>
          </select>
          <p id="goal-error" class="text-red-500 text-sm hidden"></p>
          <button id="save-goal-btn" data-i18n="save_goal_btn" class="bg-blue-500 text-white py-3 px-6 rounded-full font-bold w-full shadow-lg hover:bg-blue-600 transition-colors">Save Goal</button>
          <ul id="saved-goals-list" class="text-green-600 font-bold text-center mt-2"></ul>
        </div>
      </section>

      <section class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <div class="flex items-center justify-between mb-4">
          <h2 data-i18n="ai_insights_title" class="text-2xl font-semibold text-gray-800 flex items-center">ü§ñ AI Insights</h2>
          <div class="flex items-center">
            <label data-i18n="subscribed_label" for="subscription-toggle" class="text-sm text-gray-500 mr-2">Subscribed?</label>
            <input type="checkbox" id="subscription-toggle" class="form-checkbox h-5 w-5 text-blue-600 rounded"/>
          </div>
        </div>
        <button id="generate-insights-btn" data-i18n="generate_insights_btn" class="bg-purple-500 text-white py-3 px-6 rounded-full font-bold w-full mb-4 shadow-lg hover:bg-purple-600 transition-colors">Generate Insights</button>
        <div id="insights-container" class="space-y-4">
          <p data-i18n="insights_placeholder" id="insights-placeholder" class="italic text-gray-500 text-center">Click "Generate Insights" to get personalized feedback on your academic and financial goals.</p>
          <div id="insights-loading" class="text-center mt-4 loading-spinner"><i class="fas fa-spinner fa-spin text-3xl text-gray-500"></i></div>
          <div id="insights-content" class="bg-gray-50 p-4 rounded-xl shadow-inner hidden"></div>
        </div>
      </section>

      <section id="rewards" class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <h2 data-i18n="rewards_title" class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">üèÜ Rewards</h2>
        <div id="rewards-list" class="space-y-4"><p data-i18n="no_rewards" class="italic text-gray-500 text-center">No rewards yet. Keep up the great work!</p></div>
        <div class="text-center mt-4 loading-spinner"><i class="fas fa-spinner fa-spin text-3xl text-gray-500"></i></div>
      </section>

      <section class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <h2 data-i18n="analytics_title" class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">üìä Analytics</h2>
        <div class="w-full h-64"><canvas id="analytics-chart"></canvas></div>
      </section>
    </div>
  </main>

  <footer class="text-center text-gray-500 text-sm mt-8 mb-4">
    <span data-i18n="footer_text">&copy; 2025 SmartStudentAct ‚Äì Empowering Students Globally.</span>
  </footer>

  <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-4px_12px_-1px_rgba(0,0,0,0.1)] py-2 px-4 rounded-t-3xl z-40">
    <div class="flex justify-around items-center h-full">
      <a href="./students.html" class="tab-link flex flex-col items-center justify-center p-2 text-gray-500 hover:text-blue-500 transition-colors" data-tab="dashboard">
        <i class="fas fa-home text-2xl mb-1"></i><span data-i18n="dashboard_tab" class="text-xs font-medium">Dashboard</span>
      </a>
      <a href="./task-completed.html" class="tab-link flex flex-col items-center justify-center p-2 text-gray-500 hover:text-blue-500 transition-colors" data-tab="completed">
        <i class="fas fa-check-circle text-2xl mb-1"></i><span data-i18n="completed_tab" class="text-xs font-medium">Completed</span>
      </a>
      <a href="./teachers-list.html" class="tab-link flex flex-col items-center justify-center p-2 text-gray-500 hover:text-blue-500 transition-colors" data-tab="teachers">
        <i class="fas fa-chalkboard-teacher text-2xl mb-1"></i><span data-i18n="teachers_tab" class="text-xs font-medium">Teachers</span>
      </a>
      <a href="./student_quiz.html" class="tab-link flex flex-col items-center justify-center p-2 text-gray-500 hover:text-blue-500 transition-colors" data-tab="quiz">
        <i class="fas fa-wallet text-2xl mb-1"></i><span data-i18n="quiz_tab" class="text-xs font-medium">Quizzes</span>
      </a>
      <a href="AI Essay Checker.html" class="tab-link flex flex-col items-center justify-center p-2 text-gray-500 hover:text-blue-500 transition-colors" data-tab="ai-checker">
        <i class="fas fa-robot text-2xl mb-1"></i><span data-i18n="ai_checker_tab" class="text-xs font-medium">ü§ñAI Checker</span>
      </a>
      <a href="./profile.html" class="tab-link flex flex-col items-center justify-center p-2 text-gray-500 hover:text-blue-500 transition-colors" data-tab="profile">
        <i class="fas fa-user-circle text-2xl mb-1"></i><span data-i18n="profile_tab" class="text-xs font-medium">Profile</span>
      </a>
    </div>
  </nav>

  <!-- Add Task Modal -->
<div id="add-assignment-modal" class="modal-overlay">
  <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-6 modal-content relative">
    <button class="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl"
      onclick="closeModal('add-assignment-modal')">&times;</button>
    <h3 class="text-xl font-bold mb-4" data-i18n="add_assignment_modal_title">Add Task</h3>
    <input type="text" placeholder="Task Name" id="assignment-name"
      class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"/>
    <textarea placeholder="Description" id="assignment-desc"
      class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"></textarea>
    <input type="date" id="assignment-due-date"
      class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"/>
    <input type="time" id="assignment-due-time"
      class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"/>
    <button id="save-assignment-btn"
      class="bg-green-500 text-white py-2 px-6 rounded-full w-full font-bold hover:bg-green-600">
      Save Task
    </button>
  </div>
</div>


  <div id="budget-modal" class="modal-overlay">
    <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 modal-content relative">
      <button class="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl" onclick="closeModal('budget-modal')">&times;</button>
      <h3 class="text-xl font-bold mb-4" data-i18n="add_budget_modal_title">Add Budget</h3>
      <input type="text" placeholder="Expense Name" id="expense-name" class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"/>
      <input type="number" placeholder="Amount" id="expense-amount" class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"/>
      <input type="date" id="expense-date" class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"/>
      <select id="expense-category" class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none">
        <option value="necessity">Necessity</option>
        <option value="entertainment">Entertainment</option>
        <option value="education">Education</option>
        <option value="other">Other</option>
      </select>
      <button id="save-budget-btn" class="bg-green-500 text-white py-2 px-6 rounded-full w-full font-bold hover:bg-green-600">Save Expense</button>
    </div>
  </div>

  <div id="menu-modal" class="modal-overlay">
    <div id="menu-content" class="bg-white h-full w-64 p-6 shadow-2xl transition-transform duration-300 ease-in-out transform -translate-x-full">
      <button id="close-menu-btn" class="text-gray-500 text-2xl absolute top-4 right-4">&times;</button>
      <h2 class="text-xl font-bold mb-6">Menu</h2>
      <nav>
        <ul class="space-y-4">
          <li><a href="./students.html" class="text-blue-600 font-semibold hover:underline">Dashboard</a></li>
          <li><a href="./financial.html" class="text-blue-600 font-semibold hover:underline">Financial</a></li>
          <li><a href="./settings.html" class="hover:underline">Settings</a></li>
          <li><a href="./rewards.html" class="hover:underline">Rewards</a></li>
           <li><a href="./contact.html" class="block px-4 py-2 text-sm hover:bg-gray-100">üì© Contact</a></li>
          <li><button id="menu-logout-btn" class="text-red-500 font-semibold hover:underline">Logout</button></li>
        </ul>
      </nav>
    </div>
  </div>

  
  <div id="toast-container"></div>
  
  <script src="translate.js"></script>
  

<script>
  const API_BASE_URL = "https://api.smartstudentact.com/api";

  async function subscribeUserToPush() {
    if (!("serviceWorker" in navigator)) return;

    const reg = await navigator.serviceWorker.ready;

    try {
      const subscription = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(
          "BIiReZmmNOxbUaqVrIob40QBGzO_CN5FcDvUlyx8_13PRxIC0Ru46KDW3VYRjJUQquvud5FSvIhWgvtgbjuP0fA"
        ),
      });

      console.log("üì° Push Subscription:", subscription);

      const res = await fetch(`${API_BASE_URL}/push/subscribe`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        credentials: "include",
        body: JSON.stringify(subscription),
      });

      if (!res.ok) throw new Error("Failed to save push subscription");

      console.log("‚úÖ Successfully subscribed to push");
    } catch (err) {
      console.error("‚ùå Push subscription failed:", err);
    }
  }


  document.addEventListener("DOMContentLoaded", async () => {
    let currentLang = "en";
    const dashboardName = "students";


    if (typeof translatePage === "function") {
      translatePage(dashboardName, currentLang);
      const langSelect = document.getElementById("lang-select");
      if (langSelect) {
        langSelect.addEventListener("change", (e) => {
          currentLang = e.target.value;
          translatePage(dashboardName, currentLang);
        });
      }
    }


    const DOM = {
      logoutBtn: document.getElementById("logout-btn"),
      menuLogoutBtn: document.getElementById("menu-logout-btn"),
      menuBtn: document.getElementById("menu-btn"),
      closeMenuBtn: document.getElementById("close-menu-btn"),
      menuContent: document.getElementById("menu-content"),
      addAssignmentBtn: document.getElementById("add-assignment-btn"),
      addBudgetBtn: document.getElementById("add-budget-btn"),
      saveAssignmentBtn: document.getElementById("save-assignment-btn"),
      saveBudgetBtn: document.getElementById("save-budget-btn"),
      saveGoalBtn: document.getElementById("save-goal-btn"),
      goalInput: document.getElementById("goal-input"),
      savedGoalsList: document.getElementById("saved-goals-list"),
      assignmentsList: document.getElementById("assignments-list"),
      budgetList: document.getElementById("budget-list"),
      insightsContent: document.getElementById("insights-content"),
      insightsPlaceholder: document.getElementById("insights-placeholder"),
      generateInsightsBtn: document.getElementById("generate-insights-btn"),
      profileForm: document.getElementById("profile-form"),
      profilePhotoInput: document.getElementById("profile-photo"),
      profilePreview: document.getElementById("profile-preview"),
      addAssignmentModal: document.getElementById("add-assignment-modal"),
      budgetModal: document.getElementById("budget-modal"),
      menuModal: document.getElementById("menu-modal"),
      chartCanvas: document.getElementById("analytics-chart"),
    };


    function showToast(message, type = "info") {
      const container = document.getElementById("toast-container");
      if (!container) return;
      const toast = document.createElement("div");
      const colors = {
        success: "bg-green-500",
        error: "bg-red-500",
        info: "bg-blue-500",
        warning: "bg-yellow-500",
      };
      toast.className = `toast ${colors[type] || colors.info} text-white px-4 py-2 rounded-full shadow-lg`;
      toast.innerText = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    async function fetchWithAuth(endpoint, options = {}) {
      const res = await fetch(`${API_BASE_URL}${endpoint}`, {
        ...options,
        credentials: "include",
      });
      if (!res.ok) throw new Error((await res.json()).message || "Request failed");
      return res.json();
    }

    async function checkAuthentication() {
      try {
        await fetchWithAuth("/auth/check");
        return true;
      } catch {
        showToast("Please login first.", "error");
        setTimeout(() => (window.location.href = "/login.html"), 1500);
        return false;
      }
    }


    async function handleSaveAssignment() {
  const title = document.getElementById("assignment-name").value.trim();
  const description = document.getElementById("assignment-desc").value.trim();
  const dueDate = document.getElementById("assignment-due-date").value;
  const dueTime = document.getElementById("assignment-due-time").value;

  if (!title || !dueDate || !dueTime) {
    return showToast("Enter all task fields", "warning");
  }

  try {
    const due_date = new Date(`${dueDate}T${dueTime}`).toISOString();

    // Include userId if needed
    await fetchWithAuth("/student/tasks", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title,
        description,
        due_date,
        userId: req.userId || undefined // optional, backend already reads JWT
      }),
    });

    showToast("Task added!", "success");
    closeModal("add-assignment-modal");
    fetchAssignments();
    scheduleReminders(title, due_date);
  } catch (e) {
    showToast(e.message, "error");
  }
}

    async function handleSubmission(assignmentId) {

      const submissionText = prompt("Enter your submission text:");
      if (submissionText === null) return; 

      const formData = new FormData();
      formData.append("assignmentId", assignmentId);
      formData.append("submissionText", submissionText);
 

      try {
        await fetchWithAuth("/student/submissions", {
          method: "POST",
          body: formData,
        });
        showToast("Assignment submitted successfully!", "success");
        fetchAssignments(); 
      } catch (e) {
        showToast(e.message, "error");
      }
    }

    async function fetchAssignments() {
      try {
        const [teacherAssignments, studentTasks] = await Promise.all([
          fetchWithAuth("/student/assignments"),
          fetchWithAuth("/student/tasks"),
        ]);

        let assignmentsHtml = "";
        if (teacherAssignments.length > 0) {
          assignmentsHtml += `<h3 class="font-bold text-lg mb-2 text-blue-600">Teacher-Assigned Assignments</h3>`;
          assignmentsHtml += teacherAssignments.map((a) => {
            const due = a.due_date ? new Date(a.due_date).toLocaleString() : "N/A";
            return `
              <li class="p-4 border-b rounded-lg shadow-sm mb-2 bg-gray-100 flex justify-between items-center">
                <div>
                  <h4 class="font-semibold">${a.title || "Untitled"}</h4>
                  <p class="text-sm text-gray-600">${a.description || ""}</p>
                  <span class="text-xs text-gray-500 block mt-1">Due: ${due}</span>
                </div>
                <button onclick="handleSubmission('${a._id}')" class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm hover:bg-blue-600 transition-colors duration-200">Submit</button>
              </li>
            `;
          }).join("");
        } else {
          assignmentsHtml += `<p data-i18n="no_assignments" class="italic text-gray-500 text-center">No teacher-assigned assignments.</p>`;
        }

        assignmentsHtml += `<hr class="my-4 border-gray-300">`;

        if (studentTasks.length > 0) {
          assignmentsHtml += `<h3 class="font-bold text-lg mb-2 text-purple-600">My Personal Tasks</h3>`;
          assignmentsHtml += studentTasks.map((t) => {
            const due = t.due_date ? new Date(t.due_date).toLocaleString() : "N/A";
            const completedClass = t.is_completed ? "line-through text-gray-400" : "";
            const completedText = t.is_completed ? "Completed" : "Mark as Done";
            const buttonAction = t.is_completed ? "" : `onclick="markTaskComplete('${t._id}')"`;
            const buttonClass = t.is_completed ? "bg-green-500 cursor-not-allowed" : "bg-purple-500 hover:bg-purple-600";
            return `
              <li class="p-4 border-b rounded-lg shadow-sm mb-2 bg-gray-100 flex justify-between items-center ${completedClass}">
                <div>
                  <h4 class="font-semibold">${t.title}</h4>
                  <p class="text-sm text-gray-600">${t.description || ""}</p>
                  <span class="text-xs text-gray-500 block mt-1">Due: ${due}</span>
                </div>
                <button ${buttonAction} class="${buttonClass} text-white px-3 py-1 rounded-full text-sm transition-colors duration-200">${completedText}</button>
              </li>
            `;
          }).join("");
        } else {
          assignmentsHtml += `<p data-i18n="no_tasks" class="italic text-gray-500 text-center">No personal tasks added yet.</p>`;
        }

        DOM.assignmentsList.innerHTML = assignmentsHtml;
      } catch (e) {
        showToast(e.message, "error");
      }
    }

    window.markTaskComplete = async (taskId) => {
      try {
        await fetchWithAuth(`/student/tasks/${taskId}/complete`, {
          method: "PATCH"
        });
        showToast("Task marked as completed!", "success");
        fetchAssignments(); 
      } catch (e) {
        showToast(e.message, "error");
      }
    }

    function scheduleReminders(title, due_at) {
      const due = new Date(due_at).getTime();
      const now = Date.now();
      const reminders = [24, 6, 2];

      reminders.forEach((h) => {
        const msBefore = h * 60 * 60 * 1000;
        const reminderTime = due - msBefore;
        if (reminderTime > now) {
          const delay = reminderTime - now;
          setTimeout(() => {
            showToast(`Reminder: "${title}" is due in ${h}h!`, "info");
            fetchWithAuth("/student/reminders", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                title,
                hours_before: h
              }),
            }).catch(() => {});
          }, delay);
        }
      });
    }


    async function handleSaveBudget() {
  const description = document.getElementById("expense-name").value.trim();
  const amount = parseFloat(document.getElementById("expense-amount").value.trim());
  const date = document.getElementById("expense-date").value;
  const category = document.getElementById("expense-category").value;

  if (!description || isNaN(amount) || !date) {
    return showToast("Enter all budget fields", "warning");
  }

  try {
    await fetchWithAuth("/budget/add-entry", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        description,
        amount,
        date,
        category,
        type: "expense",
        userId: req.userId || undefined // optional
      }),
    });
    showToast("Budget entry saved!", "success");
    closeModal("budget-modal");
    fetchBudget();
  } catch (e) {
    showToast(e.message, "error");
  }
}


    async function handleSaveGoal() {
  const description = DOM.goalInput.value.trim();
  const target_date = document.getElementById("goal-target-date").value;
  const type = document.getElementById("goal-type").value;

  if (!description || !target_date) {
    return showToast("Enter all goal fields", "warning");
  }

  try {
    await fetchWithAuth("/rewards/goals", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        description,
        target_date,
        type,
        progress: 0,
        userId: req.userId || undefined // optional
      }),
    });

    showToast("Goal saved üéØ", "success");
    DOM.goalInput.value = "";
    document.getElementById("goal-target-date").value = "";
    fetchGoal();
  } catch (e) {
    showToast(e.message, "error");
  }
}

    async function fetchQuizzes() {
      try {
        const quizzes = await fetchWithAuth("/student/quizzes");
        const quizzesList = document.getElementById("quizzes-list");
        quizzesList.innerHTML = quizzes.length ?
          quizzes.map(
            (q) =>
            `<li class="p-2 border-b">${q.title || "Untitled"} - Due: ${q.dueDate ? new Date(q.dueDate).toLocaleDateString() : "N/A"}</li>`
          ).join("") :
          `<p data-i18n="no_quizzes" class="italic text-gray-500 text-center">No quizzes assigned yet.</p>`;
      } catch (e) {
        showToast(e.message, "error");
      }
    }


    async function handleProfileUpload(e) {
  e.preventDefault();

  const formData = new FormData();
  const file = DOM.profileForm.querySelector('input[type="file"]').files[0];
  if (!file) {
    showToast("No file selected.", "error");
    return;
  }

  formData.append("profilePhoto", file); 

  try {
    const res = await fetch(`${API_BASE_URL}/profile/upload-photo`, {
      method: "POST",
      body: formData,
      credentials: "include",
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "Upload failed");

    DOM.profilePreview.src = data.photoUrl || "./images/default-avatar.png";
    showToast("Profile updated!", "success");
  } catch (err) {
    console.error(err);
    DOM.profilePreview.src = "./images/default-avatar.png";
    showToast(err.message, "error");
  }
}


    
    function renderChart() {
      if (!DOM.chartCanvas) return;
      const ctx = DOM.chartCanvas.getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Assignments", "Quizzes", "Budget"],
          datasets: [{
            label: "Activity",
            data: [12, 19, 3], // Placeholder
            backgroundColor: ["#3b82f6", "#8b5cf6", "#ef4444"],
            borderRadius: 10,
          }, ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              display: false
            }
          },
        },
      });
    }


    async function handleLogout() {
      try {
        await fetch(`${API_BASE_URL}/users/logout`, {
          method: "POST",
          credentials: "include",
        });
        showToast("Logged out", "info");
        setTimeout(() => (window.location.href = "/login.html"), 1000);
      } catch {
        showToast("Logout failed", "error");
      }
    }

    function openModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.classList.add("active");
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.classList.remove("active");
    }

    window.openModal = openModal;
    window.closeModal = closeModal;
    window.handleSubmission = handleSubmission;


    if (await checkAuthentication()) {
      fetchAssignments();
      fetchBudget();
      fetchGoal();
      fetchQuizzes();
      renderChart();
    }

    // üéõ Event Listeners
    if (DOM.menuBtn) {
      DOM.menuBtn.addEventListener("click", () => {
        DOM.menuModal.classList.add("active");
        DOM.menuContent.style.transform = "translateX(0)";
      });
    }
    if (DOM.closeMenuBtn) {
      DOM.closeMenuBtn.addEventListener("click", () => {
        DOM.menuContent.style.transform = "translateX(-100%)";
        setTimeout(() => DOM.menuModal.classList.remove("active"), 300);
      });
    }
    if (DOM.addAssignmentBtn) DOM.addAssignmentBtn.addEventListener("click", () => openModal("add-assignment-modal"));
    if (DOM.addBudgetBtn) DOM.addBudgetBtn.addEventListener("click", () => openModal("budget-modal"));
    if (DOM.saveAssignmentBtn) DOM.saveAssignmentBtn.addEventListener("click", handleSaveAssignment);
    if (DOM.saveBudgetBtn) DOM.saveBudgetBtn.addEventListener("click", handleSaveBudget);
    if (DOM.saveGoalBtn) DOM.saveGoalBtn.addEventListener("click", handleSaveGoal);
    if (DOM.generateInsightsBtn) DOM.generateInsightsBtn.addEventListener("click", async () => {
      try {
        const advice = await fetchWithAuth("/rewards/advice");
        DOM.insightsPlaceholder.classList.add("hidden");
        DOM.insightsContent.classList.remove("hidden");
        DOM.insightsContent.innerText = advice.message || "No advice received.";
      } catch (e) {
        showToast(e.message, "error");
      }
    });
    if (DOM.logoutBtn) DOM.logoutBtn.addEventListener("click", handleLogout);
    if (DOM.menuLogoutBtn) DOM.menuLogoutBtn.addEventListener("click", handleLogout);
    if (DOM.profilePhotoInput) DOM.profilePhotoInput.addEventListener("change", handleProfileUpload);
  });

  // üë§ Live profile preview
  document.getElementById("profile-photo")?.addEventListener("change", function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById("profile-preview").src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
</script>
</body>
</html>
