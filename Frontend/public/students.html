<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartStudentAct - Dashboard</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWMR745QHX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-EWMR745QHX');
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: "class" };
    if (
      localStorage.getItem("theme") === "dark" ||
      (!("theme" in localStorage) && window.matchMedia("(prefers-color-scheme: dark)").matches)
    ) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  </script>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png"/>
  <link rel="icon" type="image/png" sizes="16x16" href="./images/icon.png"/>
  <link rel="manifest" href="/site.webmanifest"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap");
    body { font-family: "Inter", sans-serif; padding-bottom: 70px; }
    .modal-overlay { background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 50; }
    .modal-overlay.active { display: flex; }
    .tab-active { color: #3b82f6; border-bottom: 2px solid #3b82f6; }
    .loading-spinner { display: none; }
    .modal-content { max-height: 90vh; overflow-y: auto; }
    #toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 8px; z-index: 60; }
    .toast { animation: fadeinout 4s forwards; opacity: 0; }
    @keyframes fadeinout {
      0% { opacity: 0; transform: translateY(20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }
  </style>
</head>
<body class="min-h-screen bg-[#f0f2f5] dark:bg-gray-900 dark:text-white transition-colors duration-200">

  <header class="bg-white text-gray-800 p-4 flex justify-between items-center shadow-lg rounded-b-3xl">
    <button id="menu-btn" class="p-2 text-2xl text-blue-600 focus:outline-none" aria-label="Open navigation menu"><i class="fas fa-bars"></i></button>
    <span data-i18n="nav_title" class="text-xl font-bold flex-1 text-center">üìò SmartStudentAct</span>
    <button id="logout-btn" class="bg-red-500 py-2 px-4 rounded-full font-bold shadow-md text-white hover:bg-red-600 transition-colors"><span data-i18n="logout">Logout</span></button>
  </header>

  <main class="p-4 sm:p-6 lg:p-8">
    <div class="max-w-4xl mx-auto">
      
      
      <div class="flex flex-col sm:flex-row items-center justify-between mb-8">
        <div class="flex flex-col items-center sm:items-start mb-4 sm:mb-0">
          <img id="profile-preview" src="./images/default-avatar.png" class="w-24 h-24 rounded-full shadow-lg mb-2 transform transition-transform duration-300 hover:scale-110" />
          <div class="text-center sm:text-left mb-2">
            <h2 id="profile-name" class="text-xl font-bold text-gray-800"></h2>
            <p id="profile-school" class="text-sm text-gray-600 font-medium"></p>
          </div>
          <form id="profile-form" class="flex items-center space-x-2">
            <label for="profile-photo" class="bg-blue-500 text-white text-sm py-1 px-3 rounded-full cursor-pointer hover:bg-blue-600 transition-colors">
              <i class="fas fa-camera"></i> <span data-i18n="change_photo">Change Photo</span>
            </label>
            <input type="file" id="profile-photo" name="profilePhoto" accept="image/*" class="hidden" />
          </form>
        </div>
        
        <div id="language-switcher" class="relative mt-4 sm:mt-0">
          <select id="lang-select" class="px-3 py-2 bg-white border border-gray-300 rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none pr-8 cursor-pointer text-sm">
            <option value="en">EN - English</option>
            <option value="fr">FR - Fran√ßais</option>
            <option value="es">ES - Espa√±ol</option>
            <option value="tr">TR - T√ºrk√ße</option>
            <option value="ar">AR - ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
            <option value="ru">RU - –†—É—Å—Å–∫–∏–π</option>
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
          </div>
        </div>
      </div>

      <h1 data-i18n="welcome_heading" class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mt-8 mb-4">Welcome to SmartStudentAct</h1>
      <p data-i18n="welcome_text" class="text-lg text-center text-gray-600 mb-8">Your learning & financial companion</p>

      <!-- Notification Subscription Button -->
      <div class="flex justify-center mb-6">
        <button id="notification-btn" class="px-6 py-2 rounded-full font-semibold shadow transition-colors bg-blue-500 text-white hover:bg-blue-600 flex items-center gap-2">
          <span id="notification-btn-icon">üîî</span>
          <span id="notification-btn-text">Subscribe to Notifications</span>
        </button>
      </div>
      
      <section class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <h2 data-i18n="assignments_title" class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">üìö Assignments</h2>
        <button id="add-assignment-btn" data-i18n="add_assignment_btn" class="bg-green-500 text-white py-3 px-6 rounded-full font-bold w-full mb-4 shadow-lg hover:bg-green-600 transition-colors">+ Add Assignment</button>
        <div id="assignments-list" class="space-y-4">
          <p data-i18n="no_assignments" class="italic text-gray-500 text-center">No assignments added yet.</p>
        </div>
        <div id="assignments-loading" class="text-center mt-4 loading-spinner"><i class="fas fa-spinner fa-spin text-3xl text-gray-500"></i></div>
      </section>

      <section class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <h2 data-i18n="quizzes_title" class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">üìù Quizzes</h2>
        <div id="quizzes-list" class="space-y-4">
          <p data-i18n="no_quizzes" class="italic text-gray-500 text-center">No quizzes assigned yet.</p>
        </div>
        <div id="quizzes-loading" class="text-center mt-4 loading-spinner"><i class="fas fa-spinner fa-spin text-3xl text-gray-500"></i></div>
      </section>

      <section class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <h2 data-i18n="budget_title" class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">üí∞ Budget</h2>
        <button id="add-budget-btn" data-i18n="add_expense_btn" class="bg-green-500 text-white py-3 px-6 rounded-full font-bold w-full mb-4 shadow-lg hover:bg-green-600 transition-colors">+ Add Expense</button>
        <div id="budget-list" class="space-y-4">
          <p data-i18n="no_budget" class="italic text-gray-500 text-center">No budget entries yet.</p>
        </div>
        <div id="budget-loading" class="text-center mt-4 loading-spinner"><i class="fas fa-spinner fa-spin text-3xl text-gray-500"></i></div>
      </section>

      <section class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <h2 data-i18n="weekly_goal_title" class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">üéØ Weekly Goal</h2>
        <div class="space-y-4">
          <input id="goal-input" type="text" data-i18n-placeholder="goal_placeholder" placeholder="Your weekly goal" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500 text-base"/>
          <input id="goal-target-date" type="date" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500 text-base"/>
          <select id="goal-type" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500 text-base">
            <option value="academic">Academic</option>
            <option value="personal">Personal</option>
            <option value="extracurricular">Extracurricular</option>
          </select>
          <p id="goal-error" class="text-red-500 text-sm hidden"></p>
          <button id="save-goal-btn" data-i18n="save_goal_btn" class="bg-blue-500 text-white py-3 px-6 rounded-full font-bold w-full shadow-lg hover:bg-blue-600 transition-colors">Save Goal</button>
          <ul id="saved-goals-list" class="text-green-600 font-bold text-center mt-2"></ul>
        </div>
      </section>

      <section class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <div class="flex items-center justify-between mb-4">
          <h2 data-i18n="ai_insights_title" class="text-2xl font-semibold text-gray-800 flex items-center">ü§ñ AI Insights</h2>
          <div class="flex items-center">
            <label data-i18n="subscribed_label" for="subscription-toggle" class="text-sm text-gray-500 mr-2">Subscribed?</label>
            <input type="checkbox" id="subscription-toggle" class="form-checkbox h-5 w-5 text-blue-600 rounded"/>
          </div>
        </div>
        <button id="generate-insights-btn" data-i18n="generate_insights_btn" class="bg-purple-500 text-white py-3 px-6 rounded-full font-bold w-full mb-4 shadow-lg hover:bg-purple-600 transition-colors">Generate Insights</button>
        <div id="insights-container" class="space-y-4">
          <p data-i18n="insights_placeholder" id="insights-placeholder" class="italic text-gray-500 text-center">Click "Generate Insights" to get personalized feedback on your academic and financial goals.</p>
          <div id="insights-loading" class="text-center mt-4 loading-spinner"><i class="fas fa-spinner fa-spin text-3xl text-gray-500"></i></div>
          <div id="insights-content" class="bg-gray-50 p-4 rounded-xl shadow-inner hidden"></div>
        </div>
      </section>

       <section id="student-messages" class="mb-6">
  <h3 class="font-bold text-lg mb-2 text-green-600">Teacher Messages</h3>
  <ul id="messages-list" class="space-y-2">
    
  </ul>
</section>

      <section id="rewards" class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <h2 data-i18n="rewards_title" class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">üèÜ Rewards</h2>
        <div id="rewards-list" class="space-y-4"><p data-i18n="no_rewards" class="italic text-gray-500 text-center">No rewards yet. Keep up the great work!</p></div>
        <div class="text-center mt-4 loading-spinner"><i class="fas fa-spinner fa-spin text-3xl text-gray-500"></i></div>
      </section>

      <section class="bg-white rounded-3xl shadow-xl p-6 mb-6 transform hover:scale-105 transition-transform duration-300">
        <h2 data-i18n="analytics_title" class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">üìä Analytics</h2>
        <div class="w-full h-64"><canvas id="analytics-chart"></canvas></div>
      </section>
    </div>
  </main>

  <footer class="text-center text-gray-500 text-sm mt-8 mb-4">
    <span data-i18n="footer_text">&copy; 2025 SmartStudentAct ‚Äì Empowering Students Globally.</span>
  </footer>

  <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-4px_12px_-1px_rgba(0,0,0,0.1)] py-2 px-4 rounded-t-3xl z-40">
    <div class="flex justify-around items-center h-full">
      <a href="./students.html" class="tab-link flex flex-col items-center justify-center p-2 text-gray-500 hover:text-blue-500 transition-colors" data-tab="dashboard">
        <i class="fas fa-home text-2xl mb-1"></i><span data-i18n="dashboard_tab" class="text-xs font-medium">Dashboard</span>
      </a>
      <a href="./task-completed.html" class="tab-link flex flex-col items-center justify-center p-2 text-gray-500 hover:text-blue-500 transition-colors" data-tab="completed">
        <i class="fas fa-check-circle text-2xl mb-1"></i><span data-i18n="completed_tab" class="text-xs font-medium">Completed</span>
      </a>
      <a href="./teachers-list.html" class="tab-link flex flex-col items-center justify-center p-2 text-gray-500 hover:text-blue-500 transition-colors" data-tab="teachers">
        <i class="fas fa-chalkboard-teacher text-2xl mb-1"></i><span data-i18n="teachers_tab" class="text-xs font-medium">Teachers</span>
      </a>
      <a href="./student_quiz.html" class="tab-link flex flex-col items-center justify-center p-2 text-gray-500 hover:text-blue-500 transition-colors" data-tab="quiz">
        <i class="fas fa-wallet text-2xl mb-1"></i><span data-i18n="quiz_tab" class="text-xs font-medium">Quizzes</span>
      </a>
      <a href="AI Essay Checker.html" class="tab-link flex flex-col items-center justify-center p-2 text-gray-500 hover:text-blue-500 transition-colors" data-tab="ai-checker">
        <i class="fas fa-robot text-2xl mb-1"></i><span data-i18n="ai_checker_tab" class="text-xs font-medium">ü§ñAI Checker</span>
      </a>
      <a href="./profile.html" class="tab-link flex flex-col items-center justify-center p-2 text-gray-500 hover:text-blue-500 transition-colors" data-tab="profile">
        <i class="fas fa-user-circle text-2xl mb-1"></i><span data-i18n="profile_tab" class="text-xs font-medium">Profile</span>
      </a>
    </div>
  </nav>

  
<div id="add-assignment-modal" class="modal-overlay">
  <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-6 modal-content relative">
    <button class="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl"
      onclick="closeModal('add-assignment-modal')">&times;</button>
    <h3 class="text-xl font-bold mb-4" data-i18n="add_assignment_modal_title">Add Task</h3>
    <input type="text" placeholder="Task Name" id="assignment-name"
      class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"/>
    <textarea placeholder="Description" id="assignment-desc"
      class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"></textarea>
    <input type="date" id="assignment-due-date"
      class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"/>
    <input type="time" id="assignment-due-time"
      class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"/>
    <button id="save-assignment-btn"
      class="bg-green-500 text-white py-2 px-6 rounded-full w-full font-bold hover:bg-green-600">
      Save Task
    </button>
  </div>
</div>


  <div id="budget-modal" class="modal-overlay">
    <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 modal-content relative">
      <button class="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl" onclick="closeModal('budget-modal')">&times;</button>
      <h3 class="text-xl font-bold mb-4" data-i18n="add_budget_modal_title">Add Budget</h3>
      <input type="text" placeholder="Expense Name" id="expense-name" class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"/>
      <input type="number" placeholder="Amount" id="expense-amount" class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"/>
      <input type="date" id="expense-date" class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none"/>
      <select id="expense-category" class="w-full mb-3 px-4 py-2 border rounded-xl focus:outline-none">
        <option value="necessity">Necessity</option>
        <option value="entertainment">Entertainment</option>
        <option value="education">Education</option>
        <option value="other">Other</option>
      </select>
      <button id="save-budget-btn" class="bg-green-500 text-white py-2 px-6 rounded-full w-full font-bold hover:bg-green-600">Save Expense</button>
    </div>
  </div>

  <div id="menu-modal" class="modal-overlay">
    <div id="menu-content" class="bg-white h-full w-64 p-6 shadow-2xl transition-transform duration-300 ease-in-out transform -translate-x-full">
      <button id="close-menu-btn" class="text-gray-500 text-2xl absolute top-4 right-4">&times;</button>
      <h2 class="text-xl font-bold mb-6">Menu</h2>
      <nav>
        <ul class="space-y-4">
          <li><a href="./students.html" class="text-blue-600 font-semibold hover:underline">Dashboard</a></li>
          <li><a href="./financial.html" class="text-blue-600 font-semibold hover:underline">Financial</a></li>
          <li><a href="./special-link.html" class="text-blue-600 font-semibold hover:underline">Special Links</a></li>
          <li><a href="./settings.html" class="hover:underline">Settings</a></li>
          <li><a href="./rewards.html" class="hover:underline">Rewards</a></li>
           <li><a href="./contact.html" class="block px-4 py-2 text-sm hover:bg-gray-100">üì© Contact</a></li>
          <li><button id="menu-logout-btn" class="text-red-500 font-semibold hover:underline">Logout</button></li>
        </ul>
      </nav>
    </div>
  </div>

  <div id="toast-container"></div>
  
  <script src="api-config.js"></script>
  <script src="translate.js"></script>
  

<script>
  const API_BASE_URL = window.API_BASE_URL || 'http://localhost:3000/api';
  let currentUser = {};
  let analyticsChartInstance = null;

  async function isUserSubscribedToPush() {
    if (!('serviceWorker' in navigator)) return false;
    const reg = await navigator.serviceWorker.ready;
    const subscription = await reg.pushManager.getSubscription();
    return !!subscription;
  }

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
      outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
  }

  async function subscribeUserToPush() {
  if (!('serviceWorker' in navigator)) return;

  // Ensure service worker is registered
  try {
    await navigator.serviceWorker.register('/sw.js');
  } catch (err) {
    console.warn('Service worker registration failed or already registered:', err.message || err);
  }

  const reg = await navigator.serviceWorker.ready;

  try {
    // Ask for notification permission if not decided yet
    if (Notification.permission === 'default') {
      const p = await Notification.requestPermission();
      if (p !== 'granted') {
        console.log('Push permission not granted');
        return;
      }
    }

    if (Notification.permission !== 'granted') return;

    // If already subscribed, reuse the subscription
    let subscription = await reg.pushManager.getSubscription();
    if (!subscription) {
      subscription = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(
          'BIiReZmmNOxbUaqVrIob40QBGzO_CN5FcDvUlyx8_13PRxIC0Ru46KDW3VYRjJUQquvud5FSvIhWgvtgbjuP0fA'
        ),
      });
    }

    console.log('üì° Push Subscription:', subscription);

    // Send to server to save (idempotent)
    const res = await fetch(`${API_BASE_URL}/push/subscribe`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(subscription),
    });

    if (!res.ok) {
      const body = await res.json().catch(() => ({}));
      throw new Error(body.message || 'Failed to save push subscription');
    }

    console.log('‚úÖ Successfully subscribed to push');
    updateNotificationBtn(true);
  } catch (err) {
    console.error('‚ùå Push subscription failed:', err);
    updateNotificationBtn(false);
  }
}

function updateNotificationBtn(isSubscribed) {
  const btn = document.getElementById('notification-btn');
  const icon = document.getElementById('notification-btn-icon');
  const text = document.getElementById('notification-btn-text');
  if (!btn || !icon || !text) return;
  if (isSubscribed) {
    btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
    btn.classList.add('bg-green-500', 'hover:bg-green-600');
    icon.textContent = 'üîî';
    text.textContent = 'Subscribed to Notifications';
  } else {
    btn.classList.remove('bg-green-500', 'hover:bg-green-600');
    btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
    icon.textContent = 'üîï';
    text.textContent = 'Subscribe to Notifications';
  }
}

async function unsubscribeUserFromPush() {
  if (!('serviceWorker' in navigator)) return;
  const reg = await navigator.serviceWorker.ready;
  const subscription = await reg.pushManager.getSubscription();
  if (subscription) {
    await subscription.unsubscribe();
    updateNotificationBtn(false);
    showToast('Unsubscribed from notifications', 'info');
  }
}

  // --- Utility Functions ---
  function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast px-4 py-2 rounded shadow-lg text-white ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
    toast.innerText = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }

  window.openModal = function(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.classList.add('active');
  };

  window.closeModal = function(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.classList.remove('active');
  };

  // --- Auth & API ---
  async function checkAuthentication() {
    try {
      const res = await fetch(`${API_BASE_URL}/auth/check`, { credentials: 'include' });
      if (!res.ok) {
        window.location.href = '/login.html';
        return false;
      }
      const data = await res.json();
      if (data.user) {
        // ensure we have a stable _id for sender/recipient comparisons
        currentUser = { ...data.user, _id: data.user._id || data.user.id };
      }
      return true;
    } catch (e) {
      window.location.href = '/login.html';
      return false;
    }
  }

  async function fetchWithAuth(endpoint, options = {}) {
    const headers = {
      'Content-Type': 'application/json',
      ...(options.headers || {})
    };
    
    // Handle FormData (remove Content-Type to let browser set boundary)
    if (options.body instanceof FormData) {
      delete headers['Content-Type'];
    }

    const res = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers, credentials: 'include' });
    if (res.status === 401) {
      handleLogout();
      throw new Error('Unauthorized');
    }

    if (res.status === 204) {
      return null;
    }

    const contentType = res.headers.get('content-type') || '';

    if (!res.ok) {
      let message = `Request failed with status ${res.status}`;
      try {
        if (contentType.includes('application/json')) {
          const errData = await res.json();
          message = errData?.message || message;
        } else {
          const text = await res.text();
          if (text) message = text;
        }
      } catch {
        // ignore parse errors, fallback to default message
      }
      throw new Error(message);
    }

    if (contentType.includes('application/json')) {
      try {
        return await res.json();
      } catch {
        return null;
      }
    } else {
      try {
        return await res.text();
      } catch {
        return null;
      }
    }
  }
  // --- Handlers ---
  async function handleLogout() {
    try {
      await fetch(`${API_BASE_URL}/auth/logout`, { method: 'POST', credentials: 'include' });
    } catch (e) { console.error(e); }
    localStorage.clear();
    window.location.href = '/login.html';
  }

  async function handleProfileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('profilePhoto', file);
    
    try {
      const res = await fetchWithAuth('/profile/upload-photo', {
        method: 'POST',
        body: formData
      });
      // If backend returns new URL, use it; otherwise reload profile
      if (res && (res.photoUrl || res.imageUrl)) {
        document.getElementById('profile-preview').src = res.photoUrl || res.imageUrl;
      } else {
        await loadUserProfile();
      }
      showToast('Profile photo updated!', 'success');
    } catch (error) {
      console.error(error);
      showToast('Failed to upload photo', 'error');
    }
  }

  async function handleSaveAssignment() {
    const name = document.getElementById('assignment-name').value;
    const desc = document.getElementById('assignment-desc').value;
    const date = document.getElementById('assignment-due-date').value;
    
    if(!name || !date) return showToast('Please fill required fields', 'error');

    try {
      await fetchWithAuth('/student/tasks', {
        method: 'POST',
        body: JSON.stringify({ title: name, description: desc, due_date: date })
      });
      showToast('Assignment added', 'success');
      closeModal('add-assignment-modal');
      fetchAssignments();
    } catch (e) {
      showToast(e.message || 'Failed to save assignment', 'error');
    }
  }

  async function handleReply(recipientId, recipientName) {
    const content = prompt(`Reply to ${recipientName}:`);
    if (!content) return;

    try {
      await fetchWithAuth('/messages', {
        method: 'POST',
        body: JSON.stringify({ recipientId, content })
      });
      showToast('Reply sent!', 'success');
      fetchMessages(); // Refresh list
    } catch (e) {
      showToast('Failed to send reply', 'error');
    }
  }

  async function handleCompleteAssignment(id, title, description) {
    if(!confirm('Mark this assignment as complete?')) return;

    try {
        await fetchWithAuth(`/student/tasks/${id}/complete`, { method: 'PATCH' });

        const completedTasks = JSON.parse(localStorage.getItem('completedTasks') || '[]');
        completedTasks.push({
            title: title,
            description: description,
            completedAt: new Date().toISOString()
        });
        localStorage.setItem('completedTasks', JSON.stringify(completedTasks));

        showToast('Assignment completed!', 'success');
        fetchAssignments();
    } catch (e) {
        console.error(e);
        showToast('Failed to complete assignment', 'error');
    }
  }

  async function handleSaveBudget() {
    const name = document.getElementById('expense-name').value;
    const amount = document.getElementById('expense-amount').value;
    const category = document.getElementById('expense-category').value;
    
    if(!name || !amount) return showToast('Please fill required fields', 'error');

    try {
      await fetchWithAuth('/student/budget', {
        method: 'POST',
        body: JSON.stringify({ name, amount: Number(amount), category, date: new Date().toISOString() })
      });
      showToast('Expense added', 'success');
      closeModal('budget-modal');
      fetchBudget();
    } catch (e) {
      showToast(e.message || 'Failed to save expense', 'error');
    }
  }

  async function handleSaveGoal() {
    const goal = document.getElementById('goal-input').value;
    const date = document.getElementById('goal-target-date').value;
    const type = document.getElementById('goal-type').value;
    
    if(!goal) return showToast('Please enter a goal', 'error');

    try {
      await fetchWithAuth('/advanced-goals/add', {
        method: 'POST',
        body: JSON.stringify({ text: goal, targetDate: date, type })
      });
      showToast('Goal saved', 'success');
      fetchGoal();
    } catch (e) {
      showToast(e.message || 'Failed to save goal', 'error');
    }
  }

  async function loadUserProfile() {
    try {
      const data = await fetchWithAuth('/profile');
      const user = data.user;
      
      if (user) {
        currentUser = { ...currentUser, ...user };
        const nameEl = document.getElementById('profile-name');
        if (nameEl) nameEl.textContent = `${user.firstname || ''} ${user.lastname || ''}`.trim();

        const schoolEl = document.getElementById('profile-school');
        if (schoolEl && user.school && user.school.schoolName) {
            schoolEl.textContent = `üè´ ${user.school.schoolName}`;
        }

        if (user.profile_picture_url) {
            document.getElementById('profile-preview').src = user.profile_picture_url;
        }
      }
    } catch (e) { console.error('Error loading profile:', e); }
  }

  // --- Fetchers ---
  async function fetchAssignments() {
    const list = document.getElementById('assignments-list');
    const loader = document.getElementById('assignments-loading');
    if (!list) return;

    // Small helpers
    function buildBanner(text, color = 'blue') {
      const div = document.createElement('div');
      const colorMap = {
        blue: 'bg-blue-50 border-blue-200 text-blue-700',
        red: 'bg-red-50 border-red-200 text-red-700',
        yellow: 'bg-yellow-50 border-yellow-200 text-yellow-700'
      };
      div.className = `border ${colorMap[color] || colorMap.blue} p-3 rounded-xl text-center mb-3`;
      div.textContent = text;
      return div;
    }

    function renderItems(container, items) {
      items.forEach(a => {
        const div = document.createElement('div');
        div.className = 'bg-gray-50 p-4 rounded-xl shadow-sm flex justify-between items-center';
        
        const isTask = a.type === 'task';
        const icon = isTask ? 'üìù' : 'üìö';
        const date = a.due_date || a.dueDate;
        const displayDate = date ? new Date(date).toLocaleDateString() : 'No Due Date';

        const infoDiv = document.createElement('div');
        infoDiv.innerHTML = `<h4 class="font-bold">${icon} ${a.title || 'Untitled'}</h4><p class="text-sm text-gray-500">Due: ${displayDate}</p>`;
        
        const btn = document.createElement('button');
        btn.className = 'text-green-500 hover:text-green-700 transition-colors ml-4';
        btn.innerHTML = '<i class="fas fa-check-circle text-2xl"></i>';
        if (isTask) {
          btn.onclick = () => handleCompleteAssignment(a._id, a.title, a.description);
        } else {
          btn.style.opacity = '0.5';
          btn.title = 'Submit via details';
        }
        
        div.appendChild(infoDiv);
        div.appendChild(btn);
        container.appendChild(div);
      });
    }

    const CACHE_KEY = 'ssa_cached_assignments_v1';

    if(loader) loader.style.display = 'block';
    try {
      // Prefer settled to preserve partial results
      const [assignmentsRes, tasksRes] = await Promise.allSettled([
        fetchWithAuth('/student/assignments'),
        fetchWithAuth('/student/tasks')
      ]);

      const assignments = assignmentsRes.status === 'fulfilled' ? (assignmentsRes.value || []) : [];
      const tasks = tasksRes.status === 'fulfilled' ? (tasksRes.value || []) : [];

      const allItems = [
        ...(assignments || []).map(a => ({ ...a, type: 'assignment' })), 
        ...(tasks || []).filter(t => !t.is_completed).map(t => ({ ...t, type: 'task' }))
      ];

      // Update cache
      try { localStorage.setItem(CACHE_KEY, JSON.stringify(allItems)); } catch (_) {}

      list.innerHTML = '';
      if (allItems.length === 0) {
        // Nothing from network; try cache
        const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '[]');
        if (cached.length > 0) {
          list.appendChild(buildBanner('Showing last saved assignments (offline).', 'yellow'));
          renderItems(list, cached);
        } else {
          list.innerHTML = '<p class="italic text-gray-500 text-center">No assignments added yet.</p>';
        }
      } else {
        // If one source failed, hint to user but still render
        if (assignmentsRes.status === 'rejected' || tasksRes.status === 'rejected') {
          list.appendChild(buildBanner('Loaded partially due to a network issue.', 'yellow'));
        }
        renderItems(list, allItems);
      }
    } catch (e) {
      console.error(e);
      list.innerHTML = '';
      const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '[]');
      if (cached.length > 0) {
        list.appendChild(buildBanner('Failed to refresh. Showing last saved assignments.', 'red'));
        renderItems(list, cached);
      } else {
        list.innerHTML = `
          <div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded-xl text-center">
            <p class="mb-2">Failed to load assignments.</p>
            <button id="retry-assignments" class="bg-red-500 text-white px-3 py-1 rounded-full text-sm hover:bg-red-600">Retry</button>
          </div>
        `;
        document.getElementById('retry-assignments')?.addEventListener('click', fetchAssignments);
      }
      try { showToast('Failed to load assignments', 'error'); } catch(_) {}
    } finally {
      if(loader) loader.style.display = 'none';
    }
  }
  async function fetchBudget() {
    const list = document.getElementById('budget-list');
    const loader = document.getElementById('budget-loading');
    if(loader) loader.style.display = 'block';
    try {
      const data = await fetchWithAuth('/student/budget');
      list.innerHTML = '';
      if (!data || data.length === 0) {
        list.innerHTML = '<p class="italic text-gray-500 text-center">No budget entries yet.</p>';
      } else {
        data.forEach(b => {
          const div = document.createElement('div');
          div.className = 'bg-gray-50 p-4 rounded-xl shadow-sm flex justify-between items-center';
          div.innerHTML = `<div><h4 class="font-bold">${b.name}</h4><p class="text-sm text-gray-500">${b.category}</p></div><span class="font-bold text-red-500">-$${b.amount}</span>`;
          list.appendChild(div);
        });
      }
    } catch (e) { console.error(e); }
    finally { if(loader) loader.style.display = 'none'; }
  }

  async function fetchMessages() {
    const list = document.getElementById('messages-list');
    if (!list) return;
    try {
      const data = await fetchWithAuth('/messages');
      list.innerHTML = '';
      if (!data || data.length === 0) {
        list.innerHTML = '<p class="italic text-gray-500 text-center">No messages yet.</p>';
      } else {
        data.forEach(msg => {
          const senderId = msg.sender && (msg.sender._id || msg.sender.id);
          const myId = currentUser && (currentUser._id || currentUser.id);
          const isMe = String(senderId) === String(myId);
          const other = isMe ? msg.recipient : msg.sender;
          const div = document.createElement('li');
          div.className = `p-3 rounded-lg shadow-sm ${isMe ? 'bg-blue-50 ml-8' : 'bg-white mr-8 border border-gray-200'}`;
          
          let actionBtn = '';
          if (!isMe && other && (other._id || other.id)) {
            const otherId = other._id || other.id;
            const otherFirst = other.firstname || '';
            actionBtn = `<button onclick="handleReply('${otherId}', '${otherFirst}')" class="text-xs text-blue-600 hover:underline mt-1 block">Reply</button>`;
          }

          div.innerHTML = `
            <div class="flex justify-between text-xs text-gray-500 mb-1">
              <span class="font-bold">${isMe ? 'You' : ((other?.firstname || '') + ' ' + (other?.lastname || '') + (other?.role ? (' (' + other.role + ')') : ''))}</span>
              <span>${new Date(msg.createdAt).toLocaleString()}</span>
            </div>
            <p class="text-gray-800">${msg.content}</p>
            ${actionBtn}
          `;
          list.appendChild(div);
        });
      }
    } catch (e) { console.error(e); }
  }

  async function fetchGoal() {
    try {
      const goals = await fetchWithAuth('/student/goals');
      const list = document.getElementById('saved-goals-list');
      list.innerHTML = '';
      if(goals && goals.length > 0) {
        goals.forEach(g => {
          const li = document.createElement('li');
          li.textContent = `üéØ ${g.text || g.title}`;
          list.appendChild(li);
        });
      }
    } catch(e) { console.error(e); }
  }

  async function fetchQuizzes() {
    const list = document.getElementById('quizzes-list');
    const loader = document.getElementById('quizzes-loading');
    if(loader) loader.style.display = 'block';
    try {
      const data = await fetchWithAuth('/student/quizzes');
      list.innerHTML = '';
      const quizzes = data.quizzes || [];
      if (!quizzes || quizzes.length === 0) {
        list.innerHTML = '<p class="italic text-gray-500 text-center">No quizzes assigned yet.</p>';
      } else {
        quizzes.forEach(q => {
          const div = document.createElement('div');
          div.className = 'bg-gray-50 p-4 rounded-xl shadow-sm';
          div.innerHTML = `<h4 class="font-bold">${q.title}</h4><a href="/student_quiz.html?quizId=${q._id}" class="text-blue-500 text-sm hover:underline">Take Quiz</a>`;
          list.appendChild(div);
        });
      }
    } catch (e) { console.error(e); }
    finally { if(loader) loader.style.display = 'none'; }
  }

  async function renderChart() {
    const ctx = document.getElementById('analytics-chart');
    if(!ctx) return;
    
    try {
      const res = await fetchWithAuth('/student/analytics');
      const analyticsData = res || { labels: [], data: [] };

      if (analyticsChartInstance) {
        analyticsChartInstance.destroy();
      }

      analyticsChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: analyticsData.labels,
          datasets: [{
            label: 'Activity (Tasks & Submissions)',
            data: analyticsData.data,
            borderColor: '#3b82f6',
            tension: 0.4,
            fill: true,
            backgroundColor: 'rgba(59, 130, 246, 0.1)'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    } catch (e) {
      console.error("Failed to load analytics", e);
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    if (await checkAuthentication()) {
      // Load initial data
      try { await fetchAssignments(); } catch (e) { console.warn('fetchAssignments failed:', e); }
      try { await fetchBudget(); } catch (e) { console.warn('fetchBudget failed:', e); }
      try { await fetchGoal(); } catch (e) { console.warn('fetchGoal failed:', e); }
      try { await fetchQuizzes(); } catch (e) { console.warn('fetchQuizzes failed:', e); }
      try { await fetchMessages(); } catch (e) { console.warn('fetchMessages failed:', e); }
      try { await loadUserProfile(); } catch (e) { console.warn('loadUserProfile failed:', e); }
      try { await renderChart(); } catch (e) { console.warn('renderChart failed:', e); }
      subscribeUserToPush().catch(e => console.warn('Push subscription failed on load:', e));
      let currentLang = localStorage.getItem("lang") || "en";
      const dashboardName = "students";

      const notificationBtn = document.getElementById('notification-btn');
      if (notificationBtn) {
        isUserSubscribedToPush().then(updateNotificationBtn);
        notificationBtn.addEventListener('click', async () => {
          const isSubscribed = await isUserSubscribedToPush();
          if (isSubscribed) {
            await unsubscribeUserFromPush();
          } else {
            await subscribeUserToPush();
          }
        });
      }

      if (typeof translatePage === "function") {
        translatePage(dashboardName, currentLang);
        const langSelect = document.getElementById("lang-select");
        if (langSelect) {
          langSelect.value = currentLang;
          langSelect.addEventListener("change", (e) => {
            currentLang = e.target.value;
            localStorage.setItem("lang", currentLang);
            translatePage(dashboardName, currentLang);
          });
        }
      }

      const DOM = {
        logoutBtn: document.getElementById("logout-btn"),
        menuLogoutBtn: document.getElementById("menu-logout-btn"),
        menuBtn: document.getElementById("menu-btn"),
        closeMenuBtn: document.getElementById("close-menu-btn"),
        menuContent: document.getElementById("menu-content"),
        addAssignmentBtn: document.getElementById("add-assignment-btn"),
        addBudgetBtn: document.getElementById("add-budget-btn"),
        saveAssignmentBtn: document.getElementById("save-assignment-btn"),
        saveBudgetBtn: document.getElementById("save-budget-btn"),
        saveGoalBtn: document.getElementById("save-goal-btn"),
        goalInput: document.getElementById("goal-input"),
        savedGoalsList: document.getElementById("saved-goals-list"),
        assignmentsList: document.getElementById("assignments-list"),
        budgetList: document.getElementById("budget-list"),
        insightsContent: document.getElementById("insights-content"),
        insightsPlaceholder: document.getElementById("insights-placeholder"),
        generateInsightsBtn: document.getElementById("generate-insights-btn"),
        profileForm: document.getElementById("profile-form"),
        profilePhotoInput: document.getElementById("profile-photo"),
        profilePreview: document.getElementById("profile-preview"),
        addAssignmentModal: document.getElementById("add-assignment-modal"),
        budgetModal: document.getElementById("budget-modal"),
        submissionForm: document.getElementById("submission-form"),
        menuModal: document.getElementById("menu-modal"),
        chartCanvas: document.getElementById("analytics-chart"),
      };

      if (DOM.menuBtn) {
        DOM.menuBtn.addEventListener("click", () => {
          DOM.menuModal.classList.add("active");
          DOM.menuContent.style.transform = "translateX(0)";
        });
      }
      if (DOM.closeMenuBtn) {
        DOM.closeMenuBtn.addEventListener("click", () => {
          DOM.menuContent.style.transform = "translateX(-100%)";
          setTimeout(() => DOM.menuModal.classList.remove("active"), 300);
        });
      }
      if (DOM.addAssignmentBtn) DOM.addAssignmentBtn.addEventListener("click", () => openModal("add-assignment-modal"));
      if (DOM.addBudgetBtn) DOM.addBudgetBtn.addEventListener("click", () => openModal("budget-modal"));
      if (DOM.saveAssignmentBtn) DOM.saveAssignmentBtn.addEventListener("click", handleSaveAssignment);
      if (DOM.saveBudgetBtn) DOM.saveBudgetBtn.addEventListener("click", handleSaveBudget);
      if (DOM.saveGoalBtn) DOM.saveGoalBtn.addEventListener("click", handleSaveGoal);
      if (DOM.generateInsightsBtn) DOM.generateInsightsBtn.addEventListener("click", async () => {
        try {
          const res = await fetchWithAuth("/advanced-goals/advice");
          const advice = res && res.advice ? res.advice : null;
          DOM.insightsPlaceholder.classList.add("hidden");
          DOM.insightsContent.classList.remove("hidden");
          if (advice) DOM.insightsContent.innerText = `${advice.studyAdvice || ''}\n\n${advice.spendingAdvice || ''}`.trim();
          else DOM.insightsContent.innerText = "No advice received.";
        } catch (e) {
          showToast(e.message, "error");
        }
      });
      if (DOM.logoutBtn) DOM.logoutBtn.addEventListener("click", handleLogout);
      if (DOM.menuLogoutBtn) DOM.menuLogoutBtn.addEventListener("click", handleLogout);
      if (DOM.profilePhotoInput) DOM.profilePhotoInput.addEventListener("change", handleProfileUpload);

      document.getElementById("profile-photo")?.addEventListener("change", function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            document.getElementById("profile-preview").src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      // --- Pull-to-Refresh Logic ---
      let touchStartY = 0;
      let currentY = 0;
      const ptrThreshold = 150;
      const ptrElement = document.createElement('div');
      ptrElement.id = 'ptr-indicator';
      ptrElement.className = 'fixed top-0 left-0 w-full flex justify-center items-center pointer-events-none transition-transform duration-200 z-50';
      ptrElement.style.height = '60px';
      ptrElement.style.transform = 'translateY(-60px)';
      ptrElement.innerHTML = '<div class="bg-white p-2 rounded-full shadow-md"><i class="fas fa-arrow-down text-blue-500"></i></div>';
      document.body.appendChild(ptrElement);

      window.addEventListener('touchstart', e => {
          if (window.scrollY === 0) {
              touchStartY = e.touches[0].clientY;
          }
      }, { passive: true });

      window.addEventListener('touchmove', e => {
          const y = e.touches[0].clientY;
          if (window.scrollY === 0 && y > touchStartY) {
              currentY = y - touchStartY;
              if (currentY > ptrThreshold) currentY = ptrThreshold; // Cap the drag
              ptrElement.style.transform = `translateY(${currentY - 60}px)`;
              if (currentY > 60) {
                   ptrElement.innerHTML = '<div class="bg-white p-2 rounded-full shadow-md"><i class="fas fa-arrow-up text-blue-500"></i></div>';
              }
          }
      }, { passive: true });

      window.addEventListener('touchend', async e => {
          if (window.scrollY === 0 && currentY > 60) {
              ptrElement.innerHTML = '<div class="bg-white p-2 rounded-full shadow-md"><i class="fas fa-spinner fa-spin text-blue-500"></i></div>';
              ptrElement.style.transform = 'translateY(10px)'; // Hold position
              
              // Refresh all data
              await Promise.all([
                  fetchAssignments(),
                  fetchBudget(),
                  fetchGoal(),
                  fetchQuizzes(),
                  fetchMessages(),
                  loadUserProfile(),
                  renderChart()
              ]);
              
              setTimeout(() => {
                  ptrElement.style.transform = 'translateY(-60px)';
                  ptrElement.innerHTML = '<div class="bg-white p-2 rounded-full shadow-md"><i class="fas fa-arrow-down text-blue-500"></i></div>';
              }, 500);
          } else {
              ptrElement.style.transform = 'translateY(-60px)';
          }
          touchStartY = 0;
          currentY = 0;
      });
    }
  });
</script>
</body>
</html>
