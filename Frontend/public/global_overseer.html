<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Overseer Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLp3wz/zQv2gC6P6Zg6xQ8zI+8U9l0s6fGzUfR6v6V6n6V6x6V6p6G6x6V6v6p6g6w6a6p6p6n6w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Custom styles to mimic React Native's StyleSheet.create */
        body {
            font-family: 'Inter', sans-serif;
        }

        .container {
            padding: 20px;
            background-color: #f5f7fa;
            min-height: 100vh;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f7fa;
        }
        
        /* Mimic the behavior of touchable elements */
        .action-button:active, .logout-button:active, .header-icon:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <!-- Main App Container -->
    <div id="app-container" class="container">
        <!-- The UI will be rendered here by the JavaScript -->
    </div>

    <!-- Custom Alert/Modal Box -->
    <div id="alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
            <h3 id="alert-title" class="font-bold text-lg mb-2"></h3>
            <p id="alert-message" class="text-sm text-gray-700 mb-4"></p>
            <div class="flex justify-end space-x-2">
                <button id="alert-cancel" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancel</button>
                <button id="alert-confirm" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">OK</button>
            </div>
        </div>
    </div>
    
    <script>
        // Mocking React Native/Expo dependencies for the browser environment
        const API_BASE = 'http://172.20.10.10:4000/api'; // Make sure this is your correct backend URL

        // --- Mock Router & Navigation ---
        const router = {
            replace: (path) => window.location.href = path,
            push: (path) => window.location.href = path,
        };

        // --- Mock Auth Context ---
        const mockUser = { username: 'john.doe', occupation: 'global_overseer', schoolName: 'Global HQ' };
        let userState = localStorage.getItem('mockUser') ? JSON.parse(localStorage.getItem('mockUser')) : null;
        const useAuth = () => {
            const [user, setUser] = useState(userState);
            const [isLoading, setIsLoading] = useState(false);

            const signOut = () => {
                setIsLoading(true);
                return new Promise(resolve => {
                    setTimeout(() => {
                        localStorage.removeItem('mockUser');
                        userState = null;
                        setUser(null);
                        setIsLoading(false);
                        resolve();
                    }, 500); // Simulate network delay
                });
            };

            return { user, isLoading, signOut };
        };

        // --- Mock Alert Dialog ---
        const showCustomAlert = (title, message, options) => {
            const modal = document.getElementById('alert-modal');
            const titleEl = document.getElementById('alert-title');
            const messageEl = document.getElementById('alert-message');
            const confirmBtn = document.getElementById('alert-confirm');
            const cancelBtn = document.getElementById('alert-cancel');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // Set up button actions based on options
            confirmBtn.onclick = () => {
                if (options && options[1] && options[1].onPress) {
                    options[1].onPress();
                }
                modal.classList.add('hidden');
            };

            if (options && options[0] && options[0].text === 'Cancel') {
                cancelBtn.textContent = options[0].text;
                cancelBtn.onclick = () => modal.classList.add('hidden');
                cancelBtn.classList.remove('hidden');
            } else {
                cancelBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
        };

        // --- State Management (using a simple object for reactivity) ---
        const state = {
            dashboardData: null,
            allFiles: null,
            isDataLoading: true,
            isFilesLoading: false,
            auth: {
                user: null,
                isLoading: false,
                signOut: () => {}
            }
        };

        function useState(initialValue) {
            let value = initialValue;
            const subscribers = [];
            const notify = () => subscribers.forEach(callback => callback());
            const setValue = (newValue) => {
                if (typeof newValue === 'function') {
                    value = newValue(value);
                } else {
                    value = newValue;
                }
                notify();
            };
            const subscribe = (callback) => subscribers.push(callback);
            return [
                { get value() { return value; }, subscribe },
                setValue
            ];
        }

        // --- Core Application Logic ---
        const fetchDashboardData = async () => {
            state.isDataLoading = true;
            render();
            try {
                // REAL API CALL
                const res = await fetch(`${API_BASE}/overseer/dashboard-overview`);
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Failed to fetch dashboard data');
                }
                const data = await res.json();
                // Mocking total numbers for the overview card
                state.dashboardData = {
                    totalRegions: data.managedRegions.length,
                    totalSchools: data.managedRegions.reduce((sum, region) => sum + (region.totalSchools || 0), 0),
                    totalAdmins: data.managedRegions.reduce((sum, region) => sum + (region.totalAdmins || 0), 0),
                    totalUsers: 99999, // Placeholder as this is not in the API response
                    totalOverseers: 99, // Placeholder
                    managedRegions: data.managedRegions,
                };
            } catch (error) {
                console.error('Failed to fetch global overseer dashboard data:', error);
                showCustomAlert('Error', 'Failed to load dashboard data.');
            } finally {
                state.isDataLoading = false;
                render();
            }
        };

        // ðŸ†• New function to fetch all files
        const fetchAndRenderAllFiles = async () => {
            state.isFilesLoading = true;
            render();
            try {
                const res = await fetch(`${API_BASE}/admin/all-files`);
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Failed to fetch files');
                }
                const data = await res.json();
                state.allFiles = data.files;
            } catch (error) {
                console.error('Failed to fetch all files:', error);
                showCustomAlert('Error', 'Failed to load the list of files.');
            } finally {
                state.isFilesLoading = false;
                render();
            }
        };

        const handleLogout = () => {
            showCustomAlert(
                'Logout',
                'Are you sure you want to log out?',
                [
                    { text: 'Cancel', style: 'cancel' },
                    {
                        text: 'Logout',
                        onPress: async () => {
                            try {
                                await state.auth.signOut();
                                router.replace('/public/login.html');
                            } catch (error) {
                                console.error('Logout failed:', error);
                                showCustomAlert('Logout Error', 'Failed to log out. Please try again.');
                            }
                        },
                    },
                ]
            );
        };

        // --- Render function to update the UI based on state ---
        const render = () => {
            const container = document.getElementById('app-container');
            container.innerHTML = ''; // Clear previous content

            if (state.auth.isLoading || state.isDataLoading) {
                container.innerHTML = `
                    <div class="loading-container">
                        <i class="fas fa-spinner fa-spin text-blue-500 text-5xl"></i>
                        <p class="mt-4 text-base text-gray-600">Loading Global Overseer Dashboard...</p>
                    </div>
                `;
                return;
            }

            if (!state.auth.user || state.auth.user.occupation !== 'global_overseer') {
                container.innerHTML = `
                    <div class="loading-container text-center p-4">
                        <h2 class="text-xl font-bold text-red-600 mb-2">Access Denied</h2>
                        <p class="text-gray-700">You must be logged in as a Global Overseer to access this page. Redirecting to login...</p>
                    </div>
                `;
                setTimeout(() => router.replace('/public/login.html'), 3000);
                return;
            }

            // Main Dashboard UI
            const dashboardHtml = `
                <div class="flex flex-row justify-between items-center mb-5 pb-2 border-b border-gray-200">
                    <div class="flex items-center space-x-4">
                        <button onclick="router.push('/(app)/profile')" class="p-2 text-gray-700 hover:text-gray-900 transition duration-300">
                            <i class="fas fa-user-circle text-2xl"></i>
                        </button>
                        <button onclick="router.push('/(app)/settings')" class="p-2 text-gray-700 hover:text-gray-900 transition duration-300">
                            <i class="fas fa-cog text-2xl"></i>
                        </button>
                    </div>
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-800 flex-1 text-center">Global Overseer Dashboard</h1>
                    <button id="logout-button" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-300">
                        Logout
                    </button>
                </div>
                
                <div class="bg-white rounded-xl shadow-md p-4 mb-5">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 border-b border-gray-200 pb-2 mb-2">Overview</h2>
                    <div class="p-2 bg-gray-50 rounded-lg">
                        <p class="text-base text-gray-700 mb-1">Total Regions: ${state.dashboardData?.totalRegions || 'N/A'}</p>
                        <p class="text-base text-gray-700 mb-1">Total Schools: ${state.dashboardData?.totalSchools || 'N/A'}</p>
                        <p class="text-base text-gray-700 mb-1">Total Overseers: ${state.dashboardData?.totalOverseers || 'N/A'}</p>
                        <p class="text-base text-gray-700 mb-1">Total Admins: ${state.dashboardData?.totalAdmins || 'N/A'}</p>
                        <p class="text-base text-gray-700">Total Users: ${state.dashboardData?.totalUsers || 'N/A'}</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-4 mb-5">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 border-b border-gray-200 pb-2 mb-2">Management</h2>
                    
                    <button onclick="router.push('/(app)/global-overseer')" class="action-button flex items-center justify-center bg-blue-600 text-white font-bold py-3 px-4 rounded-lg w-full mb-3 shadow-md hover:bg-blue-700 transition duration-300">
                        <i class="fas fa-users-cog mr-2"></i>
                        <span>Manage Overseers</span>
                    </button>

                    <button onclick="showCustomAlert('Navigate', 'Implement management for all school admins here.')" class="action-button flex items-center justify-center bg-blue-600 text-white font-bold py-3 px-4 rounded-lg w-full mb-3 shadow-md hover:bg-blue-700 transition duration-300">
                        <i class="fas fa-school mr-2"></i>
                        <span>Manage All School Admins</span>
                    </button>
                    
                    <button onclick="showCustomAlert('Navigate', 'Implement school and region creation here.')" class="action-button flex items-center justify-center bg-blue-600 text-white font-bold py-3 px-4 rounded-lg w-full mb-3 shadow-md hover:bg-blue-700 transition duration-300">
                        <i class="fas fa-globe mr-2"></i>
                        <span>Create New School / Region</span>
                    </button>

                    <!-- ðŸ†• New button to fetch all files -->
                    <button id="fetch-files-button" class="action-button flex items-center justify-center bg-purple-600 text-white font-bold py-3 px-4 rounded-lg w-full mb-3 shadow-md hover:bg-purple-700 transition duration-300">
                        <i class="fas fa-file-alt mr-2"></i>
                        <span>View All Uploaded Files</span>
                    </button>
                </div>

                <!-- ðŸ†• New section for displaying all files -->
                <div class="bg-white rounded-xl shadow-md p-4 mb-5" id="files-section" style="display:none;">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-800 border-b border-gray-200 pb-2 mb-2">All Uploaded Files</h2>
                    <div id="file-list-container" class="overflow-x-auto">
                        <!-- File list table will be rendered here -->
                    </div>
                </div>
            `;
            container.innerHTML = dashboardHtml;
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('fetch-files-button').addEventListener('click', fetchAndRenderAllFiles);
            
            // Render the files table if the data is available
            if (state.allFiles) {
                document.getElementById('files-section').style.display = 'block';
                const fileListContainer = document.getElementById('file-list-container');
                if (state.isFilesLoading) {
                    fileListContainer.innerHTML = '<p class="text-center text-gray-500">Loading file list...</p>';
                } else if (state.allFiles.length === 0) {
                    fileListContainer.innerHTML = '<p class="text-center text-gray-500">No files found.</p>';
                } else {
                    const tableHtml = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${state.allFiles.map(file => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${file.filename}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${file.type}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <a href="${API_BASE}/admin/view-file/${file.type}/${file.filename}" target="_blank" class="text-blue-600 hover:text-blue-900">
                                                View <i class="fas fa-external-link-alt ml-1"></i>
                                            </a>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    fileListContainer.innerHTML = tableHtml;
                }
            }
        };

        // --- Initial setup on page load ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (!localStorage.getItem('mockUser')) {
                localStorage.setItem('mockUser', JSON.stringify(mockUser));
            }
            state.auth = useAuth();
            
            if (!state.auth.user) {
                showCustomAlert('Access Denied', 'You must be logged in as a Global Overseer to access this page.');
                router.replace('/public/login');
                return;
            }

            await fetchDashboardData();
        });
    </script>

</body>
</html>
