<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Global Overseer Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .modal-content {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: #4f46e5;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      table th,
      table td {
        white-space: nowrap;
      }
      .sidebar {
        transition: transform 0.3s ease-in-out;
      }
    </style>
    <script src="api-config.js"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-white w-64 min-h-screen p-4 shadow-lg fixed lg:relative transform -translate-x-full lg:translate-x-0 transition-transform duration-200 ease-in-out z-30">
        <div class="text-center mb-10">
            <h1 class="text-2xl font-bold text-blue-600">Overseer</h1>
        </div>
        <nav class="space-y-2">
            <button onclick="changeTab('dashboard')" class="w-full flex items-center space-x-2 py-2 px-4 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <span>Dashboard</span>
            </button>
            <button onclick="changeTab('users')" class="w-full flex items-center space-x-2 py-2 px-4 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <span>User Management</span>
            </button>
            <button onclick="changeTab('files')" class="w-full flex items-center space-x-2 py-2 px-4 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                <span>File Management</span>
            </button>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center">
            <button id="menu-toggle" class="lg:hidden text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
            <h1 id="header-title" class="text-xl font-semibold text-gray-800">Dashboard</h1>
            <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition shadow-md text-sm">
                Logout
            </button>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-6 overflow-y-auto">
            <!-- Content will be injected here -->
        </main>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden"></div>

    <div
      id="assign-region-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden"
    >
      <div
        class="bg-white rounded-2xl p-8 max-w-sm w-full relative modal-content"
      >
        <button
          id="assign-region-close"
          class="absolute top-4 right-4 text-gray-500 hover:text-gray-800"
        >
          &times;
        </button>
        <h2 class="text-2xl font-bold mb-4">Assign Region</h2>
        <input
          type="email"
          id="overseer-email"
          placeholder="Overseer Email"
          class="mb-4 w-full px-4 py-2 border rounded-lg"
        />
        <input
          type="text"
          id="region-name"
          placeholder="Region Name"
          class="mb-4 w-full px-4 py-2 border rounded-lg"
        />
        <div class="flex justify-end gap-2">
          <button
            id="assign-region-cancel"
            class="px-4 py-2 border rounded-full hover:bg-gray-100"
          >
            Cancel
          </button>
          <button
            id="assign-region-confirm"
            class="px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700"
          >
            Assign
          </button>
        </div>
      </div>
    </div>

    <!-- Edit School Modal -->
    <div id="edit-school-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
      <div class="bg-white rounded-2xl p-8 max-w-sm w-full relative modal-content">
        <button id="edit-school-close" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        <h2 class="text-2xl font-bold mb-4">Edit School</h2>
        <input type="hidden" id="edit-school-id" />
        <input type="text" id="edit-school-name" placeholder="School Name" class="mb-4 w-full px-4 py-2 border rounded-lg" />
        <select id="edit-school-country" class="mb-4 w-full px-4 py-2 border rounded-lg bg-white">
            <option value="">Select Country</option>
            <!-- Options will be populated by JS -->
        </select>
        <input type="number" id="edit-school-tier" placeholder="Pricing Tier (e.g., 1, 2, 3)" min="1" class="mb-4 w-full px-4 py-2 border rounded-lg" />
        <div class="flex justify-end gap-2">
          <button id="edit-school-cancel" class="px-4 py-2 border rounded-full hover:bg-gray-100">Cancel</button>
          <button id="edit-school-confirm" class="px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700">Save Changes</button>
        </div>
      </div>
    </div>

    <div
      id="request-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden"
    >
      <div
        class="bg-white rounded-2xl p-8 max-w-lg w-full relative modal-content"
      >
        <button
          id="request-close"
          class="absolute top-4 right-4 text-gray-500 hover:text-gray-800"
        >
          &times;
        </button>
        <h2 class="text-2xl font-bold mb-4">Make a New Request</h2>
        <textarea
          id="request-text"
          rows="5"
          placeholder="Your Request"
          class="w-full mb-4 px-4 py-2 border rounded-lg"
        ></textarea>
        <div class="flex justify-end gap-2">
          <button
            id="request-cancel"
            class="px-4 py-2 border rounded-full hover:bg-gray-100"
          >
            Cancel
          </button>
          <button
            id="request-send"
            class="px-4 py-2 bg-purple-600 text-white rounded-full hover:bg-purple-700"
          >
            Send Request
          </button>
        </div>
      </div>
    </div>

    <div
      id="alert-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden"
    >
      <div
        class="bg-white rounded-2xl p-8 max-w-sm w-full text-center modal-content"
      >
        <h2 id="alert-title" class="text-xl font-bold mb-2"></h2>
        <p id="alert-message" class="text-gray-700 mb-4"></p>
        <button
          id="alert-ok"
          class="px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700"
        >
          OK
        </button>
      </div>
    </div>

    <div
      id="confirm-modal"
      class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden"
    >
      <div
        class="bg-white rounded-2xl p-8 max-w-sm w-full relative modal-content"
      >
        <h2 id="confirm-title" class="text-xl font-bold mb-2"></h2>
        <p id="confirm-message" class="text-gray-700 mb-4"></p>
        <div class="flex justify-end gap-2">
          <button
            id="confirm-cancel"
            class="px-4 py-2 border rounded-full hover:bg-gray-100"
          >
            Cancel
          </button>
          <button
            id="confirm-confirm"
            class="px-4 py-2 bg-red-600 text-white rounded-full hover:bg-red-700"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = window.API_BASE_URL;
      let filesData = [];

      const dashboardCards = document.getElementById("dashboard-cards");
      const filesTableBody = document.getElementById("files-table-body");
      const usersTableBody = document.getElementById("users-table-body");
      const logoutBtn = document.getElementById("logout-btn");
      const userSearch = document.getElementById("user-search");
      const fileSearch = document.getElementById("file-search");
      const fileFilter = document.getElementById("file-filter");

      const assignRegionModal = document.getElementById("assign-region-modal");
      const openAssignRegionBtn = document.getElementById("open-assign-region");
      const assignRegionClose = document.getElementById("assign-region-close");
      const assignRegionCancel = document.getElementById(
        "assign-region-cancel"
      );
      const assignRegionConfirm = document.getElementById(
        "assign-region-confirm"
      );
      const overseerEmailInput = document.getElementById("overseer-email");
      const regionNameInput = document.getElementById("region-name");

      const alertModal = document.getElementById("alert-modal");
      const alertTitle = document.getElementById("alert-title");
      const alertMessage = document.getElementById("alert-message");
      const alertOk = document.getElementById("alert-ok");

      const requestModal = document.getElementById("request-modal");
      const openRequestBtn = document.getElementById("open-request-btn");
      const requestClose = document.getElementById("request-close");
      const requestCancel = document.getElementById("request-cancel");
      const requestSendBtn = document.getElementById("request-send");
      const requestTextArea = document.getElementById("request-text");

      const confirmModal = document.getElementById("confirm-modal");
      const confirmTitle = document.getElementById("confirm-title");
      const confirmMessage = document.getElementById("confirm-message");
      const confirmConfirmBtn = document.getElementById("confirm-confirm"); // This will be the action button
      const confirmCancelBtn = document.getElementById("confirm-cancel");

      const showAlert = (title, message) => {
        alertTitle.textContent = title;
        alertMessage.textContent = message;
        alertModal.classList.remove("hidden");
      }

      function showConfirm(title, message, onConfirm) {
        confirmTitle.textContent = title;
        confirmMessage.innerHTML = message; // Use innerHTML to allow for styled messages
        confirmModal.classList.remove("hidden");

        // Clone and replace to remove old event listeners
        const newConfirmBtn = confirmConfirmBtn.cloneNode(true);
        confirmConfirmBtn.parentNode.replaceChild(newConfirmBtn, confirmConfirmBtn);
        
        newConfirmBtn.onclick = () => {
          onConfirm();
          confirmModal.classList.add("hidden");
        };

        confirmCancelBtn.onclick = () => {
          confirmModal.classList.add("hidden");
        };
      }

      const showLoading = (container) => {
        container.innerHTML = `<div class="flex justify-center items-center p-10">
                                <div class="spinner"></div>
                                <p class="ml-4 text-gray-600">Loading...</p>
                               </div>`;
      };

      function showError(msg) {
        dashboardCards.innerHTML = `<div class="text-red-600 font-bold">${msg}</div>`;
      }

      function showToast(message, type = "info") {
        const container =
          document.getElementById("toast-container") ||
          (() => {
            const el = document.createElement("div");
            el.id = "toast-container";
            el.className = "fixed top-4 right-4 z-[1000] space-y-2";
            document.body.appendChild(el);
            return el;
          })();
        const colors = { success: "bg-green-600", error: "bg-red-600", info: "bg-blue-600", warning: "bg-yellow-500 text-gray-900" };
        const toast = document.createElement("div");
        toast.className = `px-4 py-2 rounded text-white shadow ${colors[type] || colors.info}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3500);
      }


      async function fetchWithAuth(endpoint, options = {}) {
        const res = await fetch(`${API_BASE_URL}${endpoint}`, {
          ...options,
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
            ...(options.headers || {}),
          },
        });

        if (res.status === 401) {
          window.location.href = "/login.html";
          return;
        }

        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          throw new Error(errData.message || "Request failed");
        }

        return res.json();
      }

  async function checkAuth() {
    try {
      await fetchWithAuth("/auth/check");
      return true;
    } catch {
      showToast("Please login first.", "error");
      setTimeout(() => (window.location.href = "/login.html"), 1500);
      return false;
    }
  }

      let activeTab = 'dashboard';
      let usersData = [];
      let schoolsData = [];

      const changeTab = (tab) => {
        activeTab = tab;
        document.getElementById('header-title').textContent = tab.charAt(0).toUpperCase() + tab.slice(1);
        renderContent();
      };
      window.changeTab = changeTab; // Make it globally accessible for onclick

      const renderContent = () => {
        const mainContent = document.getElementById('main-content');
        mainContent.innerHTML = ''; // Clear previous content

        if (activeTab === 'dashboard') {
            mainContent.innerHTML = `
                <section class="mb-10">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Regional Overview</h2>
                    <div id="dashboard-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </section>
            `;
            loadDashboard();
        } else if (activeTab === 'users') {
            mainContent.innerHTML = `
                <section class="mb-10">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h2 class="text-2xl font-semibold text-gray-700">User Management</h2>
                        <div class="flex gap-2">
                            <button id="open-assign-region" class="px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition shadow-md">Assign Region</button>
                            <button id="open-request-btn" class="px-4 py-2 bg-purple-600 text-white rounded-full hover:bg-purple-700 transition shadow-md">Make Request</button>
                        </div>
                    </div>
                    <input type="text" id="user-search" placeholder="Search users by email" class="w-full mb-4 px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition"/>
                    <div class="overflow-x-auto bg-white rounded-xl shadow-inner p-4">
                        <table class="min-w-full bg-white rounded-xl">
                            <thead><tr class="bg-gray-200 text-left text-gray-600 uppercase text-sm"><th class="py-3 px-6">Email</th><th class="py-3 px-6">Role</th><th class="py-3 px-6">School/Region</th><th class="py-3 px-6">Actions</th></tr></thead>
                            <tbody id="users-table-body" class="text-gray-600 text-sm font-light"></tbody>
                        </table>
                    </div>
                </section>
            `;
            loadUsers();
            document.getElementById('user-search').addEventListener('input', (e) => loadUsers(e.target.value));
            document.getElementById('open-assign-region').addEventListener('click', () => assignRegionModal.classList.remove('hidden'));
            document.getElementById('open-request-btn').addEventListener('click', () => requestModal.classList.remove('hidden'));
        } else if (activeTab === 'files') {
            mainContent.innerHTML = `
                <section>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">File Management</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="file-search" placeholder="Search files by name" class="flex-1 px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition"/>
                        <select id="file-filter" class="px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="">All Types</option><option value="Policy">Policy</option><option value="Form">Form</option><option value="Guide">Guide</option><option value="Report">Report</option><option value="Syllabus">Syllabus</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-xl shadow-inner p-4">
                        <table class="min-w-full bg-white rounded-xl">
                            <thead><tr class="bg-gray-200 text-left text-gray-600 uppercase text-sm"><th class="py-3 px-6">Filename</th><th class="py-3 px-6">Type</th><th class="py-3 px-6">Uploaded By</th><th class="py-3 px-6">Uploaded At</th></tr></thead>
                            <tbody id="files-table-body" class="text-gray-600 text-sm font-light"></tbody>
                        </table>
                    </div>
                </section>
            `;
            loadFiles();
            document.getElementById('file-search').addEventListener('input', renderFiles);
            document.getElementById('file-filter').addEventListener('change', renderFiles);
        } else if (activeTab === 'schools') {
            mainContent.innerHTML = `
                <section>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-700">School Management</h2>
                        <button id="open-create-school-alt" class="px-4 py-2 bg-green-600 text-white rounded-full hover:bg-green-700 transition shadow-md">Create School</button>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-xl shadow-inner p-4">
                        <table class="min-w-full bg-white rounded-xl">
                            <thead><tr class="bg-gray-200 text-left text-gray-600 uppercase text-sm"><th class="py-3 px-6">School Name</th><th class="py-3 px-6">Country</th><th class="py-3 px-6">Tier</th><th class="py-3 px-6">Actions</th></tr></thead>
                            <tbody id="schools-table-body" class="text-gray-600 text-sm font-light"></tbody>
                        </table>
                    </div>
                </section>
            `;
            loadSchools();
            document.getElementById('open-create-school-alt').addEventListener('click', () => createSchoolModal.classList.remove('hidden'));
        }
      };

      const loadDashboard = async () => {
        const cardsContainer = document.getElementById("dashboard-cards");
        if (!cardsContainer) return;
        showLoading(cardsContainer);
        try {
          const data = await fetchWithAuth("/global-overseer/dashboard");
          renderDashboard(data);
        } catch (err) {
          console.error(err);
          cardsContainer.innerHTML = `<div class="col-span-full text-red-600 font-bold">${err.message || "Failed to load dashboard."}</div>`;
        }
      }
      function renderDashboard(data) {
        const dashboardCards = document.getElementById("dashboard-cards");
        if (!dashboardCards) return;
        dashboardCards.innerHTML = "";
        (data.managedRegions || []).forEach((region) => {
          const card = document.createElement("div");
          card.className = "bg-white p-6 rounded-2xl shadow-md";
          card.innerHTML = `<h2 class="text-xl font-semibold mb-2 text-gray-800">${region.name}</h2>
                        <p class="text-gray-600">Schools: ${region.totalSchools}</p>
                        <p class="text-gray-600">Admins: ${region.totalAdmins}</p>
                        <p class="text-gray-600">Teachers: ${region.totalTeachers}</p>
                        <p class="text-gray-600">Students: ${region.totalStudents}</p>`;
          dashboardCards.appendChild(card);
        });
      }

      async function loadUsers(query = "") {
        usersTableBody.innerHTML =
          '<tr><td colspan="4" class="text-center py-4">Loading...</td></tr>';
        try {
          const data = await fetchWithAuth(
            `/global-overseer/users?search=${encodeURIComponent(query)}`
          );
          usersData = data.users || [];
          renderUsers();
        } catch (err) {
          console.error(err);
          usersTableBody.innerHTML =
            '<tr><td colspan="4" class="text-center py-4 text-red-600">Could not fetch users.</td></tr>';
        }
      }
      function renderUsers(users) {
        const usersToRender = users || usersData;
        usersTableBody.innerHTML = "";
        if (usersToRender.length === 0) {
          usersTableBody.innerHTML =
            '<tr><td colspan="4" class="text-center py-4 text-gray-500">No users found.</td></tr>';
          return;
        }
        usersToRender.forEach((user) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td class="border-t px-6 py-4 text-gray-700">${
            user.email
          }</td>
                      <td class="border-t px-6 py-4 text-gray-700">${
                        user.role
                      }</td>
                      <td class="border-t px-6 py-4 text-gray-700">${
                        user.schoolName || user.teacherSchool || "-"
                      }</td>
                      <td class="border-t px-6 py-4 space-x-2">
                        <button class="bg-green-600 text-white px-3 py-1 rounded-full text-xs hover:bg-green-700 transition shadow-sm" onclick="promoteUser('${
                          user.email, 'teacher'
                        }')">Promote to Teacher</button>
                        <button class="bg-yellow-500 text-white px-3 py-1 rounded-full text-xs hover:bg-yellow-600 transition shadow-sm" onclick="promoteUser('${
                          user.email, 'student'
                        }')">Demote to Student</button>
                        <button class="bg-red-600 text-white px-3 py-1 rounded-full text-xs hover:bg-red-700 transition shadow-sm" onclick="removeUser('${
                          user.email
                        }')">Remove</button>
                      </td>`;
          usersTableBody.appendChild(tr);
        });
      }

      async function loadFiles() {
        filesTableBody.innerHTML =
          '<tr><td colspan="4" class="text-center py-4">Loading files...</td></tr>';
        try {
          const data = await fetchWithAuth("/global-overseer/all-files");
          filesData = data.files || [];
          renderFiles();
        } catch (err) {
          console.error(err);
          filesTableBody.innerHTML =
            '<tr><td colspan="4" class="text-center py-4 text-red-600">Could not fetch files.</td></tr>';
        }
      }

      const renderSchoolManagement = () => {
        const schoolsTableBody = document.getElementById('schools-table-body');
        if (!schoolsTableBody) return;

        if (schoolsData.length === 0) {
            schoolsTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No schools found.</td></tr>';
        } else {
            schoolsTableBody.innerHTML = schoolsData.map(school => `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="py-3 px-6">${school.schoolName}</td>
                    <td class="py-3 px-6">${school.schoolCountry}</td>
                    <td class="py-3 px-6">${school.tier}</td>
                    <td class="py-3 px-6">
                        <button class="text-blue-600 hover:underline" onclick="openEditSchoolModal('${school._id}')">Edit</button>
                    </td>
                </tr>
            `).join('');
        }
      };

      const loadSchools = async () => {
        const mainContent = document.getElementById('main-content');
        showLoading(mainContent);
        try {
            const data = await fetchWithAuth("/admin/schools");
            schoolsData = data || [];
            renderSchoolManagement();
        } catch (err) {
            console.error("Failed to load schools", err);
            mainContent.innerHTML = `<div class="text-red-500">${err.message || 'Failed to load schools.'}</div>`;
        }
      };

      window.promoteUser = (email, role) => {
        showConfirm(`Confirm ${role === 'teacher' ? 'Promotion' : 'Demotion'}`, `Are you sure you want to set <strong>${email}</strong>'s role to <strong>${role}</strong>?`, async () => {
          try {
            const res = await fetchWithAuth(`/admin/promote`, {
              method: "POST",
              body: JSON.stringify({ email, role }),
            });
            showToast(res.message || `User role set to ${role}`, "success");
            loadUsers(userSearch.value);
          } catch (err) {
            console.error(err);
            showToast(err.message || "Action failed", "error");
          }
        });
      }

      window.removeUser = (email) => {
        showConfirm(`Confirm Removal`, `Are you sure you want to remove <strong>${email}</strong>? This action cannot be undone.`, async () => {
        try {
          const res = await fetchWithAuth(`/admin/remove-user`, {
            method: "POST",
            body: JSON.stringify({ email }),
          });
          showToast(res.message || "User removed", "success");
          loadUsers(userSearch.value);
        } catch (err) {
          console.error(err);
          showToast(err.message || "Remove failed", "error");
        }
        });
      }
      function renderFiles() {
        const search = fileSearch.value.toLowerCase(),
          filter = fileFilter.value;
        let filtered = filesData;
        if (search)
          filtered = filtered.filter(
            (f) =>
              f.name.toLowerCase().includes(search) ||
              (f.uploader && f.uploader.toLowerCase().includes(search))
          );
        if (filter && filter !== "all")
          filtered = filtered.filter((f) => f.type === filter);
        filesTableBody.innerHTML = "";
        if (filtered.length === 0) {
          filesTableBody.innerHTML =
            '<tr><td colspan="4" class="text-center py-4 text-gray-500">No files found.</td></tr>';
          return;
        }
        filtered.forEach((f) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td class="border-t px-6 py-4 text-gray-700">${
            f.name
          }</td>
                      <td class="border-t px-6 py-4 text-gray-700">${
                        f.type
                      }</td>
                      <td class="border-t px-6 py-4 text-gray-700">${
                        f.uploader || "-"
                      }</td>
                      <td class="border-t px-6 py-4 text-gray-700">${new Date(
                        f.uploadedAt
                      ).toLocaleString()}</td>`;
          filesTableBody.appendChild(tr);
        });
      }

      logoutBtn.addEventListener("click", async () => {
        try {
          await fetch(`${API_BASE_URL}/users/logout`, {
            method: "POST",
            credentials: "include",
          });
          window.location.href = "/login.html";
        } catch (err) {
          console.error(err);
        }
      });
      openAssignRegionBtn.addEventListener("click", () =>
        assignRegionModal.classList.remove("hidden")
      );
      assignRegionClose.addEventListener("click", () =>
        assignRegionModal.classList.add("hidden")
      );
      assignRegionCancel.addEventListener("click", () =>
        assignRegionModal.classList.add("hidden")
      );
      alertOk.addEventListener("click", () =>
        alertModal.classList.add("hidden")
      );
      openRequestBtn.addEventListener("click", () =>
        requestModal.classList.remove("hidden")
      );
      requestClose.addEventListener("click", () =>
        requestModal.classList.add("hidden")
      );
      requestCancel.addEventListener("click", () =>
        requestModal.classList.add("hidden")
      );
      requestSendBtn.addEventListener("click", () => {
        const txt = requestTextArea.value.trim();
        if (txt) {
          showAlert("Request Sent", "Your request has been sent successfully.");
          requestTextArea.value = "";
          requestModal.classList.add("hidden");
        } else showAlert("Error", "Request cannot be empty.");
      });
      assignRegionConfirm.addEventListener("click", async () => {
        const email = overseerEmailInput.value.trim(),
          region = regionNameInput.value.trim();
        if (!email || !region)
          return showAlert("Error", "Email and region cannot be empty.");
        try {
          const res = await fetch(`${API_BASE_URL}/admin/assign-region`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ overseerEmail: email, region }),
          });
          const data = await res.json();
          if (!res.ok)
            return showAlert("Error", data.error || "Failed to assign region.");
          showAlert("Success", data.message);
          overseerEmailInput.value = "";
          regionNameInput.value = "";
          assignRegionModal.classList.add("hidden");
          loadDashboard();
        } catch (err) {
          console.error(err);
          showAlert("Error", "Failed to assign region. Try again later.");
        }
      });
      fileSearch.addEventListener("input", renderFiles);
      fileFilter.addEventListener("change", renderFiles);

      const menuToggle = document.getElementById('menu-toggle');
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebar-overlay');

      menuToggle.addEventListener('click', () => {
          sidebar.classList.toggle('-translate-x-full');
          sidebarOverlay.classList.toggle('hidden');
      });
      sidebarOverlay.addEventListener('click', () => {
          sidebar.classList.add('-translate-x-full');
          sidebarOverlay.classList.add('hidden');
      });

      // Create School Modal Logic
      const createSchoolModal = document.getElementById('create-school-modal');
      const createSchoolClose = document.getElementById('create-school-close');
      const createSchoolCancel = document.getElementById('create-school-cancel');
      const createSchoolConfirm = document.getElementById('create-school-confirm');

      createSchoolClose.addEventListener('click', () => createSchoolModal.classList.add('hidden'));
      createSchoolCancel.addEventListener('click', () => createSchoolModal.classList.add('hidden'));
      createSchoolConfirm.addEventListener('click', async () => {
        const schoolName = document.getElementById('new-school-name').value.trim();
        const schoolCountry = document.getElementById('new-school-country').value;
        const tier = document.getElementById('new-school-tier').value;

        if (!schoolName || !schoolCountry || !tier) {
          showToast('All fields are required.', 'error');
          return;
        }

        try {
          const res = await fetchWithAuth('/admin/schools/add', {
            method: 'POST',
            body: JSON.stringify({ schoolName, schoolCountry, tier: Number(tier) }),
          });
          showToast('School created successfully!', 'success');
          createSchoolModal.classList.add('hidden');
          if (activeTab === 'schools') loadSchools();
        } catch (err) {
          console.error(err);
          showToast(err.message || 'Failed to create school.', 'error');
        }
      });

      // Edit School Modal Logic
      const editSchoolModal = document.getElementById('edit-school-modal');
      const editSchoolClose = document.getElementById('edit-school-close');
      const editSchoolCancel = document.getElementById('edit-school-cancel');
      const editSchoolConfirm = document.getElementById('edit-school-confirm');

      editSchoolClose.addEventListener('click', () => editSchoolModal.classList.add('hidden'));
      editSchoolCancel.addEventListener('click', () => editSchoolModal.classList.add('hidden'));
      editSchoolConfirm.addEventListener('click', async () => {
        const schoolId = document.getElementById('edit-school-id').value;
        const schoolName = document.getElementById('edit-school-name').value.trim();
        const schoolCountry = document.getElementById('edit-school-country').value;
        const tier = document.getElementById('edit-school-tier').value;

        if (!schoolName || !schoolCountry || !tier) {
          showToast('All fields are required.', 'error');
          return;
        }

        try {
          const res = await fetchWithAuth(`/admin/schools/${schoolId}`, {
            method: 'PATCH',
            body: JSON.stringify({ schoolName, schoolCountry, tier: Number(tier) }),
          });
          showToast(res.message || 'School updated successfully!', 'success');
          editSchoolModal.classList.add('hidden');
          loadSchools(); // Refresh the list
        } catch (err) {
          console.error(err);
          showToast(err.message || 'Failed to update school.', 'error');
        }
      });

      window.openEditSchoolModal = (schoolId) => {
        const school = schoolsData.find(s => s._id === schoolId);
        if (!school) return showToast('School not found.', 'error');
        document.getElementById('edit-school-id').value = school._id;
        document.getElementById('edit-school-name').value = school.schoolName;
        document.getElementById('edit-school-country').value = school.schoolCountry;
        document.getElementById('edit-school-tier').value = school.tier;
        editSchoolModal.classList.remove('hidden');
      };

      // Init
      document.addEventListener("DOMContentLoaded", async () => {
        const auth = await checkAuth();
        if (!auth) return;
        renderContent();
      });
    </script>
  </body>
</html>
