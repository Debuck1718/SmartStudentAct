<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="quizTitle">Student Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="./images/icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <script src="https://kit.fontawesome.com/a2e0e9c6e2.js" crossorigin="anonymous"></script>
    <script src="api-config.js"></script>
    <script src="translate.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-start py-8">

  <div class="w-full max-w-3xl flex flex-col items-center mb-6 px-4">
    <!-- Header -->
    <div class="w-full flex justify-between items-center mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold text-blue-600" data-i18n="quizTitle">üìò Quiz</h1>
      <select id="language-select" class="border rounded-lg px-2 py-1">
        <option value="en">English</option>
        <option value="fr">Fran√ßais</option>
        <option value="es">Espa√±ol</option>
        <option value="tr">T√ºrk√ße</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      </select>
    </div>

    <!-- Quiz Content -->
    <div id="main-content" class="w-full bg-white shadow-lg rounded-xl p-6 hidden">
      <h2 id="quiz-title" class="text-xl font-semibold mb-2 text-gray-800"></h2>
      <p id="quiz-desc" class="text-gray-600 mb-4"></p>

      <!-- Timer -->
      <div id="quiz-timer" class="text-red-600 font-bold text-lg mb-4 hidden">
        ‚è± <span data-i18n="timeRemaining">Time Remaining</span>: <span id="time-remaining"></span>
      </div>

      <!-- Quiz Form -->
      <form id="quiz-form" class="space-y-6">
        <div id="questions-container" class="space-y-6"></div>
        <button type="submit" id="submit-button"
          class="w-full bg-blue-500 text-white px-4 py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors"
          data-i18n="submitQuiz">
          Submit Quiz
        </button>
      </form>

      <!-- Results -->
      <div id="quiz-result" class="mt-6 hidden text-center">
        <h3 class="text-2xl font-bold text-green-600 mb-2" data-i18n="quizSubmitted">‚úÖ Quiz Submitted</h3>
        <p id="score-text" class="text-lg text-gray-800 mb-4"></p>
        <div id="answer-breakdown" class="space-y-4 text-left"></div>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading-spinner" class="flex flex-col items-center justify-center min-h-[300px]">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
      <p class="mt-4 text-gray-500" data-i18n="loadingQuiz">Loading quiz...</p>
    </div>
  </div>
  
  <script src="translate.js"></script>

 <script>
        const API_BASE = window.API_BASE_URL;
    
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container') || (() => {
                const el = document.createElement('div');
                el.id = 'toast-container';
                el.style.position = 'fixed';
                el.style.top = '20px';
                el.style.right = '20px';
                el.style.zIndex = 1000;
                document.body.appendChild(el);
                return el;
            })();
            const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
            const t = document.createElement('div');
            t.className = `text-white px-3 py-2 rounded ${colors[type] || colors.info}`;
            t.textContent = message;
            container.appendChild(t);
            setTimeout(() => t.remove(), 3500);
        }

        async function fetchWithAuth(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const opts = {
                credentials: 'include',
                headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
                ...options,
            };

            const res = await fetch(url, opts);
            if (res.status === 401) {
                window.location.href = '/login.html';
                return;
            }
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.message || `Request failed: ${res.status}`);
            }
            return res.json();
        }

        async function checkAuthentication() {
            try {
                await fetchWithAuth('/auth/check');
                return true;
            } catch (e) {
                showToast('Please login first.', 'error');
                setTimeout(() => (window.location.href = '/login.html'), 1200);
                return false;
            }
        }
    const urlParams = new URLSearchParams(window.location.search);
    const quizId = urlParams.get('quizId');
    let currentLang = 'en';

    const mainContent = document.getElementById('main-content');
    const loadingSpinner = document.getElementById('loading-spinner');
    const quizTitle = document.getElementById('quiz-title');
    const quizDesc = document.getElementById('quiz-desc');
    const questionsContainer = document.getElementById('questions-container');
    const quizForm = document.getElementById('quiz-form');
    const quizResult = document.getElementById('quiz-result');
    const scoreText = document.getElementById('score-text');
    const breakdownContainer = document.getElementById('answer-breakdown');
    const quizTimer = document.getElementById('quiz-timer');
    const timeRemainingSpan = document.getElementById('time-remaining');
    const submitButton = document.getElementById('submit-button');
    const languageSelect = document.getElementById('language-select');

    let countdownInterval = null;

    const showLoading = () => {
        loadingSpinner.classList.remove('hidden');
        mainContent.classList.add('hidden');
    };

    const hideLoading = () => {
        loadingSpinner.classList.add('hidden');
        mainContent.classList.remove('hidden');
    };
    
    const fetchQuiz = async () => {
        if (!quizId) {
            hideLoading();
            questionsContainer.innerHTML = `<p class="text-gray-500 text-center text-lg mt-8" data-i18n="noQuizIdError">No quiz ID provided.</p>`;
            return;
        }

        try {
            const data = await fetchWithAuth(`/student/quizzes/${quizId}`);
            if (!data || !data.quiz) {
                hideLoading();
                questionsContainer.innerHTML = `<p class="text-gray-500 text-center text-lg mt-8" data-i18n="noQuizFound">No quiz found with this ID.</p>`;
                return;
            }
            renderQuiz(data.quiz);
            hideLoading();
        } catch (err) {
            hideLoading();
            questionsContainer.innerHTML = `<p class="text-red-500 text-center text-lg mt-8">${err.message}</p>`;
            console.error(err);
        }
    };

    const startCountdown = (minutes) => {
        if (!minutes) return;
        quizTimer.classList.remove('hidden');
        let remainingSeconds = minutes * 60;

        countdownInterval = setInterval(() => {
            const mins = Math.floor(remainingSeconds / 60);
            const secs = remainingSeconds % 60;
            timeRemainingSpan.textContent = `${mins}m ${secs}s`;
            remainingSeconds--;

            if (remainingSeconds < 0) {
                clearInterval(countdownInterval);
                alert(getTranslation('timeUpAutoSubmit'));
                autoSubmitQuiz();
            }
        }, 1000);
    };

    const renderQuiz = (quiz) => {
        quizTitle.textContent = quiz.title;
        quizDesc.textContent = quiz.description || '';

        if (quiz.timeLimitMinutes) startCountdown(quiz.timeLimitMinutes);

        questionsContainer.innerHTML = "";
        quiz.questions.forEach((q, idx) => {
            const div = document.createElement('div');
            div.className = "bg-gray-50 p-4 rounded-lg shadow-sm";
            div.setAttribute("data-question", idx);
            div.innerHTML = `
              <p class="font-semibold mb-2">${idx + 1}. ${q.question}</p>
              <div class="space-y-2">
                ${q.options.map((opt, i) => `
                  <label class="flex items-center space-x-2 cursor-pointer p-2 rounded hover:bg-gray-200">
                    <input type="radio" name="q${idx}" value="${opt}" class="text-blue-500 h-4 w-4">
                    <span class="text-gray-700">${opt}</span>
                  </label>
                `).join('')}
              </div>
              <p class="hidden text-red-500 text-sm mt-2 warning" data-i18n="answerThisQuestionWarning">‚ö†Ô∏è Please answer this question</p>
            `;
            questionsContainer.appendChild(div);
        });
        translateElements(questionsContainer);
    };

    const autoSubmitQuiz = async () => {
        submitButton.disabled = true;
        const answers = {};
        document.querySelectorAll('[data-question]').forEach((div, idx) => {
            const selected = quizForm.querySelector(`input[name=q${idx}]:checked`);
            answers[idx] = selected ? selected.value : null;
        });

        try {
            const result = await fetchWithAuth(`/student/quizzes/${quizId}/submit`, {
                method: 'POST',
                body: JSON.stringify({ answers, autoSubmit: true }),
            });
            showResults(result.quiz, result.submission);
        } catch (err) {
            console.error(err);
            showToast(getTranslation('autoSubmitError') || 'Auto-submit failed', 'error');
        }
    };

    const showResults = (quiz, submission) => {
        clearInterval(countdownInterval);
        quizTimer.classList.add('hidden');
        quizForm.classList.add('hidden');
        quizResult.classList.remove('hidden');
        scoreText.textContent = `${getTranslation('youScored')} ${submission.score} / ${quiz.questions.length}`;

        breakdownContainer.innerHTML = '';
        quiz.questions.forEach((q, idx) => {
            const studentAnswer = submission.answers[idx] || getTranslation('noAnswer');
            const isCorrect = q.correct === studentAnswer;

            const div = document.createElement('div');
            div.className = `p-3 rounded-lg transition-colors ${isCorrect ? 'bg-green-100' : 'bg-red-100'}`;
            div.innerHTML = `
              <p class="font-semibold">${idx + 1}. ${q.question}</p>
              <p class="mt-1"><span data-i18n="yourAnswer">Your answer</span>: <span class="${isCorrect ? 'text-green-600' : 'text-red-600'} font-medium">${studentAnswer}</span></p>
              <p class="mt-1"><span data-i18n="correctAnswer">Correct answer</span>: <span class="font-bold text-green-700">${q.correct}</span></p>
              ${isCorrect ? '' : `<p class="mt-2 text-red-500 text-sm font-semibold" data-i18n="incorrectAnswerFeedback">Your answer was incorrect.</p>`}
            `;
            breakdownContainer.appendChild(div);
        });
        translateElements(breakdownContainer);
    };

    quizForm.addEventListener('submit', async(e) => {
        e.preventDefault();
        clearInterval(countdownInterval);
        submitButton.disabled = true;

        const answers = {};
        let allAnswered = true;

        document.querySelectorAll('[data-question]').forEach(div => {
            div.classList.remove('border', 'border-red-500');
            div.querySelector('.warning').classList.add('hidden');
        });

        const totalQuestions = document.querySelectorAll('[data-question]').length;

        for (let i = 0; i < totalQuestions; i++) {
            const selected = quizForm.querySelector(`input[name=q${i}]:checked`);
            if (selected) {
                answers[i] = selected.value;
            } else {
                allAnswered = false;
                const div = document.querySelector(`[data-question="${i}"]`);
                div.classList.add('border', 'border-red-500');
                div.querySelector('.warning').classList.remove('hidden');
            }
        }

        if (!allAnswered) {
            alert(getTranslation('answerAllQuestionsWarning'));
            submitButton.disabled = false;
            return;
        }

        try {
            const result = await fetchWithAuth(`/student/quizzes/${quizId}/submit`, {
                method: 'POST',
                body: JSON.stringify({ answers, autoSubmit: false }),
            });
            showResults(result.quiz, result.submission);
        } catch (err) {
            showToast(getTranslation('submittingError') || 'Submit failed', 'error');
            console.error(err);
        }
    });

    function getTranslation(key) {
        if (typeof translations !== 'undefined' && translations[key] && translations[key][currentLang]) {
            return translations[key][currentLang];
        }
        return key;
    }

    languageSelect.addEventListener("change", (e) => {
        const lang = e.target.value;
        currentLang = lang;
        translatePage('student-quiz', lang);
        document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";
    });

    document.addEventListener('DOMContentLoaded', async () => {
        translatePage('student-quiz', 'en');
        if (!(await checkAuthentication())) return;
        fetchQuiz();
    });
</script>
</body>
</html>




