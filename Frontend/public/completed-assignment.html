
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="page_title">Completed Assigned Tasks</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="./images/icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EWMR745QHX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-EWMR745QHX');
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .cute-back-btn {
      display: inline-flex;
      align-items: center;
      background: linear-gradient(90deg, #f472b6 0%, #60a5fa 100%);
      color: #fff;
      font-weight: 600;
      border-radius: 9999px;
      box-shadow: 0 2px 8px rgba(100,100,255,0.08);
      padding: 0.6rem 1.4rem;
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
      border: none;
      transition: background 0.2s, transform 0.2s;
      cursor: pointer;
      gap: 0.5rem;
    }
    .cute-back-btn:hover {
      background: linear-gradient(90deg, #60a5fa 0%, #f472b6 100%);
      transform: scale(1.04);
      box-shadow: 0 4px 16px rgba(100,100,255,0.13);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Header -->
  <header class="w-full max-w-4xl mx-auto p-4">
    <div class="flex justify-between items-center">
      <a href="javascript:history.back()" class="cute-back-btn">
        <span style="font-size:1.3em;">üêæ</span> <span data-i18n="back_button">Back</span>
      </a>

      <!-- Language Dropdown -->
      <select id="language-dropdown" class="p-2 border rounded-md bg-white shadow">
        <option value="en">English</option>
        <option value="fr">Fran√ßais</option>
        <option value="es">Espa√±ol</option>
        <option value="tr">T√ºrk√ße</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      </select>
    </div>
    <h1 class="text-3xl font-bold text-gray-800 text-center mb-6" data-i18n="page_title">Completed Student Submissions</h1>
  </header>

  <!-- Main container -->
  <div class="container bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full mx-auto">
    <div id="tasks-list" class="space-y-4"></div>
  </div>

  <script src="api-config.js"></script>
  <script>
    const translations = {
      en: { page_title: "Completed Student Submissions", student: "Student", status: "Status", date: "Date", loading: "Loading submissions...", no_submissions: "No completed assignments found.", back_button: "Back", grade: "Grade", feedback: "Feedback", gradeAction: "Grade Submission", score: "Score", submitGrade: "Submit Grade", gradeSuccess: "Graded successfully!", statuses: { Completed: "Completed", Graded: "Graded" }, unsubmit: "Unsubmit", confirmUnsubmit: "Are you sure you want to unsubmit this assignment? You will need to submit it again before the deadline.", unsubmitSuccess: "Assignment unsubmitted successfully.", unsubmitError: "Failed to unsubmit assignment.", unsubmitDisabledPastDue: "Unsubmit disabled (past due date)" },
      fr: { page_title: "Soumissions des √âtudiants Termin√©es", student: "√âtudiant", status: "Statut", date: "Date", loading: "Chargement des soumissions...", no_submissions: "Aucune devoir termin√© trouv√©.", back_button: "Retour", grade: "Note", feedback: "Commentaire", gradeAction: "Noter la soumission", score: "Score", submitGrade: "Soumettre la note", gradeSuccess: "Not√© avec succ√®s !", statuses: { Completed: "Termin√©", Graded: "Not√©" }, unsubmit: "Annuler la soumission", confirmUnsubmit: "√ätes-vous s√ªr de vouloir annuler la soumission de ce devoir ? Vous devrez le soumettre √† nouveau avant la date limite.", unsubmitSuccess: "Devoir d√©soumis avec succ√®s.", unsubmitError: "√âchec de l'annulation de la soumission du devoir.", unsubmitDisabledPastDue: "Annuler la soumission d√©sactiv√© (date limite d√©pass√©e)" },
      es: { page_title: "Env√≠os de Estudiantes Completados", student: "Estudiante", status: "Estado", date: "Fecha", loading: "Cargando env√≠os...", no_submissions: "No se encontraron tareas completadas.", back_button: "Volver", grade: "Calificaci√≥n", feedback: "Comentarios", gradeAction: "Calificar env√≠o", score: "Puntuaci√≥n", submitGrade: "Enviar calificaci√≥n", gradeSuccess: "¬°Calificado con √©xito!", statuses: { Completed: "Completado", Graded: "Calificado" }, unsubmit: "Deshacer env√≠o", confirmUnsubmit: "¬øEst√°s seguro de que quieres deshacer el env√≠o de esta tarea? Deber√°s enviarla de nuevo antes de la fecha l√≠mite.", unsubmitSuccess: "Env√≠o de tarea deshecho con √©xito.", unsubmitError: "Error al deshacer el env√≠o de la tarea.", unsubmitDisabledPastDue: "Deshacer env√≠o deshabilitado (fecha l√≠mite pasada)" },
      tr: { page_title: "Tamamlanan √ñƒürenci G√∂nderimleri", student: "√ñƒürenci", status: "Durum", date: "Tarih", loading: "G√∂nderimler y√ºkleniyor...", no_submissions: "Tamamlanmƒ±≈ü √∂dev bulunamadƒ±.", back_button: "Geri", grade: "Not", feedback: "Geri bildirim", gradeAction: "G√∂nderimi Notlandƒ±r", score: "Puan", submitGrade: "Notu G√∂nder", gradeSuccess: "Ba≈üarƒ±yla notlandƒ±rƒ±ldƒ±!", statuses: { Completed: "Tamamlandƒ±", Graded: "Deƒüerlendirildi" }, unsubmit: "G√∂nderimi Geri Al", confirmUnsubmit: "Bu √∂devi geri almak istediƒüinizden emin misiniz? Son teslim tarihinden √∂nce tekrar g√∂ndermeniz gerekecek.", unsubmitSuccess: "√ñdev ba≈üarƒ±yla geri alƒ±ndƒ±.", unsubmitError: "√ñdev geri alƒ±namadƒ±.", unsubmitDisabledPastDue: "G√∂nderimi geri al devre dƒ±≈üƒ± (son teslim tarihi ge√ßti)" },
      ar: { page_title: "ÿ™ŸÇÿØŸäŸÖÿßÿ™ ÿßŸÑÿ∑ŸÑÿßÿ® ÿßŸÑŸÖŸÉÿ™ŸÖŸÑÿ©", student: "ÿßŸÑÿ∑ÿßŸÑÿ®", status: "ÿßŸÑÿ≠ÿßŸÑÿ©", date: "ÿßŸÑÿ™ÿßÿ±ŸäÿÆ", loading: "ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÇÿØŸäŸÖÿßÿ™...", no_submissions: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ Ÿàÿßÿ¨ÿ®ÿßÿ™ ŸÖŸÉÿ™ŸÖŸÑÿ©.", back_button: "ÿ±ÿ¨Ÿàÿπ", grade: "ÿßŸÑÿØÿ±ÿ¨ÿ©", feedback: "ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™", gradeAction: "ÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ™ŸÇÿØŸäŸÖ", score: "ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©", submitGrade: "ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿØÿ±ÿ¨ÿ©", gradeSuccess: "ÿ™ŸÖ ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!", statuses: { Completed: "ŸÖŸÉÿ™ŸÖŸÑ", Graded: "ÿ™ŸÖ ÿßŸÑÿ™ŸÇŸäŸäŸÖ" }, unsubmit: "ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ", confirmUnsubmit: "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿ±ÿ≥ÿßŸÑ Ÿáÿ∞ÿß ÿßŸÑŸàÿßÿ¨ÿ®ÿü ÿ≥ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ•ÿ±ÿ≥ÿßŸÑŸá ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ŸÇÿ®ŸÑ ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÜŸáÿßÿ¶Ÿä.", unsubmitSuccess: "ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸàÿßÿ¨ÿ® ÿ®ŸÜÿ¨ÿßÿ≠.", unsubmitError: "ŸÅÿ¥ŸÑ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸàÿßÿ¨ÿ®.", unsubmitDisabledPastDue: "ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ŸÖÿπÿ∑ŸÑ (ÿ™ÿ¨ÿßŸàÿ≤ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ)" },
      ru: { page_title: "–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–µ –†–∞–±–æ—Ç—ã", student: "–°—Ç—É–¥–µ–Ω—Ç", status: "–°—Ç–∞—Ç—É—Å", date: "–î–∞—Ç–∞", loading: "–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç...", no_submissions: "–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.", back_button: "–ù–∞–∑–∞–¥", grade: "–û—Ü–µ–Ω–∫–∞", feedback: "–û—Ç–∑—ã–≤", gradeAction: "–û—Ü–µ–Ω–∏—Ç—å —Ä–∞–±–æ—Ç—É", score: "–ë–∞–ª–ª—ã", submitGrade: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É", gradeSuccess: "–£—Å–ø–µ—à–Ω–æ –æ—Ü–µ–Ω–µ–Ω–æ!", statuses: { Completed: "–ó–∞–≤–µ—Ä—à–µ–Ω–æ", Graded: "–û—Ü–µ–Ω–µ–Ω–æ" }, unsubmit: "–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É", confirmUnsubmit: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —ç—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è? –í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞ –¥–æ –∫—Ä–∞–π–Ω–µ–≥–æ —Å—Ä–æ–∫–∞.", unsubmitSuccess: "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–¥–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–∞.", unsubmitError: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞–¥–∞–Ω–∏—è.", unsubmitDisabledPastDue: "–û—Ç–º–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∞ (—Å—Ä–æ–∫ —Å–¥–∞—á–∏ –∏—Å—Ç—ë–∫)" }
    };

    let currentLang = "en";
    const tasksListContainer = document.getElementById("tasks-list");

    function setLanguage(lang) {
        currentLang = lang;
        document.querySelectorAll("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            if (translations[lang][key]) el.textContent = translations[lang][key];
        });
        document.body.dir = lang === "ar" ? "rtl" : "ltr";
        fetchCompletedAssignments();
    }

    async function authFetch(endpoint, options = {}) {
        const res = await fetch(`${window.API_BASE_URL}${endpoint}`, {
            ...options,
            credentials: 'include',
            headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
        });
        if (res.status === 401) window.location.href = '/login.html';
        return res;
    }

    function renderTasks(submissions) {
        tasksListContainer.innerHTML = "";
        if (!submissions || submissions.length === 0) {
            tasksListContainer.innerHTML = `<p class="text-center text-gray-500 italic">${translations[currentLang].no_submissions}</p>`;
            return;
        }

        submissions.forEach(item => {
            const labels = translations[currentLang];
      const taskItemDiv = document.createElement("div");
            taskItemDiv.className = "bg-green-50 p-4 rounded-lg border-l-4 border-green-500 shadow-sm";
            
            const studentName = item.student ? `${item.student.firstname} ${item.student.lastname}` : 'Unknown Student';
            const submissionDate = item.submitted_at ? new Date(item.submitted_at).toLocaleString() : 'N/A';
            const isGraded = item.status === 'Graded' || (item.grade !== undefined && item.grade !== null);

            let gradingSection = '';
            if (isGraded) {
                 gradingSection = `
                    <div class="mt-4 p-3 bg-blue-50 rounded border border-blue-100">
                        <p class="font-bold text-blue-800">${labels.grade}: ${item.grade}</p>
                        ${item.feedback ? `<p class="text-sm text-blue-700 mt-1"><strong>${labels.feedback}:</strong> ${item.feedback}</p>` : ''}
                    </div>
                `;
            } else {
                gradingSection = `
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <button class="text-blue-600 text-sm font-semibold hover:underline flex items-center gap-1" onclick="toggleGradeForm('${item._id}')">
                            <span>‚úèÔ∏è</span> ${labels.gradeAction}
                        </button>
                        <form id="grade-form-${item._id}" class="hidden mt-3 space-y-3 bg-white p-3 rounded border border-gray-200" onsubmit="handleGrade(event, '${item._id}')">
                            <div>
                                <label class="block text-xs font-bold text-gray-700 uppercase mb-1">${labels.score}</label>
                                <input type="number" name="score" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" required min="0" />
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-700 uppercase mb-1">${labels.feedback}</label>
                                <textarea name="feedback" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" rows="2" placeholder="Optional feedback..."></textarea>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-blue-700 transition-colors">
                                    ${labels.submitGrade}
                                </button>
                            </div>
                        </form>
                    </div>
                `;
            }

            taskItemDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-lg font-semibold text-gray-800">${item.assignment ? item.assignment.title : 'Untitled Assignment'}</p>
                        <p class="text-sm text-gray-600 mt-1"><span class="font-medium">${labels.student}:</span> ${studentName}</p>
                    </div>
                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${isGraded ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">
                        ${isGraded ? (labels.statuses?.Graded || 'Graded') : (labels.statuses?.Completed || item.status)}
                    </span>
                </div>
                <p class="text-sm text-gray-500 mt-1">${labels.date}: ${submissionDate}</p>
                
                ${item.submission_text ? `<div class="mt-3 p-3 bg-white rounded border border-gray-200 text-sm text-gray-700 whitespace-pre-wrap">${item.submission_text}</div>` : ''}
                
                ${(item.submission_files && item.submission_files.length > 0) || item.submission_file ? `
                    <div class="mt-3">
                        <p class="text-sm font-medium text-gray-700 mb-1">Submitted Files:</p>
                        <div class="space-y-1">
                            ${(item.submission_files || (item.submission_file ? [item.submission_file] : [])).map(file => `
                                <a href="${file.url}" target="_blank" class="inline-flex items-center gap-2 text-blue-600 text-sm hover:underline">
                                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                                    <span>${file.name || 'View File'}</span>
                                </a>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${gradingSection}
            `;
            tasksListContainer.appendChild(taskItemDiv);
        });
    }

    window.handleUnsubmit = async function(submissionId) {
        const lang = currentLang;
        if (confirm(translations[lang].confirmUnsubmit)) {
            try {
                const res = await authFetch(`/student/submissions/${submissionId}`, {
                    method: 'DELETE'
                });
                if (!res.ok) throw new Error('Failed to unsubmit');
                alert(translations[lang].unsubmitSuccess);
                fetchCompletedAssignments();
            } catch (error) {
                alert(translations[lang].unsubmitError);
                console.error(error);
            }
        }
    }
    async function handleGrade(event, submissionId) {
        event.preventDefault();
        const form = event.target;
        const score = form.score.value;
        const feedback = form.feedback.value;
        const btn = form.querySelector('button[type="submit"]');
        
        btn.disabled = true;
        btn.textContent = '...';

        try {
            const res = await authFetch(`/teacher/submissions/${submissionId}/grade`, {
                method: 'POST',
                body: JSON.stringify({ score, feedback })
            });
            
            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.message || 'Failed to grade');
            }
            
            alert(translations[currentLang].gradeSuccess || 'Graded successfully!');
            fetchCompletedAssignments(); // Refresh list
        } catch (err) {
            alert(err.message);
            btn.disabled = false;
            btn.textContent = translations[currentLang].submitGrade || 'Submit Grade';
        }
    }

    window.toggleGradeForm = function(id) {
        const form = document.getElementById(`grade-form-${id}`);
        if (form) form.classList.toggle('hidden');
    }

    async function fetchCompletedAssignments() {
        tasksListContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentLang].loading}</p>`;
        try {
            const res = await authFetch('/teacher/submissions');
            if (!res.ok) throw new Error('Failed to fetch submissions.');
            const submissions = await res.json();
            renderTasks(submissions);
        } catch (error) {
            tasksListContainer.innerHTML = `<p class="text-center text-red-500">${error.message}</p>`;
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("language-dropdown").addEventListener("change", (e) => setLanguage(e.target.value));
      setLanguage("en");
    });
  </script>

</body>
</html>
