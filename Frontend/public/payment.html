<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="pageTitle">Upgrade Your Account</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        max-width: 80%;
        text-align: center;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4"
  >
    <!-- Language Selector -->
    <div class="absolute top-4 right-4 z-20">
      <select
        id="language-selector"
        class="bg-white border border-gray-300 rounded-lg p-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        <option value="en">EN</option>
        <option value="fr">FR</option>
        <option value="es">ES</option>
        <option value="tr">TR</option>
        <option value="ar">AR</option>
        <option value="ru">RU</option>
      </select>
    </div>

    <!-- Modal -->
    <div id="alert-modal" class="modal">
      <div class="modal-content shadow-lg">
        <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
        <p id="modal-message" class="mb-6"></p>
        <button
          onclick="closeModal()"
          class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors"
          data-i18n="okButton"
        >
          OK
        </button>
      </div>
    </div>

    <!-- Payment Box -->
    <div
      class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center border border-gray-200"
    >
      <svg
        class="w-16 h-16 mx-auto text-yellow-500"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        ></path>
      </svg>
      <h1
        class="text-3xl font-bold text-gray-800 mt-4"
        data-i18n="trialEndedTitle"
      >
        Trial Ended
      </h1>
      <p class="text-gray-600 mt-2" data-i18n="trialEndedMessage">
        Your trial period has expired. Please upgrade to continue enjoying all
        features.
      </p>

      <div id="payment-details" class="mt-6 p-4 bg-blue-50 rounded-xl">
        <p
          class="text-sm text-blue-800 font-semibold"
          data-i18n="subscriptionFee"
        >
          Subscription Fee
        </p>
        <p id="amount-text" class="text-2xl font-bold text-blue-900 mt-1">
          Loading...
        </p>
      </div>

      <button
        id="payButton"
        class="w-full mt-6 py-3 px-6 rounded-full bg-blue-600 text-white font-semibold shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
        data-i18n="payButton"
        disabled
      >
        Proceed to Payment
      </button>

      <div id="message" class="mt-4 text-center"></div>
    </div>

    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script>
      const translations = {
        en: {
          pageTitle: "Upgrade Your Account",
          trialEndedTitle: "Trial Ended",
          trialEndedMessage:
            "Your trial period has expired. Please upgrade to continue enjoying all features.",
          subscriptionFee: "Subscription Fee",
          payButton: "Proceed to Payment",
          loadingPrice: "Loading price...",
          initiatingPayment: "Initiating payment...",
          verifyingPayment: "Verifying payment...",
          paymentSuccess: "Payment successful!",
          subscriptionActive: "Your subscription is now active.",
          paymentCanceled: "Payment canceled.",
          paymentError: "Payment error",
          verificationFailed: "Payment verification failed",
          error: "Error",
          networkError: "Network error. Please try again.",
          okButton: "OK",
        },
        fr: {
          pageTitle: "Mettez Ã  niveau votre compte",
          trialEndedTitle: "Essai terminÃ©",
          trialEndedMessage:
            "Votre pÃ©riode d'essai est terminÃ©e. Veuillez passer Ã  la version payante pour continuer.",
          subscriptionFee: "Frais d'abonnement",
          payButton: "ProcÃ©der au paiement",
          loadingPrice: "Chargement du prix...",
          initiatingPayment: "Initialisation du paiement...",
          verifyingPayment: "VÃ©rification du paiement...",
          paymentSuccess: "Paiement rÃ©ussi !",
          subscriptionActive: "Votre abonnement est maintenant actif.",
          paymentCanceled: "Paiement annulÃ©.",
          paymentError: "Erreur de paiement",
          verificationFailed: "Ã‰chec de la vÃ©rification du paiement",
          error: "Erreur",
          networkError: "Erreur rÃ©seau. Veuillez rÃ©essayer.",
          okButton: "OK",
        },
        es: {
          pageTitle: "Actualiza tu cuenta",
          trialEndedTitle: "Prueba finalizada",
          trialEndedMessage:
            "Tu perÃ­odo de prueba ha terminado. Por favor, actualiza para seguir disfrutando de todas las funciones.",
          subscriptionFee: "Tarifa de suscripciÃ³n",
          payButton: "Proceder al pago",
          loadingPrice: "Cargando precio...",
          initiatingPayment: "Iniciando pago...",
          verifyingPayment: "Verificando pago...",
          paymentSuccess: "Â¡Pago exitoso!",
          subscriptionActive: "Tu suscripciÃ³n ahora estÃ¡ activa.",
          paymentCanceled: "Pago cancelado.",
          paymentError: "Error de pago",
          verificationFailed: "FallÃ³ la verificaciÃ³n del pago",
          error: "Error",
          networkError: "Error de red. IntÃ©ntalo de nuevo.",
          okButton: "OK",
        },
        tr: {
          pageTitle: "HesabÄ±nÄ±zÄ± YÃ¼kseltin",
          trialEndedTitle: "Deneme SÃ¼resi Sona Erdi",
          trialEndedMessage:
            "Deneme sÃ¼reniz sona erdi. TÃ¼m Ã¶zellikleri kullanmaya devam etmek iÃ§in yÃ¼kseltin.",
          subscriptionFee: "Abonelik Ãœcreti",
          payButton: "Ã–demeye Devam Et",
          loadingPrice: "Fiyat yÃ¼kleniyor...",
          initiatingPayment: "Ã–deme baÅŸlatÄ±lÄ±yor...",
          verifyingPayment: "Ã–deme doÄŸrulanÄ±yor...",
          paymentSuccess: "Ã–deme baÅŸarÄ±lÄ±!",
          subscriptionActive: "AboneliÄŸiniz artÄ±k aktif.",
          paymentCanceled: "Ã–deme iptal edildi.",
          paymentError: "Ã–deme hatasÄ±",
          verificationFailed: "Ã–deme doÄŸrulamasÄ± baÅŸarÄ±sÄ±z",
          error: "Hata",
          networkError: "AÄŸ hatasÄ±. LÃ¼tfen tekrar deneyin.",
          okButton: "Tamam",
        },
        ar: {
          pageTitle: "Ù‚Ù… Ø¨ØªØ±Ù‚ÙŠØ© Ø­Ø³Ø§Ø¨Ùƒ",
          trialEndedTitle: "Ø§Ù†ØªÙ‡Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©",
          trialEndedMessage:
            "Ø§Ù†ØªÙ‡Øª ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª.",
          subscriptionFee: "Ø±Ø³ÙˆÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ",
          payButton: "Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø¯ÙØ¹",
          loadingPrice: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±...",
          initiatingPayment: "Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙØ¹...",
          verifyingPayment: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹...",
          paymentSuccess: "ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!",
          subscriptionActive: "Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø§Ù„Ø¢Ù† Ù…ÙØ¹Ù„.",
          paymentCanceled: "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹.",
          paymentError: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹",
          verificationFailed: "ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹",
          error: "Ø®Ø·Ø£",
          networkError: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
          okButton: "Ø­Ø³Ù†Ø§Ù‹",
        },
        ru: {
          pageTitle: "ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ÑĞ²Ğ¾Ğ¹ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚",
          trialEndedTitle: "ĞŸÑ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½",
          trialEndedMessage:
            "Ğ’Ğ°Ñˆ Ğ¿Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»ÑÑ. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ²ÑĞµĞ¼Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼Ğ¸.",
          subscriptionFee: "Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸",
          payButton: "ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğµ",
          loadingPrice: "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ†ĞµĞ½Ñ‹...",
          initiatingPayment: "Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹...",
          verifyingPayment: "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹...",
          paymentSuccess: "ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!",
          subscriptionActive: "Ğ’Ğ°ÑˆĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°.",
          paymentCanceled: "ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°.",
          paymentError: "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹",
          verificationFailed: "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒ",
          error: "ĞÑˆĞ¸Ğ±ĞºĞ°",
          networkError: "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.",
          okButton: "ĞĞš",
        },
      };

      const API_BASE_URL = "https://smartstudentact.onrender.com/api";
      const PAYSTACK_PUBLIC_KEY =
        "pk_live_7d871b198024f60a328d95812595be2443695fcb";

      const payButton = document.getElementById("payButton");
      const messageDiv = document.getElementById("message");
      const amountText = document.getElementById("amount-text");
      const languageSelector = document.getElementById("language-selector");


      let finalAmount = 0;
      let finalCurrency = "";
      let paymentEmail = "";
      let retryTimeout = null;

   function showLoading(text) {
  payButton.disabled = true;
  payButton.innerHTML = `<span class="animate-spin mr-2">&#9696;</span> ${text}`;
}

function hideLoading() {
  console.log("hideLoading â†’ email:", paymentEmail, "amount:", finalAmount);
  payButton.disabled = !(finalAmount > 0 && paymentEmail);
  translatePage(languageSelector.value);
}

function showAlert(title, message) {
  document.getElementById("modal-title").textContent = title;
  document.getElementById("modal-message").textContent = message;
  document.getElementById("alert-modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("alert-modal").style.display = "none";
}

async function authFetch(url, options = {}) {
  const res = await fetch(url, {
    credentials: "include",
    headers: {
      "Content-Type": "application/json",
      ...(options.headers || {}),
    },
    ...options,
  });

  if (res.status === 401 || res.status === 403) {
    window.location.href = "/login.html";
    throw new Error("Unauthorized");
  }

  if (!res.ok) {
    throw new Error(`HTTP error ${res.status}`);
  }

  return res;
}

async function checkAuth() {
  try {
    const res = await authFetch(`${API_BASE_URL}/auth/check`);
    const data = await res.json();

    paymentEmail = data.email || data.user?.email || "";
    console.log("Auth email resolved:", paymentEmail);

    return data;
  } catch (e) {
    console.error("Auth check failed:", e);
    window.location.href = "/login.html";
  }
}

function translatePage(lang) {
  document.documentElement.lang = lang;

  document.querySelectorAll("[data-i18n]").forEach((el) => {
    const key = el.getAttribute("data-i18n");
    if (translations[lang] && translations[lang][key]) {
      el.textContent = translations[lang][key];
    }
  });

  payButton.textContent = translations[lang].payButton;
}

async function fetchPaymentDetails() {
  const lang = languageSelector.value;
  showLoading(translations[lang].loadingPrice);

  try {
    const res = await authFetch(`${API_BASE_URL}/pricing`);
    const data = await res.json();

    finalAmount = parseFloat(data.localPrice || 0);
    finalCurrency = data.currency || "USD";

    amountText.textContent =
      finalAmount > 0 ? `${finalCurrency} ${finalAmount.toFixed(2)}` : "N/A";

    console.log("Pricing resolved:", {
      finalAmount,
      finalCurrency,
      email: paymentEmail,
    });

    hideLoading();

    if (retryTimeout) clearTimeout(retryTimeout);
  } catch (e) {
    console.error("Pricing fetch failed:", e);

    messageDiv.innerHTML = `<p class="text-red-600">${translations[lang].networkError}</p>`;
    showAlert(translations[lang].error, translations[lang].networkError);

    payButton.disabled = true;
    hideLoading();

    retryTimeout = setTimeout(fetchPaymentDetails, 5000);
  }
}


     
      async function initiatePayment() {
  const lang = languageSelector.value;
  showLoading(translations[lang].initiatingPayment);

  try {
    const initRes = await authFetch(`${API_BASE_URL}/payment/initiate`, {
      method: "POST",
      body: JSON.stringify({
        gateway: "paystack",
        email: paymentEmail,          // ğŸ‘ˆ pass email
        amount: finalAmount,          // ğŸ‘ˆ pass amount in normal units (backend converts if needed)
        currency: finalCurrency,      // ğŸ‘ˆ pass currency (e.g., "GHS")
        phoneNumber: paymentPhone || "" // ğŸ‘ˆ optional if you collect phone
      }),
    });

    const paymentData = await initRes.json();

    // If backend returns { error: ... }
    if (paymentData.error) {
      throw new Error(paymentData.error);
    }

    const amountInKobo = Math.round(finalAmount * 100);

    const handler = PaystackPop.setup({
      key: PAYSTACK_PUBLIC_KEY,
      email: paymentEmail || paymentData?.email,
      amount: amountInKobo,
      currency: finalCurrency,
      ref: paymentData?.reference || `PSK_${Date.now()}`,
      callback: async function (response) {
        messageDiv.innerHTML = `<p class="text-blue-600 font-semibold">${translations[lang].verifyingPayment}</p>`;
        try {
          await authFetch(`${API_BASE_URL}/payment/success`, {
            method: "POST",
            body: JSON.stringify({
              gateway: "paystack",
              transaction_reference: response.reference,
            }),
          });
          messageDiv.innerHTML = `<p class="text-green-600 font-semibold">${translations[lang].paymentSuccess}</p>`;
          showAlert("âœ…", translations[lang].subscriptionActive);
        } catch (e) {
          messageDiv.innerHTML = `<p class="text-red-600">${translations[lang].error}: ${e.message}</p>`;
          showAlert(translations[lang].verificationFailed, e.message);
        }
        hideLoading();
      },
      onClose: function () {
        messageDiv.innerHTML = `<p class="text-red-600">${translations[lang].paymentCanceled}</p>`;
        hideLoading();
      },
    });
    handler.openIframe();
  } catch (e) {
    console.error(e);
    messageDiv.innerHTML = `<p class="text-red-600">${translations[lang].error}: ${e.message}</p>`;
    showAlert(translations[lang].paymentError, e.message);
    hideLoading();
  }
}


      document.addEventListener("DOMContentLoaded", async () => {
        const userLang = navigator.language.split("-")[0];
        if (translations[userLang]) languageSelector.value = userLang;
        translatePage(languageSelector.value);
        await checkAuth();
        await fetchPaymentDetails();

        payButton.addEventListener("click", initiatePayment);
      });
    </script>
  </body>
</html>

