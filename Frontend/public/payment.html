<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="pageTitle">Upgrade Your Account</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        max-width: 80%;
        text-align: center;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4"
  >
    <!-- Language Selector -->
    <div class="absolute top-4 right-4 z-20">
      <select
        id="language-selector"
        class="bg-white border border-gray-300 rounded-lg p-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        <option value="en">EN</option>
        <option value="fr">FR</option>
        <option value="es">ES</option>
        <option value="tr">TR</option>
        <option value="ar">AR</option>
        <option value="ru">RU</option>
      </select>
    </div>

    <!-- Modal -->
    <div id="alert-modal" class="modal">
      <div class="modal-content shadow-lg">
        <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
        <p id="modal-message" class="mb-6"></p>
        <button
          onclick="closeModal()"
          class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors"
          data-i18n="okButton"
        >
          OK
        </button>
      </div>
    </div>

    <!-- Payment Box -->
    <div
      class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center border border-gray-200"
    >
      <svg
        class="w-16 h-16 mx-auto text-yellow-500"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        ></path>
      </svg>
      <h1
        class="text-3xl font-bold text-gray-800 mt-4"
        data-i18n="trialEndedTitle"
      >
        Trial Ended
      </h1>
      <p class="text-gray-600 mt-2" data-i18n="trialEndedMessage">
        Your trial period has expired. Please upgrade to continue enjoying all
        features.
      </p>

      <div id="payment-details" class="mt-6 p-4 bg-blue-50 rounded-xl">
        <p
          class="text-sm text-blue-800 font-semibold"
          data-i18n="subscriptionFee"
        >
          Subscription Fee
        </p>
        <p id="amount-text" class="text-2xl font-bold text-blue-900 mt-1">
          Loading...
        </p>
      </div>

      <!-- ✅ Phone Number Input -->
      <div class="mt-4">
        <input
          id="phoneNumber"
          type="tel"
          placeholder="Enter phone number (optional)"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
        />
      </div>

      <button
        id="payButton"
        class="w-full mt-6 py-3 px-6 rounded-full bg-blue-600 text-white font-semibold shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
        data-i18n="payButton"
        disabled
      >
        Proceed to Payment
      </button>

      <div id="message" class="mt-4 text-center"></div>
    </div>

    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script>
      const translations = {
        en: {
          pageTitle: "Upgrade Your Account",
          trialEndedTitle: "Trial Ended",
          trialEndedMessage:
            "Your trial period has expired. Please upgrade to continue enjoying all features.",
          subscriptionFee: "Subscription Fee",
          payButton: "Proceed to Payment",
          loadingPrice: "Loading price...",
          initiatingPayment: "Initiating payment...",
          verifyingPayment: "Verifying payment...",
          paymentSuccess: "Payment successful!",
          subscriptionActive: "Your subscription is now active.",
          paymentCanceled: "Payment canceled.",
          paymentError: "Payment error",
          verificationFailed: "Payment verification failed",
          error: "Error",
          networkError: "Network error. Please try again.",
          okButton: "OK",
        },
        fr: {
          pageTitle: "Mettez à niveau votre compte",
          trialEndedTitle: "Essai terminé",
          trialEndedMessage:
            "Votre période d'essai est terminée. Veuillez passer à la version payante pour continuer.",
          subscriptionFee: "Frais d'abonnement",
          payButton: "Procéder au paiement",
          loadingPrice: "Chargement du prix...",
          initiatingPayment: "Initialisation du paiement...",
          verifyingPayment: "Vérification du paiement...",
          paymentSuccess: "Paiement réussi !",
          subscriptionActive: "Votre abonnement est maintenant actif.",
          paymentCanceled: "Paiement annulé.",
          paymentError: "Erreur de paiement",
          verificationFailed: "Échec de la vérification du paiement",
          error: "Erreur",
          networkError: "Erreur réseau. Veuillez réessayer.",
          okButton: "OK",
        },
        es: {
          pageTitle: "Actualiza tu cuenta",
          trialEndedTitle: "Prueba finalizada",
          trialEndedMessage:
            "Tu período de prueba ha terminado. Por favor, actualiza para seguir disfrutando de todas las funciones.",
          subscriptionFee: "Tarifa de suscripción",
          payButton: "Proceder al pago",
          loadingPrice: "Cargando precio...",
          initiatingPayment: "Iniciando pago...",
          verifyingPayment: "Verificando pago...",
          paymentSuccess: "¡Pago exitoso!",
          subscriptionActive: "Tu suscripción ahora está activa.",
          paymentCanceled: "Pago cancelado.",
          paymentError: "Error de pago",
          verificationFailed: "Falló la verificación del pago",
          error: "Error",
          networkError: "Error de red. Inténtalo de nuevo.",
          okButton: "OK",
        },
        tr: {
          pageTitle: "Hesabınızı Yükseltin",
          trialEndedTitle: "Deneme Süresi Sona Erdi",
          trialEndedMessage:
            "Deneme süreniz sona erdi. Tüm özellikleri kullanmaya devam etmek için yükseltin.",
          subscriptionFee: "Abonelik Ücreti",
          payButton: "Ödemeye Devam Et",
          loadingPrice: "Fiyat yükleniyor...",
          initiatingPayment: "Ödeme başlatılıyor...",
          verifyingPayment: "Ödeme doğrulanıyor...",
          paymentSuccess: "Ödeme başarılı!",
          subscriptionActive: "Aboneliğiniz artık aktif.",
          paymentCanceled: "Ödeme iptal edildi.",
          paymentError: "Ödeme hatası",
          verificationFailed: "Ödeme doğrulaması başarısız",
          error: "Hata",
          networkError: "Ağ hatası. Lütfen tekrar deneyin.",
          okButton: "Tamam",
        },
        ar: {
          pageTitle: "قم بترقية حسابك",
          trialEndedTitle: "انتهت الفترة التجريبية",
          trialEndedMessage:
            "انتهت فترة التجربة الخاصة بك. يرجى الترقية للاستمرار في استخدام جميع الميزات.",
          subscriptionFee: "رسوم الاشتراك",
          payButton: "المتابعة للدفع",
          loadingPrice: "جاري تحميل السعر...",
          initiatingPayment: "جاري بدء الدفع...",
          verifyingPayment: "جاري التحقق من الدفع...",
          paymentSuccess: "تم الدفع بنجاح!",
          subscriptionActive: "اشتراكك الآن مفعل.",
          paymentCanceled: "تم إلغاء الدفع.",
          paymentError: "خطأ في الدفع",
          verificationFailed: "فشل التحقق من الدفع",
          error: "خطأ",
          networkError: "خطأ في الشبكة. حاول مرة أخرى.",
          okButton: "حسناً",
        },
        ru: {
          pageTitle: "Обновите свой аккаунт",
          trialEndedTitle: "Пробный период завершен",
          trialEndedMessage:
            "Ваш пробный период закончился. Пожалуйста, обновите аккаунт, чтобы продолжить пользоваться всеми функциями.",
          subscriptionFee: "Стоимость подписки",
          payButton: "Перейти к оплате",
          loadingPrice: "Загрузка цены...",
          initiatingPayment: "Инициализация оплаты...",
          verifyingPayment: "Проверка оплаты...",
          paymentSuccess: "Оплата прошла успешно!",
          subscriptionActive: "Ваша подписка активирована.",
          paymentCanceled: "Оплата отменена.",
          paymentError: "Ошибка оплаты",
          verificationFailed: "Не удалось проверить оплату",
          error: "Ошибка",
          networkError: "Ошибка сети. Пожалуйста, попробуйте снова.",
          okButton: "ОК",
        },
      };

      const API_BASE_URL = "https://smartstudentact.onrender.com/api";
      const PAYSTACK_PUBLIC_KEY =
        "pk_live_7d871b198024f60a328d95812595be2443695fcb";

      const payButton = document.getElementById("payButton");
      const messageDiv = document.getElementById("message");
      const amountText = document.getElementById("amount-text");
      const languageSelector = document.getElementById("language-selector");
      const phoneInput = document.getElementById("phoneNumber"); // ✅ grab phone input

      let finalAmount = 0;
      let finalCurrency = "";
      let paymentEmail = "";
      let retryTimeout = null;

   function showLoading(text) {
  payButton.disabled = true;
  payButton.innerHTML = `<span class="animate-spin mr-2">&#9696;</span> ${text}`;
}

function hideLoading() {
  console.log("hideLoading → email:", paymentEmail, "amount:", finalAmount);
  payButton.disabled = !(finalAmount > 0 && paymentEmail);
  translatePage(languageSelector.value);
}

function showAlert(title, message) {
  document.getElementById("modal-title").textContent = title;
  document.getElementById("modal-message").textContent = message;
  document.getElementById("alert-modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("alert-modal").style.display = "none";
}

async function authFetch(url, options = {}) {
  const res = await fetch(url, {
    credentials: "include",
    headers: {
      "Content-Type": "application/json",
      ...(options.headers || {}),
    },
    ...options,
  });

  if (res.status === 401 || res.status === 403) {
    window.location.href = "/login.html";
    throw new Error("Unauthorized");
  }

  if (!res.ok) {
    throw new Error(`HTTP error ${res.status}`);
  }

  return res;
}

async function checkAuth() {
  try {
    const res = await authFetch(`${API_BASE_URL}/auth/check`);
    const data = await res.json();

    paymentEmail = data.email || data.user?.email || "";
    console.log("Auth email resolved:", paymentEmail);

    return data;
  } catch (e) {
    console.error("Auth check failed:", e);
    window.location.href = "/login.html";
  }
}

function translatePage(lang) {
  document.documentElement.lang = lang;

  document.querySelectorAll("[data-i18n]").forEach((el) => {
    const key = el.getAttribute("data-i18n");
    if (translations[lang] && translations[lang][key]) {
      el.textContent = translations[lang][key];
    }
  });

  payButton.textContent = translations[lang].payButton;
}

async function fetchPaymentDetails() {
  const lang = languageSelector.value;
  showLoading(translations[lang].loadingPrice);

  try {
    const res = await authFetch(`${API_BASE_URL}/pricing`);
    const data = await res.json();

    finalAmount = parseFloat(data.localPrice || 0);
    finalCurrency = data.currency || "USD";

    amountText.textContent =
      finalAmount > 0 ? `${finalCurrency} ${finalAmount.toFixed(2)}` : "N/A";

    console.log("Pricing resolved:", {
      finalAmount,
      finalCurrency,
      email: paymentEmail,
    });

    hideLoading();

    if (retryTimeout) clearTimeout(retryTimeout);
  } catch (e) {
    console.error("Pricing fetch failed:", e);

    messageDiv.innerHTML = `<p class="text-red-600">${translations[lang].networkError}</p>`;
    showAlert(translations[lang].error, translations[lang].networkError);

    payButton.disabled = true;
    hideLoading();

    retryTimeout = setTimeout(fetchPaymentDetails, 5000);
  }
}


     
      async function initiatePayment() {
        const lang = languageSelector.value;
        showLoading(translations[lang].initiatingPayment);

        // ✅ Safely get phone number
        const paymentPhone = phoneInput ? phoneInput.value.trim() : "";

        try {
          const initRes = await authFetch(`${API_BASE_URL}/payment/initiate`, {
            method: "POST",
            body: JSON.stringify({
              gateway: "paystack",
              phoneNumber: paymentPhone,
            }),
          });

          const paymentData = (await initRes.json()).data;
          const amountInKobo = Math.round(finalAmount * 100);

          const handler = PaystackPop.setup({
            key: PAYSTACK_PUBLIC_KEY,
            email: paymentEmail || paymentData?.email,
            amount: amountInKobo,
            currency: finalCurrency,
            ref: paymentData?.reference || `PSK_${Date.now()}`,
            callback: async function (response) {
              messageDiv.innerHTML = `<p class="text-blue-600 font-semibold">${translations[lang].verifyingPayment}</p>`;
              try {
                await authFetch(`${API_BASE_URL}/payment/success`, {
                  method: "POST",
                  body: JSON.stringify({
                    gateway: "paystack",
                    transaction_reference: response.reference,
                  }),
                });
                messageDiv.innerHTML = `<p class="text-green-600 font-semibold">${translations[lang].paymentSuccess}</p>`;
                showAlert("✅", translations[lang].subscriptionActive);
              } catch (e) {
                messageDiv.innerHTML = `<p class="text-red-600">${translations[lang].error}: ${e.message}</p>`;
                showAlert(translations[lang].verificationFailed, e.message);
              }
              hideLoading();
            },
            onClose: function () {
              messageDiv.innerHTML = `<p class="text-red-600">${translations[lang].paymentCanceled}</p>`;
              hideLoading();
            },
          });
          handler.openIframe();
        } catch (e) {
          console.error(e);
          messageDiv.innerHTML = `<p class="text-red-600">${translations[lang].error}: ${e.message}</p>`;
          showAlert(translations[lang].paymentError, e.message);
          hideLoading();
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const userLang = navigator.language.split("-")[0];
        if (translations[userLang]) languageSelector.value = userLang;
        translatePage(languageSelector.value);
        await checkAuth();
        await fetchPaymentDetails();

        payButton.addEventListener("click", initiatePayment);
      });
    </script>
  </body>
</html>

