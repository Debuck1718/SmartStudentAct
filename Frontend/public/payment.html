<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n="pageTitle">Upgrade Your Account</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .modal { position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000;}
    .modal-content { background:white;padding:2rem;border-radius:1rem;max-width:80%;text-align:center;}
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

  <!-- Language Selector -->
  <div class="absolute top-4 right-4 z-20">
    <select id="language-selector" class="bg-white border border-gray-300 rounded-lg p-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
      <option value="en">EN</option>
      <option value="fr">FR</option>
      <option value="es">ES</option>
      <option value="tr">TR</option>
      <option value="ar">AR</option>
      <option value="ru">RU</option>
    </select>
  </div>

  <!-- Modal -->
  <div id="alert-modal" class="modal">
    <div class="modal-content shadow-lg">
      <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
      <p id="modal-message" class="mb-6"></p>
      <button onclick="closeModal()" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors" data-i18n="okButton">OK</button>
    </div>
  </div>

  <!-- Payment Box -->
  <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center border border-gray-200">
    <svg class="w-16 h-16 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <h1 class="text-3xl font-bold text-gray-800 mt-4" data-i18n="trialEndedTitle">Trial Ended</h1>
    <p class="text-gray-600 mt-2" data-i18n="trialEndedMessage">Your trial period has expired. Please upgrade to continue enjoying all features.</p>
    
    <div id="payment-details" class="mt-6 p-4 bg-blue-50 rounded-xl">
      <p class="text-sm text-blue-800 font-semibold" data-i18n="subscriptionFee">Subscription Fee</p>
      <p id="amount-text" class="text-2xl font-bold text-blue-900 mt-1">Loading...</p>
    </div>

    <button 
      id="payButton"
      class="w-full mt-8 py-3 px-6 rounded-full bg-blue-600 text-white font-semibold shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
      data-i18n="payButton"
    >
      Proceed to Payment
    </button>

    <div id="message" class="mt-4 text-center"></div>
  </div>

  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script>
    const translations = { /* ... your existing translations ... */ };

    const payButton = document.getElementById('payButton');
    const messageDiv = document.getElementById('message');
    const amountText = document.getElementById('amount-text');
    const languageSelector = document.getElementById('language-selector');

    const API_BASE_URL = "https://smartstudentact.onrender.com/api";
    const PAYSTACK_PUBLIC_KEY = 'pk_live_7d871b198024f60a328d95812595be2443695fcb';
    let finalAmount = 0, finalCurrency = '', paymentEmail = '';

    async function authFetch(url, options = {}) {
      const res = await fetch(url, { ...options, credentials: "include", headers: { "Content-Type": "application/json", ...(options.headers || {}) } });
      if (res.status === 401 || res.status === 403) {
        window.location.href = "/login.html";
        throw new Error("Unauthorized");
      }
      return res;
    }

    async function checkAuth() {
      try {
        const res = await authFetch(`${API_BASE_URL}/auth/check`);
        if (!res.ok) window.location.href = "/login.html";
        const data = await res.json();
        paymentEmail = data.email || '';
        return data;
      } catch (e) {
        console.error("Auth check failed:", e);
        window.location.href = "/login.html";
      }
    }

    function showAlert(title, message) {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-message').textContent = message;
      document.getElementById('alert-modal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('alert-modal').style.display = 'none'; }
    function showLoading(text) { payButton.disabled = true; payButton.innerHTML = `<span class="animate-spin mr-2">&#9696;</span> ${text}`; }
    function hideLoading() { payButton.disabled = false; translatePage(languageSelector.value); }

    function translatePage(lang) {
      document.documentElement.lang = lang;
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) el.textContent = translations[lang][key];
      });
      payButton.textContent = translations[lang].payButton;
    }

    async function fetchPaymentDetails() {
      const lang = languageSelector.value;
      showLoading(translations[lang].loadingPrice);
      try {
        const res = await authFetch(`${API_BASE_URL}/pricing`);
        const data = await res.json();
        finalAmount = parseFloat(data.localPrice || 0);
        finalCurrency = data.currency || 'USD';
        amountText.textContent = `${finalCurrency} ${finalAmount.toFixed(2)}`;
        hideLoading();
      } catch (e) {
        console.error(e);
        messageDiv.innerHTML = `<p class="text-red-600">${translations[lang].error}: ${e.message}</p>`;
        showAlert(translations[lang].error, translations[lang].networkError);
        hideLoading();
      }
    }

    async function payWithPaystack() {
      const lang = languageSelector.value;
      showLoading(translations[lang].initiatingPayment);
      try {
        const initRes = await authFetch(`${API_BASE_URL}/payment/initiate`, {
          method: 'POST',
          body: JSON.stringify({ gateway: 'paystack' })
        });
        const paymentData = (await initRes.json()).data;
        const amountInKobo = Math.round(finalAmount * 100);
        let handler = PaystackPop.setup({
          key: PAYSTACK_PUBLIC_KEY,
          email: paymentEmail || paymentData?.email,
          amount: amountInKobo,
          currency: finalCurrency,
          ref: paymentData?.reference || `PSK_${Date.now()}`,
          callback: async function (response) {
            messageDiv.innerHTML = `<p class="text-blue-600 font-semibold">${translations[lang].verifyingPayment}</p>`;
            try {
              await authFetch(`${API_BASE_URL}/payment/success`, {
                method: 'POST',
                body: JSON.stringify({ gateway: 'paystack', transaction_reference: response.reference })
              });
              messageDiv.innerHTML = `<p class="text-green-600 font-semibold">${translations[lang].paymentSuccess}</p>`;
              showAlert("âœ…", translations[lang].subscriptionActive);
            } catch (e) {
              messageDiv.innerHTML = `<p class="text-red-600">${translations[lang].error}: ${e.message}</p>`;
              showAlert(translations[lang].verificationFailed, e.message);
            }
            hideLoading();
          },
          onClose: function () {
            messageDiv.innerHTML = `<p class="text-red-600">${translations[lang].paymentCanceled}</p>`;
            hideLoading();
          }
        });
        handler.openIframe();
      } catch (e) {
        console.error(e);
        messageDiv.innerHTML = `<p class="text-red-600">${translations[lang].error}: ${e.message}</p>`;
        showAlert(translations[lang].paymentError, e.message);
        hideLoading();
      }
    }

    payButton.addEventListener('click', payWithPaystack);
    languageSelector.addEventListener('change', async e => { translatePage(e.target.value); await fetchPaymentDetails(); });

    document.addEventListener('DOMContentLoaded', async () => {
      const userLang = navigator.language.split('-')[0];
      if (translations[userLang]) languageSelector.value = userLang;
      translatePage(languageSelector.value);
      await checkAuth(); 
      await fetchPaymentDetails(); 
    });
  </script>
</body>
</html>

