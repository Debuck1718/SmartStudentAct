<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartStudentAct - Worker Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
   <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="./images/icon.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="./images/icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="api-config.js"></script>
</head>

<body class="bg-gray-50 text-gray-800">
  <!-- Header -->
  <header class="bg-blue-600 text-white py-4 shadow">
    <div class="max-w-6xl mx-auto flex justify-between items-center px-4">
      <div class="flex items-center gap-3 relative group">
        <img
          id="profilePhoto"
          src="./images/default-avatar.png"
          alt="Profile"
          class="w-10 h-10 rounded-full border-2 border-white object-cover cursor-pointer"
        />
        <h1 id="title" class="text-xl font-semibold">ðŸ‘· Worker Dashboard</h1>
        <!-- Dropdown menu -->
        <div class="absolute top-full mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20 hidden group-hover:block">
          <a href="#" id="change-photo-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Change Photo</a>
          <a href="#" id="remove-photo-btn" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Remove Photo</a>
        </div>
      </div>

    <div class="flex gap-2 items-center">
      <select id="langSelect" class="text-black rounded p-1">
        <option value="en">EN</option>
        <option value="fr">FR</option>
        <option value="es">ES</option>
        <option value="tr">TR</option>
        <option value="ar">AR</option>
        <option value="ru">RU</option>
        <option value="pt">PT</option>
      </select>
      <button id="logoutBtn" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600">Logout</button>
    </div>
  </div>
</header>

<!-- Hidden file input for photo upload -->
<input type="file" id="photoInput" accept="image/*" style="display: none" />

  <main class="max-w-6xl mx-auto py-8 px-4 space-y-8">
    <!-- Navigation Links -->
    <nav class="bg-white rounded-lg shadow p-4 flex justify-around">
      <a href="worker.html" class="text-blue-600 font-semibold hover:underline" id="nav_dashboard">Dashboard</a>
      <a href="global-leaderboard.html" class="text-blue-600 font-semibold hover:underline" id="nav_dashboard">Global leaderboard</a>
      <a href="contact.html" class="text-gray-700 hover:underline" id="nav_contact">Contact</a>
      <a href="settings.html" class="text-gray-700 hover:underline" id="nav_settings">Settings</a>
    </nav>

    <!-- Overview -->
    <section id="overview" class="bg-white rounded-lg shadow p-6">
      <h2 id="overview_title" class="text-xl font-semibold mb-4">Overview</h2>
      <div id="overviewData" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
        <div><h3 id="overview_motivation" class="font-semibold">Motivation</h3><p id="motivationLevel">--%</p></div>
        <div><h3 id="overview_goals" class="font-semibold">Goals Completed</h3><p id="goalProgress">--%</p></div>
        <div><h3 id="overview_streak" class="font-semibold">Active Streak</h3><p id="streakStatus">-- days</p></div>
      </div>
    </section>

    <!-- Add Reminder -->
    <section id="addReminder" class="bg-white rounded-lg shadow p-6">
      <h2 id="reminder_title" class="text-xl font-semibold mb-4">Add Reminder</h2>
      <form id="reminderForm" class="grid md:grid-cols-2 gap-4">
        <input type="text" id="reminderTitle" placeholder="Title" class="border p-2 rounded" required />
        <input type="date" id="reminderDate" class="border p-2 rounded" required />
        <input type="time" id="reminderTime" class="border p-2 rounded" required />
        <input type="text" id="reminderCategory" placeholder="Category" class="border p-2 rounded" />
        <label class="md:col-span-2 flex items-center gap-2">
          <input type="checkbox" id="reminderRecurring" /> <span>Recurring Reminder</span>
        </label>
        <button type="submit" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 md:col-span-2">
          Add Reminder
        </button>
      </form>
    </section>

    <!-- Add Goal -->
    <section id="addGoal" class="bg-white rounded-lg shadow p-6">
      <h2 id="goal_title" class="text-xl font-semibold mb-4">Add New Goal</h2>
      <form id="goalForm" class="grid md:grid-cols-2 gap-4">
        <input type="text" id="goalTitle" placeholder="Title" class="border p-2 rounded" required />
        <input type="date" id="goalDate" class="border p-2 rounded" required />
        <input type="text" id="goalCategory" placeholder="Category" class="border p-2 rounded" />
        <textarea id="goalDesc" placeholder="Description" class="border p-2 rounded md:col-span-2"></textarea>
        <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 md:col-span-2">
          Add Goal
        </button>
      </form>
    </section>

    <!-- Insights -->
    <section id="insights" class="bg-white rounded-lg shadow p-6">
      <h2 id="insight_title" class="text-xl font-semibold mb-4">AI Insights</h2>
      <div id="insightBox" class="space-y-2 text-gray-700">
        <p><strong>Goal Insight:</strong> <span id="goalInsight">Loading...</span></p>
        <p><strong>Finance Insight:</strong> <span id="financeInsight">Loading...</span></p>
        <p><strong>Motivation Insight:</strong> <span id="motivationInsight">Loading...</span></p>
        <p><strong>Advice Summary:</strong> <span id="adviceSummary">Loading...</span></p>
      </div>
    </section>

    <!-- Financial Summary -->
    <section id="finance" class="bg-white rounded-lg shadow p-6">
      <h2 id="finance_title" class="text-xl font-semibold mb-4">Finance Summary</h2>
      <canvas id="financeChart" height="150"></canvas>
    </section>

    <!-- Rewards -->
    <section id="rewards" class="bg-white rounded-lg shadow p-6">
      <h2 id="reward_title" class="text-xl font-semibold mb-4">Rewards & Achievements</h2>
      <div id="rewardData" class="grid md:grid-cols-2 gap-4"></div>
    </section>
  </main>

  <footer class="bg-gray-100 text-center text-gray-500 py-4">
    <p>Â© 2025 SmartStudentAct. All rights reserved.</p>
  </footer>

  <!-- Cropper Modal -->
  <div id="cropper-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-4 rounded-lg shadow-xl max-w-md w-full">
      <h2 class="text-xl font-bold mb-4">Crop Your Photo</h2>
      <div class="img-container">
        <img id="cropper-image" src="" class="max-w-full">
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="cancel-crop-btn" type="button" class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
        <button id="crop-and-save-btn" type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Crop & Save</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.API_BASE_URL;
    const userId = localStorage.getItem("user_id");

    function showToast(message, type = "info") {
      const container =
        document.getElementById("toast-container") ||
        (() => {
          const el = document.createElement("div");
          el.id = "toast-container";
          el.className = "fixed top-4 right-4 z-[1000] space-y-2";
          document.body.appendChild(el);
          return el;
        })();
      const colors = { success: "bg-green-600", error: "bg-red-600", info: "bg-blue-600", warning: "bg-yellow-500 text-gray-900" };
      const toast = document.createElement("div");
      toast.className = `px-4 py-2 rounded text-white shadow ${colors[type] || colors.info}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }

    async function authFetch(endpoint, options = {}) {
      const res = await fetch(`${API_BASE_URL}${endpoint}`, {
        ...options,
        credentials: "include",
        headers: {
          ...(options.headers || {}),
        },
      });
      if (res.status === 401) {
        window.location.href = "/login.html";
        return null;
      }
      return res;
    }
    let translations = {};

    async function loadTranslations(lang) {
      const res = await fetch(`/locales/worker.json`);
      const data = await res.json();
      translations = data[lang] || data["en"];
      document.querySelectorAll("[id]").forEach(el => {
        if (translations[el.id]) el.textContent = translations[el.id];
      });
    }

    const langSelect = document.getElementById("langSelect");
    langSelect.addEventListener("change", e => {
      localStorage.setItem("lang", e.target.value);
      loadTranslations(e.target.value);
    });

    async function loadOverview() {
      try {
        const res = await authFetch(`/worker/overview`);
        if (!res) return;
        const body = await res.json();
        const data = body.data;
        document.getElementById("motivationLevel").innerText = data.motivation_level + "%";
        document.getElementById("goalProgress").innerText = data.goal_progress_percent + "%";
        document.getElementById("streakStatus").innerText = data.active_streak_days + " days";
        renderFinanceChart(data.financial_summary);
      } catch (err) {
        console.error("Overview load error:", err);
        showToast("Failed to load overview", "error");
      }
    }

    async function loadInsights() {
      try {
        const res = await authFetch(`/worker/insight`);
        if (!res) return;
        const body = await res.json();
        const data = body.insights;
        document.getElementById("goalInsight").innerText = data.goalInsight || "â€”";
        document.getElementById("financeInsight").innerText = data.financeInsight || "â€”";
        document.getElementById("motivationInsight").innerText = data.motivationInsight || "â€”";
        document.getElementById("adviceSummary").innerText = data.adviceSummary || "â€”";
      } catch (err) {
        console.error("Insight error:", err);
        showToast("Failed to load insights", "error");
      }
    }

    async function loadRewards() {
      try {
        const res = await authFetch(`/worker/rewards/dashboard`);
        if (!res) return;
        const r = await res.json();
        document.getElementById("rewardData").innerHTML = `
          <div class="p-4 border rounded">
            <p><strong>Total Points:</strong> ${r.totalPoints}</p>
            <p><strong>Productivity:</strong> ${r.productivityScore}</p>
            <p><strong>Consistency Weeks:</strong> ${r.consistencyWeeks}</p>
          </div>
          <div class="p-4 border rounded">
            <p><strong>Last Updated:</strong> ${new Date(r.lastUpdated).toLocaleDateString()}</p>
            <p><strong>Recent Activities:</strong></p>
            <ul class="text-sm list-disc ml-6">
              ${r.pointsLog.map(p => `<li>${p.source} +${p.points}pts - ${p.description}</li>`).join('')}
            </ul>
          </div>`;
      } catch (err) {
        console.error("Rewards load error:", err);
        showToast("Failed to load rewards", "error");
      }
    }

    function renderFinanceChart(financials) {
      const ctx = document.getElementById("financeChart").getContext("2d");
      new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Income", "Expenses", "Savings"],
          datasets: [{
            data: [financials.total_income, financials.total_expenses, financials.total_savings],
            backgroundColor: ["#22c55e", "#ef4444", "#3b82f6"]
          }]
        },
        options: { responsive: true, plugins: { legend: { position: "bottom" } } }
      });
    }

    document.getElementById("goalForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const payload = {
        user_id: userId,
        title: document.getElementById("goalTitle").value,
        description: document.getElementById("goalDesc").value,
        target_completion_date: document.getElementById("goalDate").value,
        category: document.getElementById("goalCategory").value
      };
      try {
        const res = await authFetch(`/worker/add-goal`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res) return;
        const body = await res.json();
        if (!res.ok) throw new Error(body.message || "Failed to add goal");
        showToast("Goal added successfully!", "success");
        loadOverview();
      } catch (err) {
        console.error(err);
        showToast(err.message || "Error adding goal", "error");
      }
    });

    document.getElementById("reminderForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const dueDateTime = new Date(
        document.getElementById("reminderDate").value + "T" +
        document.getElementById("reminderTime").value
      ).toISOString();
      const payload = {
        user_id: userId,
        title: document.getElementById("reminderTitle").value,
        due_date: dueDateTime,
        category: document.getElementById("reminderCategory").value,
        is_recurring: document.getElementById("reminderRecurring").checked
      };
      try {
        const res = await authFetch(`/worker/add-reminder`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res) return;
        const body = await res.json();
        if (!res.ok) throw new Error(body.message || "Failed to add reminder");
        showToast("Reminder added successfully!", "success");
      } catch (err) {
        console.error(err);
        showToast(err.message || "Error adding reminder", "error");
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("user_id");
      window.location.href = "/login.html";
    });

    // Profile photo upload logic
const photoInput = document.getElementById("photoInput");
const profilePhoto = document.getElementById("profilePhoto");
const changePhotoBtn = document.getElementById("change-photo-btn");
const removePhotoBtn = document.getElementById("remove-photo-btn");

  async function loadProfilePhoto() {
    try {
      const res = await authFetch(`/profile`);
      if (!res) return;
      const body = await res.json();
      const url = body?.user?.profile_picture_url || "/images/default-avatar.png";
      profilePhoto.src = url;
      removePhotoBtn.classList.toggle('hidden', !body?.user?.profile_picture_url);
    } catch (err) {
      console.warn("Could not load profile photo:", err);
      profilePhoto.src = "/images/default-avatar.png";
    }
  }

changePhotoBtn.addEventListener("click", (e) => {
  e.preventDefault();
  photoInput.click();
});

removePhotoBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    if (!confirm("Are you sure you want to remove your profile photo?")) return;
    try {
        const res = await authFetch(`/profile/photo`, { method: "DELETE" });
        if (!res) throw new Error("Request failed");
        const body = await res.json();
        if (!res.ok) throw new Error(body.message || "Failed to remove photo");
        showToast("Profile photo removed!", "success");
        loadProfilePhoto();
    } catch (err) {
        showToast(err.message, "error");
    }
});

let cropper;
const cropperModal = document.getElementById("cropper-modal");
const cropperImage = document.getElementById("cropper-image");
const cropAndSaveBtn = document.getElementById("crop-and-save-btn");
const cancelCropBtn = document.getElementById("cancel-crop-btn");

photoInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
        cropperImage.src = event.target.result;
        cropperModal.classList.remove("hidden");
        if (cropper) cropper.destroy();
        cropper = new Cropper(cropperImage, { aspectRatio: 1, viewMode: 1 });
    };
    reader.readAsDataURL(file);
});

function closeCropperModal() {
    cropperModal.classList.add("hidden");
    if (cropper) cropper.destroy();
    photoInput.value = "";
}

cancelCropBtn.addEventListener("click", closeCropperModal);

cropAndSaveBtn.addEventListener("click", () => {
    if (!cropper) return;
    cropper.getCroppedCanvas({ width: 512, height: 512 }).toBlob(async (blob) => {
        const formData = new FormData();
        formData.append("profilePhoto", blob, "profile.jpg");
        try {
            const res = await fetch(`${API_BASE_URL}/profile/upload-photo`, { method: "POST", credentials: "include", body: formData });
            const body = await res.json();
            if (!res.ok) throw new Error(body.message || "Upload failed");
            showToast("Profile photo updated!", "success");
            loadProfilePhoto();
        } catch (err) {
            showToast(err.message, "error");
        } finally {
            closeCropperModal();
        }
    }, 'image/jpeg');
});


    const savedLang = localStorage.getItem("lang") || "en";
    langSelect.value = savedLang;
    loadTranslations(savedLang);
    loadOverview();
    loadInsights();
    loadRewards();
    loadProfilePhoto();
  </script>
</body>
</html>
