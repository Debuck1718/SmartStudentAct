<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Overseer Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./images/icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="./images/icon.png"
    />
    <link rel="manifest" href="/site.webmanifest" />
    <style>
      body {
        font-family: "Inter", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: #f5f7fa;
      }

      .spinner {
        border-top-color: #007bff;
        -webkit-animation: spinner 1s linear infinite;
        animation: spinner 1s linear infinite;
      }

      @-webkit-keyframes spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .modal-overlay {
        background-color: rgba(0, 0, 0, 0.5);
      }
    </style>
    <!-- Ionicons for the icons, just like in the React Native version -->
    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>
  </head>
  <body class="bg-gray-100">
    <!-- The main container for the dashboard -->
    <div class="max-w-4xl mx-auto p-6 lg:p-10">
      <!-- Loading state container -->
      <div
        id="loading-container"
        class="flex flex-col items-center justify-center min-h-screen"
      >
        <div
          class="spinner w-12 h-12 border-4 rounded-full border-gray-200"
        ></div>
        <p class="mt-4 text-lg font-medium text-gray-600">
          Loading Overseer Dashboard...
        </p>
      </div>

      <!-- Dashboard content container (hidden by default) -->
      <div id="dashboard-content" class="hidden">
        <!-- Header section -->
        <div
          class="flex items-center justify-between pb-4 mb-6 border-b border-gray-200"
        >
          <div class="flex items-center space-x-2">
            <!-- Profile and Settings buttons, now with click handlers -->
            <button
              id="profile-btn"
              class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <ion-icon
                name="person-circle-outline"
                class="text-3xl text-gray-700"
              ></ion-icon>
            </button>
            <button
              id="settings-btn"
              class="p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <ion-icon
                name="settings-outline"
                class="text-3xl text-gray-700"
              ></ion-icon>
            </button>
          </div>
          <h1 class="text-2xl font-bold text-center text-gray-800 flex-1">
            Overseer Dashboard
          </h1>
          <button
            id="logout-btn"
            class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition-colors"
          >
            Logout
          </button>
        </div>

        <!-- Dashboard sections -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
          <h2
            class="text-xl font-semibold text-gray-700 pb-2 border-b border-gray-100 mb-4"
          >
            Your Regions
          </h2>
          <div id="regions-container">
            <!-- Dynamic region cards will be inserted here by JavaScript -->
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
          <h2
            class="text-xl font-semibold text-gray-700 pb-2 border-b border-gray-100 mb-4"
          >
            Management
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button
              id="manage-schools-btn"
              class="flex items-center justify-center space-x-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition-colors"
            >
              <ion-icon name="map-outline" class="text-2xl"></ion-icon>
              <span>Manage Schools & Regions</span>
            </button>
            <button
              id="manage-admins-btn"
              class="flex items-center justify-center space-x-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition-colors"
            >
              <ion-icon name="people-outline" class="text-2xl"></ion-icon>
              <span>Manage School Admins</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Custom Modal for Alerts/Confirmations -->
    <div
      id="custom-modal"
      class="hidden fixed inset-0 z-50 overflow-y-auto flex items-center justify-center modal-overlay"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-sm w-full">
        <div class="text-center">
          <h3
            id="modal-title"
            class="text-lg leading-6 font-medium text-gray-900 mb-2"
          ></h3>
          <div class="mt-2">
            <p id="modal-message" class="text-sm text-gray-500"></p>
          </div>
        </div>
        <div
          class="mt-5 sm:mt-6 sm:flex sm:flex-row-reverse space-x-2 space-x-reverse"
        >
          <button
            id="modal-confirm-btn"
            type="button"
            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm"
          >
            Logout
          </button>
          <button
            id="modal-cancel-btn"
            type="button"
            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- NEW: Profile & Settings Modal -->
    <div
      id="profile-modal"
      class="hidden fixed inset-0 z-50 overflow-y-auto flex items-center justify-center modal-overlay"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-lg w-full">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
          Update Profile & Settings
        </h3>
        <form id="profile-form" class="space-y-4">
          <div>
            <label
              for="username"
              class="block text-sm font-medium text-gray-700"
              >Username</label
            >
            <input
              type="text"
              id="username"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700"
              >Email</label
            >
            <input
              type="email"
              id="email"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div>
            <label
              for="password"
              class="block text-sm font-medium text-gray-700"
              >New Password</label
            >
            <input
              type="password"
              id="password"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div id="profile-message" class="text-sm mt-2 font-medium"></div>
          <div class="flex justify-end space-x-3">
            <button
              type="button"
              id="close-profile-modal-btn"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              id="update-profile-btn"
              class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors"
            >
              Update Profile
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const API_BASE_URL = 'https://smartstudentact.onrender.com/api';

        const loadingContainer = document.getElementById("loading-container");
        const dashboardContent = document.getElementById("dashboard-content");
        const regionsContainer = document.getElementById("regions-container");
        const logoutBtn = document.getElementById("logout-btn");
        const manageSchoolsBtn = document.getElementById("manage-schools-btn");
        const manageAdminsBtn = document.getElementById("manage-admins-btn");
        const profileBtn = document.getElementById("profile-btn");
        const settingsBtn = document.getElementById("settings-btn");

        const customModal = document.getElementById("custom-modal");
        const modalTitle = document.getElementById("modal-title");
        const modalMessage = document.getElementById("modal-message");
        const modalConfirmBtn = document.getElementById("modal-confirm-btn");
        const modalCancelBtn = document.getElementById("modal-cancel-btn");

        const profileModal = document.getElementById("profile-modal");
        const profileForm = document.getElementById("profile-form");
        const closeProfileModalBtn = document.getElementById(
          "close-profile-modal-btn"
        );
        const usernameInput = document.getElementById("username");
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const profileMessage = document.getElementById("profile-message");

        // Helper for authenticated requests, now only sending HttpOnly cookies
        const authFetch = async (url, options = {}) => {
          return fetch(url, {
            ...options,
            credentials: "include", // send HttpOnly cookie automatically
            headers: {
              "Content-Type": "application/json",
              ...(options.headers || {}),
            },
          });
        };

        const showCustomModal = (title, message, onConfirm) => {
          modalTitle.textContent = title;
          modalMessage.textContent = message;
          customModal.classList.remove("hidden");
          modalConfirmBtn.onclick = () => {
            customModal.classList.add("hidden");
            onConfirm();
          };
          modalCancelBtn.onclick = () => customModal.classList.add("hidden");
        };

        const fetchDashboardData = async () => {
          loadingContainer.classList.remove("hidden");
          dashboardContent.classList.add("hidden");

          try {
            const response = await authFetch(
              `${API_BASE_URL}/overseer/dashboard-overview`
            );
            if (!response.ok) {
              if (response.status === 401 || response.status === 403) {
                console.error(
                  `Auth error ${response.status}, redirecting to login.`
                );
                window.location.href = "/login.html";
                return;
              }
              throw new Error(
                `API call failed with status: ${response.status}`
              );
            }

            const data = await response.json();
            renderRegions(data.regions);
          } catch (error) {
            console.error("Error fetching dashboard data:", error);
            regionsContainer.innerHTML = `<p class="text-center text-red-500 italic py-4">Failed to load data. Please try again later.</p>`;
          } finally {
            loadingContainer.classList.add("hidden");
            dashboardContent.classList.remove("hidden");
          }
        };

        const renderRegions = (regions) => {
          regionsContainer.innerHTML = "";
          if (!regions || regions.length === 0) {
            regionsContainer.innerHTML = `<p class="text-center text-gray-500 italic py-4">No regions assigned to you yet.</p>`;
          } else {
            regions.forEach((region) => {
              const card = document.createElement("div");
              card.className = "bg-gray-100 p-4 rounded-lg mb-3 shadow-sm";
              card.innerHTML = `
                        <p class="text-base text-gray-700 font-semibold mb-1">Region: ${
                          region.name
                        }</p>
                        <p class="text-sm text-gray-600">Schools in Region: ${
                          region.totalSchools || 0
                        }</p>
                        <p class="text-sm text-gray-600">Admins in Region: ${
                          region.totalAdmins || 0
                        }</p>
                    `;
              regionsContainer.appendChild(card);
            });
          }
        };

        const handleLogout = () => {
          showCustomModal(
            "Confirm Logout",
            "Are you sure you want to log out?",
            async () => {
              try {
                await authFetch(`${API_BASE_URL}/auth/logout`, {
                  method: "POST",
                });
              } catch (e) {
                console.error("Logout failed:", e);
              }
              window.location.href = "/login.html";
            }
          );
        };

        const handleManageSchoolsAndRegions = () => {
          console.log("Navigating to School & Region Management...");
        };

        const handleManageAdmins = () => {
          console.log("Navigating to School Admin Management...");
        };

        const showProfileSettingsModal = async () => {
          try {
            const response = await authFetch(`${API_BASE_URL}/profile`);
            if (!response.ok) throw new Error("Failed to fetch profile data");
            const user = await response.json();
            usernameInput.value = user.username || "";
            emailInput.value = user.email || "";
          } catch (e) {
            console.error("Error fetching profile:", e);
            usernameInput.value = "";
            emailInput.value = "";
          }
          passwordInput.value = "";
          profileMessage.textContent = "";
          profileModal.classList.remove("hidden");
        };

        const handleProfileUpdate = async (event) => {
          event.preventDefault();
          const newUsername = usernameInput.value;
          const newEmail = emailInput.value;
          const newPassword = passwordInput.value;

          if (!newUsername || !newEmail) {
            profileMessage.textContent = "Username and Email are required.";
            profileMessage.className = "text-sm mt-2 text-red-500 font-medium";
            return;
          }

          const payload = {
            username: newUsername,
            email: newEmail,
            ...(newPassword && { password: newPassword }),
          };

          try {
            const response = await authFetch(`${API_BASE_URL}/profile`, {
              method: "PATCH",
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || "Failed to update profile.");
            }

            profileMessage.textContent = "Profile updated successfully!";
            profileMessage.className =
              "text-sm mt-2 text-green-500 font-medium";
            setTimeout(() => profileModal.classList.add("hidden"), 2000);
          } catch (error) {
            profileMessage.textContent = error.message;
            profileMessage.className = "text-sm mt-2 text-red-500 font-medium";
          }
        };

        logoutBtn.addEventListener("click", handleLogout);
        manageSchoolsBtn.addEventListener(
          "click",
          handleManageSchoolsAndRegions
        );
        manageAdminsBtn.addEventListener("click", handleManageAdmins);
        profileBtn.addEventListener("click", showProfileSettingsModal);
        settingsBtn.addEventListener("click", showProfileSettingsModal);
        closeProfileModalBtn.addEventListener("click", () =>
          profileModal.classList.add("hidden")
        );
        profileForm.addEventListener("submit", handleProfileUpdate);

        fetchDashboardData();
      });
    </script>
  </body>
</html>
